/*
 PlayCanvas Engine v0.182.1 revision b9c2b30
 http://playcanvas.com
 Copyright 2011-2016 PlayCanvas Ltd. All rights reserved.
 Do not distribute.
 Contains: https://github.com/tildeio/rsvp.js - see page for license information
*/
var pc={version:"0.182.1",revision:"b9c2b30",config:{},common:{},apps:{},data:{},unpack:function(){console.warn("pc.unpack has been deprecated and will be removed shortly. Please update your code.")},makeArray:function(f){var a,b=[],d=f.length;for(a=0;a<d;++a)b.push(f[a]);return b},type:function(f){if(null===f)return"null";var a=typeof f;return"undefined"==a||"number"==a||"string"==a||"boolean"==a?a:_typeLookup[Object.prototype.toString.call(f)]},extend:function(f,a){var b,d;
for(b in a)d=a[b],f[b]="object"==pc.type(d)?pc.extend({},d):"array"==pc.type(d)?pc.extend([],d):d;return f},isDefined:function(f){return void 0!==f}},_typeLookup=function(){var f={},a,b="Array Object Function Date RegExp Float32Array".split(" ");for(a=0;a<b.length;++a)f["[object "+b[a]+"]"]=b[a].toLowerCase();return f}();"undefined"!==typeof exports&&(exports.pc=pc);(function(){for(var f=0,a=["ms","moz","webkit","o"],b=0;b<a.length&&!window.requestAnimationFrame;++b)window.requestAnimationFrame=window[a[b]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[a[b]+"CancelAnimationFrame"]||window[a[b]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var b=(new Date).getTime(),g=Math.max(0,16-(b-f)),h=window.setTimeout(function(){a(b+g)},g);f=b+g;return h});window.cancelAnimationFrame||(window.cancelAnimationFrame=
function(a){clearTimeout(a)})})();String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!0,writable:!0,value:function(f){for(var a=0,b=f.length;a<b;a++)if(this[a]!==f[a])return!1;return!0}});String.prototype.endsWith||Object.defineProperty(String.prototype,"endsWith",{enumerable:!1,configurable:!0,writable:!0,value:function(f){for(var a=0,b=f.length;a<b;a++)if(this[a+this.length-b]!==f[a])return!1;return!0}});
String.prototype.includes||(String.prototype.includes=function(f,a){"number"!==typeof a&&(a=0);return a+f.length>this.length?!1:-1!==this.indexOf(f,a)});(function(){if("undefined"!==typeof document){var f=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("fullscreenchange",!0,!1,null);document.dispatchEvent(a)},a=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("fullscreenerror",!0,!1,null);document.dispatchEvent(a)};document.addEventListener("webkitfullscreenchange",f,!1);document.addEventListener("mozfullscreenchange",f,!1);document.addEventListener("MSFullscreenChange",f,!1);document.addEventListener("webkitfullscreenerror",
a,!1);document.addEventListener("mozfullscreenerror",a,!1);document.addEventListener("MSFullscreenError",a,!1);Element.prototype.requestFullscreen=Element.prototype.mozRequestFullScreen?function(){this.mozRequestFullScreen()}:Element.prototype.requestFullscreen||Element.prototype.webkitRequestFullscreen||Element.prototype.msRequestFullscreen||function(){};document.exitFullscreen=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen;document.hasOwnProperty("fullscreenElement")||
Object.defineProperty(document,"fullscreenElement",{enumerable:!0,configurable:!1,get:function(){return document.webkitCurrentFullScreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement}});document.hasOwnProperty("fullscreenEnabled")||Object.defineProperty(document,"fullscreenEnabled",{enumerable:!0,configurable:!1,get:function(){return document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled}})}})();pc.extend(pc,function(){var f=function(){this.data=new Float32Array(4);3<=arguments.length?(this.data[0]=arguments[0],this.data[1]=arguments[1],this.data[2]=arguments[2],this.data[3]=4<=arguments.length?arguments[3]:1):(this.data[0]=0,this.data[1]=0,this.data[2]=0,this.data[3]=1)};f.prototype={clone:function(){return new pc.Color(this.r,this.g,this.b,this.a)},copy:function(a){var b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return this},set:function(a,b,d,e){var g=this.data;g[0]=a;
g[1]=b;g[2]=d;g[3]=void 0===e?1:e;return this},fromString:function(a){var b=parseInt(a.replace("#","0x"));7<a.length?a=pc.math.intToBytes32(b):(a=pc.math.intToBytes24(b),a[3]=255);this.set(a[0]/255,a[1]/255,a[2]/255,a[3]/255);return this},toString:function(a){var b="#"+(16777216+(parseInt(255*this.r)<<16)+(parseInt(255*this.g)<<8)+parseInt(255*this.b)).toString(16).slice(1);!0===a&&(a=parseInt(255*this.a).toString(16),b=this.a<16/255?b+("0"+a):b+a);return b}};Object.defineProperty(f.prototype,"r",
{get:function(){return this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(f.prototype,"g",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(f.prototype,"b",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(f.prototype,"a",{get:function(){return this.data[3]},set:function(a){this.data[3]=a}});return{Color:f}}());pc.guid=function(){return{create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(f){var a=16*Math.random()|0;return("x"==f?a:a&3|8).toString(16)})}}}();pc.extend(pc,function(){var f=function(){this._isRunning=!1;this._b=this._a=0};f.prototype={start:function(){this._isRunning=!0;this._a=(new Date).getTime()},stop:function(){this._isRunning=!1;this._b=(new Date).getTime()},getMilliseconds:function(){return this._b-this._a}};return{Timer:f,now:!window.performance||!performance.now||!performance.timing?Date.now:function(){return performance.now()}}}());pc.extend(pc,function(){return{createURI:function(f){var a="";if((f.authority||f.scheme)&&(f.host||f.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(f.host&&f.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(f.path&&f.hostpath)throw Error("Can't have 'path' and 'hostpath' option");f.scheme&&(a+=f.scheme+":");f.authority&&(a+="//"+f.authority);f.host&&(a+=f.host);f.path&&(a+=f.path);f.hostpath&&(a+=f.hostpath);f.query&&(a+="?"+f.query);
f.fragment&&(a+="#"+f.fragment);return a},URI:function(f){f=f.match(/^(([^:\/?\#]+):)?(\/\/([^\/?\#]*))?([^?\#]*)(\?([^\#]*))?(\#(.*))?/);this.scheme=f[2];this.authority=f[4];this.path=f[5];this.query=f[7];this.fragment=f[9];this.toString=function(){var a="";this.scheme&&(a+=this.scheme+":");this.authority&&(a+="//"+this.authority);a+=this.path;this.query&&(a+="?"+this.query);this.fragment&&(a+="#"+this.fragment);return a};this.getQuery=function(){var a,b,d={};this.query&&(a=decodeURIComponent(this.query).split("&"),
a.forEach(function(a){b=a.split("=");d[b[0]]=b[1]},this));return d};this.setQuery=function(a){q="";for(var b in a)a.hasOwnProperty(b)&&(""!==q&&(q+="&"),q+=encodeURIComponent(b)+"="+encodeURIComponent(a[b]));this.query=q}}}}());pc.extend(pc,function(){return{log:{write:function(f){console.log(f)},open:function(){pc.log.write("Powered by PlayCanvas "+pc.version+" "+pc.revision)},info:function(f){console.info("INFO:    "+f)},debug:function(f){console.debug("DEBUG:   "+f)},error:function(f){console.error("ERROR:   "+f)},warning:function(f){console.warn("WARNING: "+f)},alert:function(f){pc.log.write("ALERT:   "+f);alert(f)},assert:function(f,a){!1===f&&(pc.log.write("ASSERT:  "+a),alert("ASSERT failed: "+a))}}}}());
var logINFO=pc.log.info,logDEBUG=pc.log.debug,logWARNING=pc.log.warning,logERROR=pc.log.error,logALERT=pc.log.alert,logASSERT=pc.log.assert;Function.prototype.extendsFrom=function(f){var a,b,d=function(){};a=this;b=function(){f.apply(this,arguments);a.apply(this,arguments);this.constructor=a};b._super=f.prototype;d.prototype=f.prototype;b.prototype=new d;return b};pc.extend(pc,function(){return{inherits:function(f,a){var b=function(){},d=function(){a.apply(this,arguments);f.apply(this,arguments)};d._super=a.prototype;b.prototype=a.prototype;d.prototype=new b;return d}}}());Function.prototype.bind||(Function.prototype.bind=function(f){if("function"!==typeof this)throw new TypeError("Function.prototype.bind - what is trying to be fBound is not callable");var a=Array.prototype.slice.call(arguments,1),b=this,d=function(){},e=function(){return b.apply(this instanceof d?this:f||window,a.concat(Array.prototype.slice.call(arguments)))};d.prototype=this.prototype;e.prototype=new d;return e});pc.path=function(){return{delimiter:"/",join:function(){var f,a=arguments.length,b=arguments[0];for(f=0;f<a-1;++f){var d=arguments[f],e=arguments[f+1];if(!pc.isDefined(d)||!pc.isDefined(e))throw Error("undefined argument to pc.path.join");b=e[0]===pc.path.delimiter?e:d&&e&&d[d.length-1]!==pc.path.delimiter&&e[0]!==pc.path.delimiter?b+(pc.path.delimiter+e):b+e}return b},split:function(f){var f=f.split(pc.path.delimiter),a=f.slice(f.length-1)[0];return[f.slice(0,f.length-1).join(pc.path.delimiter),
a]},getBasename:function(f){return pc.path.split(f)[1]},getDirectory:function(f){f=f.split(pc.path.delimiter);return f.slice(0,f.length-1).join(pc.path.delimiter)},getExtension:function(f){var a=f.split("?")[0].split(".").pop();return a!==f?"."+a:""},isRelativePath:function(f){return"/"!==f.charAt(0)&&null===f.match(/:\/\//)},extractPath:function(f){var a=".",b=f.split("/"),d=0;if(1<b.length){!1===pc.path.isRelativePath(f)&&(a="");for(d=0;d<b.length-1;++d)a+="/"+b[d]}return a}}}();pc.string=function(){return{ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:this.ASCII_LOWERCASE+this.ASCII_UPPERCASE,format:function(f){var a=0,b,d=pc.makeArray(arguments);d.shift();for(a=0;a<d.length;a++)b=RegExp("\\{"+a+"\\}","gi"),f=f.replace(b,d[a]);return f},startsWith:function(f,a){console.warn("WARNING: startsWith: Function is deprecated. Use String.startsWith instead.");return f.startsWith(a)},endsWith:function(f,a){console.warn("WARNING: endsWith: Function is deprecated. Use String.endsWith instead.");
return f.endsWith(a)},toBool:function(f,a){if("true"===f)return!0;if(a){if("false"===f)return!1;throw Error("Not a boolean string");}return!1}}}();pc.extend(pc,function(){return{json:{parse:function(f,a){return JSON.parse(f,a)},stringify:function(f,a,b){return JSON.stringify(f,function(b,e){this[b]instanceof Float32Array&&(e=pc.makeArray(this[b]));return a?a(b,e):e},b)}}}}());pc.cookie=function(){return{set:function(f,a,b){b=b||{};f=f+"="+a;b.path&&(f+=";path="+b.path);b.domain&&(f+=";domain="+b.domain);b.path&&(f+=";path="+b.path);b.secure&&(f+=";secure");f=b.lifetime?f+(";max-age="+86400*b.lifetime):f+";max-age=86400";document.cookie=f},get:function(f){var a,b=document.cookie.split(";"),d,e=b.length;for(d=0;d<e;d++)if(a=b[d].trim(),a.startsWith(f))return a.split("=")[1]},remove:function(f,a){a.lifetime=0;pc.cookie.set(f,"",a)}}}();pc.debug=function(){var f=null,a=null,b=null,d=null;return{display:function(e){f||(f=document.createElement("table"),a=document.createElement("tr"),b=document.createElement("td"),d=document.createElement("td"),f.style.cssText="position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc",f.style.top="0px",f.style.left="0px",f.style.border="thin solid #cccccc",document.body.appendChild(f));f.innerHTML="";for(var g in e){var h=a.cloneNode(),k=b.cloneNode(),m=d.cloneNode();k.textContent=g;m.textContent=
e[g];h.appendChild(k);h.appendChild(m);f.appendChild(h)}}}}();pc.events=function(){var f={attach:function(a){var b=pc.events;a.on=b.on;a.off=b.off;a.fire=b.fire;a.once=b.once;a.hasEvent=b.hasEvent;a.bind=b.on;a.unbind=b.off;return a},on:function(a,b,d){if("string"!=pc.type(a))throw new TypeError("Event name must be a string");var e=this._callbacks||(this._callbacks={});(e[a]||(e[a]=[])).push({callback:b,scope:d||this});return this},off:function(a,b,d){var e=this._callbacks;if(e){if(b){a=e[a];if(!a)return this;for(e=0;e<a.length;e++)if(a[e].callback===b&&(!d||
d===a[e].scope))a.splice(e,1),e--}else e[a]=[];return this}},fire:function(a){var b,d,e,g;if(this._callbacks&&this._callbacks[a]&&(d=this._callbacks[a].length)){if(1<arguments.length){e=Array(arguments.length-1);for(b=1;b<arguments.length;b++)e[b-1]=arguments[b]}g=this._callbacks[a].slice();var h=0;for(b=0;b<d;++b)g[b].callback.apply(g[b].scope,e),g[b].callback.once?this._callbacks[a].splice(h,1):h++}return this},once:function(a,b,d){b.once=!0;this.on(a,b,d)},hasEvent:function(a){return void 0!==
this._callbacks&&void 0!==this._callbacks[a]&&0<this._callbacks[a].length}};f.bind=f.on;f.unbind=f.off;return f}();pc.extend(pc,function(){var f=function(a){this._index={};this._key=a||null};f.prototype={addItem:function(a){for(var d=a.tags._list,e=0;e<d.length;e++)this.add(d[e],a)},removeItem:function(a){for(var d=a.tags._list,e=0;e<d.length;e++)this.remove(d[e],a)},add:function(a,d){this._index[a]&&-1!==this._index[a].list.indexOf(d)||(this._index[a]||(this._index[a]={list:[]},this._key&&(this._index[a].keys={})),this._index[a].list.push(d),this._key&&(this._index[a].keys[d[this._key]]=d))},remove:function(a,
d){if(this._index[a]&&(!this._key||this._index[a].keys[d[this._key]])){var e=this._index[a].indexOf(d);-1!==e&&(this._index[a].list.splice(e,1),this._key&&delete this._index[a].keys[d[this._key]],0===this._index[a].list.length&&delete this._index[a])}},find:function(a){var d=this,e={},g=[],h,f,m,r,u,l=function(a,b){return d._index[a].list.length-d._index[b].list.length};for(h=0;h<a.length;h++){r=a[h];if(r instanceof Array){if(0===r.length)continue;if(1===r.length)r=r[0];else{m=!1;for(f=0;f<r.length;f++)if(!this._index[r[f]]){m=
!0;break}if(m)continue;r=r.slice(0).sort(l);u=r.slice(1);1===u.length&&(u=u[0]);for(f=0;f<this._index[r[0]].list.length;f++)if(m=this._index[r[0]].list[f],(this._key?!e[m[this._key]]:-1===g.indexOf(m))&&m.tags.has(u))this._key&&(e[m[this._key]]=!0),g.push(m);continue}}if(r&&"string"===typeof r&&this._index[r])for(f=0;f<this._index[r].list.length;f++)m=this._index[r].list[f],this._key?e[m[this._key]]||(e[m[this._key]]=!0,g.push(m)):-1===g.indexOf(m)&&g.push(m)}return g}};var a=function(a){this._index=
{};this._list=[];this._parent=a;pc.events.attach(this)};a.prototype={add:function(){var a=!1,d=this._processArguments(arguments,!0);if(!d.length)return a;for(var e=0;e<d.length;e++)this._index[d[e]]||(a=!0,this._index[d[e]]=!0,this._list.push(d[e]),this.fire("add",d[e],this._parent));a&&this.fire("change",this._parent);return a},remove:function(){var a=!1;if(!this._list.length)return a;var d=this._processArguments(arguments,!0);if(!d.length)return a;for(var e=0;e<d.length;e++)this._index[d[e]]&&(a=
!0,delete this._index[d[e]],this._list.splice(this._list.indexOf(d[e]),1),this.fire("remove",d[e],this._parent));a&&this.fire("change",this._parent);return a},clear:function(){if(this._list.length){var a=this._list.slice(0);this._list=[];this._index={};for(var d=0;d<a.length;d++)this.fire("remove",a[d],this._parent);this.fire("change",this._parent)}},has:function(){if(!this._list.length)return!1;var a=this._processArguments(arguments);if(!a.length)return!1;for(var d=0;d<a.length;d++)if(1===a[d].length){if(this._index[a[d][0]])return!0}else{for(var e=
!0,g=0;g<a[d].length;g++)if(!this._index[a[d][g]]){e=!1;break}if(e)return!0}return!1},list:function(){return this._list.slice(0)},_processArguments:function(a,d){var e=[],g=[];if(!a||!a.length)return e;for(var h=0;h<a.length;h++)if(a[h]instanceof Array){d||(g=[]);for(var f=0;f<a[h].length;f++)"string"===typeof a[h][f]&&(d?e.push(a[h][f]):g.push(a[h][f]));!d&&g.length&&e.push(g)}else"string"===typeof a[h]&&(d?e.push(a[h]):e.push([a[h]]));return e}};Object.defineProperty(a.prototype,"size",{get:function(){return this._list.length}});
return{TagsCache:f,Tags:a}}());pc.dom=function(){return{getWidth:function(f){return f.offsetWidth},getHeight:function(f){return f.offsetHeight},setText:function(f,a){f.textContent?f.textContent=a:f.innerText&&(f.innerText=a)},getText:function(f){return f.textContent||f.innerText}}}();pc.extend(pc,function(){var f=function(a,d){this.objects=[];this.ctor=a;this.name=d.name;this.useNew=void 0===d.useNew||d.useNew;if(this.metrics=d.metrics)this.used=this.total=0};f.prototype={_construct:function(a,d){function e(){return a.apply(this,d)}e.prototype=a.prototype;return new e},allocate:function(){var a;this.objects.length?(a=this.objects.pop(),this.ctor.apply(a,arguments),this.metrics&&this.used++):(a=this.useNew?this._construct(this.ctor,arguments):this.ctor.apply(this,arguments),this.metrics&&
(this.total++,this.used++));return a},free:function(a){this.objects.push(a);this.metrics&&this.used--;if(a.onFree)a.onFree()},usage:function(){return pc.string.format("{0} - total: {1}, used: {2}",this.name,this.total,this.used)}};var a=function(a,d){this._constructor=a;this._pool=[];this._count=0;this._resize(d)};a.prototype={_resize:function(a){if(a>this._pool.length)for(var d=this._pool.length;d<a;d++)this._pool[d]=new this._constructor},allocate:function(){this._count>=this._pool.length&&this._resize(2*
this._pool.length);return this._pool[this._count++]},freeAll:function(){this._count=0}};return{AllocatePool:a,ObjectPool:f}}());pc.math={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,INV_LOG2:1/Math.log(2),clamp:function(f,a,b){return f>=b?b:f<=a?a:f},intToBytes24:function(f){return[f>>16&255,f>>8&255,f&255]},intToBytes32:function(f){return[f>>24&255,f>>16&255,f>>8&255,f&255]},bytesToInt24:function(f,a,b){f.length&&(b=f[2],a=f[1],f=f[0]);return f<<16|a<<8|b},bytesToInt32:function(f,a,b,d){f.length&&(d=f[3],b=f[2],a=f[1],f=f[0]);return(f<<24|a<<16|b<<8|d)>>>32},lerp:function(f,a,b){return f+(a-f)*pc.math.clamp(b,0,1)},lerpAngle:function(f,
a,b){180<a-f&&(a-=360);-180>a-f&&(a+=360);return pc.math.lerp(f,a,pc.math.clamp(b,0,1))},powerOfTwo:function(f){return 0!==f&&!(f&f-1)},nextPowerOfTwo:function(f){f--;f|=f>>1;f|=f>>2;f|=f>>4;f|=f>>8;f|=f>>16;f++;return f},random:function(f,a){return Math.random()*(a-f)+f},smoothstep:function(f,a,b){if(b<=f)return 0;if(b>=a)return 1;b=(b-f)/(a-f);return b*b*(3-2*b)},smootherstep:function(f,a,b){if(b<=f)return 0;if(b>=a)return 1;b=(b-f)/(a-f);return b*b*b*(b*(6*b-15)+10)}};pc.math.intToBytes=pc.math.intToBytes32;
pc.math.bytesToInt=pc.math.bytesToInt32;Math.log2||(Math.log2=function(f){return Math.log(f)*pc.math.INV_LOG2});pc.extend(pc,function(){var f=function(){this.data=new Float32Array(2);2===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0)};f.prototype={add:function(a){var b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];return this},add2:function(a,b){var d=a.data,e=b.data,g=this.data;g[0]=d[0]+e[0];g[1]=d[1]+e[1];return this},clone:function(){return(new f).copy(this)},copy:function(a){var b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];return this},dot:function(a){var b=this.data,a=a.data;return b[0]*
a[0]+b[1]*a[1]},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]},lerp:function(a,b,d){var a=a.data,b=b.data,e=this.data;e[0]=a[0]+d*(b[0]-a[0]);e[1]=a[1]+d*(b[1]-a[1]);return this},mul:function(a){var b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];return this},mul2:function(a,b){var d=a.data,e=b.data,g=this.data;g[0]=d[0]*e[0];g[1]=d[1]*e[1];
return this},normalize:function(){return this.scale(1/this.length())},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;return this},set:function(a,b){var d=this.data;d[0]=a;d[1]=b;return this},sub:function(a){var b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];return this},sub2:function(a,b){var d=a.data,e=b.data,g=this.data;g[0]=d[0]-e[0];g[1]=d[1]-e[1];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+"]"}};Object.defineProperty(f.prototype,"x",{get:function(){return this.data[0]},
set:function(a){this.data[0]=a}});Object.defineProperty(f.prototype,"y",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(f,"ONE",{get:function(){var a=new f(1,1);return function(){return a}}()});Object.defineProperty(f,"RIGHT",{get:function(){var a=new f(1,0);return function(){return a}}()});Object.defineProperty(f,"UP",{get:function(){var a=new f(0,1);return function(){return a}}()});Object.defineProperty(f,"ZERO",{get:function(){var a=new f(0,0);return function(){return a}}()});
return{Vec2:f}}());pc.extend(pc,function(){var f=function(){this.data=new Float32Array(3);3===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0,this.data[2]=0)};f.prototype={add:function(a){var b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];b[2]+=a[2];return this},add2:function(a,b){var d=a.data,e=b.data,g=this.data;g[0]=d[0]+e[0];g[1]=d[1]+e[1];g[2]=d[2]+e[2];return this},clone:function(){return(new f).copy(this)},copy:function(a){var b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];return this},
cross:function(a,b){var d,e,g,h,f,m,r;d=a.data;e=b.data;g=this.data;h=d[0];f=d[1];d=d[2];m=e[0];r=e[1];e=e[2];g[0]=f*e-r*d;g[1]=d*m-e*h;g[2]=h*r-m*f;return this},dot:function(a){var b=this.data,a=a.data;return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]},lerp:function(a,
b,d){var a=a.data,b=b.data,e=this.data;e[0]=a[0]+d*(b[0]-a[0]);e[1]=a[1]+d*(b[1]-a[1]);e[2]=a[2]+d*(b[2]-a[2]);return this},mul:function(a){var b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];b[2]*=a[2];return this},mul2:function(a,b){var d=a.data,e=b.data,g=this.data;g[0]=d[0]*e[0];g[1]=d[1]*e[1];g[2]=d[2]*e[2];return this},normalize:function(){return this.scale(1/this.length())},project:function(a){var b=this.data,a=a.data,d=(b[0]*a[0]+b[1]*a[1]+b[2]*a[2])/(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);b[0]=a[0]*d;
b[1]=a[1]*d;b[2]=a[2]*d;return this},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;b[2]*=a;return this},set:function(a,b,d){var e=this.data;e[0]=a;e[1]=b;e[2]=d;return this},sub:function(a){var b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];b[2]-=a[2];return this},sub2:function(a,b){var d=a.data,e=b.data,g=this.data;g[0]=d[0]-e[0];g[1]=d[1]-e[1];g[2]=d[2]-e[2];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+", "+this.data[2]+"]"}};Object.defineProperty(f.prototype,"x",{get:function(){return this.data[0]},
set:function(a){this.data[0]=a}});Object.defineProperty(f.prototype,"y",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(f.prototype,"z",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(f,"BACK",{get:function(){var a=new f(0,0,1);return function(){return a}}()});Object.defineProperty(f,"DOWN",{get:function(){var a=new f(0,-1,0);return function(){return a}}()});Object.defineProperty(f,"FORWARD",{get:function(){var a=
new f(0,0,-1);return function(){return a}}()});Object.defineProperty(f,"LEFT",{get:function(){var a=new f(-1,0,0);return function(){return a}}()});Object.defineProperty(f,"ONE",{get:function(){var a=new f(1,1,1);return function(){return a}}()});Object.defineProperty(f,"RIGHT",{get:function(){var a=new f(1,0,0);return function(){return a}}()});Object.defineProperty(f,"UP",{get:function(){var a=new f(0,1,0);return function(){return a}}()});Object.defineProperty(f,"ZERO",{get:function(){var a=new f(0,
0,0);return function(){return a}}()});return{Vec3:f}}());pc.extend(pc,function(){var f=function(){this.data=new Float32Array(4);4===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0,this.data[2]=0,this.data[3]=0)};f.prototype={add:function(a){var b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];b[2]+=a[2];b[3]+=a[3];return this},add2:function(a,b){var d=a.data,e=b.data,g=this.data;g[0]=d[0]+e[0];g[1]=d[1]+e[1];g[2]=d[2]+e[2];g[3]=d[3]+e[3];return this},clone:function(){return(new f).copy(this)},copy:function(a){var b=this.data,a=a.data;
b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return this},dot:function(a){var b=this.data,a=a.data;return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]+b[3]*a[3]},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]},lerp:function(a,b,d){var a=a.data,b=b.data,e=this.data;e[0]=a[0]+d*(b[0]-a[0]);
e[1]=a[1]+d*(b[1]-a[1]);e[2]=a[2]+d*(b[2]-a[2]);e[3]=a[3]+d*(b[3]-a[3]);return this},mul:function(a){var b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];b[2]*=a[2];b[3]*=a[3];return this},mul2:function(a,b){var d=a.data,e=b.data,g=this.data;g[0]=d[0]*e[0];g[1]=d[1]*e[1];g[2]=d[2]*e[2];g[3]=d[3]*e[3];return this},normalize:function(){return this.scale(1/this.length())},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;b[2]*=a;b[3]*=a;return this},set:function(a,b,d,e){var g=this.data;g[0]=a;g[1]=b;g[2]=
d;g[3]=e;return this},sub:function(a){var b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];b[2]-=a[2];b[3]-=a[3];return this},sub2:function(a,b){var d=a.data,e=b.data,g=this.data;g[0]=d[0]-e[0];g[1]=d[1]-e[1];g[2]=d[2]-e[2];g[3]=d[3]-e[3];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+", "+this.data[2]+", "+this.data[3]+"]"}};Object.defineProperty(f.prototype,"x",{get:function(){return this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(f.prototype,"y",{get:function(){return this.data[1]},
set:function(a){this.data[1]=a}});Object.defineProperty(f.prototype,"z",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(f.prototype,"w",{get:function(){return this.data[3]},set:function(a){this.data[3]=a}});Object.defineProperty(f,"ONE",{get:function(){var a=new f(1,1,1,1);return function(){return a}}()});Object.defineProperty(f,"ZERO",{get:function(){var a=new f(0,0,0,0);return function(){return a}}()});return{Vec4:f}}());pc.extend(pc,function(){var f=function(){this.data=new Float32Array(9);9===arguments.length?this.data.set(arguments):this.setIdentity()};f.prototype={clone:function(){return(new pc.Mat3).copy(this)},copy:function(a){var a=a.data,b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return this},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===
a[8]},isIdentity:function(){var a=this.data;return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&1===a[4]&&0===a[5]&&0===a[6]&&0===a[7]&&1===a[8]},setIdentity:function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return this},toString:function(){for(var a="[",b=0;9>b;b++)a+=this.data[b],a+=9!==b?", ":"";return a+"]"},transpose:function(){var a=this.data,b;b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];a[6]=b;b=a[5];a[5]=a[7];a[7]=b;return this}};Object.defineProperty(f,"IDENTITY",
{get:function(){var a=new f;return function(){return a}}()});Object.defineProperty(f,"ZERO",{get:function(){var a=new f(0,0,0,0,0,0,0,0,0);return function(){return a}}()});return{Mat3:f}}());pc.extend(pc,function(){var f=function(){this.data=new Float32Array(16);16===arguments.length?this.data.set(arguments):this.setIdentity()},a,b,d;a=new pc.Vec3;b=new pc.Vec3;d=new pc.Vec3;var e,g,h;e=new pc.Vec3;g=new pc.Vec3;h=new pc.Vec3;var k=new pc.Vec3;f.prototype={add2:function(a,b){var d=a.data,e=b.data,g=this.data;g[0]=d[0]+e[0];g[1]=d[1]+e[1];g[2]=d[2]+e[2];g[3]=d[3]+e[3];g[4]=d[4]+e[4];g[5]=d[5]+e[5];g[6]=d[6]+e[6];g[7]=d[7]+e[7];g[8]=d[8]+e[8];g[9]=d[9]+e[9];g[10]=d[10]+e[10];g[11]=d[11]+
e[11];g[12]=d[12]+e[12];g[13]=d[13]+e[13];g[14]=d[14]+e[14];g[15]=d[15]+e[15];return this},add:function(a){return this.add2(this,a)},clone:function(){return(new pc.Mat4).copy(this)},copy:function(a){var a=a.data,b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return this},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===
a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===a[8]&&b[9]===a[9]&&b[10]===a[10]&&b[11]===a[11]&&b[12]===a[12]&&b[13]===a[13]&&b[14]===a[14]&&b[15]===a[15]},isIdentity:function(){var a=this.data;return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},mul2:function(a,b){var d,e,g,h,f,k,y,x,A,D,C,z,E,F,N,J,M,O,K,H;J=a.data;var L=b.data,S=this.data;d=J[0];e=J[1];g=J[2];
h=J[3];f=J[4];k=J[5];y=J[6];x=J[7];A=J[8];D=J[9];C=J[10];z=J[11];E=J[12];F=J[13];N=J[14];J=J[15];M=L[0];O=L[1];K=L[2];H=L[3];S[0]=d*M+f*O+A*K+E*H;S[1]=e*M+k*O+D*K+F*H;S[2]=g*M+y*O+C*K+N*H;S[3]=h*M+x*O+z*K+J*H;M=L[4];O=L[5];K=L[6];H=L[7];S[4]=d*M+f*O+A*K+E*H;S[5]=e*M+k*O+D*K+F*H;S[6]=g*M+y*O+C*K+N*H;S[7]=h*M+x*O+z*K+J*H;M=L[8];O=L[9];K=L[10];H=L[11];S[8]=d*M+f*O+A*K+E*H;S[9]=e*M+k*O+D*K+F*H;S[10]=g*M+y*O+C*K+N*H;S[11]=h*M+x*O+z*K+J*H;M=L[12];O=L[13];K=L[14];H=L[15];S[12]=d*M+f*O+A*K+E*H;S[13]=e*M+
k*O+D*K+F*H;S[14]=g*M+y*O+C*K+N*H;S[15]=h*M+x*O+z*K+J*H;return this},mul:function(a){return this.mul2(this,a)},transformPoint:function(a,b){var d=this.data,e=a.data,b=void 0===b?new pc.Vec3:b;return b.set(e[0]*d[0]+e[1]*d[4]+e[2]*d[8]+d[12],e[0]*d[1]+e[1]*d[5]+e[2]*d[9]+d[13],e[0]*d[2]+e[1]*d[6]+e[2]*d[10]+d[14])},transformVector:function(a,b){var d=this.data,e=a.data,b=void 0===b?new pc.Vec3:b;return b.set(e[0]*d[0]+e[1]*d[4]+e[2]*d[8],e[0]*d[1]+e[1]*d[5]+e[2]*d[9],e[0]*d[2]+e[1]*d[6]+e[2]*d[10])},
setLookAt:function(e,g,h){d.sub2(e,g).normalize();b.copy(h).normalize();a.cross(b,d).normalize();b.cross(d,a);g=this.data;g[0]=a.x;g[1]=a.y;g[2]=a.z;g[3]=0;g[4]=b.x;g[5]=b.y;g[6]=b.z;g[7]=0;g[8]=d.x;g[9]=d.y;g[10]=d.z;g[11]=0;g[12]=e.x;g[13]=e.y;g[14]=e.z;g[15]=1;return this},setFrustum:function(a,b,d,e,g,h){var f,k,y,x,A;f=2*g;k=b-a;y=e-d;x=h-g;A=this.data;A[0]=f/k;A[1]=0;A[2]=0;A[3]=0;A[4]=0;A[5]=f/y;A[6]=0;A[7]=0;A[8]=(b+a)/k;A[9]=(e+d)/y;A[10]=(-h-g)/x;A[11]=-1;A[12]=0;A[13]=0;A[14]=-f*h/x;A[15]=
0;return this},setPerspective:function(a,b,d,e,g){g?(a=d*Math.tan(a*Math.PI/360),g=a/b):(g=d*Math.tan(a*Math.PI/360),a=g*b);return this.setFrustum(-a,a,-g,g,d,e)},setOrtho:function(a,b,d,e,g,h){var f=this.data;f[0]=2/(b-a);f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2/(e-d);f[6]=0;f[7]=0;f[8]=0;f[9]=0;f[10]=-2/(h-g);f[11]=0;f[12]=-(b+a)/(b-a);f[13]=-(e+d)/(e-d);f[14]=-(h+g)/(h-g);f[15]=1;return this},setFromAxisAngle:function(a,b){var d,e,g,h,f,k,y,x,A,b=b*pc.math.DEG_TO_RAD;d=a.x;e=a.y;g=a.z;h=Math.cos(b);
f=Math.sin(b);k=1-h;y=k*d;x=k*e;A=this.data;A[0]=y*d+h;A[1]=y*e+f*g;A[2]=y*g-f*e;A[3]=0;A[4]=y*e-f*g;A[5]=x*e+h;A[6]=x*g+f*d;A[7]=0;A[8]=y*g+f*e;A[9]=x*g-d*f;A[10]=k*g*g+h;A[11]=0;A[12]=0;A[13]=0;A[14]=0;A[15]=1;return this},setTranslate:function(a,b,d){var e=this.data;e[0]=1;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=1;e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=1;e[11]=0;e[12]=a;e[13]=b;e[14]=d;e[15]=1;return this},setScale:function(a,b,d){var e=this.data;e[0]=a;e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=b;e[6]=0;e[7]=0;e[8]=
0;e[9]=0;e[10]=d;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return this},invert:function(){var a,b,d,e,g,h,f,k,y,x,A,D,C,z,E,F,N,J,M,O,K,H,L,S,$,I,Q,Y,G,W;W=this.data;a=W[0];b=W[1];d=W[2];e=W[3];g=W[4];h=W[5];f=W[6];k=W[7];y=W[8];x=W[9];A=W[10];D=W[11];C=W[12];z=W[13];E=W[14];F=W[15];N=a*h-b*g;J=a*f-d*g;M=a*k-e*g;O=b*f-d*h;K=b*k-e*h;H=d*k-e*f;L=y*z-x*C;S=y*E-A*C;$=y*F-D*C;I=x*E-A*z;Q=x*F-D*z;Y=A*F-D*E;G=1/(N*Y-J*Q+M*I+O*$-K*S+H*L);W[0]=(h*Y-f*Q+k*I)*G;W[1]=(-b*Y+d*Q-e*I)*G;W[2]=(z*H-E*K+F*O)*G;W[3]=
(-x*H+A*K-D*O)*G;W[4]=(-g*Y+f*$-k*S)*G;W[5]=(a*Y-d*$+e*S)*G;W[6]=(-C*H+E*M-F*J)*G;W[7]=(y*H-A*M+D*J)*G;W[8]=(g*Q-h*$+k*L)*G;W[9]=(-a*Q+b*$-e*L)*G;W[10]=(C*K-z*M+F*N)*G;W[11]=(-y*K+x*M-D*N)*G;W[12]=(-g*I+h*S-f*L)*G;W[13]=(a*I-b*S+d*L)*G;W[14]=(-C*O+z*J-E*N)*G;W[15]=(y*O-x*J+A*N)*G;return this},setIdentity:function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return this},setTRS:function(a,b,d){var e,g,h,f,k,
y,x,A,D,C,z,E,F;e=a.x;g=a.y;a=a.z;h=b.x;f=b.y;k=b.z;y=b.w;b=d.x;x=d.y;d=d.z;A=h+h;D=f+f;C=k+k;z=h*A;E=h*D;h*=C;F=f*D;f*=C;k*=C;A*=y;D*=y;y*=C;C=this.data;C[0]=(1-(F+k))*b;C[1]=(E+y)*b;C[2]=(h-D)*b;C[3]=0;C[4]=(E-y)*x;C[5]=(1-(z+k))*x;C[6]=(f+A)*x;C[7]=0;C[8]=(h+D)*d;C[9]=(f-A)*d;C[10]=(1-(z+F))*d;C[11]=0;C[12]=e;C[13]=g;C[14]=a;C[15]=1;return this},transpose:function(){var a,b=this.data;a=b[1];b[1]=b[4];b[4]=a;a=b[2];b[2]=b[8];b[8]=a;a=b[3];b[3]=b[12];b[12]=a;a=b[6];b[6]=b[9];b[9]=a;a=b[7];b[7]=b[13];
b[13]=a;a=b[11];b[11]=b[14];b[14]=a;return this},invertTo3x3:function(a){var b,d,e,g,h,f,k,y,x,A;x=this.data;A=a.data;a=x[10]*x[5]-x[6]*x[9];b=-x[10]*x[1]+x[2]*x[9];d=x[6]*x[1]-x[2]*x[5];e=-x[10]*x[4]+x[6]*x[8];g=x[10]*x[0]-x[2]*x[8];h=-x[6]*x[0]+x[2]*x[4];f=x[9]*x[4]-x[5]*x[8];k=-x[9]*x[0]+x[1]*x[8];y=x[5]*x[0]-x[1]*x[4];x=x[0]*a+x[1]*e+x[2]*f;if(0===x)return console.warn("pc.Mat4#invertTo3x3: Matrix not invertible"),this;x=1/x;A[0]=x*a;A[1]=x*b;A[2]=x*d;A[3]=x*e;A[4]=x*g;A[5]=x*h;A[6]=x*f;A[7]=
x*k;A[8]=x*y;return this},getTranslation:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[12],this.data[13],this.data[14])},getX:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[0],this.data[1],this.data[2])},getY:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[4],this.data[5],this.data[6])},getZ:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[8],this.data[9],this.data[10])},getScale:function(a){a=void 0===a?new pc.Vec3:a;this.getX(e);this.getY(g);
this.getZ(h);a.set(e.length(),g.length(),h.length());return a},setFromEulerAngles:function(a,b,d){var e,g,h,f,a=a*pc.math.DEG_TO_RAD,b=b*pc.math.DEG_TO_RAD,d=d*pc.math.DEG_TO_RAD;e=Math.sin(-a);a=Math.cos(-a);g=Math.sin(-b);b=Math.cos(-b);h=Math.sin(-d);d=Math.cos(-d);f=this.data;f[0]=b*d;f[1]=-b*h;f[2]=g;f[3]=0;f[4]=a*h+d*e*g;f[5]=a*d-e*g*h;f[6]=-b*e;f[7]=0;f[8]=e*h-a*d*g;f[9]=d*e+a*g*h;f[10]=a*b;f[11]=0;f[12]=0;f[13]=0;f[14]=0;f[15]=1;return this},getEulerAngles:function(a){var b,d,e,g,h,f,a=void 0===
a?new pc.Vec3:a;this.getScale(k);e=k.x;b=k.y;g=k.z;h=this.data;d=Math.asin(-h[2]/e);f=0.5*Math.PI;d<f?d>-f?(b=Math.atan2(h[6]/b,h[10]/g),e=Math.atan2(h[1]/e,h[0]/e)):(e=0,b=-Math.atan2(h[4]/b,h[5]/b)):(e=0,b=Math.atan2(h[4]/b,h[5]/b));return a.set(b,d,e).scale(pc.math.RAD_TO_DEG)},toString:function(){var a,b;b="[";for(a=0;16>a;a+=1)b+=this.data[a],b+=15!==a?", ":"";return b+"]"}};Object.defineProperty(f,"IDENTITY",{get:function(){var a=new f;return function(){return a}}()});Object.defineProperty(f,
"ZERO",{get:function(){var a=new f(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return function(){return a}}()});return{Mat4:f}}());pc.extend(pc,function(){var f=function(a,b,d,e){this.x=void 0===a?0:a;this.y=void 0===b?0:b;this.z=void 0===d?0:d;this.w=void 0===e?1:e};f.prototype={clone:function(){return new pc.Quat(this.x,this.y,this.z,this.w)},conjugate:function(){this.x*=-1;this.y*=-1;this.z*=-1;return this},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w;return this},equals:function(a){return this.x===a.x&&this.y===a.y&&this.z===a.z&&this.w===a.w},getEulerAngles:function(a){var b,d,e,g,h,f,a=void 0===a?new pc.Vec3:
a;e=this.x;g=this.y;h=this.z;f=this.w;d=2*(f*g-e*h);-0.99999>=d?(b=2*Math.atan2(e,f),d=-Math.PI/2,e=0):0.99999<=d?(b=2*Math.atan2(e,f),d=Math.PI/2,e=0):(b=Math.atan2(2*(f*e+g*h),1-2*(e*e+g*g)),d=Math.asin(d),e=Math.atan2(2*(f*h+e*g),1-2*(g*g+h*h)));return a.set(b,d,e).scale(pc.math.RAD_TO_DEG)},invert:function(){return this.conjugate().normalize()},length:function(){var a,b,d,e;a=this.x;b=this.y;d=this.z;e=this.w;return Math.sqrt(a*a+b*b+d*d+e*e)},lengthSq:function(){var a=this.data;return a[0]*a[0]+
a[1]*a[1]+a[2]*a[2]},mul:function(a){var b,d,e,g,h,f,m;b=this.x;d=this.y;e=this.z;g=this.w;h=a.x;f=a.y;m=a.z;a=a.w;this.x=g*h+b*a+d*m-e*f;this.y=g*f+d*a+e*h-b*m;this.z=g*m+e*a+b*f-d*h;this.w=g*a-b*h-d*f-e*m;return this},mul2:function(a,b){var d,e,g,h,f,m,r,u;d=a.x;e=a.y;g=a.z;h=a.w;f=b.x;m=b.y;r=b.z;u=b.w;this.x=h*f+d*u+e*r-g*m;this.y=h*m+e*u+g*f-d*r;this.z=h*r+g*u+d*m-e*f;this.w=h*u-d*f-e*m-g*r;return this},normalize:function(){var a=this.length();0===a?(this.x=this.y=this.z=0,this.w=1):(a=1/a,this.x*=
a,this.y*=a,this.z*=a,this.w*=a);return this},set:function(a,b,d,e){this.x=a;this.y=b;this.z=d;this.w=e;return this},setFromAxisAngle:function(a,b){var d,e,b=b*0.5*pc.math.DEG_TO_RAD;d=Math.sin(b);e=Math.cos(b);this.x=d*a.x;this.y=d*a.y;this.z=d*a.z;this.w=e;return this},setFromEulerAngles:function(a,b,d){var e,g,h;e=0.5*pc.math.DEG_TO_RAD;a*=e;b*=e;d*=e;e=Math.sin(a);a=Math.cos(a);g=Math.sin(b);b=Math.cos(b);h=Math.sin(d);d=Math.cos(d);this.x=e*b*d-a*g*h;this.y=a*g*d+e*b*h;this.z=a*b*h-e*g*d;this.w=
a*b*d+e*g*h;return this},setFromMat4:function(a){var b,d,e,g,h,f,m,r,u,l,n,a=a.data;b=a[0];d=a[1];e=a[2];g=a[4];h=a[5];f=a[6];m=a[8];r=a[9];a=a[10];u=1/Math.sqrt(b*b+d*d+e*e);l=1/Math.sqrt(g*g+h*h+f*f);n=1/Math.sqrt(m*m+r*r+a*a);b*=u;d*=u;e*=u;g*=l;h*=l;f*=l;m*=n;r*=n;a*=n;u=b+h+a;0<=u?(b=Math.sqrt(u+1),this.w=0.5*b,b=0.5/b,this.x=(f-r)*b,this.y=(m-e)*b,this.z=(d-g)*b):b>h?b>a?(b=Math.sqrt(b-(h+a)+1),this.x=0.5*b,b=0.5/b,this.w=(f-r)*b,this.y=(d+g)*b,this.z=(e+m)*b):(b=Math.sqrt(a-(b+h)+1),this.z=
0.5*b,b=0.5/b,this.w=(d-g)*b,this.x=(m+e)*b,this.y=(r+f)*b):h>a?(b=Math.sqrt(h-(a+b)+1),this.y=0.5*b,b=0.5/b,this.w=(m-e)*b,this.z=(f+r)*b,this.x=(g+d)*b):(b=Math.sqrt(a-(b+h)+1),this.z=0.5*b,b=0.5/b,this.w=(d-g)*b,this.x=(m+e)*b,this.y=(r+f)*b);return this},slerp:function(a,b,d){var e,g,h,f,m,r;e=a.x;g=a.y;h=a.z;a=a.w;f=b.x;m=b.y;r=b.z;var b=b.w,u=a*b+e*f+g*m+h*r;0>u&&(b=-b,f=-f,m=-m,r=-r,u=-u);if(1<=Math.abs(u))return this.w=a,this.x=e,this.y=g,this.z=h,this;var l=Math.acos(u),n=Math.sqrt(1-u*u);
if(0.001>Math.abs(n))return this.w=0.5*a+0.5*b,this.x=0.5*e+0.5*f,this.y=0.5*g+0.5*m,this.z=0.5*h+0.5*r,this;u=Math.sin((1-d)*l)/n;d=Math.sin(d*l)/n;this.w=a*u+b*d;this.x=e*u+f*d;this.y=g*u+m*d;this.z=h*u+r*d;return this},transformVector:function(a,b){void 0===b&&(b=new pc.Vec3);var d=a.x,e=a.y,g=a.z,h=this.x,f=this.y,m=this.z,r=this.w,u=r*d+f*g-m*e,l=r*e+m*d-h*g,n=r*g+h*e-f*d,d=-h*d-f*e-m*g;b.x=u*r+d*-h+l*-m-n*-f;b.y=l*r+d*-f+n*-h-u*-m;b.z=n*r+d*-m+u*-f-l*-h;return b},toString:function(){return"["+
this.x+", "+this.y+", "+this.z+", "+this.w+"]"}};Object.defineProperty(f,"IDENTITY",{get:function(){var a=new f;return function(){return a}}()});Object.defineProperty(f,"ZERO",{get:function(){var a=new f(0,0,0,0);return function(){return a}}()});return{Quat:f}}());pc.extend(pc,function(){var f=function(a){this.keys=[];this.type=1;this.tension=0.5;if(a)for(var b=0;b<a.length-1;b+=2)this.keys.push([a[b],a[b+1]]);this.sort()};f.prototype={add:function(a,b){for(var d=this.keys,e=d.length,g=0;g<e&&!(d[g][0]>a);g++);d=[a,b];this.keys.splice(g,0,d);return d},get:function(a){return this.keys[a]},sort:function(){this.keys.sort(function(a,b){return a[0]-b[0]})},value:function(a){var b=this.keys;if(!b.length)return 0;if(a<b[0][0])return b[0][1];if(a>b[b.length-1][0])return b[b.length-
1][1];for(var d=0,e=b.length?b[0][1]:0,g=1,h=0,f=0,m=b.length;f<m;f++){if(b[f][0]===a)return b[f][1];h=b[f][1];if(a<b[f][0]){g=b[f][0];break}d=b[f][0];e=b[f][1]}m=g-d;a=0===m?0:(a-d)/m;if(1===this.type)a*=a*(3-2*a);else if(2===this.type||3===this.type){var m=e+(e-h),r=h+(h-e),u=g=d=g-d;0<f&&(f-=1);0<f&&(m=b[f-1][1],g=b[f][0]-b[f-1][0]);b.length>f+1&&(d=b[f+1][0]-b[f][0]);b.length>f+2&&(u=b[f+2][0]-b[f+1][0],r=b[f+2][1]);m=e+(m-e)*d/g;r=h+(r-h)*d/u;return 2===this.type?this._interpolateCatmullRom(m,
e,h,r,a):this._interpolateCardinal(m,e,h,r,a,this.tension)}return pc.math.lerp(e,h,a)},_interpolateHermite:function(a,b,d,e,g){var h=g*g,f=g*g*g;return a*(2*f-3*h+1)+b*(-2*f+3*h)+d*(f-2*h+g)+e*(f-h)},_interpolateCardinal:function(a,b,d,e,g,h){return this._interpolateHermite(b,d,h*(d-a),h*(e-b),g)},_interpolateCatmullRom:function(a,b,d,e,g){return this._interpolateCardinal(a,b,d,e,g,0.5)},closest:function(a){for(var b=this.keys,d=b.length,e=2,g=null,h=0;h<d;h++){var f=Math.abs(a-b[h][0]);if(e>=f)e=
f,g=b[h];else break}return g},clone:function(){var a=new pc.Curve;a.keys=pc.extend(a.keys,this.keys);a.type=this.type;return a},quantize:function(a){for(var a=Math.max(a,2),b=new Float32Array(a),d=1/(a-1),e=0;e<a;e++){var g=this.value(d*e);b[e]=g}return b}};Object.defineProperty(f.prototype,"length",{get:function(){return this.keys.length}});return{Curve:f,CURVE_LINEAR:0,CURVE_SMOOTHSTEP:1,CURVE_CATMULL:2,CURVE_CARDINAL:3}}());pc.extend(pc,function(){var f=function(){var a;this.curves=[];this._type=pc.CURVE_SMOOTHSTEP;if(1<arguments.length)for(a=0;a<arguments.length;a++)this.curves.push(new pc.Curve(arguments[a]));else if(0===arguments.length)this.curves.push(new pc.Curve);else{var b=arguments[0];if("number"===pc.type(b))for(a=0;a<b;a++)this.curves.push(new pc.Curve);else for(a=0;a<b.length;a++)this.curves.push(new pc.Curve(b[a]))}};f.prototype={get:function(a){return this.curves[a]},value:function(a,b){var d=this.curves.length,
b=b||[];b.length=d;for(var e=0;e<d;e++)b[e]=this.curves[e].value(a);return b},clone:function(){var a=new pc.CurveSet;a.curves=[];for(var b=0;b<this.curves.length;b++)a.curves.push(this.curves[b].clone());a._type=this._type;return a},quantize:function(a){for(var a=Math.max(a,2),b=this.curves.length,d=new Float32Array(a*b),e=1/(a-1),g=[],h=0;h<a;h++){var f=this.value(e*h,g);if(1==b)d[h]=f[0];else for(var m=0;m<b;m++)d[h*b+m]=f[m]}return d}};Object.defineProperty(f.prototype,"length",{get:function(){return this.curves.length}});
Object.defineProperty(f.prototype,"type",{get:function(){return this._type},set:function(a){this._type=a;for(var b=0;b<this.curves.length;b++)this.curves[b].type=a}});return{CurveSet:f}}());pc.extend(pc,function(){var f=new pc.Vec3,a=new pc.Vec3,b=new pc.Vec3,d=new pc.Vec3,e=new pc.Vec3,g=new pc.Vec3,h=function(a,b){this.center=a||new pc.Vec3(0,0,0);this.halfExtents=b||new pc.Vec3(0.5,0.5,0.5);this._min=new pc.Vec3;this._max=new pc.Vec3};h.prototype={add:function(a){var b=this.center,d=this.halfExtents,e=b.x-d.x,g=b.x+d.x,h=b.y-d.y,f=b.y+d.y,s=b.z-d.z,B=b.z+d.z,y=a.center,x=a.halfExtents,a=y.x-x.x,A=y.x+x.x,D=y.y-x.y,C=y.y+x.y,z=y.z-x.z,y=y.z+x.z;a<e&&(e=a);A>g&&(g=A);D<h&&(h=D);C>f&&
(f=C);z<s&&(s=z);y>B&&(B=y);b.set(e+g,h+f,s+B).scale(0.5);d.set(g-e,f-h,B-s).scale(0.5)},copy:function(a){this.center.copy(a.center);this.halfExtents.copy(a.halfExtents);this.type=a.type},intersects:function(a){var b=this.getMax(),d=this.getMin(),e=a.getMax(),a=a.getMin();return d.x<=e.x&&b.x>=a.x&&d.y<=e.y&&b.y>=a.y&&d.z<=e.z&&b.z>=a.z},intersectsRay:function(h){var m=g.copy(h.direction).normalize();f.sub2(h.origin,aabb.center);d.set(Math.abs(f.x),Math.abs(f.y),Math.abs(f.z));b.mul2(f,m);if(d.x>
aabb.halfExtents.x&&0<=b.x||d.y>aabb.halfExtents.y&&0<=b.y||d.z>aabb.halfExtents.z&&0<=b.z)return!1;e.set(Math.abs(m.x),Math.abs(m.y),Math.abs(m.z));a.cross(m,f);a.set(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z));return a.x>aabb.halfExtents.y*e.z+aabb.halfExtents.z*e.y||a.y>aabb.halfExtents.x*e.z+aabb.halfExtents.z*e.x||a.z>aabb.halfExtents.x*e.y+aabb.halfExtents.y*e.x?!1:!0},setMinMax:function(a,b){this.center.add2(b,a).scale(0.5);this.halfExtents.sub2(b,a).scale(0.5)},getMin:function(){return this._min.copy(this.center).sub(this.halfExtents)},
getMax:function(){return this._max.copy(this.center).add(this.halfExtents)},containsPoint:function(a){var b=this.getMin(),d=this.getMax(),e;for(e=0;3>e;++e)if(a.data[e]<b.data[e]||a.data[e]>d.data[e])return!1;return!0},setFromTransformedAabb:function(a,b){var d=this.center,e=this.halfExtents,g=a.center.data,h=a.halfExtents.data,b=b.data,f=b[0],s=b[4],B=b[8],y=b[1],x=b[5],A=b[9],D=b[2],C=b[6],z=b[10],E=Math.abs(f),F=Math.abs(s),N=Math.abs(B),J=Math.abs(y),M=Math.abs(x),O=Math.abs(A),K=Math.abs(D),
H=Math.abs(C),L=Math.abs(z);d.set(b[12]+f*g[0]+s*g[1]+B*g[2],b[13]+y*g[0]+x*g[1]+A*g[2],b[14]+D*g[0]+C*g[1]+z*g[2]);e.set(E*h[0]+F*h[1]+N*h[2],J*h[0]+M*h[1]+O*h[2],K*h[0]+H*h[1]+L*h[2])},compute:function(b){for(var d=f.set(b[0],b[1],b[2]),e=a.set(b[0],b[1],b[2]),g=b.length/3,h=1;h<g;h++){var n=b[3*h+0],w=b[3*h+1],s=b[3*h+2];n<d.x&&(d.x=n);w<d.y&&(d.y=w);s<d.z&&(d.z=s);n>e.x&&(e.x=n);w>e.y&&(e.y=w);s>e.z&&(e.z=s)}this.setMinMax(d,e)}};return{BoundingBox:h}}());pc.extend(pc,function(){function f(a,b){this.center=a||new pc.Vec3(0,0,0);this.radius=void 0===b?0.5:b}var a=new pc.Vec3,b=new pc.Vec3,d=new pc.Vec3,e=new pc.Vec3;f.prototype={containsPoint:function(b){var b=a.sub2(b,this.center).lengthSq(),d=this.radius;return b<d*d},compute:function(g){var h,f=g.length/3;for(h=0;h<f;h++)a.set(g[3*h],g[3*h+1],g[3*h+2]),d.addSelf(a),0===h%100&&(d.scale(1/f),b.add(d),d.set(0,0,0));d.scale(1/f);b.add(d);this.center.copy(b);var m=0;for(h=0;h<f;h++)a.set(g[3*h],g[3*h+
1],g[3*h+2]),e.sub2(a,this.center),m=Math.max(e.lengthSq(),m);this.radius=Math.sqrt(m)},intersectRay:function(d){var e=a.copy(d.origin).sub(this.center),f=e.dot(b.copy(d.direction).normalize()),e=e.dot(e)-this.radius*this.radius;if(0<e&&0<f)return null;e=f*f-e;if(0>e)return null;t=Math.abs(-f-Math.sqrt(e));return d.direction.clone().scale(t).add(d.origin)}};return{BoundingSphere:f}}());pc.extend(pc,function(){var f=new pc.Mat4,a=function(a,d){a=a||(new pc.Mat4).setPerspective(90,16/9,0.1,1E3);d=d||new pc.Mat4;this.planes=[];for(var e=0;6>e;e++)this.planes[e]=[];this.update(a,d)};a.prototype={update:function(a,d){f.mul2(a,d);var e=f.data;this.planes[0][0]=e[3]-e[0];this.planes[0][1]=e[7]-e[4];this.planes[0][2]=e[11]-e[8];this.planes[0][3]=e[15]-e[12];t=Math.sqrt(this.planes[0][0]*this.planes[0][0]+this.planes[0][1]*this.planes[0][1]+this.planes[0][2]*this.planes[0][2]);this.planes[0][0]/=
t;this.planes[0][1]/=t;this.planes[0][2]/=t;this.planes[0][3]/=t;this.planes[1][0]=e[3]+e[0];this.planes[1][1]=e[7]+e[4];this.planes[1][2]=e[11]+e[8];this.planes[1][3]=e[15]+e[12];t=Math.sqrt(this.planes[1][0]*this.planes[1][0]+this.planes[1][1]*this.planes[1][1]+this.planes[1][2]*this.planes[1][2]);this.planes[1][0]/=t;this.planes[1][1]/=t;this.planes[1][2]/=t;this.planes[1][3]/=t;this.planes[2][0]=e[3]+e[1];this.planes[2][1]=e[7]+e[5];this.planes[2][2]=e[11]+e[9];this.planes[2][3]=e[15]+e[13];t=
Math.sqrt(this.planes[2][0]*this.planes[2][0]+this.planes[2][1]*this.planes[2][1]+this.planes[2][2]*this.planes[2][2]);this.planes[2][0]/=t;this.planes[2][1]/=t;this.planes[2][2]/=t;this.planes[2][3]/=t;this.planes[3][0]=e[3]-e[1];this.planes[3][1]=e[7]-e[5];this.planes[3][2]=e[11]-e[9];this.planes[3][3]=e[15]-e[13];t=Math.sqrt(this.planes[3][0]*this.planes[3][0]+this.planes[3][1]*this.planes[3][1]+this.planes[3][2]*this.planes[3][2]);this.planes[3][0]/=t;this.planes[3][1]/=t;this.planes[3][2]/=t;
this.planes[3][3]/=t;this.planes[4][0]=e[3]-e[2];this.planes[4][1]=e[7]-e[6];this.planes[4][2]=e[11]-e[10];this.planes[4][3]=e[15]-e[14];t=Math.sqrt(this.planes[4][0]*this.planes[4][0]+this.planes[4][1]*this.planes[4][1]+this.planes[4][2]*this.planes[4][2]);this.planes[4][0]/=t;this.planes[4][1]/=t;this.planes[4][2]/=t;this.planes[4][3]/=t;this.planes[5][0]=e[3]+e[2];this.planes[5][1]=e[7]+e[6];this.planes[5][2]=e[11]+e[10];this.planes[5][3]=e[15]+e[14];t=Math.sqrt(this.planes[5][0]*this.planes[5][0]+
this.planes[5][1]*this.planes[5][1]+this.planes[5][2]*this.planes[5][2]);this.planes[5][0]/=t;this.planes[5][1]/=t;this.planes[5][2]/=t;this.planes[5][3]/=t},containsPoint:function(a){for(var d=0;6>d;d++)if(0>=this.planes[d][0]*a.x+this.planes[d][1]*a.y+this.planes[d][2]*a.z+this.planes[d][3])return!1;return!0},containsSphere:function(a){var d=0,e;for(p=0;6>p;p++){e=this.planes[p][0]*a.center.x+this.planes[p][1]*a.center.y+this.planes[p][2]*a.center.z+this.planes[p][3];if(e<=-a.radius)return 0;e>
a.radius&&d++}return 6===d?2:1}};return{Frustum:a}}());pc.extend(pc,function(){var f=function(a,b){this.normal=b||new pc.Vec3(0,0,1);this.point=a||new pc.Vec3(0,0,0);this.d=-this.normal.dot(this.point)};f.prototype={distance:function(a){return this.normal.dot(a)+this.d},intersect:function(a,b){var d=this.distance(a),e=this.distance(b);return d/(d-e)},intersectPosition:function(a,b){var d=this.intersect(a,b),e=new pc.Vec3;e.lerp(a,b,d);return e}};return{Plane:f}}());pc.extend(pc,function(){return{Ray:function(f,a){this.origin=f||new pc.Vec3(0,0,0);this.direction=a||new pc.Vec3(0,0,-1)}}}());(function(){var f={ADDRESS_REPEAT:0,ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BLENDEQUATION_ADD:0,BLENDEQUATION_SUBTRACT:1,BLENDEQUATION_REVERSE_SUBTRACT:2,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,CLEARFLAG_COLOR:1,
CLEARFLAG_DEPTH:2,CLEARFLAG_STENCIL:4,CUBEFACE_POSX:0,CUBEFACE_NEGX:1,CUBEFACE_POSY:2,CUBEFACE_NEGY:3,CUBEFACE_POSZ:4,CUBEFACE_NEGZ:5,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,ELEMENTTYPE_INT8:0,ELEMENTTYPE_UINT8:1,ELEMENTTYPE_INT16:2,ELEMENTTYPE_UINT16:3,ELEMENTTYPE_INT32:4,ELEMENTTYPE_UINT32:5,ELEMENTTYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,
INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_A8:0,PIXELFORMAT_L8:1,PIXELFORMAT_L8_A8:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R5_G5_B5_A1:4,PIXELFORMAT_R4_G4_B4_A4:5,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PIXELFORMAT_DXT1:8,PIXELFORMAT_DXT3:9,PIXELFORMAT_DXT5:10,PIXELFORMAT_RGB16F:11,PIXELFORMAT_RGBA16F:12,PIXELFORMAT_RGB32F:13,PIXELFORMAT_RGBA32F:14,PIXELFORMAT_ETC1:15,PIXELFORMAT_PVRTC_2BPP_RGB_1:16,PIXELFORMAT_PVRTC_2BPP_RGBA_1:17,PIXELFORMAT_PVRTC_4BPP_RGB_1:18,
PIXELFORMAT_PVRTC_4BPP_RGBA_1:19,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_TANGENT:"TANGENT",SEMANTIC_BLENDWEIGHT:"BLENDWEIGHT",SEMANTIC_BLENDINDICES:"BLENDINDICES",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_TEXCOORD2:"TEXCOORD2",SEMANTIC_TEXCOORD3:"TEXCOORD3",SEMANTIC_TEXCOORD4:"TEXCOORD4",
SEMANTIC_TEXCOORD5:"TEXCOORD5",SEMANTIC_TEXCOORD6:"TEXCOORD6",SEMANTIC_TEXCOORD7:"TEXCOORD7",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",SEMANTIC_ATTR4:"ATTR4",SEMANTIC_ATTR5:"ATTR5",SEMANTIC_ATTR6:"ATTR6",SEMANTIC_ATTR7:"ATTR7",SEMANTIC_ATTR8:"ATTR8",SEMANTIC_ATTR9:"ATTR9",SEMANTIC_ATTR10:"ATTR10",SEMANTIC_ATTR11:"ATTR11",SEMANTIC_ATTR12:"ATTR12",SEMANTIC_ATTR13:"ATTR13",SEMANTIC_ATTR14:"ATTR14",SEMANTIC_ATTR15:"ATTR15",TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,
UNIFORMTYPE_BOOL:0,UNIFORMTYPE_INT:1,UNIFORMTYPE_FLOAT:2,UNIFORMTYPE_VEC2:3,UNIFORMTYPE_VEC3:4,UNIFORMTYPE_VEC4:5,UNIFORMTYPE_IVEC2:6,UNIFORMTYPE_IVEC3:7,UNIFORMTYPE_IVEC4:8,UNIFORMTYPE_BVEC2:9,UNIFORMTYPE_BVEC3:10,UNIFORMTYPE_BVEC4:11,UNIFORMTYPE_MAT2:12,UNIFORMTYPE_MAT3:13,UNIFORMTYPE_MAT4:14,UNIFORMTYPE_TEXTURE2D:15,UNIFORMTYPE_TEXTURECUBE:16,SHADERTAG_MATERIAL:1};pc.extend(pc,f);pc.gfx={};pc.extend(pc.gfx,f)})();pc.extend(pc,function(){var f=function(a){this.name=a;this.value=null;this.versionObject=new pc.VersionedObject};f.prototype={setValue:function(a){this.value=a;this.versionObject.increment()},getValue:function(){return this.value}};return{ScopeId:f}}());pc.extend(pc,function(){var f=function(a){this.name=a;this.variables={};this.namespaces={}};f.prototype={resolve:function(a){!1===this.variables.hasOwnProperty(a)&&(this.variables[a]=new pc.ScopeId(a));return this.variables[a]},getSubSpace:function(a){!1===this.namespaces.hasOwnProperty(a)&&(this.namespaces[a]=new pc.ScopeSpace(a),logDEBUG("Added ScopeSpace: "+a));return this.namespaces[a]}};return{ScopeSpace:f}}());pc.extend(pc,function(){var f=function(){this.revision=this.globalId=0};f.prototype={equals:function(a){return this.globalId===a.globalId&&this.revision===a.revision},notequals:function(a){return this.globalId!==a.globalId||this.revision!==a.revision},copy:function(a){this.globalId=a.globalId;this.revision=a.revision},reset:function(){this.revision=this.globalId=0}};return{Version:f}}());pc.extend(pc,function(){var f=0,a=function(){f++;this.version=new pc.Version;this.version.globalId=f};a.prototype={increment:function(){this.version.revision++}};return{VersionedObject:a}}());pc.extend(pc,function(){function f(g,f){this.index=0;switch(f.dataType){case pc.ELEMENTTYPE_INT8:this.array=new Int8Array(g,f.offset);break;case pc.ELEMENTTYPE_UINT8:this.array=new Uint8Array(g,f.offset);break;case pc.ELEMENTTYPE_INT16:this.array=new Int16Array(g,f.offset);break;case pc.ELEMENTTYPE_UINT16:this.array=new Uint16Array(g,f.offset);break;case pc.ELEMENTTYPE_INT32:this.array=new Int32Array(g,f.offset);break;case pc.ELEMENTTYPE_UINT32:this.array=new Uint32Array(g,f.offset);break;case pc.ELEMENTTYPE_FLOAT32:this.array=
new Float32Array(g,f.offset)}switch(f.numComponents){case 1:this.set=a;break;case 2:this.set=b;break;case 3:this.set=d;break;case 4:this.set=e}}function a(a){this.array[this.index]=a}function b(a,b){this.array[this.index]=a;this.array[this.index+1]=b}function d(a,b,d){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=d}function e(a,b,d,e){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=d;this.array[this.index+3]=e}function g(a){this.vertexBuffer=
a;this.buffer=this.vertexBuffer.lock();this.setters=[];this.element={};for(var a=this.vertexBuffer.getFormat(),b=0;b<a.elements.length;b++){var d=a.elements[b];this.setters[b]=new f(this.buffer,d);this.element[d.name]=this.setters[b]}}g.prototype={next:function(){for(var a=0,b=this.setters,d=this.setters.length,e=this.vertexBuffer.getFormat();a<d;){var g=b[a++];g.index+=e.size/g.array.constructor.BYTES_PER_ELEMENT}},end:function(){this.vertexBuffer.unlock()}};return{VertexIterator:g}}());pc.extend(pc,function(){var f=[];f[pc.ELEMENTTYPE_INT8]=1;f[pc.ELEMENTTYPE_UINT8]=1;f[pc.ELEMENTTYPE_INT16]=2;f[pc.ELEMENTTYPE_UINT16]=2;f[pc.ELEMENTTYPE_INT32]=4;f[pc.ELEMENTTYPE_UINT32]=4;f[pc.ELEMENTTYPE_FLOAT32]=4;return{VertexFormat:function(a,b){var d,e,g;this.elements=[];this.hasColor=this.hasUv1=this.hasUv0=!1;d=this.size=0;for(e=b.length;d<e;d++){var h=b[d];g={name:h.semantic,offset:0,stride:0,stream:-1,scopeId:a.scope.resolve(h.semantic),dataType:h.type,numComponents:h.components,normalize:void 0===
h.normalize?!1:h.normalize,size:h.components*f[h.type]};this.elements.push(g);this.size+=g.size;h.semantic===pc.SEMANTIC_TEXCOORD0?this.hasUv0=!0:h.semantic===pc.SEMANTIC_TEXCOORD1?this.hasUv1=!0:h.semantic===pc.SEMANTIC_COLOR&&(this.hasColor=!0)}d=h=0;for(e=this.elements.length;d<e;d++)g=this.elements[d],g.offset=h,g.stride=this.size,h+=g.size}}}());pc.extend(pc,function(){var f=function(a,b,d,e,g){this.usage=e||pc.BUFFER_STATIC;this.format=b;this.numVertices=d;this.numBytes=b.size*d;a._vram.vb+=this.numBytes;this.device=a;this.bufferId=this.device.gl.createBuffer();if(!g||!this.setData(g))this.storage=new ArrayBuffer(this.numBytes)};f.prototype={destroy:function(){this.device.gl.deleteBuffer(this.bufferId);this.device._vram.vb-=this.storage.byteLength},getFormat:function(){return this.format},getUsage:function(){return this.usage},getNumVertices:function(){return this.numVertices},
lock:function(){return this.storage},unlock:function(){var a=this.device.gl,b;switch(this.usage){case pc.BUFFER_STATIC:b=a.STATIC_DRAW;break;case pc.BUFFER_DYNAMIC:b=a.DYNAMIC_DRAW;break;case pc.BUFFER_STREAM:b=a.STREAM_DRAW}a.bindBuffer(a.ARRAY_BUFFER,this.bufferId);a.bufferData(a.ARRAY_BUFFER,this.storage,b)},setData:function(a){if(a.byteLength!==this.numBytes)return console.error("VertexBuffer: wrong initial data size: expected "+this.numBytes+", got "+a.byteLength),!1;this.storage=a;this.unlock();
return!0}};return{VertexBuffer:f}}());pc.extend(pc,function(){var f=function(a,b,d,e){this.usage=e||pc.BUFFER_STATIC;this.format=b;this.numIndices=d;this.device=a;d=this.device.gl;this.bufferId=d.createBuffer();var g;b===pc.INDEXFORMAT_UINT8?(g=1,this.glFormat=d.UNSIGNED_BYTE):b===pc.INDEXFORMAT_UINT16?(g=2,this.glFormat=d.UNSIGNED_SHORT):b===pc.INDEXFORMAT_UINT32&&(g=4,this.glFormat=d.UNSIGNED_INT);this.bytesPerIndex=g;b=this.numIndices*g;this.storage=new ArrayBuffer(b);a._vram.ib+=b};f.prototype={destroy:function(){this.device.gl.deleteBuffer(this.bufferId);
this.device._vram.ib-=this.storage.byteLength},getFormat:function(){return this.format},getNumIndices:function(){return this.numIndices},lock:function(){return this.storage},unlock:function(){var a=this.device.gl,b;switch(this.usage){case pc.BUFFER_STATIC:b=a.STATIC_DRAW;break;case pc.BUFFER_DYNAMIC:b=a.DYNAMIC_DRAW;break;case pc.BUFFER_STREAM:b=a.STREAM_DRAW}a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.bufferId);a.bufferData(a.ELEMENT_ARRAY_BUFFER,this.storage,b)}};return{IndexBuffer:f}}());pc.extend(pc,function(){var f=function(a,b){this.device=a;var d=4,e=4,g=pc.PIXELFORMAT_R8_G8_B8_A8,f=!1,k=!0,m=!1,r=!1;void 0!==b&&(d=void 0!==b.width?b.width:d,e=void 0!==b.height?b.height:e,g=void 0!==b.format?b.format:g,f=void 0!==b.cubemap?b.cubemap:f,k=void 0!==b.autoMipmap?b.autoMipmap:k,m=void 0!==b.rgbm?b.rgbm:m,r=void 0!==b.fixCubemapSeams?b.fixCubemapSeams:r);this.name=null;this.autoMipmap=k;this.rgbm=m;this.fixCubemapSeams=r;this._cubemap=f;this._format=g;this._compressed=g===pc.PIXELFORMAT_DXT1||
g===pc.PIXELFORMAT_DXT3||g===pc.PIXELFORMAT_DXT5||g>=pc.PIXELFORMAT_ETC1;this._width=d||4;this._height=e||4;this._addressV=this._addressU=pc.ADDRESS_REPEAT;this._minFilter=pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height)?pc.FILTER_LINEAR_MIPMAP_LINEAR:pc.FILTER_LINEAR;this._magFilter=pc.FILTER_LINEAR;this._anisotropy=1;this._invalid=!1;this._levels=f?[[null,null,null,null,null,null]]:[null];this._levelsUpdated=f?[[!0,!0,!0,!0,!0,!0]]:[!0];this._lockedLevel=-1;this._anisotropyDirty=
this._addressVDirty=this._addressUDirty=this._magFilterDirty=this._minFilterDirty=this._needsUpload=!0;this._gpuSize=0};Object.defineProperty(f.prototype,"minFilter",{get:function(){return this._minFilter},set:function(a){if(!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))a===pc.FILTER_NEAREST||a===pc.FILTER_LINEAR||(logWARNING("Invalid minification filter mode set on non power of two texture. Forcing linear addressing."),a=pc.FILTER_LINEAR);a!==this._minFilter&&(this._minFilter=
a,this._minFilterDirty=!0)}});Object.defineProperty(f.prototype,"magFilter",{get:function(){return this._magFilter},set:function(a){a===pc.FILTER_NEAREST||a===pc.FILTER_LINEAR||logWARNING("Invalid magnification filter mode. Must be set to FILTER_NEAREST or FILTER_LINEAR.");a!==this._magFilter&&(this._magFilter=a,this._magFilterDirty=!0)}});Object.defineProperty(f.prototype,"addressU",{get:function(){return this._addressU},set:function(a){if((!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))&&
a!==pc.ADDRESS_CLAMP_TO_EDGE)logWARNING("Invalid address mode in U set on non power of two texture. Forcing clamp to edge addressing."),a=pc.ADDRESS_CLAMP_TO_EDGE;a!==this._addressU&&(this._addressU=a,this._addressUDirty=!0)}});Object.defineProperty(f.prototype,"addressV",{get:function(){return this._addressV},set:function(a){if((!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))&&a!==pc.ADDRESS_CLAMP_TO_EDGE)logWARNING("Invalid address mode in V set on non power of two texture. Forcing clamp to edge addressing."),
a=pc.ADDRESS_CLAMP_TO_EDGE;a!==this._addressV&&(this._addressV=a,this._addressVDirty=!0)}});Object.defineProperty(f.prototype,"anisotropy",{get:function(){return this._anisotropy},set:function(a){a=pc.math.clamp(a,1,this.device.maxAnisotropy);a!==this._anisotropy&&(this._anisotropy=a,this._anisotropyDirty=!0)}});Object.defineProperty(f.prototype,"width",{get:function(){return this._width}});Object.defineProperty(f.prototype,"height",{get:function(){return this._height}});Object.defineProperty(f.prototype,
"format",{get:function(){return this._format}});Object.defineProperty(f.prototype,"cubemap",{get:function(){return this._cubemap}});pc.extend(f.prototype,{bind:function(){},destroy:function(){this._glTextureId&&(this.device.gl.deleteTexture(this._glTextureId),this.device._vram.tex-=this._gpuSize)},lock:function(a){a=a||{level:0,face:0,mode:pc.TEXTURELOCK_WRITE};void 0===a.level&&(a.level=0);void 0===a.face&&(a.face=0);void 0===a.mode&&(a.mode=pc.TEXTURELOCK_WRITE);this._lockedLevel=a.level;if(null===
this._levels[a.level])switch(this._format){case pc.PIXELFORMAT_A8:case pc.PIXELFORMAT_L8:this._levels[a.level]=new Uint8Array(this._width*this._height);break;case pc.PIXELFORMAT_L8_A8:this._levels[a.level]=new Uint8Array(2*this._width*this._height);break;case pc.PIXELFORMAT_R5_G6_B5:case pc.PIXELFORMAT_R5_G5_B5_A1:case pc.PIXELFORMAT_R4_G4_B4_A4:this._levels[a.level]=new Uint16Array(this._width*this._height);break;case pc.PIXELFORMAT_R8_G8_B8:this._levels[a.level]=new Uint8Array(3*this._width*this._height);
break;case pc.PIXELFORMAT_R8_G8_B8_A8:this._levels[a.level]=new Uint8Array(4*this._width*this._height);break;case pc.PIXELFORMAT_DXT1:this._levels[a.level]=new Uint8Array(8*Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4));break;case pc.PIXELFORMAT_DXT3:case pc.PIXELFORMAT_DXT5:this._levels[a.level]=new Uint8Array(16*Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4));break;case pc.PIXELFORMAT_RGB16F:case pc.PIXELFORMAT_RGB32F:this._levels[a.level]=new Float32Array(3*this._width*
this._height);break;case pc.PIXELFORMAT_RGBA16F:case pc.PIXELFORMAT_RGBA32F:this._levels[a.level]=new Float32Array(4*this._width*this._height)}return this._levels[a.level]},recover:function(){},setSource:function(a){var b,d=!1,e,g;if(this._cubemap){e=a[0]&&a[0].width||0;g=a[0]&&a[0].height||0;if(a[0])for(b=0;6>b;b++){if(!a[b]||a[b].width!==e||a[b].height!==g||!(a[b]instanceof HTMLImageElement)&&!(a[b]instanceof HTMLCanvasElement)&&!(a[b]instanceof HTMLVideoElement))d=!0}else d=!0;for(b=0;6>b;b++)if(d||
this._levels[0][b]!==a[b])this._levelsUpdated[0][b]=!0}else{!(a instanceof HTMLImageElement)&&(!(a instanceof HTMLCanvasElement)&&!(a instanceof HTMLVideoElement))&&(d=!0);if(d||a!==this._levels[0])this._levelsUpdated[0]=!0;e=a.width;g=a.height}if(d)if(this._height=this._width=4,this._cubemap)for(b=0;6>b;b++)this._levels[0][b]=null,this._levelsUpdated[0][b]=!0;else this._levels[0]=null,this._levelsUpdated[0]=!0;else this._width=e,this._height=g,this._levels[0]=a;if(this._invalid!==d||!d)this._invalid=
d,this.upload(),this.minFilter=this._minFilter,this.magFilter=this._magFilter,this.addressU=this._addressU,this.addressV=this._addressV},getSource:function(){return this._levels[0]},unlock:function(){logASSERT(-1!==this._lockedLevel,"Attempting to unlock a texture that is not locked");this.upload();this._lockedLevel=-1},upload:function(){this._needsUpload=!0},getDds:function(){this.format!==pc.PIXELFORMAT_R8_G8_B8_A8&&console.error("This format is not implemented yet");for(var a=128,b=0,d,e;this._levels[b];){if(this.cubemap)for(e=
0;6>e;e++){if(!this._levels[b][e]){console.error("No level data for mip "+b+", face "+e);return}d=this._levels[b][e].length;if(!d){console.error("No byte array for mip "+b+", face "+e);return}a+=d}else{d=this._levels[b].length;if(!d){console.error("No byte array for mip "+b);return}a+=d}a+=this._levels[b].length;b++}a=new ArrayBuffer(a);e=new Uint32Array(a,0,32);b=528391;1<this._levels.length&&(b|=131072);d=4096;1<this._levels.length&&(d|=4194304);if(1<this._levels.length||this.cubemap)d|=8;var g=
this.cubemap?65024:0;e[0]=542327876;e[1]=124;e[2]=b;e[3]=this.height;e[4]=this.width;e[5]=4*this.width*this.height;e[6]=0;e[7]=this._levels.length;for(b=0;11>b;b++)e[8+b]=0;e[19]=32;e[20]=65;e[21]=0;e[22]=32;e[23]=16711680;e[24]=65280;e[25]=255;e[26]=4278190080;e[27]=d;e[28]=g;e[29]=0;e[30]=0;e[31]=0;var g=128,f,k;if(this.cubemap)for(e=0;6>e;e++)for(b=0;b<this._levels.length;b++){f=this._levels[b][e];k=new Uint8Array(a,g,f.length);for(d=0;d<f.length;d++)k[d]=f[d];g+=f.length}else for(b=0;b<this._levels.length;b++){f=
this._levels[b];k=new Uint8Array(a,g,f.length);for(d=0;d<f.length;d++)k[d]=f[d];g+=f.length}return a}});return{Texture:f}}());pc.extend(pc,function(){var f={depth:!0,face:0},a=function(a,d,e){this._device=a;this._colorBuffer=d;e=void 0!==e?e:f;this._face=void 0!==e.face?e.face:0;this._depth=void 0!==e.depth?e.depth:!0};a.prototype={destroy:function(){var a=this._device.gl;a.deleteFramebuffer(this._frameBuffer);this._depthBuffer&&a.deleteRenderbuffer(this._depthBuffer)}};Object.defineProperty(a.prototype,"colorBuffer",{get:function(){return this._colorBuffer}});Object.defineProperty(a.prototype,"face",{get:function(){return this._face}});
Object.defineProperty(a.prototype,"width",{get:function(){return this._colorBuffer.width}});Object.defineProperty(a.prototype,"height",{get:function(){return this._colorBuffer.height}});return{RenderTarget:a}}());pc.extend(pc,function(){return{ShaderInput:function(f,a,b,d){this.locationId=d;this.scopeId=f.scope.resolve(a);this.version=new pc.Version;this.dataType=b;this.array=[]}}}());pc.extend(pc,function(){function f(a){for(var a=a.split("\n"),b=0,g=a.length;b<g;b++)a[b]=b+1+":\t"+a[b];return a.join("\n")}function a(a,b,g){b=a.createShader(b);a.shaderSource(b,g);a.compileShader(b);return b}var b=function(b,e){this.device=b;this.definition=e;this.ready=!1;var g=pc.now();this.device.fire("shader:compile:start",{timestamp:g,target:this});var f=this.device.gl;this.vshader=a(f,f.VERTEX_SHADER,e.vshader);this.fshader=a(f,f.FRAGMENT_SHADER,e.fshader);var k=this.vshader,m=this.fshader,
r=f.createProgram();f.attachShader(r,k);f.attachShader(r,m);this.program=r;b._shaderStats.vsCompiled++;b._shaderStats.fsCompiled++;b._shaderStats.linked++;e.tag===pc.SHADERTAG_MATERIAL&&b._shaderStats.materialShaders++;f=pc.now();this.device.fire("shader:compile:end",{timestamp:f,target:this});this.device._shaderStats.compileTime+=f-g};b.prototype={link:function(){var a=this.device.gl,b=pc.now();this.device.fire("shader:link:start",{timestamp:b,target:this});a.linkProgram(this.program);a.getShaderParameter(this.vshader,
a.COMPILE_STATUS)||logERROR("Failed to compile vertex shader:\n\n"+f(this.definition.vshader)+"\n\n"+a.getShaderInfoLog(this.vshader));a.getShaderParameter(this.fshader,a.COMPILE_STATUS)||logERROR("Failed to compile fragment shader:\n\n"+f(this.definition.fshader)+"\n\n"+a.getShaderInfoLog(this.fshader));a.getProgramParameter(this.program,a.LINK_STATUS)||logERROR("Failed to link shader program. Error: "+a.getProgramInfoLog(this.program));a.deleteShader(this.vshader);a.deleteShader(this.fshader);this.attributes=
[];this.uniforms=[];this.samplers=[];var g=0,h,k,m={};m[a.BOOL]=pc.UNIFORMTYPE_BOOL;m[a.INT]=pc.UNIFORMTYPE_INT;m[a.FLOAT]=pc.UNIFORMTYPE_FLOAT;m[a.FLOAT_VEC2]=pc.UNIFORMTYPE_VEC2;m[a.FLOAT_VEC3]=pc.UNIFORMTYPE_VEC3;m[a.FLOAT_VEC4]=pc.UNIFORMTYPE_VEC4;m[a.INT_VEC2]=pc.UNIFORMTYPE_IVEC2;m[a.INT_VEC3]=pc.UNIFORMTYPE_IVEC3;m[a.INT_VEC4]=pc.UNIFORMTYPE_IVEC4;m[a.BOOL_VEC2]=pc.UNIFORMTYPE_BVEC2;m[a.BOOL_VEC3]=pc.UNIFORMTYPE_BVEC3;m[a.BOOL_VEC4]=pc.UNIFORMTYPE_BVEC4;m[a.FLOAT_MAT2]=pc.UNIFORMTYPE_MAT2;
m[a.FLOAT_MAT3]=pc.UNIFORMTYPE_MAT3;m[a.FLOAT_MAT4]=pc.UNIFORMTYPE_MAT4;m[a.SAMPLER_2D]=pc.UNIFORMTYPE_TEXTURE2D;m[a.SAMPLER_CUBE]=pc.UNIFORMTYPE_TEXTURECUBE;for(var r=a.getProgramParameter(this.program,a.ACTIVE_ATTRIBUTES);g<r;)h=a.getActiveAttrib(this.program,g++),k=a.getAttribLocation(this.program,h.name),void 0===this.definition.attributes[h.name]&&console.error('Vertex shader attribute "'+h.name+'" is not mapped to a semantic in shader definition.'),h=new pc.ShaderInput(this.device,this.definition.attributes[h.name],
m[h.type],k),this.attributes.push(h);g=0;for(r=a.getProgramParameter(this.program,a.ACTIVE_UNIFORMS);g<r;)h=a.getActiveUniform(this.program,g++),k=a.getUniformLocation(this.program,h.name),h.type===a.SAMPLER_2D||h.type===a.SAMPLER_CUBE?this.samplers.push(new pc.ShaderInput(this.device,h.name,m[h.type],k)):this.uniforms.push(new pc.ShaderInput(this.device,h.name,m[h.type],k));this.ready=!0;a=pc.now();this.device.fire("shader:link:end",{timestamp:a,target:this});this.device._shaderStats.compileTime+=
a-b},destroy:function(){this.device.gl.deleteProgram(this.program)}};return{Shader:b}}());pc.extend(pc,function(){var f=function(a){this._device=a;this._cache={};this._generators={}};f.prototype.register=function(a,b){this.isRegistered(a)||(this._generators[a]=b)};f.prototype.unregister=function(a){this.isRegistered(a)&&delete this._generators[a]};f.prototype.isRegistered=function(a){return void 0!==this._generators[a]};f.prototype.getProgram=function(a,b){var d=this._generators[a];if(void 0===d)return logERROR("No program library functions registered for: "+a),null;var e=d.generateKey(g,
b),g=this._cache[e];if(!g)var g=this._device,d=d.createShaderDefinition(g,b),g=this._cache[e]=new pc.Shader(g,d);return g};return{ProgramLibrary:f}}());pc.extend(pc,function(){function f(a){this.name="UnsupportedBrowserError";this.message=a||""}function a(a){this.name="ContextCreationError";this.message=a||""}function b(a,b,d){b=a.createTexture();a.bindTexture(a.TEXTURE_2D,b);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.texImage2D(a.TEXTURE_2D,
0,a.RGBA,2,2,0,a.RGBA,d,null);d=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,d);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,b,0);a.bindTexture(a.TEXTURE_2D,null);if(a.checkFramebufferStatus(a.FRAMEBUFFER)!=a.FRAMEBUFFER_COMPLETE)return a.deleteTexture(b),!1;a.deleteTexture(b);return!0}f.prototype=Error.prototype;a.prototype=Error.prototype;var d=function(){logWARNING("Context lost.")},e=function(){logINFO("Context restored.")},g=function(a,b){var d=a.width,e=a.height;
if(d>b||e>b){var g=b/Math.max(d,e),f=Math.floor(d*g),g=Math.floor(e*g);console.warn("Image dimensions larger than max supported texture size of "+b+". Resizing from "+d+", "+e+" to "+f+", "+g+".");var h=document.createElement("canvas");h.width=f;h.height=g;h.getContext("2d").drawImage(a,0,0,d,e,0,0,f,g);return h}return a},h=null,k=function(a,g){this.gl=void 0;this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this.precision="highp";this.enableAutoInstancing=!1;this.autoInstancingMaxObjects=
16384;this.attributesInvalidated=!0;this.boundBuffer=null;this.instancedAttribs={};this.enabledAttributes={};this.textureUnits=[];this.commitFunction={};this._maxPixelRatio=1;this._height=this._width=0;this.updateClientRect();if(!window.WebGLRenderingContext)throw new pc.UnsupportedBrowserError;if(a){for(var f=["webgl","experimental-webgl"],h=null,k=0;k<f.length;k++){try{h=a.getContext(f[k],g)}catch(w){}if(h)break}this.gl=h}if(!this.gl)throw new pc.ContextCreationError;var s=this.gl;a.addEventListener("webglcontextlost",
d,!1);a.addEventListener("webglcontextrestored",e,!1);this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this.precision="highp";this.maxTextureSize=s.getParameter(s.MAX_TEXTURE_SIZE);this.maxCubeMapSize=s.getParameter(s.MAX_CUBE_MAP_TEXTURE_SIZE);this.maxRenderBufferSize=s.getParameter(s.MAX_RENDERBUFFER_SIZE);if(s.getShaderPrecisionFormat){f=s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.HIGH_FLOAT);k=s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.MEDIUM_FLOAT);s.getShaderPrecisionFormat(s.VERTEX_SHADER,
s.LOW_FLOAT);var h=s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.HIGH_FLOAT),B=s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.MEDIUM_FLOAT);s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.LOW_FLOAT);s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.HIGH_INT);s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.MEDIUM_INT);s.getShaderPrecisionFormat(s.VERTEX_SHADER,s.LOW_INT);s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.HIGH_INT);s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,s.MEDIUM_INT);s.getShaderPrecisionFormat(s.FRAGMENT_SHADER,
s.LOW_INT);k=0<k.precision&&0<B.precision;0<f.precision&&0<h.precision||(k?(this.precision="mediump",console.warn("WARNING: highp not supported, using mediump")):(this.precision="lowp",console.warn("WARNING: highp and mediump not supported, using lowp")))}this.maxPrecision=this.precision;this.defaultClearOptions={color:[0,0,0,1],depth:1,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH};this.glAddress=[s.REPEAT,s.CLAMP_TO_EDGE,s.MIRRORED_REPEAT];this.glBlendEquation=[s.FUNC_ADD,s.FUNC_SUBTRACT,s.FUNC_REVERSE_SUBTRACT];
this.glBlendFunction=[s.ZERO,s.ONE,s.SRC_COLOR,s.ONE_MINUS_SRC_COLOR,s.DST_COLOR,s.ONE_MINUS_DST_COLOR,s.SRC_ALPHA,s.SRC_ALPHA_SATURATE,s.ONE_MINUS_SRC_ALPHA,s.DST_ALPHA,s.ONE_MINUS_DST_ALPHA];this.glClearFlag=[0,s.COLOR_BUFFER_BIT,s.DEPTH_BUFFER_BIT,s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT,s.STENCIL_BUFFER_BIT,s.STENCIL_BUFFER_BIT|s.COLOR_BUFFER_BIT,s.STENCIL_BUFFER_BIT|s.DEPTH_BUFFER_BIT,s.STENCIL_BUFFER_BIT|s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT];this.glFilter=[s.NEAREST,s.LINEAR,s.NEAREST_MIPMAP_NEAREST,
s.NEAREST_MIPMAP_LINEAR,s.LINEAR_MIPMAP_NEAREST,s.LINEAR_MIPMAP_LINEAR];this.glPrimitive=[s.POINTS,s.LINES,s.LINE_LOOP,s.LINE_STRIP,s.TRIANGLES,s.TRIANGLE_STRIP,s.TRIANGLE_FAN];this.glType=[s.BYTE,s.UNSIGNED_BYTE,s.SHORT,s.UNSIGNED_SHORT,s.INT,s.UNSIGNED_INT,s.FLOAT];this.unmaskedVendor=this.unmaskedRenderer=null;if(this.extRendererInfo=s.getExtension("WEBGL_debug_renderer_info"))this.unmaskedRenderer=s.getParameter(this.extRendererInfo.UNMASKED_RENDERER_WEBGL),this.unmaskedVendor=s.getParameter(this.extRendererInfo.UNMASKED_VENDOR_WEBGL);
this.extTextureFloat=s.getExtension("OES_texture_float");this.extTextureFloatLinear=s.getExtension("OES_texture_float_linear");this.extTextureFloat&&(this.extTextureFloatRenderable=b(s,this.extTextureFloat,s.FLOAT));if(this.extTextureHalfFloat=s.getExtension("OES_texture_half_float"))this.extTextureHalfFloatRenderable=b(s,this.extTextureHalfFloat,this.extTextureHalfFloat.HALF_FLOAT_OES);this.extUintElement=s.getExtension("OES_element_index_uint");this.maxVertexTextures=s.getParameter(s.MAX_VERTEX_TEXTURE_IMAGE_UNITS);
this.supportsBoneTextures=this.extTextureFloat&&0<this.maxVertexTextures;this.extTextureLod=s.getExtension("EXT_shader_texture_lod");this.fragmentUniformsCount=s.getParameter(s.MAX_FRAGMENT_UNIFORM_VECTORS);this.samplerCount=s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS);this.useTexCubeLod=this.extTextureLod&&16>this.samplerCount;this.extDepthTexture=null;(this.extStandardDerivatives=s.getExtension("OES_standard_derivatives"))&&s.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,s.NICEST);
this.extTextureFilterAnisotropic=s.getExtension("EXT_texture_filter_anisotropic");this.extTextureFilterAnisotropic||(this.extTextureFilterAnisotropic=s.getExtension("WEBKIT_EXT_texture_filter_anisotropic"));this.extCompressedTextureS3TC=s.getExtension("WEBGL_compressed_texture_s3tc");this.extCompressedTextureS3TC||(this.extCompressedTextureS3TC=s.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"));if(f=this.extCompressedTextureS3TC)f=window.navigator.userAgent.indexOf("MSIE "),h=navigator.userAgent.match(/Trident.*rv\:11\./),
f=0<f||!!h;f&&(this.extCompressedTextureS3TC=!1);if(this.extCompressedTextureS3TC){h=s.getParameter(s.COMPRESSED_TEXTURE_FORMATS);for(f=0;f<h.length;f++);}this.extInstancing=s.getExtension("ANGLE_instanced_arrays");this.extCompressedTextureETC1=s.getExtension("WEBGL_compressed_texture_etc1");this.extCompressedTexturePVRTC=s.getExtension("WEBGL_compressed_texture_pvrtc")||s.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");this.maxDrawBuffers=(this.extDrawBuffers=s.getExtension("EXT_draw_buffers"))?
s.getParameter(this.extDrawBuffers.MAX_DRAW_BUFFERS_EXT):1;this.maxColorAttachments=this.extDrawBuffers?s.getParameter(this.extDrawBuffers.MAX_COLOR_ATTACHMENTS_EXT):1;this.renderTarget=null;this.scope=new pc.ScopeSpace("Device");this.commitFunction={};this.commitFunction[pc.UNIFORMTYPE_BOOL]=function(a,b){s.uniform1i(a,b)};this.commitFunction[pc.UNIFORMTYPE_INT]=function(a,b){s.uniform1i(a,b)};this.commitFunction[pc.UNIFORMTYPE_FLOAT]=function(a,b){"number"==typeof b?s.uniform1f(a,b):s.uniform1fv(a,
b)};this.commitFunction[pc.UNIFORMTYPE_VEC2]=function(a,b){s.uniform2fv(a,b)};this.commitFunction[pc.UNIFORMTYPE_VEC3]=function(a,b){s.uniform3fv(a,b)};this.commitFunction[pc.UNIFORMTYPE_VEC4]=function(a,b){s.uniform4fv(a,b)};this.commitFunction[pc.UNIFORMTYPE_IVEC2]=function(a,b){s.uniform2iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_BVEC2]=function(a,b){s.uniform2iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_IVEC3]=function(a,b){s.uniform3iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_BVEC3]=function(a,
b){s.uniform3iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_IVEC4]=function(a,b){s.uniform4iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_BVEC4]=function(a,b){s.uniform4iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_MAT2]=function(a,b){s.uniformMatrix2fv(a,!1,b)};this.commitFunction[pc.UNIFORMTYPE_MAT3]=function(a,b){s.uniformMatrix3fv(a,!1,b)};this.commitFunction[pc.UNIFORMTYPE_MAT4]=function(a,b){s.uniformMatrix4fv(a,!1,b)};this.setBlending(!1);this.setBlendFunction(pc.BLENDMODE_ONE,pc.BLENDMODE_ZERO);this.setBlendEquation(pc.BLENDEQUATION_ADD);
this.setColorWrite(!0,!0,!0,!0);this.setCullMode(pc.CULLFACE_BACK);this.setDepthTest(!0);this.setDepthWrite(!0);this.setClearDepth(1);this.setClearColor(0,0,0,0);s.enable(s.SCISSOR_TEST);this.programLib=new pc.ProgramLibrary(this);for(var y in pc.programlib)this.programLib.register(y,pc.programlib[y]);y=s.getParameter(s.MAX_VERTEX_UNIFORM_VECTORS);y=y-16-8;y-=1;y-=16;this.boneLimit=Math.floor(y/4);this.boneLimit=Math.min(this.boneLimit,128);"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34);
pc.events.attach(this);this.boundBuffer=null;this.instancedAttribs={};this.activeTexture=0;this.textureUnits=[];this.attributesInvalidated=!0;this.enabledAttributes={};this._shaderSwitchesPerFrame=this._drawCallsPerFrame=0;this._primsPerFrame=[];for(f=pc.PRIMITIVE_POINTS;f<=pc.PRIMITIVE_TRIFAN;f++)this._primsPerFrame[f]=0;this._renderTargetCreationTime=0;this._vram={tex:0,vb:0,ib:0};this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0};y=s.createBuffer();f=new ArrayBuffer(16);
s.bindBuffer(s.ARRAY_BUFFER,y);s.bufferData(s.ARRAY_BUFFER,f,s.STATIC_DRAW);s.getError();s.vertexAttribPointer(0,4,s.UNSIGNED_BYTE,!1,4,0);this.supportsUnsignedByte=0===s.getError();s.deleteBuffer(y)};k.prototype={updateClientRect:function(){this.clientRect=this.canvas.getBoundingClientRect()},setViewport:function(a,b,d,e){this.gl.viewport(a,b,d,e)},setScissor:function(a,b,d,e){this.gl.scissor(a,b,d,e)},getProgramLibrary:function(){return this.programLib},setProgramLibrary:function(a){this.programLib=
a},updateBegin:function(){var a=this.gl;this.indexBuffer=this.boundBuffer=null;var b=this.renderTarget;if(b)if(b._glFrameBuffer)a.bindFramebuffer(a.FRAMEBUFFER,b._glFrameBuffer);else{var d=pc.now();this.fire("fbo:create",{timestamp:d,target:this});b._glFrameBuffer=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,b._glFrameBuffer);var e=b._colorBuffer;e._glTextureId||(e._width=Math.min(e.width,this.maxRenderBufferSize),e._height=Math.min(e.height,this.maxRenderBufferSize),this.setTexture(e,0));
a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,e._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+b._face:a.TEXTURE_2D,e._glTextureId,0);b._depth&&(b._glDepthBuffer||(b._glDepthBuffer=a.createRenderbuffer()),a.bindRenderbuffer(a.RENDERBUFFER,b._glDepthBuffer),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,b.width,b.height),a.bindRenderbuffer(a.RENDERBUFFER,null),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,b._glDepthBuffer));switch(a.checkFramebufferStatus(a.FRAMEBUFFER)){case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");
break;case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case a.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED")}this._renderTargetCreationTime+=pc.now()-d}else a.bindFramebuffer(a.FRAMEBUFFER,null);for(a=0;16>a;a++)this.textureUnits[a]=null},updateEnd:function(){var a=this.gl,b=this.renderTarget;b&&(a.bindFramebuffer(a.FRAMEBUFFER,
null),b=b._colorBuffer,b._glTextureId&&(b.autoMipmap&&pc.math.powerOfTwo(b._width)&&pc.math.powerOfTwo(b._height))&&(a.bindTexture(b._glTarget,b._glTextureId),a.generateMipmap(b._glTarget)))},initializeTexture:function(a){var b=this.gl;a._glTextureId=b.createTexture();a._glTarget=a._cubemap?b.TEXTURE_CUBE_MAP:b.TEXTURE_2D;switch(a._format){case pc.PIXELFORMAT_A8:a._glFormat=b.ALPHA;a._glInternalFormat=b.ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_L8:a._glFormat=b.LUMINANCE;a._glInternalFormat=
b.LUMINANCE;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_L8_A8:a._glFormat=b.LUMINANCE_ALPHA;a._glInternalFormat=b.LUMINANCE_ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_R5_G6_B5:a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=b.UNSIGNED_SHORT_5_6_5;break;case pc.PIXELFORMAT_R5_G5_B5_A1:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_SHORT_5_5_5_1;break;case pc.PIXELFORMAT_R4_G4_B4_A4:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=
b.UNSIGNED_SHORT_4_4_4_4;break;case pc.PIXELFORMAT_R8_G8_B8:a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_R8_G8_B8_A8:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_DXT1:ext=this.extCompressedTextureS3TC;a._glFormat=b.RGB;a._glInternalFormat=ext.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case pc.PIXELFORMAT_DXT3:ext=this.extCompressedTextureS3TC;a._glFormat=b.RGBA;a._glInternalFormat=ext.COMPRESSED_RGBA_S3TC_DXT3_EXT;
break;case pc.PIXELFORMAT_DXT5:ext=this.extCompressedTextureS3TC;a._glFormat=b.RGBA;a._glInternalFormat=ext.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case pc.PIXELFORMAT_ETC1:ext=this.extCompressedTextureETC1;a._glFormat=b.RGB;a._glInternalFormat=ext.COMPRESSED_RGB_ETC1_WEBGL;break;case pc.PIXELFORMAT_PVRTC_2BPP_RGB_1:ext=this.extCompressedTexturePVRTC;a._glFormat=b.RGB;a._glInternalFormat=ext.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1:ext=this.extCompressedTexturePVRTC;
a._glFormat=b.RGBA;a._glInternalFormat=ext.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case pc.PIXELFORMAT_PVRTC_4BPP_RGB_1:ext=this.extCompressedTexturePVRTC;a._glFormat=b.RGB;a._glInternalFormat=ext.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1:ext=this.extCompressedTexturePVRTC;a._glFormat=b.RGBA;a._glInternalFormat=ext.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case pc.PIXELFORMAT_RGB16F:ext=this.extTextureHalfFloat;a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=
ext.HALF_FLOAT_OES;break;case pc.PIXELFORMAT_RGBA16F:ext=this.extTextureHalfFloat;a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=ext.HALF_FLOAT_OES;break;case pc.PIXELFORMAT_RGB32F:a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=b.FLOAT;break;case pc.PIXELFORMAT_RGBA32F:a._glFormat=b.RGBA,a._glInternalFormat=b.RGBA,a._glPixelType=b.FLOAT}},uploadTexture:function(a){for(var b=this.gl,d=0,e,f;a._levels[d]||0===d;){e=a._levels[d];1==d&&!a._compressed&&b.generateMipmap(a._glTarget);
if(a._cubemap){var k;b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1);b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);if(e[0]instanceof HTMLCanvasElement||e[0]instanceof HTMLImageElement||e[0]instanceof HTMLVideoElement)for(k=0;6>k;k++){if(a._levelsUpdated[0][k]){f=e[k];if(f instanceof HTMLImageElement&&(f.width>this.maxCubeMapSize||f.height>this.maxCubeMapSize))f=g(f,this.maxCubeMapSize),0===d&&(a.width=f.width,a.height=f.height);b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+k,d,a._glInternalFormat,a._glFormat,
a._glPixelType,f)}}else{f=1/Math.pow(2,d);for(k=0;6>k;k++)if(a._levelsUpdated[0][k]){var s=e[k];a._compressed?b.compressedTexImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+k,d,a._glInternalFormat,Math.max(a._width*f,1),Math.max(a._height*f,1),0,s):b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+k,d,a._glInternalFormat,Math.max(a._width*f,1),Math.max(a._height*f,1),0,a._glFormat,a._glPixelType,s)}}}else if(e instanceof HTMLCanvasElement||e instanceof HTMLImageElement||e instanceof HTMLVideoElement){if(e instanceof
HTMLImageElement&&(e.width>this.maxTextureSize||e.height>this.maxTextureSize))e=g(e,this.maxTextureSize),0===d&&(a.width=e.width,a.height=e.height);b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0);b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);b.texImage2D(b.TEXTURE_2D,d,a._glInternalFormat,a._glFormat,a._glPixelType,e)}else b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1),f=1/Math.pow(2,d),a._compressed?b.compressedTexImage2D(b.TEXTURE_2D,d,a._glInternalFormat,Math.max(a._width*f,1),Math.max(a._height*f,1),0,
e):b.texImage2D(b.TEXTURE_2D,d,a._glInternalFormat,Math.max(a._width*f,1),Math.max(a._height*f,1),0,a._glFormat,a._glPixelType,e);d++}if(a._cubemap)for(d=0;6>d;d++)a._levelsUpdated[0][d]=!1;else a._levelsUpdated[0]=!1;a.autoMipmap&&(pc.math.powerOfTwo(a._width)&&pc.math.powerOfTwo(a._height)&&1===a._levels.length&&!a._compressed)&&b.generateMipmap(a._glTarget);a._gpuSize&&(this._vram.tex-=a._gpuSize);h||(h={},h[pc.PIXELFORMAT_A8]=1,h[pc.PIXELFORMAT_L8]=1,h[pc.PIXELFORMAT_L8_A8]=1,h[pc.PIXELFORMAT_R5_G6_B5]=
2,h[pc.PIXELFORMAT_R5_G5_B5_A1]=2,h[pc.PIXELFORMAT_R4_G4_B4_A4]=2,h[pc.PIXELFORMAT_R8_G8_B8]=4,h[pc.PIXELFORMAT_R8_G8_B8_A8]=4,h[pc.PIXELFORMAT_RGB16F]=8,h[pc.PIXELFORMAT_RGBA16F]=8,h[pc.PIXELFORMAT_RGB32F]=16,h[pc.PIXELFORMAT_RGBA32F]=16);d=1;if(a.autoMipmap||a._minFilter===b.NEAREST_MIPMAP_NEAREST||a._minFilter===b.NEAREST_MIPMAP_LINEAR||a._minFilter===b.LINEAR_MIPMAP_NEAREST||a._minFilter===b.LINEAR_MIPMAP_LINEAR)d=Math.round(Math.log2(Math.max(a._width,a._height))+1);b=a._width;e=a._height;for(f=
k=0;f<d;f++)k=a._compressed?a._format===pc.PIXELFORMAT_ETC1?k+8*Math.floor((b+3)/4)*Math.floor((e+3)/4):a._format===pc.PIXELFORMAT_PVRTC_2BPP_RGB_1||a._format===pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1?k+Math.max(b,16)*Math.max(e,8)/4:a._format===pc.PIXELFORMAT_PVRTC_4BPP_RGB_1||a._format===pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1?k+Math.max(b,8)*Math.max(e,8)/2:k+Math.floor((b+4-1)/4)*Math.floor((e+4-1)/4)*(a._format===pc.PIXELFORMAT_DXT1?8:16):k+b*e*h[a._format],b=Math.max(0.5*b,1),e=Math.max(0.5*e,1);a._cubemap&&
(k*=6);a._gpuSize=k;this._vram.tex+=a._gpuSize},setTexture:function(a,b){var d=this.gl;a._glTextureId||this.initializeTexture(a);this.activeTexture!==b&&(d.activeTexture(d.TEXTURE0+b),this.activeTexture=b);var e=a._glTarget;this.textureUnits[b]!==a&&(d.bindTexture(e,a._glTextureId),this.textureUnits[b]=a);a._minFilterDirty&&(d.texParameteri(e,d.TEXTURE_MIN_FILTER,this.glFilter[a._minFilter]),a._minFilterDirty=!1);a._magFilterDirty&&(d.texParameteri(e,d.TEXTURE_MAG_FILTER,this.glFilter[a._magFilter]),
a._magFilterDirty=!1);a._addressUDirty&&(d.texParameteri(e,d.TEXTURE_WRAP_S,this.glAddress[a._addressU]),a._addressUDirty=!1);a._addressVDirty&&(d.texParameteri(e,d.TEXTURE_WRAP_T,this.glAddress[a._addressV]),a._addressVDirty=!1);if(a._anisotropyDirty){var g=this.extTextureFilterAnisotropic;if(g){var f=a.anisotropy,f=Math.min(f,this.maxAnisotropy);d.texParameterf(e,g.TEXTURE_MAX_ANISOTROPY_EXT,f)}a._anisotropyDirty=!1}a._needsUpload&&(this.uploadTexture(a),a._needsUpload=!1)},draw:function(a,b){var d=
this.gl,e,g,f,h,k,y,x;e=this.shader;x=e.samplers;var A=e.uniforms;1<b&&(this.boundBuffer=null,this.attributesInvalidated=!0);if(this.attributesInvalidated){y=e.attributes;e=0;for(f=y.length;e<f;e++)g=y[e],h=g.scopeId.value,null!==h&&(k=this.vertexBuffers[h.stream],this.boundBuffer!==k.bufferId&&(d.bindBuffer(d.ARRAY_BUFFER,k.bufferId),this.boundBuffer=k.bufferId),this.enabledAttributes[g.locationId]||(d.enableVertexAttribArray(g.locationId),this.enabledAttributes[g.locationId]=!0),d.vertexAttribPointer(g.locationId,
h.numComponents,this.glType[h.dataType],h.normalize,h.stride,h.offset),1===h.stream&&1<b?this.instancedAttribs[g.locationId]||(this.extInstancing.vertexAttribDivisorANGLE(g.locationId,1),this.instancedAttribs[g.locationId]=!0):this.instancedAttribs[g.locationId]&&(this.extInstancing.vertexAttribDivisorANGLE(g.locationId,0),this.instancedAttribs[g.locationId]=!1));this.attributesInvalidated=!1}var D=0;e=0;for(f=x.length;e<f;e++)if(h=x[e],k=h.scopeId.value)if(k instanceof pc.Texture)y=k,this.setTexture(y,
D),h.slot!==D&&(d.uniform1i(h.locationId,D),h.slot=D),D++;else{h.array.length=0;numTexures=k.length;for(g=0;g<numTexures;g++)y=k[g],this.setTexture(y,D),h.array[g]=D,D++;d.uniform1iv(h.locationId,h.array)}e=0;for(f=A.length;e<f;e++)if(x=A[e],g=x.scopeId,h=x.version,k=g.versionObject.version,h.globalId!==k.globalId||h.revision!==k.revision)if(h.globalId=k.globalId,h.revision=k.revision,null!==g.value)this.commitFunction[x.dataType](x.locationId,g.value);this._drawCallsPerFrame++;this._primsPerFrame[a.type]+=
a.count*(1<b?b:1);a.indexed?1<b?(this.extInstancing.drawElementsInstancedANGLE(this.glPrimitive[a.type],a.count,this.indexBuffer.glFormat,2*a.base,b),this.boundBuffer=null,this.attributesInvalidated=!0):d.drawElements(this.glPrimitive[a.type],a.count,this.indexBuffer.glFormat,a.base*this.indexBuffer.bytesPerIndex):1<b?(this.extInstancing.drawArraysInstancedANGLE(this.glPrimitive[a.type],a.base,a.count,b),this.boundBuffer=null,this.attributesInvalidated=!0):d.drawArrays(this.glPrimitive[a.type],a.base,
a.count)},clear:function(a){var b=this.defaultClearOptions,a=a||b,d=void 0===a.flags?b.flags:a.flags;if(0!==d){var e=this.gl;if(d&pc.CLEARFLAG_COLOR){var g=void 0===a.color?b.color:a.color;this.setClearColor(g[0],g[1],g[2],g[3])}d&pc.CLEARFLAG_DEPTH&&(this.setClearDepth(void 0===a.depth?b.depth:a.depth),this.depthWrite||e.depthMask(!0));e.clear(this.glClearFlag[d]);d&pc.CLEARFLAG_DEPTH&&(this.depthWrite||e.depthMask(!1))}},readPixels:function(a,b,d,e,g){var f=this.gl;f.readPixels(a,b,d,e,f.RGBA,f.UNSIGNED_BYTE,
g)},setClearDepth:function(a){a!==this.clearDepth&&(this.gl.clearDepth(a),this.clearDepth=a)},setClearColor:function(a,b,d,e){if(a!==this.clearRed||b!==this.clearGreen||d!==this.clearBlue||e!==this.clearAlpha)this.gl.clearColor(a,b,d,e),this.clearRed=a,this.clearGreen=b,this.clearBlue=d,this.clearAlpha=e},setRenderTarget:function(a){this.renderTarget=a},getRenderTarget:function(){return this.renderTarget},getDepthTest:function(){return this.depthTest},setDepthTest:function(a){if(this.depthTest!==
a){var b=this.gl;a?b.enable(b.DEPTH_TEST):b.disable(b.DEPTH_TEST);this.depthTest=a}},getDepthWrite:function(){return this.depthWrite},setDepthWrite:function(a){this.depthWrite!==a&&(this.gl.depthMask(a),this.depthWrite=a)},setColorWrite:function(a,b,d,e){if(this.writeRed!==a||this.writeGreen!==b||this.writeBlue!==d||this.writeAlpha!==e)this.gl.colorMask(a,b,d,e),this.writeRed=a,this.writeGreen=b,this.writeBlue=d,this.writeAlpha=e},getBlending:function(){return this.blending},setBlending:function(a){if(this.blending!==
a){var b=this.gl;a?b.enable(b.BLEND):b.disable(b.BLEND);this.blending=a}},setBlendFunction:function(a,b){if(this.blendSrc!==a||this.blendDst!==b)this.gl.blendFunc(this.glBlendFunction[a],this.glBlendFunction[b]),this.blendSrc=a,this.blendDst=b},setBlendEquation:function(a){this.blendEquation!==a&&(this.gl.blendEquation(this.glBlendEquation[a]),this.blendEquation=a)},setCullMode:function(a){if(this.cullMode!==a){var b=this.gl;switch(a){case pc.CULLFACE_NONE:b.disable(b.CULL_FACE);break;case pc.CULLFACE_FRONT:b.enable(b.CULL_FACE);
b.cullFace(b.FRONT);break;case pc.CULLFACE_BACK:b.enable(b.CULL_FACE);b.cullFace(b.BACK);break;case pc.CULLFACE_FRONTANDBACK:b.enable(b.CULL_FACE),b.cullFace(b.FRONT_AND_BACK)}this.cullMode=a}},getCullMode:function(){return this.cullMode},setIndexBuffer:function(a){if(this.indexBuffer!==a){this.indexBuffer=a;var b=this.gl;b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,a?a.bufferId:null)}},setVertexBuffer:function(a,b){if(this.vertexBuffers[b]!==a){this.vertexBuffers[b]=a;for(var d=0,e=a.getFormat().elements,
g=e.length;d<g;){var f=e[d++];f.stream=b;f.scopeId.setValue(f)}this.attributesInvalidated=!0}},setShader:function(a){a!==this.shader&&(this.shader=a,a.ready||a.link(),this._shaderSwitchesPerFrame++,this.gl.useProgram(a.program),this.attributesInvalidated=!0)},getHdrFormat:function(){return this.extTextureHalfFloatRenderable?pc.PIXELFORMAT_RGB16F:this.extTextureFloatRenderable?pc.PIXELFORMAT_RGB32F:pc.PIXELFORMAT_R8_G8_B8_A8},getBoneLimit:function(){return this.boneLimit},setBoneLimit:function(a){this.boneLimit=
a},enableValidation:function(){console.warn("enableValidation: This function is deprecated and will be removed shortly.")},validate:function(){console.warn("validate: This function is deprecated and will be removed shortly.")},resizeCanvas:function(a,b){this._width=a;this._height=b;var d=Math.min(this._maxPixelRatio,window.devicePixelRatio),a=a*d,b=b*d;this.canvas.width=a;this.canvas.height=b;this.fire("resizecanvas",a,b)}};Object.defineProperty(k.prototype,"width",{get:function(){return this.gl.drawingBufferWidth||
this.canvas.width}});Object.defineProperty(k.prototype,"height",{get:function(){return this.gl.drawingBufferHeight||this.canvas.height}});Object.defineProperty(k.prototype,"fullscreen",{get:function(){return!!document.fullscreenElement},set:function(a){a?this.gl.canvas.requestFullscreen():document.exitFullscreen()}});Object.defineProperty(k.prototype,"maxAnisotropy",{get:function(){var a;return function(){if(void 0===a){a=1;var b=this.gl,d=this.extTextureFilterAnisotropic;d&&(a=b.getParameter(d.MAX_TEXTURE_MAX_ANISOTROPY_EXT))}return a}}()});
Object.defineProperty(k.prototype,"maxPixelRatio",{get:function(){return this._maxPixelRatio},set:function(a){this._maxPixelRatio=a;this.resizeCanvas(this._width,this._height)}});return{UnsupportedBrowserError:f,ContextCreationError:a,GraphicsDevice:k,precalculatedTangents:!0}}());pc.extend(pc,function(){var f={},a={};f.collectAttribs=function(a){for(var d={},e=0,g=a.indexOf("attribute");0<=g;){var f=a.indexOf(";",g),k=a.lastIndexOf(" ",f),f=a.substr(k+1,f-(k+1));"aPosition"==f?d.aPosition=pc.SEMANTIC_POSITION:(d[f]="ATTR"+e,e++);g=a.indexOf("attribute",g+1)}return d};f.createShader=function(a,d,e){d=f[d];e=pc.programlib.getSnippet(a,"fs_precision")+"\n"+f[e];attribs=this.collectAttribs(d);return new pc.Shader(a,{attributes:attribs,vshader:d,fshader:e})};f.createShaderFromCode=
function(b,d,e,g){var f=a[g];if(void 0!==f)return f;e=pc.programlib.getSnippet(b,"fs_precision")+"\n"+e;attribs=this.collectAttribs(d);a[g]=new pc.Shader(b,{attributes:attribs,vshader:d,fshader:e});return a[g]};return{shaderChunks:f}}());pc.extend(pc,function(){var f=null;return{drawQuadWithShader:function(a,b,d,e){if(null===f){var g=new pc.VertexFormat(a,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.ELEMENTTYPE_FLOAT32}]);f=new pc.VertexBuffer(a,g,4);g=new pc.VertexIterator(f);g.element[pc.SEMANTIC_POSITION].set(-1,-1);g.next();g.element[pc.SEMANTIC_POSITION].set(1,-1);g.next();g.element[pc.SEMANTIC_POSITION].set(-1,1);g.next();g.element[pc.SEMANTIC_POSITION].set(1,1);g.end()}a.setRenderTarget(b);a.updateBegin();var h;e?(b=
e.x,h=e.y,g=e.z,e=e.w):(g=null!==b?b.width:a.width,e=null!==b?b.height:a.height,h=b=0);a.setViewport(b,h,g,e);a.setScissor(b,h,g,e);e=a.getDepthTest();g=a.getDepthWrite();a.setDepthTest(!1);a.setDepthWrite(!1);a.setBlending(!1);a.setVertexBuffer(f,0);a.setShader(d);a.draw({type:pc.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1});a.setDepthTest(e);a.setDepthWrite(g);a.updateEnd()}}}());pc.extend(pc,function(){function f(){for(var a=Date.now()+10;Date.now()<a;);}function a(a,b,g){var f=b._colorBuffer;if(f.format==pc.PIXELFORMAT_R8_G8_B8_A8){var k=new Uint8Array(4*f.width*f.height),a=a.gl;a.bindFramebuffer(a.FRAMEBUFFER,b._glFrameBuffer);a.readPixels(0,0,f.width,f.height,a.RGBA,a.UNSIGNED_BYTE,k);f._levels||(f._levels=[]);f._levels[0]||(f._levels[0]=[]);f._levels[0][g]=k}}function b(a,b){return Math.atan2(a*b,Math.sqrt(a*a+b*b+1))}return{prefilterCubemap:function(b){var e=b.device,
g=b.sourceCubemap,h=b.method,k=b.samples,m=b.cpuSync,r=b.chromeFix;if(m&&!g._levels[0])console.error("ERROR: prefilter: cubemap must have _levels");else{var u=pc.shaderChunks,l=g.rgbm,k=u.createShaderFromCode(e,u.fullscreenQuadVS,u.rgbmPS+u.prefilterCubemapPS.replace(/\$METHOD/g,0===h?"cos":"phong").replace(/\$NUMSAMPLES/g,k).replace(/\$textureCube/g,l?"textureCubeRGBM":"textureCube"),"prefilter"+h+""+k+""+l),n=u.createShaderFromCode(e,u.fullscreenQuadVS,u.outputCubemapPS,"outputCubemap"),w=e.scope.resolve("source"),
s=e.scope.resolve("params"),B=new pc.Vec4,y=g.width,u=g.format,x=[[],b.filteredFixed,b.filteredRgbm,b.filteredFixedRgbm],A=0===h?[0.9,0.85,0.7,0.4,0.25]:[512,128,32,8,2],D=[64,32,16,8,4],C,z,E;z=u===pc.PIXELFORMAT_R8_G8_B8;C=!1;var F;m&&(C=g._levels[0][0]instanceof HTMLImageElement);if((z||C)&&m){u=pc.PIXELFORMAT_R8_G8_B8_A8;F=new pc.gfx.Texture(e,{cubemap:!0,rgbm:l,format:u,width:y,height:y,autoMipmap:!1});F.minFilter=pc.FILTER_LINEAR;F.magFilter=pc.FILTER_LINEAR;F.addressU=pc.ADDRESS_CLAMP_TO_EDGE;
F.addressV=pc.ADDRESS_CLAMP_TO_EDGE;for(E=0;6>E;E++)C=new pc.RenderTarget(e,F,{face:E,depth:!1}),B.x=E,B.y=0,w.setValue(g),s.setValue(B.data),r&&f(),pc.drawQuadWithShader(e,C,n),a(e,C,E);g=F}if(128<y){z=Math.round(Math.log2(128));var N=Math.round(Math.log2(y))-z;for(z=0;z<N;z++){var y=0.5*g.width,J=0===h?1:Math.pow(2,Math.round(Math.log2(A[0])+2*(N-z)));F=new pc.gfx.Texture(e,{cubemap:!0,rgbm:l,format:u,width:y,height:y,autoMipmap:!1});F.minFilter=pc.FILTER_LINEAR;F.magFilter=pc.FILTER_LINEAR;F.addressU=
pc.ADDRESS_CLAMP_TO_EDGE;F.addressV=pc.ADDRESS_CLAMP_TO_EDGE;for(E=0;6>E;E++)C=new pc.RenderTarget(e,F,{face:E,depth:!1}),B.x=E,B.y=J,B.z=y,B.w=l?3:0,w.setValue(g),s.setValue(B.data),r&&f(),pc.drawQuadWithShader(e,C,n),z===N-1&&m&&a(e,C,E);g=F}}b.sourceCubemap=g;F=null;if(!l&&b.filteredFixedRgbm){F=new pc.gfx.Texture(e,{cubemap:!0,rgbm:!0,format:pc.PIXELFORMAT_R8_G8_B8_A8,width:y,height:y,autoMipmap:!1});F.minFilter=pc.FILTER_LINEAR;F.magFilter=pc.FILTER_LINEAR;F.addressU=pc.ADDRESS_CLAMP_TO_EDGE;
F.addressV=pc.ADDRESS_CLAMP_TO_EDGE;for(E=0;6>E;E++)C=new pc.RenderTarget(e,F,{face:E,depth:!1}),B.x=E,B.w=2,w.setValue(g),s.setValue(B.data),r&&f(),pc.drawQuadWithShader(e,C,n),a(e,C,E)}y=0===h?1:2048;C=0===h?0:-1;x[C]=[];for(z=0;5>z;z++)for(n=C;n<x.length;n++)null!=x[n]&&(x[n][z]=new pc.gfx.Texture(e,{cubemap:!0,rgbm:2>n?l:!0,format:2>n?u:pc.PIXELFORMAT_R8_G8_B8_A8,fixCubemapSeams:1===n||3===n,width:D[z],height:D[z],autoMipmap:!1}),x[n][z].minFilter=pc.FILTER_LINEAR,x[n][z].magFilter=pc.FILTER_LINEAR,
x[n][z].addressU=pc.ADDRESS_CLAMP_TO_EDGE,x[n][z].addressV=pc.ADDRESS_CLAMP_TO_EDGE);for(n=C;n<x.length;n++)if(null!=x[n])if(1<n&&l)x[n]=x[n-2];else for(z=0;5>z;z++)for(E=0;6>E;E++)C=new pc.RenderTarget(e,x[n][z],{face:E,depth:!1}),B.x=E,B.y=0>n?y:A[z],B.z=D[z],B.w=l?3:n,w.setValue(0===z?g:0===h?x[0][z-1]:x[-1][z-1]),s.setValue(B.data),r&&f(),pc.drawQuadWithShader(e,C,k),m&&a(e,C,E);b.filtered=x[0];if(m&&b.singleFilteredFixed){g=[g,b.filteredFixed[0],b.filteredFixed[1],b.filteredFixed[2],b.filteredFixed[3],
b.filteredFixed[4],b.filteredFixed[5]];l=new pc.gfx.Texture(e,{cubemap:!0,rgbm:l,fixCubemapSeams:!0,format:u,width:128,height:128,autoMipmap:!1});for(z=0;6>z;z++)l._levels[z]=g[z]._levels[0];l.addressU=pc.ADDRESS_CLAMP_TO_EDGE;l.addressV=pc.ADDRESS_CLAMP_TO_EDGE;l.upload();l.minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR;l.magFilter=pc.FILTER_LINEAR;l._prefilteredMips=!0;b.singleFilteredFixed=l}if(m&&b.singleFilteredFixedRgbm&&b.filteredFixedRgbm){g=[F,b.filteredFixedRgbm[0],b.filteredFixedRgbm[1],b.filteredFixedRgbm[2],
b.filteredFixedRgbm[3],b.filteredFixedRgbm[4],b.filteredFixedRgbm[5]];l=new pc.gfx.Texture(e,{cubemap:!0,rgbm:!0,fixCubemapSeams:!0,format:pc.PIXELFORMAT_R8_G8_B8_A8,width:128,height:128,autoMipmap:!1});for(z=0;6>z;z++)l._levels[z]=g[z]._levels[0];l.addressU=pc.ADDRESS_CLAMP_TO_EDGE;l.addressV=pc.ADDRESS_CLAMP_TO_EDGE;l.upload();l.minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR;l.magFilter=pc.FILTER_LINEAR;l._prefilteredMips=!0;b.singleFilteredFixedRgbm=l}}},shFromCubemap:function(a,e){var g,f=a.width;if(a.format!=
pc.PIXELFORMAT_R8_G8_B8_A8)console.error("ERROR: SH: cubemap must be RGBA8");else{if(a._levels[0]){if(!a._levels[0][0].length)if(a._levels[0][0]instanceof HTMLImageElement){var k=pc.Application.getApplication().graphicsDevice,m=k.gl;g=pc.shaderChunks;var r=g.createShaderFromCode(k,g.fullscreenQuadVS,g.fullscreenQuadPS,"fsQuadSimple"),u=k.scope.resolve("source");for(g=0;6>g;g++){var l=a._levels[0][g],n=new pc.gfx.Texture(k,{cubemap:!1,rgbm:!1,format:a.format,width:f,height:f,autoMipmap:!1});n.minFilter=
pc.FILTER_NEAREST;n.magFilter=pc.FILTER_NEAREST;n.addressU=pc.ADDRESS_CLAMP_TO_EDGE;n.addressV=pc.ADDRESS_CLAMP_TO_EDGE;n._levels[0]=l;n.upload();l=new pc.gfx.Texture(k,{cubemap:!1,rgbm:!1,format:a.format,width:f,height:f,autoMipmap:!1});l.minFilter=pc.FILTER_NEAREST;l.magFilter=pc.FILTER_NEAREST;l.addressU=pc.ADDRESS_CLAMP_TO_EDGE;l.addressV=pc.ADDRESS_CLAMP_TO_EDGE;targ=new pc.RenderTarget(k,l,{depth:!1});u.setValue(n);pc.drawQuadWithShader(k,targ,r);l=new Uint8Array(4*f*f);m.bindFramebuffer(m.FRAMEBUFFER,
targ._glFrameBuffer);m.readPixels(0,0,n.width,n.height,m.RGBA,m.UNSIGNED_BYTE,l);a._levels[0][g]=l}}else{console.error("ERROR: SH: cubemap must be composed of arrays or images");return}k=[];for(u=0;u<f;u++)for(r=0;r<f;r++)k[u*f+r]=(new pc.Vec3(2*(r/(f-1))-1,2*(u/(f-1))-1,1)).normalize();var m=new Float32Array(27),w,s,B,y,x,A,D;for(g=l=0;6>g;g++)for(u=0;u<f;u++)for(r=0;r<f;r++){n=u*f+r;y=r;w=u;s=f;var C=2*(y+0.5)/s-1,z=2*(w+0.5)/s-1,C=C*(1-1/s),z=z*(1-1/s),E=1/s;B=C-E;var F=z-E,C=C+E,z=z+E;B=b(B,F)-
b(B,z)-b(C,F)+b(C,z);if(0===y&&0===w||y===s-1&&0===w||0===y&&w===s-1||y===s-1&&w===s-1)B/=3;else if(0===y||0===w||y===s-1||w===s-1)B*=0.5;y=B;weight1=4*y/17;weight2=8*y/17;weight3=15*y/17;weight4=5*y/68;weight5=15*y/68;w=k[n];0==g?(x=w.z,A=-w.y,D=-w.x):1==g?(x=-w.z,A=-w.y,D=w.x):2==g?(x=w.x,A=w.z,D=w.y):3==g?(x=w.x,A=-w.z,D=-w.y):4==g?(x=w.x,A=-w.y,D=w.z):5==g&&(x=-w.x,A=-w.y,D=-w.z);e||(x=-x);s=a._levels[0][g][4*n+3]/255;for(w=0;3>w;w++)B=a._levels[0][g][4*n+w]/255,a.rgbm?(B*=8*s,B*=B):B=Math.pow(B,
2.2),m[0+w]+=B*weight1,m[3+w]+=B*weight2*x,m[6+w]+=B*weight2*A,m[9+w]+=B*weight2*D,m[12+w]+=B*weight3*x*D,m[15+w]+=B*weight3*D*A,m[18+w]+=B*weight3*A*x,m[21+w]+=B*weight4*(3*D*D-1),m[24+w]+=B*weight5*(x*x-A*A),l+=y}for(w=0;w<m.length;w++)m[w]*=4*Math.PI/l;return m}console.error("ERROR: SH: cubemap must be synced to CPU")}}}}());pc.extend(pc,function(){return{paraboloidFromCubemap:function(f,a,b,d){var e=pc.shaderChunks,e=e.createShaderFromCode(f,e.fullscreenQuadVS,(a.fixCubemapSeams?e.fixCubemapSeamsStretchPS:e.fixCubemapSeamsNonePS)+e.genParaboloidPS,"genParaboloid"),g=f.scope.resolve("source"),h=f.scope.resolve("params"),k=new pc.Vec4,m=a.width,r=a.rgbm,u=a.format,m=2*Math.max(m,8),m=new pc.gfx.Texture(f,{rgbm:r,format:u,width:2*m,height:m,autoMipmap:!1});m.minFilter=pc.FILTER_LINEAR;m.magFilter=pc.FILTER_LINEAR;m.addressU=
pc.ADDRESS_CLAMP_TO_EDGE;m.addressV=pc.ADDRESS_CLAMP_TO_EDGE;r=new pc.RenderTarget(f,m,{depth:!1});k.x=b;k.y=d?-1:1;g.setValue(a);h.setValue(k.data);pc.drawQuadWithShader(f,r,e);return m},generateDpAtlas:function(f,a,b){var d,e;e=new pc.Vec4;var g=new pc.Vec4,h=4*a[0].width,k=pc.shaderChunks,k=k.createShaderFromCode(f,k.fullscreenQuadVS,k.dpAtlasQuadPS,"dpAtlasQuad"),m=f.scope.resolve("source"),r=f.scope.resolve("params"),u=new pc.gfx.Texture(f,{rgbm:a[0].rgbm,format:a[0].format,width:h,height:h,
autoMipmap:!1});u.minFilter=pc.FILTER_LINEAR;u.magFilter=pc.FILTER_LINEAR;u.addressU=pc.ADDRESS_CLAMP_TO_EDGE;u.addressV=pc.ADDRESS_CLAMP_TO_EDGE;for(var l=new pc.RenderTarget(f,u,{depth:!1}),n=(h+2)/h-1,w=0;6>w;w++){d=pc.paraboloidFromCubemap(f,a[w],w,b);m.setValue(d);d=e;var s=w;d.x=0.5*pc.math.clamp(s-2,0,1);var s=s-6*d.x,B=1-d.x;d.y=Math.min(0.5*s,0.75)*B+d.x;d.z=(1-0.5*pc.math.clamp(s,0,1))*B;d.w=0.5*d.z;d=1/d.z;g.x=d*n;g.y=2*g.x;g.x+=1;g.y+=1;r.setValue(g.data);e.x*=h;e.y*=h;e.z*=h;e.w*=h;pc.drawQuadWithShader(f,
l,k,e)}return u}}}());pc.shaderChunks.ambientPrefilteredCubeLodPS="void addAmbient() {\n    vec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n    fixedReflDir.x *= -1.0;\n    dDiffuseLight += processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) ).rgb);\n}\n\n";pc.shaderChunks.reflectionPrefilteredCubePS="uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\nuniform samplerCube texture_prefilteredCubeMap4;\nuniform float material_reflectivity;\n\nvoid addReflection() {\n\n    // Unfortunately, WebGL doesn't allow us using textureCubeLod. Therefore bunch of nasty workarounds is required.\n    // We fix mip0 to 128x128, so code is rather static.\n    // Mips smaller than 4x4 aren't great even for diffuse. Don't forget that we don't have bilinear filtering between different faces.\n\n    float bias = saturate(1.0 - dGlossiness) * 5.0; // multiply by max mip level\n    int index1 = int(bias);\n    int index2 = int(min(bias + 1.0, 7.0));\n\n    vec3 fixedReflDir = fixSeams(cubeMapProject(dReflDirW), bias);\n    fixedReflDir.x *= -1.0;\n\n    vec4 cubes[6];\n    cubes[0] = textureCube(texture_prefilteredCubeMap128, fixedReflDir);\n    cubes[1] = textureCube(texture_prefilteredCubeMap64, fixedReflDir);\n    cubes[2] = textureCube(texture_prefilteredCubeMap32, fixedReflDir);\n    cubes[3] = textureCube(texture_prefilteredCubeMap16, fixedReflDir);\n    cubes[4] = textureCube(texture_prefilteredCubeMap8, fixedReflDir);\n    cubes[5] = textureCube(texture_prefilteredCubeMap4, fixedReflDir);\n\n    // Also we don't have dynamic indexing in PS, so...\n    vec4 cube[2];\n    for(int i = 0; i < 6; i++) {\n        if (i == index1) {\n            cube[0] = cubes[i];\n        }\n        if (i == index2) {\n            cube[1] = cubes[i];\n        }\n    }\n\n    // another variant\n    /*if (index1==0){ cube[0]=cubes[0];\n    }else if (index1==1){ cube[0]=cubes[1];\n    }else if (index1==2){ cube[0]=cubes[2];\n    }else if (index1==3){ cube[0]=cubes[3];\n    }else if (index1==4){ cube[0]=cubes[4];\n    }else if (index1==5){ cube[0]=cubes[5];}\n\n    if (index2==0){ cube[1]=cubes[0];\n    }else if (index2==1){ cube[1]=cubes[1];\n    }else if (index2==2){ cube[1]=cubes[2];\n    }else if (index2==3){ cube[1]=cubes[3];\n    }else if (index2==4){ cube[1]=cubes[4];\n    }else if (index2==5){ cube[1]=cubes[5];}*/\n\n    vec4 cubeFinal = mix(cube[0], cube[1], fract(bias));\n    vec3 refl = processEnvironment($DECODE(cubeFinal).rgb);\n\n    dReflection += vec4(refl, material_reflectivity);\n}\n\n";
pc.shaderChunks.ambientSHPS="uniform vec3 ambientSH[9];\nvoid addAmbient() {\n    vec3 n = dNormalW;\n\n    vec3 color =\n                        ambientSH[0] +\n                        ambientSH[1] * n.x +\n                        ambientSH[2] * n.y +\n                        ambientSH[3] * n.z +\n                        ambientSH[4] * n.x * n.z +\n                        ambientSH[5] * n.z * n.y +\n                        ambientSH[6] * n.y * n.x +\n                        ambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n                        ambientSH[8] * (n.x * n.x - n.y * n.y);\n\n    dDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n\n";
pc.shaderChunks.normalMapPS="uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    dNormalMap = normalMap;\n    dNormalW = dTBN * normalMap;\n}\n\n";pc.shaderChunks.gamma2_2FastPS="vec3 gammaCorrectInput(vec3 color) {\n    return color * (color * (color * 0.305306011 + 0.682171111) + 0.012522878);\n}\n\nfloat gammaCorrectInput(float color) {\n    return color * (color * (color * 0.305306011 + 0.682171111) + 0.012522878);\n}\n\nvec4 gammaCorrectInput(vec4 color) {\n    return vec4(gammaCorrectInput(color.rgb), color.a);\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    vec4 rgba = texture2D(tex, uv);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    vec4 rgba = textureCube(tex, uvw);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n    color += vec3(0.0000001);\n    return pow(color, vec3(0.45));\n}\n\n";
pc.shaderChunks.particle_pointAlongVS="    angle = atan(velocityV.x, velocityV.y); // not the fastest way, but easier to plug in; TODO: create rot matrix right from vectors\n\n";pc.shaderChunks.glossConstPS="uniform float material_shininess;\nvoid getGlossiness() {\n    dGlossiness = material_shininess + 0.0000001;\n}\n\n";pc.shaderChunks.tonemappingFilmicPS="const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\n\nuniform float exposure;\n\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\n\nvec3 toneMap(vec3 color) {\n    color = uncharted2Tonemap(color * exposure);\n    vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n    color = color * whiteScale;\n\n    return color;\n}\n\n";
pc.shaderChunks.skyboxPS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n\nvoid main(void) {\n    gl_FragColor = textureCube(texture_cubeMap, fixSeams(vViewDir));\n}\n\n";pc.shaderChunks.particleUpdaterAABBPS="uniform mat3 spawnBounds;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    return emitterPos + spawnBounds * (inBounds - vec3(0.5));\n}\n\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity -= vec3(0, 0, initialVelocity);\n}\n\n";
pc.shaderChunks.uv1VS="\nvec2 getUv1() {\n    return vertex_texCoord1;\n}\n";pc.shaderChunks.emissiveVertPS="vec3 getEmission() {\n    return gammaCorrectInput(saturate(vVertexColor.$CH));\n}\n\n";pc.shaderChunks.particle_cpu_endVS="\n    localPos *= particle_vertexData2.y * emitterScale;\n    localPos += particlePos;\n\n    gl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n}\n\n";pc.shaderChunks.normalVertexPS="void getNormal() {\n    dNormalW = normalize(vNormalW);\n}\n\n";
pc.shaderChunks.lightSpecularPhongPS="float getLightSpecular() {\n    float specPow = dGlossiness;\n\n    specPow = antiAliasGlossiness(specPow);\n\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    return pow(max(dot(dReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\n\n";pc.shaderChunks.reflectionDpAtlasPS="uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\n\nvec2 getDpAtlasUv(vec2 uv, float mip) {\n\n    vec4 rect;\n    float sx = saturate(mip - 2.0);\n    rect.x = sx * 0.5;\n\n    float t = mip - rect.x * 6.0;\n    float i = 1.0 - rect.x;\n    rect.y = min(t * 0.5, 0.75) * i + rect.x;\n\n    float st = saturate(t);\n    rect.z = (1.0 - st * 0.5) * i;\n    rect.w = rect.z * 0.5;\n\n    float rcRectZ = 1.0 / rect.z;\n    float scaleFactor = 0.00390625 * rcRectZ; // 0.0078125 = (256 + 2) / 256 - 1, 0.00390625 same for 512\n    vec2 scale = vec2(scaleFactor, scaleFactor * 2.0);\n    uv = uv * (vec2(1.0) - scale) + scale * 0.5;\n\n    uv = uv * rect.zw + rect.xy;\n\n    return uv;\n}\n\nvoid addReflection() {\n\n    vec3 reflDir = normalize(cubeMapProject(dReflDirW));\n\n    // Convert vector to DP coords\n    bool up = reflDir.y > 0.0;\n    float scale = 0.90909090909090909090909090909091;// 1.0 / 1.1;\n    vec3 reflDirWarp = reflDir.xzx * vec3(-0.25, 0.5, 0.25);\n    float reflDirVer = abs(reflDir.y) + 1.0;\n    reflDirWarp /= reflDirVer;\n    reflDirWarp *= scale;\n    reflDirWarp = vec3(0.75, 0.5, 0.25) - reflDirWarp;\n    vec2 tc = up? reflDirWarp.xy : reflDirWarp.zy;\n\n    float bias = saturate(1.0 - dGlossiness) * 5.0; // multiply by max mip level\n\n    float mip = floor(bias);\n    vec3 tex1 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\n    mip = min(mip + 1.0, 5.0);\n    vec3 tex2 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\n    tex1 = mix(tex1, tex2, fract(bias));\n    tex1 = processEnvironment(tex1);\n\n    dReflection += vec4(tex1, material_reflectivity);\n}\n\n\n";
pc.shaderChunks.refractionPS="uniform float material_refraction, material_refractionIndex;\n\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n    float vn = dot(viewVec, Normal);\n    float k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n    vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n    return refrVec;\n}\n\nvoid addRefraction() {\n\n    // use same reflection code with refraction vector\n    vec3 tmp = dReflDirW;\n    vec4 tmp2 = dReflection;\n    dReflection = vec4(0.0);\n    dReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n\n    addReflection();\n\n    dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n    dReflDirW = tmp;\n    dReflection = tmp2;\n}\n\n";
pc.shaderChunks.metalnessTexConstPS="uniform sampler2D texture_metalnessMap;\nuniform float material_metalness;\nvoid getSpecularity() {\n    processMetalness(texture2D(texture_metalnessMap, $UV).$CH * material_metalness);\n}\n\n";pc.shaderChunks.diffuseVertPS="void getAlbedo() {\n    dAlbedo = gammaCorrectInput(saturate(vVertexColor.$CH));\n}\n\n";pc.shaderChunks.particleAnimFrameLoopVS="\n    float animFrame = floor(texCoordsAlphaLife.w * animTexParams.z);\n\n";pc.shaderChunks.spotPS="float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n    float cosAngle = dot(dLightDirNormW, lightSpotDirW);\n    return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n\n";
pc.shaderChunks.transformInstancedVS="mat4 getModelMatrix() {\n    return mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n}\n\nvec4 getPosition() {\n    dModelMatrix = getModelMatrix();\n    vec4 posW = dModelMatrix * vec4(vertex_position, 1.0);\n    dPositionW = posW.xyz;\n    return matrix_viewProjection * posW;\n}\n\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n\n";pc.shaderChunks.normalMapFloatPS="uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    dNormalMap = normalMap;\n    normalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n    dNormalW = dTBN * normalMap;\n}\n\n";
pc.shaderChunks.combineDiffuseSpecularOldPS="vec3 combineColor() {\n    return mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n\n";pc.shaderChunks.particleUpdaterStartPS="float saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\n\nvec3 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex, tc);\n    vec4 b = texture2D(tex, tc + graphSampleSize);\n    float c = fract(tc.x * graphNumSamples);\n\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n\n    return mix(a.xyz, b.xyz, c);\n}\n\nvoid main(void)\n{\n    if (gl_FragCoord.x > numParticles) discard;\n    float outMask0 = gl_FragCoord.y < 1.0? 1.0 : 0.0;\n    float outMask1 = (gl_FragCoord.y < 2.0 && gl_FragCoord.y >= 1.0)? 1.0 : 0.0;\n    float outMask2 = (gl_FragCoord.y < 3.0 && gl_FragCoord.y >= 2.0)? 1.0 : 0.0;\n\n    vec4 tex = texture2D(particleTexIN, vec2(vUv0.x, 0.125));\n    vec4 tex2 = texture2D(particleTexIN, vec2(vUv0.x, 0.375));\n    vec4 texR = texture2D(particleTexIN, vec2(vUv0.x, 0.625));\n\n    vec4 rndFactor = fract(texR + vec4(seed));\n    float particleLifetime = lifetime;\n    float life = tex2.w + delta;\n    float particleRate = rate + rateDiv * rndFactor.x;\n\n        float nlife = clamp(life / particleLifetime, 0.0, 1.0);\n        vec3 localVelocityDiv;\n        vec3 velocityDiv;\n        vec3 paramDiv;\n        vec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n        vec3 velocity =      tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n        vec3 params =        tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n        float rotSpeed = params.x;\n        float rotSpeedDiv = paramDiv.y;\n        float angle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n        float visMode = tex.w < 0.0? -1.0 : 1.0;\n\n        localVelocity +=    (localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n        velocity +=         (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n        rotSpeed +=         (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\n        addInitialVelocity(localVelocity, rndFactor.xyz);\n\n        vec3 outVelocity = emitterMatrix * localVelocity.xyz + velocity.xyz * emitterScale;\n        vec3 outPosition = tex.xyz + outVelocity * delta;\n        float outRotation = angle + rotSpeed * delta;\n\n        bool respawn = life <= 0.0 || life >= particleLifetime;\n        outPosition = respawn? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : outPosition;\n        outRotation = respawn? mix(startAngle, startAngle2, rndFactor.x) : outRotation;\n        outVelocity = respawn? vec3(0.0) : outVelocity;\n";
pc.shaderChunks.opacityTexPS="uniform sampler2D texture_opacityMap;\nvoid getOpacity() {\n    dAlpha = texture2D(texture_opacityMap, $UV).$CH;\n}\n\n";pc.shaderChunks.emissiveTexConstPS="uniform sampler2D texture_emissiveMap;\nuniform vec3 material_emissive;\nvec3 getEmission() {\n    return $texture2DSAMPLE(texture_emissiveMap, $UV).$CH * material_emissive;\n}\n\n";pc.shaderChunks.normalVS="vec3 getNormal() {\n    dNormalMatrix = matrix_normal;\n    return normalize(dNormalMatrix * vertex_normal);\n}\n\n";
pc.shaderChunks.particle_stretchVS="    vec3 moveDir = particleVelocity * stretch;\n    vec3 posPrev = pos - moveDir;\n    posPrev += particlePosMoved;\n\n    vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\n    float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\n    particlePos = mix(particlePos, posPrev, interpolation);\n\n";pc.shaderChunks.reflDirPS="void getReflDir() {\n    dReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n}\n\n";
pc.shaderChunks.skyboxHDRPS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n\nvoid main(void) {\n    vec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(vViewDir, $FIXCONST)).rgb);\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n\n";pc.shaderChunks.reflectionPrefilteredCubeLodPS="#extension GL_EXT_shader_texture_lod : enable\n\nuniform samplerCube texture_prefilteredCubeMap128;\nuniform float material_reflectivity;\n\nvoid addReflection() {\n\n    float bias = saturate(1.0 - dGlossiness) * 5.0; // multiply by max mip level\n    vec3 fixedReflDir = fixSeams(cubeMapProject(dReflDirW), bias);\n    fixedReflDir.x *= -1.0;\n\n    vec3 refl = processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) ).rgb);\n\n    dReflection += vec4(refl, material_reflectivity);\n}\n\n";
pc.shaderChunks.reflectionSpherePS="uniform mat4 matrix_view;\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvoid addReflection() {\n\n    vec3 reflDirV = (mat3(matrix_view) * dReflDirW).xyz;\n\n    float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n    vec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\n    dReflection += vec4($texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb, material_reflectivity);\n}\n\n\n";
pc.shaderChunks.specularVertConstPS="uniform vec3 material_specular;\nvoid getSpecularity() {\n    dSpecularity = saturate(vVertexColor.$CH) * material_specular;\n}\n\n";pc.shaderChunks.tonemappingNonePS="vec3 toneMap(vec3 color) {\n    return color;\n}\n\n";pc.shaderChunks.shadowVSPS="\nfloat getShadowHardVS(sampler2D shadowMap, vec3 shadowParams) {\n    float depth = unpackFloat(texture2DProj(shadowMap, vMainShadowUv));\n    return (depth < min(vMainShadowUv.z + shadowParams.z, 1.0)) ? 0.0 : 1.0;\n}\n\nfloat getShadowMaskVS(sampler2D shadowMap, vec3 shadowParams) {\n    return unpackMask(texture2DProj(shadowMap, vMainShadowUv));\n}\n\nfloat getShadowPCF3x3VS(sampler2D shadowMap, vec3 shadowParams) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z += shadowParams.z;\n    dShadowCoord.xyz /= vMainShadowUv.w;\n    dShadowCoord.z = min(dShadowCoord.z, 1.0);\n    return _getShadowPCF3x3(shadowMap, shadowParams);\n}\n\nfloat getShadowPCF3x3_YZWVS(sampler2D shadowMap, vec3 shadowParams) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z += shadowParams.z;\n    dShadowCoord.xyz /= vMainShadowUv.w;\n    dShadowCoord.z = min(dShadowCoord.z, 1.0);\n    return _getShadowPCF3x3_YZW(shadowMap, shadowParams);\n}\n\n";
pc.shaderChunks.particle_lambertPS="\n    vec3 negNormal = max(normal, vec3(0.0));\n    vec3 posNormal = max(-normal, vec3(0.0));\n\n\n";pc.shaderChunks.viewNormalVS="\nuniform mat4 matrix_view;\nvec3 getViewNormal() {\n    return mat3(matrix_view) * vNormalW;\n}\n";pc.shaderChunks.packDepthPS="// Packing a float in GLSL with multiplication and mod\n// http://blog.gradientstudios.com/2012/08/23/shadow-map-improvement\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n\n\n";
pc.shaderChunks.basePS="\nuniform vec3 view_position;\n\nuniform vec3 light_globalAmbient;\n\nfloat square(float x) {\n    return x*x;\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec3 saturate(vec3 x) {\n    return clamp(x, vec3(0.0), vec3(1.0));\n}\n\n";pc.shaderChunks.dpAtlasQuadPS="varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec4 params;\n\nvoid main(void) {\n    vec2 uv = vUv0;\n    uv = uv * 2.0 - vec2(1.0);\n    uv *= params.xy;\n    uv = uv * 0.5 + 0.5;\n    gl_FragColor = texture2D(source, uv);\n}\n";
pc.shaderChunks.fullscreenQuadPS="varying vec2 vUv0;\nuniform sampler2D source;\n\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n";pc.shaderChunks.lightDirPointPS="void getLightDirPoint(vec3 lightPosW) {\n    dLightDirW = vPositionW - lightPosW;\n    dLightDirNormW = normalize(dLightDirW);\n    dLightPosW = lightPosW;\n}\n\n";pc.shaderChunks.transformSkinnedVS="mat4 getModelMatrix() {\n    return getBoneMatrix(vertex_boneIndices.x) * vertex_boneWeights.x +\n           getBoneMatrix(vertex_boneIndices.y) * vertex_boneWeights.y +\n           getBoneMatrix(vertex_boneIndices.z) * vertex_boneWeights.z +\n           getBoneMatrix(vertex_boneIndices.w) * vertex_boneWeights.w;\n}\n\nvec4 getPosition() {\n    dModelMatrix = getModelMatrix();\n    vec4 posW = dModelMatrix * vec4(vertex_position, 1.0);\n    //posW.xyz /= posW.w;\n    posW.xyz += skinPosOffset;\n    dPositionW = posW.xyz;// / posW.w;\n    return matrix_viewProjection * posW;\n}\n\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n\n";
pc.shaderChunks.particle_lightingPS="\n    vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n                        negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n                        negNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\n\n    rgb *= light;\n\n\n";pc.shaderChunks.particle_blendMultiplyPS="\n    rgb = mix(vec3(1.0), rgb, vec3(a));\n    if (rgb.r + rgb.g + rgb.b > 2.99) discard;\n\n";pc.shaderChunks.dilatePS="varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n    vec4 c = texture2D(source, vUv0);\n    c = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n    gl_FragColor = c;\n}\n\n";
pc.shaderChunks.particleUpdaterEndPS="\n   tex = vec4(outPosition, (outRotation + 1000.0) * visMode) * outMask0 +\n          vec4(outVelocity, life) * outMask1 +\n          texR * outMask2;\n\n    gl_FragColor = tex;\n}\n\n";pc.shaderChunks.extensionVS="\n";pc.shaderChunks.skyboxPrefilteredCubePS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n    float scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvoid main(void) {\n    vec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n\n";
pc.shaderChunks.particle_normalMapPS="\n    vec3 normalMap         = normalize( texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0 );\n    vec3 normal = ParticleMat * normalMap;\n\n\n\n\n";pc.shaderChunks.metalnessPS="void processMetalness(float metalness) {\n    const float dielectricF0 = 0.04;\n    dSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n    dAlbedo *= 1.0 - metalness;\n}\n\n";pc.shaderChunks.aoSpecOccConstSimplePS="void occludeSpecular() {\n    float specOcc = dAo;\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n\n";
pc.shaderChunks.particleVS="attribute vec4 particle_vertexData; // XYZ = particle position, W = particle ID + random factor\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform mat4 matrix_view;\n\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\n\nvarying vec4 texCoordsAlphaLife;\n\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc) {\n    return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\n\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex,tc);\n    vec4 b = texture2D(tex,tc + graphSampleSize);\n    float c = fract(tc.x*graphNumSamples);\n\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n\n    return mix(a, b, c);\n}\n\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n\n    return m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY, out mat3 localMat) {\n    vec3 viewUp = matrix_viewInverse[1].xyz;\n    vec3 posCam = matrix_viewInverse[3].xyz;\n\n    mat3 billMat;\n    billMat[2] = normalize(InstanceCoords - posCam);\n    billMat[0] = normalize(cross(viewUp, billMat[2]));\n    billMat[1] = -viewUp;\n    vec3 pos = billMat * vec3(quadXY, 0);\n\n    localMat = billMat;\n\n    return pos;\n}\n\nvoid main(void) {\n    vec3 meshLocalPos = particle_vertexData.xyz;\n    float id = floor(particle_vertexData.w);\n\n    float rndFactor = fract(sin(id + 1.0 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n    vec4 particleTex = texture2D(particleTexOUT, vec2(id / numParticlesPot, 0.125));\n    vec3 pos = particleTex.xyz;\n    float angle = (particleTex.w < 0.0? -particleTex.w : particleTex.w) - 1000.0;\n    bool hide = particleTex.w < 0.0;\n\n    vec4 particleTex2 = texture2D(particleTexOUT, vec2(id / numParticlesPot, 0.375));\n    vec3 particleVelocity = particleTex2.xyz;\n    vec2 velocityV = normalize((mat3(matrix_view) * particleVelocity).xy); // should be removed by compiler if align/stretch is not used\n    float life = particleTex2.w;\n\n    float particleLifetime = lifetime;\n\n    if (life <= 0.0 || life > particleLifetime || hide) meshLocalPos = vec3(0.0);\n    vec2 quadXY = meshLocalPos.xy;\n    float nlife = clamp(life / particleLifetime, 0.0, 1.0);\n\n    vec3 paramDiv;\n    vec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float scale = params.y;\n    float scaleDiv = paramDiv.x;\n    float alphaDiv = paramDiv.z;\n\n    scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5,    (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0),    nlife);\n\n    vec3 particlePos = pos;\n    vec3 particlePosMoved = vec3(0.0);\n\n    mat2 rotMatrix;\n    mat3 localMat;\n\n\n";
pc.shaderChunks.normalXYPS="vec3 unpackNormal(vec4 nmap) {\n    vec3 normal;\n    normal.xy = nmap.wy * 2.0 - 1.0;\n    normal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n    return normal;\n}\n\n";pc.shaderChunks.outputCubemapPS="varying vec2 vUv0;\n\nuniform samplerCube source;\nuniform vec4 params;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec4 encodeRGBM(vec4 color) { // modified RGBM\n    color.rgb = pow(color.rgb, vec3(0.5));\n    color.rgb *= 1.0 / 8.0;\n\n    color.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n    color.a = ceil(color.a * 255.0) / 255.0;\n\n    color.rgb /= color.a;\n    return color;\n}\n\nvoid main(void) {\n\n    vec2 st = vUv0 * 2.0 - 1.0;\n    float face = params.x;\n\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n\n    gl_FragColor = textureCube(source, vec);\n    if (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n\n";
pc.shaderChunks.normalXYZPS="vec3 unpackNormal(vec4 nmap) {\n    return nmap.xyz * 2.0 - 1.0;\n}\n\n";pc.shaderChunks.metalnessConstPS="uniform float material_metalness;\nvoid getSpecularity() {\n    processMetalness(material_metalness);\n}\n\n";pc.shaderChunks.reflectionSphereLowPS="uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvoid addReflection() {\n\n    vec3 reflDirV = vNormalV;\n\n    vec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n    dReflection += vec4($texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb, material_reflectivity);\n}\n\n";
pc.shaderChunks.outputAlphaPremulPS="gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n";pc.shaderChunks.parallaxPS="uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax() {\n    float parallaxScale = material_heightMapFactor;\n    const float parallaxBias = 0.01;\n\n    float height = texture2D(texture_heightMap, $UV).$CH * parallaxScale - parallaxBias;\n    vec3 viewDirT = dViewDirW * dTBN;\n\n    dUvOffset = min(height * viewDirT.xy, vec2(parallaxBias));\n}\n\n";
pc.shaderChunks.particle_blendNormalPS="\n    if (a < 0.01) discard;\n";pc.shaderChunks.specularAaToksvigPS="float antiAliasGlossiness(float power) {\n    float rlen = 1.0 / saturate(length(dNormalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * toksvig;\n}\n\n";pc.shaderChunks.emissiveConstPS="uniform vec3 material_emissive;\nvec3 getEmission() {\n    return material_emissive;\n}\n\n";pc.shaderChunks.TBNfastPS="void getTBN() {\n    dTBN = mat3((vTangentW), (vBinormalW), (vNormalW));\n}\n\n";
pc.shaderChunks.aoSpecOccPS="uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n    specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n\n";
pc.shaderChunks.gamma2_2PS="vec3 gammaCorrectInput(vec3 color) {\n    return pow(color, vec3(2.2));\n}\n\nfloat gammaCorrectInput(float color) {\n    return pow(color, 2.2);\n}\n\nvec4 gammaCorrectInput(vec4 color) {\n    return vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    vec4 rgba = texture2D(tex, uv);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    vec4 rgba = textureCube(tex, uvw);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n    color += vec3(0.0000001);\n    return pow(color, vec3(0.45));\n}\n\n";
pc.shaderChunks.particle_blendAddPS="\n    rgb *= gammaCorrectInput(a);\n    if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n\n";pc.shaderChunks.startVS="\nvoid main(void) {\n    gl_Position = getPosition();\n";pc.shaderChunks.normalSkinnedVS="vec3 getNormal() {\n    dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n\n";pc.shaderChunks.particleUpdaterRespawnPS="    if (life >= particleLifetime) {\n        life -= max(particleLifetime, (numParticles - 1.0) * particleRate);\n        visMode = 1.0;\n    }\n    visMode = life < 0.0? 1.0: visMode;\n\n";
pc.shaderChunks.bakeLmEndPS="\ngl_FragColor.rgb = dDiffuseLight;\ngl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\ngl_FragColor.rgb /= 8.0;\ngl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\ngl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\ngl_FragColor.rgb /= gl_FragColor.a;\n\n";pc.shaderChunks.lightmapSingleVertPS="void addLightMap() {\n    dDiffuseLight += saturate(vVertexColor.$CH);\n}\n\n";
pc.shaderChunks.opacityConstPS="uniform float material_opacity;\nvoid getOpacity() {\n    dAlpha = material_opacity;\n}\n\n";pc.shaderChunks.baseVS="\nattribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\n\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\nvec3 dLightPosW;\nvec3 dLightDirNormW;\nvec3 dNormalW;\n\n";
pc.shaderChunks.glossVertPS="void getGlossiness() {\n    dGlossiness = saturate(vVertexColor.$CH) + 0.0000001;\n}\n\n";pc.shaderChunks.ambientPrefilteredCubePS="void addAmbient() {\n    vec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n    fixedReflDir.x *= -1.0;\n    dDiffuseLight += processEnvironment($DECODE(textureCube(texture_prefilteredCubeMap4, fixedReflDir)).rgb);\n}\n\n";pc.shaderChunks.aoSpecOccConstPS="void occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n\n";
pc.shaderChunks.particle_wrapVS="\n    vec3 origParticlePos = particlePos;\n    particlePos -= matrix_model[3].xyz;\n    particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n    particlePos += matrix_model[3].xyz;\n    particlePosMoved = particlePos - origParticlePos;\n\n\n";pc.shaderChunks.combineDiffuseSpecularPS="vec3 combineColor() {\n    return mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n\n";pc.shaderChunks.normalInstancedVS="vec3 getNormal() {\n    dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n\n";
pc.shaderChunks.glossTexConstPS="uniform sampler2D texture_glossMap;\nuniform float material_shininess;\nvoid getGlossiness() {\n    dGlossiness = material_shininess * texture2D(texture_glossMap, $UV).$CH + 0.0000001;\n}\n\n";pc.shaderChunks.fresnelSchlickPS="// Schlick's approximation\nuniform float material_fresnelFactor; // unused\nvoid getFresnel() {\n    float fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n    float fresnel2 = fresnel * fresnel;\n    fresnel *= fresnel2 * fresnel2;\n    fresnel *= dGlossiness * dGlossiness;\n    dSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n}\n\n";
pc.shaderChunks.diffuseConstPS="uniform vec3 material_diffuse;\nvoid getAlbedo() {\n    dAlbedo = material_diffuse.rgb;\n}\n\n";pc.shaderChunks.particle_normalVS="\n    Normal = normalize(localPos - localMat[2]);\n\n\n";pc.shaderChunks.combineDiffuseSpecularNoConservePS="vec3 combineColor() {\n    return dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n\n";pc.shaderChunks.uv0VS="\nvec2 getUv0() {\n    return vertex_texCoord0;\n}\n";
pc.shaderChunks.opacityVertConstPS="uniform float material_opacity;\nvoid getOpacity() {\n    dAlpha = saturate(vVertexColor.$CH) * material_opacity;\n}\n\n";pc.shaderChunks.emissiveTexPS="uniform sampler2D texture_emissiveMap;\nvec3 getEmission() {\n    return $texture2DSAMPLE(texture_emissiveMap, $UV).$CH;\n}\n\n";pc.shaderChunks.tonemappingLinearPS="uniform float exposure;\nvec3 toneMap(vec3 color) {\n    return color * exposure;\n}\n\n";pc.shaderChunks.genParaboloidPS="varying vec2 vUv0;\n\nuniform samplerCube source;\nuniform vec4 params; // x = mip\n\nvoid main(void) {\n\n    vec2 uv = vUv0;\n\n    float side = uv.x < 0.5? 1.0 : -1.0;\n    vec2 tc;\n    tc.x = fract(uv.x * 2.0) * 2.0 - 1.0;\n    tc.y = uv.y * 2.0 - 1.0;\n\n    // scale projection a bit to have a little overlap for filtering\n    const float scale = 1.1;\n    tc *= scale;\n\n    vec3 dir;\n    dir.y = (dot(tc, tc) - 1.0) * side; // from 1.0 center to 0.0 borders quadratically\n    dir.xz = tc * -2.0;\n\n    dir.x *= -side * params.y; // flip original cubemap x instead of doing it at runtime\n\n    dir = fixSeams(dir, params.x);\n\n    vec4 color = textureCube(source, dir, -100.0);\n    gl_FragColor = color;\n}\n";
pc.shaderChunks.specularAaNonePS="float antiAliasGlossiness(float power) {\n    return power;\n}\n\n";pc.shaderChunks.specularAaToksvigFloatPS="float antiAliasGlossiness(float power) {\n    float rlen = 1.0 / saturate(length(dNormalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * mix(1.0, toksvig, material_bumpiness);\n}\n\n";pc.shaderChunks.prefilterCubemapPS="varying vec2 vUv0;\n\nuniform samplerCube source;\nuniform vec4 params;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nfloat rnd(vec2 uv) {\n    return fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\n\nconst float PI = 3.14159265358979;\nvec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) { // cos + lerped cone size (better than just lerped)\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = sqrt(1.0 - uv.x);\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return normalize(mix(vecSpace * sampleDir, cubeDir, params.y));\n}\n\nvec3 hemisphereSample_phong(vec2 uv, mat3 vecSpace, vec3 cubeDir, float specPow) {\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return vecSpace * sampleDir;\n}\n\nmat3 matrixFromVector(vec3 n) { // frisvad\n    float a = 1.0 / (1.0 + n.z);\n    float b = -n.x * n.y * a;\n    vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n    vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n    return mat3(b1, b2, n);\n}\n\nvec4 encodeRGBM(vec3 color) { // modified RGBM\n    vec4 encoded;\n    encoded.rgb = pow(color.rgb, vec3(0.5));\n    encoded.rgb *= 1.0 / 8.0;\n\n    encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n    encoded.a = ceil(encoded.a * 255.0) / 255.0;\n\n    encoded.rgb /= encoded.a;\n    return encoded;\n}\n\nvoid main(void) {\n\n    vec2 st = vUv0 * 2.0 - 1.0;\n\n    if (params.w==1.0 || params.w==3.0) {\n        st = 2.0 * floor(gl_FragCoord.xy) / (params.z - 1.0) - 1.0;\n    }\n\n    float face = params.x;\n\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n\n    mat3 vecSpace = matrixFromVector(normalize(vec));\n\n    vec3 color = vec3(0.0);\n    const int samples = $NUMSAMPLES;\n    vec3 vect;\n    for(int i=0; i<samples; i++) {\n        float sini = sin(float(i));\n        float cosi = cos(float(i));\n        float rand = rnd(vec2(sini, cosi));\n\n        vect = hemisphereSample_$METHOD(vec2(float(i) / float(samples), rand), vecSpace, vec, params.y);\n\n        color += $textureCube(source, vect).rgb;\n    }\n    color /= float(samples);\n\n    gl_FragColor = params.w < 2.0? vec4(color, 1.0) : encodeRGBM(color);\n}\n";
pc.shaderChunks.particleAnimFrameClampVS="\n    float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.z), animTexParams.w);\n\n";pc.shaderChunks.glossVertConstPS="uniform float material_shininess;\nvoid getGlossiness() {\n    dGlossiness = material_shininess * saturate(vVertexColor.$CH) + 0.0000001;\n}\n\n";pc.shaderChunks.cubeMapProjectBoxPS="uniform vec3 envBoxMin, envBoxMax;\n\nvec3 cubeMapProject(vec3 nrdir) {\n    vec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n    vec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\n    vec3 rbminmax;\n    rbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n    rbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n    rbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\n    float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\n    vec3 posonbox = vPositionW + nrdir * fa;\n    vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n    return posonbox - envBoxPos;\n}\n\n";
pc.shaderChunks.fixCubemapSeamsStretchPS="vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    float scale = 1.0 - exp2(mipmapIndex) / 128.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvec3 fixSeams(vec3 vec) {\n    float scale = 1.0 - 1.0 / 128.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    float scale = invRecMipSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\n";
pc.shaderChunks.opacityTexConstPS="uniform sampler2D texture_opacityMap;\nuniform float material_opacity;\nvoid getOpacity() {\n    dAlpha = texture2D(texture_opacityMap, $UV).$CH * material_opacity;\n}\n\n";pc.shaderChunks.combineDiffuseSpecularNoReflSeparateAmbientPS="uniform vec3 material_ambient;\nvec3 combineColor() {\n    return (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n\n";
pc.shaderChunks.tangentBinormalVS="\nvec3 getTangent() {\n    return normalize(dNormalMatrix * vertex_tangent.xyz);\n}\n\nvec3 getBinormal() {\n    return cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n\n";pc.shaderChunks.emissiveVertConstPS="uniform vec3 material_emissive;\nvec3 getEmission() {\n    return gammaCorrectInput(saturate(vVertexColor.$CH)) * material_emissive;\n}\n\n";pc.shaderChunks.specularTexPS="uniform sampler2D texture_specularMap;\nvoid getSpecularity() {\n    dSpecularity = texture2D(texture_specularMap, $UV).$CH;\n}\n\n";
pc.shaderChunks.particle_TBNVS="\n    mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0,        rotMatrix[1][0], rotMatrix[1][1], 0.0,        0.0, 0.0, 1.0);\n    localMat[2] *= -1.0;\n    ParticleMat = localMat * rot3;\n\n\n\n\n";pc.shaderChunks.normalMapFloatTBNfastPS="uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    dNormalMap = normalMap;\n    normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);\n    dNormalW = normalize(dTBN * normalMap);\n}\n\n";
pc.shaderChunks.fixCubemapSeamsNonePS="vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    return vec;\n}\n\nvec3 fixSeams(vec3 vec) {\n    return vec;\n}\n\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    return vec;\n}\n";pc.shaderChunks.particle_cpuVS="attribute vec4 particle_vertexData;     // XYZ = world pos, W = life\nattribute vec4 particle_vertexData2;     // X = angle, Y = scale, Z = alpha, W = velocity.x\nattribute vec4 particle_vertexData3;     // XYZ = particle local pos, W = velocity.y\nattribute vec2 particle_vertexData4;     // X = velocity.z, W = particle ID\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat4 matrix_view;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\n//uniform float graphSampleSize;\n//uniform float graphNumSamples;\nuniform vec3 wrapBounds, emitterScale;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\n\nvarying vec4 texCoordsAlphaLife;\n\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n    //vec4 rotationMatrix = vec4(c, -s, s, c);\n\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n\n    return m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY, out mat3 localMat)\n{\n    vec3 viewUp = matrix_viewInverse[1].xyz;\n    vec3 posCam = matrix_viewInverse[3].xyz;\n\n    mat3 billMat;\n    billMat[2] = normalize(InstanceCoords - posCam);\n    billMat[0] = normalize(cross(viewUp, billMat[2]));\n    billMat[1] = -viewUp;\n    vec3 pos = billMat * vec3(quadXY, 0);\n\n    localMat = billMat;\n\n    return pos;\n}\n\n\nvoid main(void)\n{\n    vec3 particlePos = particle_vertexData.xyz;\n    vec3 pos = particlePos;\n    vec3 vertPos = particle_vertexData3.xyz;\n    vec3 particleVelocity = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData4.x);\n    vec2 velocityV = normalize((mat3(matrix_view) * particleVelocity).xy); // should be removed by compiler if align/stretch is not used\n\n    vec2 quadXY = vertPos.xy;\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n\n    mat2 rotMatrix;\n    mat3 localMat;\n\n    float angle = particle_vertexData2.x;\n    vec3 particlePosMoved = vec3(0.0);\n    vec3 meshLocalPos = particle_vertexData3.xyz;\n\n";
pc.shaderChunks.transformVS="mat4 getModelMatrix() {\n    return matrix_model;\n}\n\nvec4 getPosition() {\n    dModelMatrix = getModelMatrix();\n    vec4 posW = dModelMatrix * vec4(vertex_position, 1.0);\n    dPositionW = posW.xyz;\n    return matrix_viewProjection * posW;\n}\n\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n\n";pc.shaderChunks.specularVertPS="void getSpecularity() {\n    dSpecularity = saturate(vVertexColor.$CH);\n}\n\n";pc.shaderChunks.particleUpdaterNoRespawnPS="    if (life >= particleLifetime) {\n        life -= max(particleLifetime, (numParticles - 1.0) * particleRate);\n        visMode = -1.0;\n    }\n";
pc.shaderChunks.opacityVertPS="void getOpacity() {\n    dAlpha = saturate(vVertexColor.$CH);\n}\n\n";pc.shaderChunks.fogExpPS="uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n";pc.shaderChunks.metalnessTexPS="uniform sampler2D texture_metalnessMap;\nvoid getSpecularity() {\n    processMetalness(texture2D(texture_metalnessMap, $UV).$CH);\n}\n\n";
pc.shaderChunks.metalnessVertPS="void getSpecularity() {\n    processMetalness(saturate(vVertexColor.$CH));\n}\n\n";pc.shaderChunks.cubeMapProjectNonePS="vec3 cubeMapProject(vec3 dir) {\n    return dir;\n}\n\n";pc.shaderChunks.particle_billboardVS="\n    quadXY = rotate(quadXY, angle, rotMatrix);\n    vec3 localPos = billboard(particlePos, quadXY, localMat);\n\n";pc.shaderChunks.particleAnimTexVS="\n    float atlasX = animFrame * animTexParams.x;\n    float atlasY = floor(atlasX) * animTexParams.y;\n    atlasX = fract(atlasX);\n\n    texCoordsAlphaLife.xy *= animTexParams.xy;\n    texCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n    texCoordsAlphaLife.y = 1.0 - texCoordsAlphaLife.y;\n\n";
pc.shaderChunks.outputAlphaOpaquePS="gl_FragColor.a = 1.0;\n";pc.shaderChunks.glossTexPS="uniform sampler2D texture_glossMap;\nvoid getGlossiness() {\n    dGlossiness = texture2D(texture_glossMap, $UV).$CH + 0.0000001;\n}\n\n";pc.shaderChunks.combineDiffuseSpecularNoReflPS="vec3 combineColor() {\n    return dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n\n";pc.shaderChunks.particle_meshVS="\n    vec3 localPos = meshLocalPos;\n    localPos.xy = rotate(localPos.xy, angle, rotMatrix);\n    localPos.yz = rotate(localPos.yz, angle, rotMatrix);\n\n    billboard(particlePos, quadXY, localMat);\n\n\n";
pc.shaderChunks.particle_endPS="    rgb = addFog(rgb);\n    rgb = toneMap(rgb);\n    rgb = gammaCorrectOutput(rgb);\n    gl_FragColor = vec4(rgb, a);\n}\n";pc.shaderChunks.viewDirPS="void getViewDir() {\n    dViewDirW = normalize(view_position - vPositionW);\n}\n\n";pc.shaderChunks.shadowCoordPS="void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.z += shadowParams.z;\n    projPos.z = min(projPos.z, 1.0);\n    dShadowCoord = projPos.xyz;\n}\n\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xyz /= projPos.w;\n    projPos.z += shadowParams.z;\n    dShadowCoord = projPos.xyz;\n}\n\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n    _getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + vNormalW * shadowParams.y * clamp(1.0 - dot(vNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\n    _getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\n\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + vNormalW * shadowParams.y * clamp(1.0 - dot(vNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n\n";
pc.shaderChunks.fullscreenQuadVS="attribute vec2 aPosition;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(aPosition, 0.5, 1.0);\n    vUv0 = aPosition.xy*0.5+0.5;\n}\n\n";pc.shaderChunks.extensionPS="\n";pc.shaderChunks.particlePS="varying vec4 texCoordsAlphaLife;\n\nuniform sampler2D colorMap;\nuniform sampler2D internalTex3;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float camera_far;\nuniform float softening;\nuniform float colorMult;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    float depth = dot(rgbaDepth, bitShift);\n    return depth;\n}\n\nvoid main(void) {\n    vec4 tex         = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n    vec4 ramp     = texture2DSRGB(internalTex3, vec2(texCoordsAlphaLife.w, 0.0));\n    ramp.rgb *= colorMult;\n\n    ramp.a += texCoordsAlphaLife.z;\n\n    vec3 rgb =     tex.rgb * ramp.rgb;\n    float a =         tex.a * ramp.a;\n\n";
pc.shaderChunks.falloffLinearPS="float getFalloffLinear(float lightRadius) {\n    float d = length(dLightDirW);\n    return max(((lightRadius - d) / lightRadius), 0.0);\n}\n\n";pc.shaderChunks.lightSpecularBlinnPS="// Energy-conserving (hopefully) Blinn-Phong\nfloat getLightSpecular() {\n    vec3 h = normalize( -dLightDirNormW + dViewDirW );\n    float nh = max( dot( h, dNormalW ), 0.0 );\n\n    float specPow = exp2(dGlossiness * 11.0); // glossiness is linear, power is not; 0 - 2048\n    specPow = antiAliasGlossiness(specPow);\n\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    specPow = max(specPow, 0.0001);\n\n    return pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\n\n";
pc.shaderChunks.shadowCoordVS="void getLightDirPoint(vec3 lightPosW) {\n    vec3 lightDirW = vPositionW - lightPosW;\n    dLightDirNormW = normalize(lightDirW);\n    dLightPosW = lightPosW;\n}\n\nvoid _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    vMainShadowUv = projPos;\n}\n\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    vMainShadowUv = projPos;\n}\n\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\n    _getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\n\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n\n";
pc.shaderChunks.rgbmPS="vec3 decodeRGBM(vec4 rgbm) {\n    vec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n    return color * color;\n}\n\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n    return decodeRGBM(texture2D(tex, uv));\n}\n\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n    return decodeRGBM(textureCube(tex, uvw));\n}\n\n";pc.shaderChunks.reflectionCubePS="uniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvoid addReflection() {\n    vec3 lookupVec = fixSeams(cubeMapProject(dReflDirW));\n    lookupVec.x *= -1.0;\n    dReflection += vec4($textureCubeSAMPLE(texture_cubeMap, lookupVec).rgb, material_reflectivity);\n}\n";
pc.shaderChunks.specularConstPS="uniform vec3 material_specular;\nvoid getSpecularity() {\n    dSpecularity = material_specular;\n}\n\n";pc.shaderChunks.packDepthMaskPS="vec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res.x = 0.0;\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n\n";
pc.shaderChunks.metalnessVertConstPS="uniform float material_metalness;\nvoid getSpecularity() {\n    processMetalness(saturate(vVertexColor.$CH) * material_metalness);\n}\n\n";pc.shaderChunks.diffuseTexPS="uniform sampler2D texture_diffuseMap;\nvoid getAlbedo() {\n    dAlbedo = texture2DSRGB(texture_diffuseMap, $UV).$CH;\n}\n\n";pc.shaderChunks.endPS="   gl_FragColor.rgb = combineColor();\n   gl_FragColor.rgb += getEmission();\n   gl_FragColor.rgb = addFog(gl_FragColor.rgb);\n   gl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n   gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n";
pc.shaderChunks.transformUv1VS="mat4 getModelMatrix() {\n    return matrix_model;\n}\nvec4 getPosition() {\n    dModelMatrix = getModelMatrix();\n    vec4 posW = dModelMatrix * vec4(vertex_position, 1.0);\n    dPositionW = posW.xyz;\n    return vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n}\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n\n";pc.shaderChunks.aoTexPS="uniform sampler2D texture_aoMap;\nvoid applyAO() {\n    dAo = texture2D(texture_aoMap, $UV).$CH;\n    dDiffuseLight *= dAo;\n}\n\n";
pc.shaderChunks.fogNonePS="vec3 addFog(vec3 color) {\n    return color;\n}\n\n\n";pc.shaderChunks.gamma1_0PS="vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    return texture2D(tex, uv);\n}\n\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    return textureCube(tex, uvw);\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n    return color;\n}\n\nvec3 gammaCorrectInput(vec3 color) {\n    return color;\n}\n\nfloat gammaCorrectInput(float color) {\n    return color;\n}\n\nvec4 gammaCorrectInput(vec4 color) {\n    return color;\n}\n\n";
pc.shaderChunks.fogExp2PS="uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * depth * fog_density * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n";pc.shaderChunks.aoVertPS="void applyAO() {\n    dAo = saturate(vVertexColor.$CH);\n    dDiffuseLight *= dAo;\n}\n\n";pc.shaderChunks.envMultiplyPS="uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n    return color * skyboxIntensity;\n}\n\n";
pc.shaderChunks.lightDiffuseLambertPS="float getLightDiffuse() {\n    return max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n\n";pc.shaderChunks.diffuseTexConstPS="uniform sampler2D texture_diffuseMap;\nuniform vec3 material_diffuse;\nvoid getAlbedo() {\n    dAlbedo = texture2DSRGB(texture_diffuseMap, $UV).$CH * material_diffuse;\n}\n\n";pc.shaderChunks.particleUpdaterSpherePS="uniform float spawnBoundsSphere;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    float rnd4 = fract(rndFactor * 1000.0);\n    return emitterPos + normalize(inBounds.xyz - vec3(0.5)) * rnd4 * spawnBoundsSphere;\n}\n\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n\n";
pc.shaderChunks.ambientConstantPS="\nvoid addAmbient() {\n    dDiffuseLight += light_globalAmbient;\n}\n";pc.shaderChunks.diffuseVertConstPS="uniform vec3 material_diffuse;\nvoid getAlbedo() {\n    dAlbedo = gammaCorrectInput(saturate(vVertexColor.$CH)) * material_diffuse;\n}\n\n";pc.shaderChunks.shadowPS="// ----- Unpacking -----\n\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n\nfloat unpackMask(vec4 rgbaDepth) {\n    return rgbaDepth.x;\n}\n\nfloat unpackFloatYZW(vec4 enc) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    float v = dot(enc.yzw, bitShift.yzw);\n    return v;\n}\n\n\n// ----- Aux -----\n\nvec3 lessThan2(vec3 a, vec3 b) {\n    return clamp((b - a)*1000.0, 0.0, 1.0); // softer version\n}\n\nvec3 greaterThan2(vec3 a, vec3 b) {\n    return clamp((a - b)*1000.0, 0.0, 1.0); // softer version\n}\n\n\n// ----- Direct/Spot Sampling -----\n\nfloat getShadowHard(sampler2D shadowMap, vec3 shadowParams) {\n    float depth = unpackFloat(texture2D(shadowMap, dShadowCoord.xy));\n    return (depth < dShadowCoord.z) ? 0.0 : 1.0;\n}\n\nfloat getShadowSpotHard(sampler2D shadowMap, vec4 shadowParams) {\n    float depth = unpackFloat(texture2D(shadowMap, dShadowCoord.xy));\n    return (depth < (length(dLightDirW) * shadowParams.w + shadowParams.z)) ? 0.0 : 1.0;\n}\n\nfloat getShadowMask(sampler2D shadowMap, vec3 shadowParams) {\n    return unpackMask(texture2D(shadowMap, dShadowCoord.xy));\n}\n\nfloat _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n    mat3 shadowKernel;\n    vec3 shadowCoord = dShadowCoord;\n    vec3 shadowZ = vec3(shadowCoord.z);\n    shadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n    shadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n    shadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\n    vec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\n    shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n    shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n    vec4 shadowValues;\n    shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n    shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n    shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n    shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n    return dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\n\nfloat _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n    vec3 shadowCoord = dShadowCoord;\n\n    float xoffset = 1.0 / shadowParams.x; // 1/shadow map width\n    float dx0 = -xoffset;\n    float dx1 = xoffset;\n\n    mat3 depthKernel;\n    depthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n    depthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n    depthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n    depthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n    depthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n    depthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n    depthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n    depthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n    depthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\n    return _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n}\n\nfloat getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n    return _getShadowPCF3x3(shadowMap, shadowParams);\n}\n\nfloat getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n    dShadowCoord.z = length(dLightDirW) * shadowParams.w + shadowParams.z;\n    return _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n\nfloat _getShadowPCF3x3_YZW(sampler2D shadowMap, vec3 shadowParams) {\n    vec3 shadowCoord = dShadowCoord;\n\n    float xoffset = 1.0 / shadowParams.x; // 1/shadow map width\n    float dx0 = -xoffset;\n    float dx1 = xoffset;\n\n    mat3 depthKernel;\n    depthKernel[0][0] = unpackFloatYZW(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n    depthKernel[0][1] = unpackFloatYZW(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n    depthKernel[0][2] = unpackFloatYZW(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n    depthKernel[1][0] = unpackFloatYZW(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n    depthKernel[1][1] = unpackFloatYZW(texture2D(shadowMap, shadowCoord.xy));\n    depthKernel[1][2] = unpackFloatYZW(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n    depthKernel[2][0] = unpackFloatYZW(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n    depthKernel[2][1] = unpackFloatYZW(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n    depthKernel[2][2] = unpackFloatYZW(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\n    return _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n}\n\nfloat getShadowPCF3x3_YZW(sampler2D shadowMap, vec3 shadowParams) {\n    return _getShadowPCF3x3_YZW(shadowMap, shadowParams);\n}\n\n\n// ----- Point Sampling -----\n\nfloat getShadowPointHard(samplerCube shadowMap, vec4 shadowParams) {\n    float depth = unpackFloat(textureCube(shadowMap, dLightDirNormW));\n    return float(depth > length(dLightDirW) * shadowParams.w + shadowParams.z);\n}\n\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\n    vec3 tc = normalize(dir);\n    vec3 tcAbs = abs(tc);\n\n    vec4 dirX = vec4(1,0,0, tc.x);\n    vec4 dirY = vec4(0,1,0, tc.y);\n    float majorAxisLength = tc.z;\n    if ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n        dirX = vec4(0,0,1, tc.z);\n        dirY = vec4(0,1,0, tc.y);\n        majorAxisLength = tc.x;\n    } else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n        dirX = vec4(1,0,0, tc.x);\n        dirY = vec4(0,0,1, tc.z);\n        majorAxisLength = tc.y;\n    }\n\n    float shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\n    vec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n    vec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n    vec3 dx0 = -xoffset;\n    vec3 dy0 = -yoffset;\n    vec3 dx1 = xoffset;\n    vec3 dy1 = yoffset;\n\n    mat3 shadowKernel;\n    mat3 depthKernel;\n\n    depthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n    depthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n    depthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n    depthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n    depthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n    depthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n    depthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n    depthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n    depthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\n    vec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\n    shadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n    shadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n    shadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\n    vec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\n    vec2 fractionalCoord = fract( uv * shadowParams.x );\n\n    shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n    shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n    vec4 shadowValues;\n    shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n    shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n    shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n    shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n    return 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\n\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n    return _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n\nvoid normalOffsetPointShadow(vec4 shadowParams) {\n    float distScale = length(dLightDirW);\n    vec3 wPos = vPositionW + vNormalW * shadowParams.y * clamp(1.0 - dot(vNormalW, -dLightDirNormW), 0.0, 1.0) * distScale; //0.02\n    vec3 dir = wPos - dLightPosW;\n    dLightDirW = dir;\n}\n\n";
pc.shaderChunks.aoSpecOccSimplePS="uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n    float specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n\n";pc.shaderChunks.TBNPS="void getTBN() {\n    dTBN = mat3(normalize(vTangentW), normalize(vBinormalW), normalize(vNormalW));\n}\n\n";pc.shaderChunks.falloffInvSquaredPS="float getFalloffInvSquared(float lightRadius) {\n    float sqrDist = dot(dLightDirW, dLightDirW);\n    float falloff = 1.0 / (sqrDist + 1.0);\n    float invRadius = 1.0 / lightRadius;\n\n    falloff *= 16.0;\n    falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\n    return falloff;\n}\n\n";
pc.shaderChunks.particle_halflambertPS="\n    vec3 negNormal = normal*0.5+0.5;\n    vec3 posNormal = -normal*0.5+0.5;\n    negNormal *= negNormal;\n    posNormal *= posNormal;\n\n\n";pc.shaderChunks.combineDiffusePS="vec3 combineColor() {\n    return dAlbedo * dDiffuseLight;\n}\n\n";pc.shaderChunks.particleUpdaterInitPS="varying vec2 vUv0;\n\nuniform sampler2D particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\n\nuniform mat3 emitterMatrix;\nuniform vec3 emitterScale;\n\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\n\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n\n";
pc.shaderChunks.fogLinearPS="uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = (fog_end - depth) / (fog_end - fog_start);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    fogFactor = gammaCorrectInput(fogFactor);\n    return mix(fog_color, color, fogFactor);\n}\n";pc.shaderChunks.particle_endVS="\n    localPos *= scale * emitterScale;\n    localPos += particlePos;\n\n    gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n}\n";
pc.shaderChunks.particle_softPS="\n    vec2 screenTC = gl_FragCoord.xy * uScreenSize.zw;\n    float depth = unpackFloat( texture2D(uDepthMap, screenTC) ) * camera_far;\n    float particleDepth = gl_FragCoord.z / gl_FragCoord.w;\n    float depthDiff = saturate(abs(particleDepth - depth) * softening);\n    a *= depthDiff;\n\n";pc.shaderChunks.specularTexConstPS="uniform sampler2D texture_specularMap;\nuniform vec3 material_specular;\nvoid getSpecularity() {\n    dSpecularity = texture2D(texture_specularMap, $UV).$CH * material_specular;\n}\n\n";
pc.shaderChunks.envConstPS="vec3 processEnvironment(vec3 color) {\n    return color;\n}\n\n";pc.shaderChunks.startPS="\nvoid main(void) {\n\tdDiffuseLight = vec3(0);\n\tdSpecularLight = vec3(0);\n    dReflection = vec4(0);\n    dSpecularity = vec3(0);\n\n\n";pc.shaderChunks.outputAlphaPS="gl_FragColor.a = dAlpha;\n";pc.shaderChunks.lightmapSinglePS="uniform sampler2D texture_lightMap;\nvoid addLightMap() {\n    dDiffuseLight += $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n}\n\n";
pc.shaderChunks.particleUpdaterOnStopPS="    visMode = life < 0.0? -1.0: visMode;\n\n";pc.shaderChunks.instancingVS="\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n\n";pc.programlib={getSnippet:function(f,a){var b="";switch(a){case "common_main_begin":b+="void main(void)\n{\n";break;case "common_main_end":b+="}\n";break;case "fs_alpha_test_decl":b+="uniform float alpha_ref;\n";break;case "fs_alpha_test":b+="    if (gl_FragColor.a < alpha_ref) discard;\n\n";break;case "fs_clamp":b+="    gl_FragColor = clamp(gl_FragColor, 0.0, 1.0);\n";break;case "fs_flat_color_decl":b+="uniform vec4 uColor;\n";break;case "fs_flat_color":b+="    gl_FragColor = uColor;\n";break;case "fs_fog_linear_decl":case "fs_fog_exp_decl":case "fs_fog_exp2_decl":b+=
"uniform vec3 fog_color;\n";b="fs_fog_linear_decl"===a?b+"uniform float fog_start;\nuniform float fog_end;\n\n":b+"uniform float fog_density;\n\n";break;case "fs_fog_linear":case "fs_fog_exp":case "fs_fog_exp2":b+="    float depth = gl_FragCoord.z / gl_FragCoord.w;\n";b="fs_fog_linear"===a?b+"    float fogFactor = (fog_end - depth) / (fog_end - fog_start);\n":"fs_fog_exp"===a?b+"    float fogFactor = exp(-depth * fog_density);\n":b+"    float fogFactor = exp(-depth * depth * fog_density * fog_density);\n";
b+="    fogFactor = clamp(fogFactor, 0.0, 1.0);\n";b+="    gl_FragColor.rgb = mix(fog_color, gl_FragColor.rgb, fogFactor);\n";break;case "fs_precision":b+="precision "+f.precision+" float;\n\n";break;case "fs_height_map_funcs":b+="vec3 perturb_normal( vec3 N, vec3 p, vec2 uv )\n";b+="{\n";b+="    vec3 dp1 = dFdx( p );\n";b+="    vec3 dp2 = dFdy( p );\n";b+="    vec2 duv1 = dFdx( uv );\n";b+="    vec2 duv2 = dFdy( uv );\n\n";b+="    vec3 dp2perp = cross( dp2, N );\n";b+="    vec3 dp1perp = cross( N, dp1 );\n\n";
b+="    const float bumpScale = 0.125;\n";b+="    float Hll = bumpScale * texture2D( texture_heightMap, uv ).x;\n";b+="    float dBx = bumpScale * texture2D( texture_heightMap, uv + duv1 ).x - Hll;\n";b+="    float dBy = bumpScale * texture2D( texture_heightMap, uv + duv2 ).x - Hll;\n\n";b+="    float fDet = dot( dp1, dp2perp );\n";b+="    vec3 vGrad = sign( fDet ) * ( dBx * dp2perp + dBy * dp1perp );\n";b+="    return normalize( abs( fDet ) * N - vGrad );\n";b+="}\n\n";break;case "fs_normal_map_funcs":pc.precalculatedTangents||
(b+="mat3 cotangent_frame( vec3 N, vec3 p, vec2 uv )\n",b+="{\n",b+="    vec3 dp1 = dFdx( p );\n",b+="    vec3 dp2 = dFdy( p );\n",b+="    vec2 duv1 = dFdx( uv );\n",b+="    vec2 duv2 = dFdy( uv );\n\n",b+="    vec3 dp2perp = cross( dp2, N );\n",b+="    vec3 dp1perp = cross( N, dp1 );\n",b+="    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n",b+="    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n",b+="    float invmax = inversesqrt( max( dot(T,T), dot(B,B) ) );\n",b+="    return mat3( T * invmax, B * invmax, N );\n",
b+="}\n\n",b+="vec3 perturb_normal( vec3 N, vec3 V, vec2 uv )\n",b+="{\n",b+="    vec3 map = texture2D( texture_normalMap, uv ).xyz;\n",b+="    map = map * 255./127. - 128./127.;\n",b+="    map.xy = map.xy * material_bumpiness;\n",b+="    mat3 TBN = cotangent_frame( N, -V, uv );\n",b+="    return normalize( TBN * map );\n",b+="}\n\n");break;case "vs_skin_decl":b=f.supportsBoneTextures?b+"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n\nuniform sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\nuniform vec3 skinPosOffset;\n\nmat4 getBoneMatrix(const in float i)\n{\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n\n    y = dy * (y + 0.5);\n\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n\n    mat4 bone = mat4(v1, v2, v3, v4);\n\n    return bone;\n}":
b+["attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n","uniform mat4 matrix_pose["+f.getBoneLimit()+"];","uniform vec3 skinPosOffset;\n\nmat4 getBoneMatrix(const in float i)\n{\n    mat4 bone = matrix_pose[int(i)];\n\n    return bone;\n}"].join("\n");b+="\n\n";break;case "vs_transform_decl":b+="attribute vec3 vertex_position;\n",b+="uniform mat4 matrix_model;\n",b+="uniform mat4 matrix_viewProjection;\n\n"}return b},gammaCode:function(f){return f===pc.GAMMA_NONE?pc.shaderChunks.gamma1_0PS:
f===pc.GAMMA_SRGBFAST?pc.shaderChunks.gamma2_2FastPS:pc.shaderChunks.gamma2_2PS},tonemapCode:function(f){return f?pc.shaderChunks.tonemappingFilmicPS:pc.shaderChunks.tonemappingLinearPS}};pc.programlib.basic={generateKey:function(f,a){var b="basic";a.fog&&(b+="_fog");a.alphaTest&&(b+="_atst");a.vertexColors&&(b+="_vcol");a.diffuseMap&&(b+="_diff");return b},createShaderDefinition:function(f,a){var b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);a.vertexColors&&(b.vertex_color=pc.SEMANTIC_COLOR);a.diffuseMap&&(b.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0);var d=pc.programlib.getSnippet,e;e=""+
d(f,"vs_transform_decl");a.skin&&(e+=d(f,"vs_skin_decl"));a.vertexColors&&(e+="attribute vec4 vertex_color;\nvarying vec4 vColor;\n");a.diffuseMap&&(e+="attribute vec2 vertex_texCoord0;\n",e+="varying vec2 vUv0;\n");e+=d(f,"common_main_begin");a.skin?(e+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n",e+="                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",e+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",
e+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n",e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n",e+="    positionW.xyz += skinPosOffset;\n"):(e+="    mat4 modelMatrix = matrix_model;\n",e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n");e+="\n";e+="    gl_Position = matrix_viewProjection * positionW;\n\n";a.vertexColors&&(e+="    vColor = vertex_color;\n");a.diffuseMap&&(e+="    vUv0 = vertex_texCoord0;\n");var g=e+=
d(f,"common_main_end");e=d(f,"fs_precision");e=a.vertexColors?e+"varying vec4 vColor;\n":e+"uniform vec4 uColor;\n";a.diffuseMap&&(e+="varying vec2 vUv0;\n",e+="uniform sampler2D texture_diffuseMap;\n");a.fog&&(e+=d(f,"fs_fog_decl"));a.alphatest&&(e+=d(f,"fs_alpha_test_decl"));e+=d(f,"common_main_begin");e=a.vertexColors?e+"    gl_FragColor = vColor;\n":e+"    gl_FragColor = uColor;\n";a.diffuseMap&&(e+="    gl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n");a.alphatest&&(e+=d(f,"fs_alpha_test"));
e+=d(f,"fs_clamp");a.fog&&(e+=d(f,"fs_fog"));e+=d(f,"common_main_end");return{attributes:b,vshader:g,fshader:e}}};pc.programlib.depth={generateKey:function(f,a){var b="depth";a.skin&&(b+="_skin");a.opacityMap&&(b+="_opam");return b},createShaderDefinition:function(f,a){var b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);a.opacityMap&&(b.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0);var d=pc.programlib.getSnippet,e;e=""+d(f,"vs_transform_decl");a.skin&&(e+=d(f,"vs_skin_decl"));a.opacityMap&&(e+="attribute vec2 vertex_texCoord0;\n\nvarying vec2 vUv0;\n\n");
e+=d(f,"common_main_begin");a.skin?(e+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n",e+="                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",e+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",e+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n",e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n",e+="    positionW.xyz += skinPosOffset;\n"):
(e+="    mat4 modelMatrix = matrix_model;\n",e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n");e+="\n";e+="    gl_Position = matrix_viewProjection * positionW;\n\n";a.opacityMap&&(e+="    vUv0 = vertex_texCoord0;\n");var g=e+=d(f,"common_main_end");e=d(f,"fs_precision");e+="uniform float camera_near;\n";e+="uniform float camera_far;\n";e+="vec4 packFloat(float depth)\n";e+="{\n";e+="    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n";e+="    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n";
e+="    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n";e+="    res -= res.xxyz * bit_mask;\n";e+="    return res;\n";e+="}\n\n";e+=d(f,"common_main_begin");e+="float depth = gl_FragCoord.z / gl_FragCoord.w;\n";e+="gl_FragColor = packFloat(depth / camera_far);\n";e+=d(f,"common_main_end");return{attributes:b,vshader:g,fshader:e}}};pc.programlib.depthrgba={generateKey:function(f,a){var b="depthrgba";a.skin&&(b+="_skin");a.opacityMap&&(b+="_opam"+a.opacityChannel);a.point&&(b+="_pnt");return b+="_"+a.shadowType},createShaderDefinition:function(f,a){var b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);a.opacityMap&&(b.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0);var d=pc.programlib.getSnippet,e;e=""+d(f,"vs_transform_decl");a.skin&&(e+=d(f,
"vs_skin_decl"));a.opacityMap&&(e+="attribute vec2 vertex_texCoord0;\n\nvarying vec2 vUv0;\n\n");a.point&&(e+="varying vec3 worldPos;\n\n");e+=d(f,"common_main_begin");a.skin?(e+="   ",e+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n",e+="                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",e+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",e+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n",
e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n",e+="    positionW.xyz += skinPosOffset;\n"):(e+="    mat4 modelMatrix = matrix_model;\n",e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n");e+="\n";e+="    gl_Position = matrix_viewProjection * positionW;\n\n";a.opacityMap&&(e+="    vUv0 = vertex_texCoord0;\n");a.point&&(e+="    worldPos = positionW.xyz;\n");var g=e+=d(f,"common_main_end");e=d(f,"fs_precision");a.opacityMap&&(e+="varying vec2 vUv0;\n\n",e+="uniform sampler2D texture_opacityMap;\n\n");
a.point&&(e+="varying vec3 worldPos;\n\n",e+="uniform vec3 view_position;\n\n",e+="uniform float light_radius;\n\n");e+=pc.shaderChunks.packDepthPS;e+=d(f,"common_main_begin");a.opacityMap&&(e+="    if (texture2D(texture_opacityMap, vUv0)."+a.opacityChannel+" < 0.25) discard;\n\n");e=a.point?e+"   gl_FragData[0] = packFloat(min(distance(view_position, worldPos) / light_radius, 0.99999));\n":e+"    gl_FragData[0] = packFloat(gl_FragCoord.z);\n";e+=d(f,"common_main_end");return{attributes:b,vshader:g,
fshader:e}}};pc.programlib.particle={generateKey:function(f,a){var b="particle",d;for(d in a)a.hasOwnProperty(d)&&(b+=a[d]);return b},_animTex:function(f,a){var b;b=""+(f.animTexLoop?a.particleAnimFrameLoopVS:a.particleAnimFrameClampVS);return b+=a.particleAnimTexVS},createShaderDefinition:function(f,a){var b=pc.programlib.getSnippet,d=pc.shaderChunks,e="",b=b(f,"fs_precision")+"\n";a.useCpu?(a.animTex&&(e+="\nuniform vec4 animTexParams;\n"),2==a.normal&&(e+="\nvarying mat3 ParticleMat;\n"),1==a.normal&&(e+="\nvarying vec3 Normal;\n"),
e+=d.particle_cpuVS,a.animTex&&(e+=this._animTex(a,d)),a.alignToMotion&&(e+=d.particle_pointAlongVS),e+=a.mesh?d.particle_meshVS:d.particle_billboardVS,1==a.normal&&(e+=d.particle_normalVS),2==a.normal&&(e+=d.particle_TBNVS),0<a.stretch&&(e+=d.particle_stretchVS),e+=d.particle_cpu_endVS):(a.animTex&&(e+="\nuniform vec4 animTexParams;\n"),2==a.normal&&(e+="\nvarying mat3 ParticleMat;\n"),1==a.normal&&(e+="\nvarying vec3 Normal;\n"),e+=d.particleVS,a.animTex&&(e+=this._animTex(a,d)),a.wrap&&(e+=d.particle_wrapVS),
a.alignToMotion&&(e+=d.particle_pointAlongVS),e+=a.mesh?d.particle_meshVS:d.particle_billboardVS,1==a.normal&&(e+=d.particle_normalVS),2==a.normal&&(e+=d.particle_TBNVS),0<a.stretch&&(e+=d.particle_stretchVS),e+=d.particle_endVS);0<a.normal&&(1==a.normal?b+="\nvarying vec3 Normal;\n":2==a.normal&&(b+="\nvarying mat3 ParticleMat;\n"),b+="\nuniform vec3 lightCube[6];\n");0===a.normal&&"none"===a.fog&&(a.srgb=!1);b+=pc.programlib.gammaCode(a.gamma);b+=pc.programlib.tonemapCode(a.toneMap);b="linear"===
a.fog?b+d.fogLinearPS:"exp"===a.fog?b+d.fogExpPS:"exp2"===a.fog?b+d.fogExp2PS:b+d.fogNonePS;2==a.normal&&(b+="\nuniform sampler2D normalMap;\n");0<a.soft&&(b+="\nuniform sampler2D uDepthMap;\n uniform vec4 uScreenSize;\n");b+=d.particlePS;0<a.soft&&(b+=d.particle_softPS);1==a.normal&&(b+="\nvec3 normal = Normal;\n");2==a.normal&&(b+=d.particle_normalMapPS);0<a.normal&&(b+=a.halflambert?d.particle_halflambertPS:d.particle_lambertPS);0<a.normal&&(b+=d.particle_lightingPS);a.blend==pc.BLEND_NORMAL?b+=
d.particle_blendNormalPS:a.blend==pc.BLEND_ADDITIVE?b+=d.particle_blendAddPS:a.blend==pc.BLEND_MULTIPLICATIVE&&(b+=d.particle_blendMultiplyPS);b+=d.particle_endPS;return{attributes:pc.shaderChunks.collectAttribs(e),vshader:e,fshader:b}}};pc.programlib.standard={hashCode:function(f){var a=0;if(0===f.length)return a;for(i=0;i<f.length;i++)char=f.charCodeAt(i),a=(a<<5)-a+char,a&=a;return a},generateKey:function(f,a){var b=[],d="standard",e;for(e in a)if("lights"===e)for(var g=0;g<a.lights.length;g++)b.push(a.lights[g].getType()+"_"+(a.lights[g].getCastShadows()?1:0)+"_"+a.lights[g].getFalloffMode()+"_"+!!a.lights[g].getNormalOffsetBias());else if("chunks"===e)for(var h in a[e])a[e].hasOwnProperty(h)&&b.push(h+a.chunks[h]);else a[e]&&
b.push(e);b.sort();for(e in b)d+=b[e]+a[b[e]];return this.hashCode(d)},_correctChannel:function(f,a){if(0<pc._matTex2D[f]){if(pc._matTex2D[f]<a.length)return a.substring(0,pc._matTex2D[f]);if(pc._matTex2D[f]>a.length){var b=a,d=b.charAt(b.length-1),e=pc._matTex2D[f]-b.length;for(i=0;i<e;i++)b+=d;return b}return a}},_setMapTransform:function(f,a,b,d){f[0]+="uniform vec4 texture_"+a+"MapTransform;\n";var e=b+100*d;f[3][e]||(f[1]+="varying vec2 vUV"+d+"_"+b+";\n",f[2]+="   vUV"+d+"_"+b+" = uv"+d+" * texture_"+
a+"MapTransform.xy + texture_"+a+"MapTransform.zw;\n",f[3][e]=!0);return f},_uvSource:function(f,a){return 0===f?"vUv"+a:"vUV"+a+"_"+f},_addMap:function(f,a,b,d,e,g){var h,k=f+"Map";return a[k+"VertexColor"]?(e||(e=a[f+"Tint"]?b[f+"VertConstPS"]:b[f+"VertPS"]),e.replace(/\$CH/g,a[k+"Channel"])):a[k]?(h=k+"Channel",d=this._uvSource(a[k+"Transform"],a[k+"Uv"])+d,e||(e=a[f+"Tint"]?b[f+"TexConstPS"]:b[f+"TexPS"]),void 0!==g&&(e=e.replace(/\$texture2DSAMPLE/g,0===g?"texture2DSRGB":1===g?"texture2DRGBM":
"texture2D")),e.replace(/\$UV/g,d).replace(/\$CH/g,a[h])):b[f+"ConstPS"]},_nonPointShadowMapProjection:function(f,a){return f.getNormalOffsetBias()?f.getType()==pc.LIGHTTYPE_SPOT?"   getShadowCoordPerspNormalOffset"+a:"   getShadowCoordOrthoNormalOffset"+a:f.getType()===pc.LIGHTTYPE_SPOT?"   getShadowCoordPersp"+a:"   getShadowCoordOrtho"+a},_addVaryingIfNeeded:function(f,a,b){return 0<=f.indexOf(b)?"varying "+a+" "+b+";\n":""},createShaderDefinition:function(f,a){var b,d,e=0<a.lights.length;a.shadingModel===
pc.SPECULAR_PHONG?(a.fresnelModel=0,a.specularAA=!1,a.prefilteredCubemap=!1,a.dpAtlas=!1,a.ambientSH=!1):a.fresnelModel=0===a.fresnelModel?pc.FRESNEL_SCHLICK:a.fresnelModel;var g=a.cubeMap||a.prefilteredCubemap&&a.useSpecular,h=a.sphereMap||g||a.dpAtlas,k=pc.precalculatedTangents,m=a.useTexCubeLod;if(a.cubeMap||a.prefilteredCubemap)a.sphereMap=null;a.dpAtlas&&(a.sphereMap=a.cubeMap=a.prefilteredCubemap=g=null);a.useSpecular||(a.specularMap=a.glossMap=null);var r=e||h||a.ambientSH||a.prefilteredCubemap;
this.options=a;var u=pc.programlib.getSnippet,l="",n="",w="",s=pc.shaderChunks,B;if(a.chunks){var y=[];for(d in s)s.hasOwnProperty(d)&&(a.chunks[d]?(y[d]=a.chunks[d],r||(y[d]=y[d].replace(/vertex_normal/g,"vec3(0)").replace(/vertex_tangent/g,"vec4(0)"))):y[d]=s[d]);s=y}s.extensionVS&&(l+=s.extensionVS+"\n");var l=l+s.baseVS,x=-1;if(!a.noShadow){for(b=0;b<a.lights.length;b++)if(B=a.lights[b].getType(),a.lights[b].getCastShadows()&&B===pc.LIGHTTYPE_DIRECTIONAL){l+="uniform mat4 light"+b+"_shadowMatrixVS;\n";
l+="uniform vec3 light"+b+"_shadowParamsVS;\n";l+="uniform vec3 light"+b+(B===pc.LIGHTTYPE_DIRECTIONAL?"_directionVS":"_positionVS")+";\n";x=b;break}0<=x&&(l+=s.shadowCoordVS)}y={vertex_position:pc.SEMANTIC_POSITION};n+="   vPositionW    = getWorldPosition();\n";a.useInstancing&&(y.instance_line1=pc.SEMANTIC_TEXCOORD2,y.instance_line2=pc.SEMANTIC_TEXCOORD3,y.instance_line3=pc.SEMANTIC_TEXCOORD4,y.instance_line4=pc.SEMANTIC_TEXCOORD5,l+=s.instancingVS);if(r){y.vertex_normal=pc.SEMANTIC_NORMAL;n+="   vNormalW    = dNormalW = getNormal();\n";
a.sphereMap&&16>=f.fragmentUniformsCount&&(l+=s.viewNormalVS,n+="   vNormalV    = getViewNormal();\n");if((a.heightMap||a.normalMap)&&k)y.vertex_tangent=pc.SEMANTIC_TANGENT,l+=s.tangentBinormalVS,n+="   vTangentW   = getTangent();\n   vBinormalW  = getBinormal();\n";0<=x&&(B=a.lights[x].getType(),n=B===pc.LIGHTTYPE_DIRECTIONAL?n+("   dLightDirNormW = light"+x+"_directionVS;\n"):n+("   getLightDirPoint(light"+x+"_positionVS);\n"),n+=this._nonPointShadowMapProjection(a.lights[x],"(light"+x+"_shadowMatrixVS, light"+
x+"_shadowParamsVS);\n"))}B=[];var A=[],D,C,z;for(d in pc._matTex2D)b=d+"Map",a[b+"VertexColor"]?(D=b+"Channel",a[D]=this._correctChannel(d,a[D])):a[b]&&(D=b+"Channel",C=b+"Transform",z=b+"Uv",a[z]=Math.min(a[z],1),a[D]=this._correctChannel(d,a[D]),z=a[z],B[z]=!0,A[z]=A[z]||a[b]&&!a[C]);a.forceUv1&&(B[1]=!0);for(b=0;2>b;b++)B[b]&&(y["vertex_texCoord"+b]=pc["SEMANTIC_TEXCOORD"+b],l+=s["uv"+b+"VS"],n+="   vec2 uv"+b+" = getUv"+b+"();\n"),A[b]&&(n+="   vUv"+b+" = uv"+b+";\n");B=[l,w,n,[]];for(d in pc._matTex2D)b=
d+"Map",a[b]&&(C=b+"Transform",a[C]&&(z=b+"Uv",this._setMapTransform(B,d,a[C],a[z])));l=B[0];w=B[1];n=B[2];a.vertexColors&&(y.vertex_color=pc.SEMANTIC_COLOR,n+="   vVertexColor = vertex_color;\n");a.skin?(y.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,y.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES,l+=u(f,"vs_skin_decl"),l+=s.transformSkinnedVS,r&&(l+=s.normalSkinnedVS)):a.useInstancing?(l+=s.transformInstancedVS,r&&(l+=s.normalInstancedVS)):(l+=s.transformVS,r&&(l+=s.normalVS));l=l+"\n"+s.startVS;l+=
n;d=l+="}";b=w;w=""+this._addVaryingIfNeeded(l,"vec4","vMainShadowUv");w+=this._addVaryingIfNeeded(l,"vec4","vVertexColor");w+=this._addVaryingIfNeeded(l,"vec3","vPositionW");w+=this._addVaryingIfNeeded(l,"vec3","vNormalV");w+=this._addVaryingIfNeeded(l,"vec3","vNormalW");w+=this._addVaryingIfNeeded(l,"vec3","vTangentW");w+=this._addVaryingIfNeeded(l,"vec3","vBinormalW");w+=this._addVaryingIfNeeded(l,"vec2","vUv0");w+=this._addVaryingIfNeeded(l,"vec2","vUv1");w+=b;d=w+d;a.forceFragmentPrecision&&
("highp"!=a.forceFragmentPrecision&&"mediump"!==a.forceFragmentPrecision&&"lowp"!==a.forceFragmentPrecision)&&(a.forceFragmentPrecision=null);a.forceFragmentPrecision&&("highp"===a.forceFragmentPrecision&&"highp"!==f.maxPrecision&&(a.forceFragmentPrecision="mediump"),"mediump"===a.forceFragmentPrecision&&"lowp"===f.maxPrecision&&(a.forceFragmentPrecision="lowp"));l="";s.extensionPS&&(l+=s.extensionPS+"\n");l+=a.forceFragmentPrecision?"precision "+a.forceFragmentPrecision+" float;\n\n":u(f,"fs_precision");
if(a.customFragmentShader)return l+=a.customFragmentShader,{attributes:y,vshader:d,fshader:l,tag:pc.SHADERTAG_MATERIAL};l+=w;w=l+=s.basePS;l="";for(b=n=0;b<a.lights.length;b++)B=a.lights[b].getType(),l+="uniform vec3 light"+b+"_color;\n",B===pc.LIGHTTYPE_DIRECTIONAL?l+="uniform vec3 light"+b+"_direction;\n":(l+="uniform vec3 light"+b+"_position;\n",l+="uniform float light"+b+"_radius;\n",B===pc.LIGHTTYPE_SPOT&&(l+="uniform vec3 light"+b+"_spotDirection;\n",l+="uniform float light"+b+"_innerConeAngle;\n",
l+="uniform float light"+b+"_outerConeAngle;\n")),a.lights[b].getCastShadows()&&!a.noShadow&&(l+="uniform mat4 light"+b+"_shadowMatrix;\n",l=B!==pc.LIGHTTYPE_DIRECTIONAL?l+("uniform vec4 light"+b+"_shadowParams;\n"):l+("uniform vec3 light"+b+"_shadowParams;\n"),l=B===pc.LIGHTTYPE_POINT?l+("uniform samplerCube light"+b+"_shadowMap;\n"):l+("uniform sampler2D light"+b+"_shadowMap;\n"),n++);l+="\n";B=a.heightMap?" + dUvOffset":"";b=a.fastTbn?s.TBNfastPS:s.TBNPS;r&&(a.normalMap&&k?(l+=a.packedNormal?s.normalXYPS:
s.normalXYZPS,k=this._uvSource(a.normalMapTransform,a.normalMapUv)+B,l=a.needsNormalFloat?l+(a.fastTbn?s.normalMapFloatTBNfastPS:s.normalMapFloatPS).replace(/\$UV/g,k):l+s.normalMapPS.replace(/\$UV/g,k),l+=b):l+=s.normalVertexPS);l+=pc.programlib.gammaCode(a.gamma);l+=pc.programlib.tonemapCode(a.toneMap);l="linear"===a.fog?l+s.fogLinearPS:"exp"===a.fog?l+s.fogExpPS:"exp2"===a.fog?l+s.fogExp2PS:l+s.fogNonePS;a.useRgbm&&(l+=s.rgbmPS);if(g||a.prefilteredCubemap)l+=a.fixSeams?s.fixCubemapSeamsStretchPS:
s.fixCubemapSeamsNonePS;r&&(l+=0<a.cubeMapProjection?s.cubeMapProjectBoxPS:s.cubeMapProjectNonePS,l+=a.skyboxIntensity?s.envMultiplyPS:s.envConstPS);l+=this._addMap("diffuse",a,s,B);if(a.blendType!==pc.BLEND_NONE||a.alphaTest)l+=this._addMap("opacity",a,s,B);l+=this._addMap("emissive",a,s,B,null,a.emissiveFormat);a.useSpecular&&(l=a.specularAA&&a.normalMap?a.needsNormalFloat&&r?l+s.specularAaToksvigFloatPS:l+s.specularAaToksvigPS:l+s.specularAaNonePS,a.useMetalness&&(l+=s.metalnessPS),l+=this._addMap(a.useMetalness?
"metalness":"specular",a,s,B),l+=this._addMap("gloss",a,s,B),0<a.fresnelModel&&(a.fresnelModel===pc.FRESNEL_SIMPLE?l+=s.fresnelSimplePS:a.fresnelModel===pc.FRESNEL_SCHLICK?l+=s.fresnelSchlickPS:a.fresnelModel===pc.FRESNEL_COMPLEX&&(l+=s.fresnelComplexPS)));a.heightMap&&(a.normalMap||(l+=b),l+=this._addMap("height",a,s,"",s.parallaxPS));if(k=a.aoMap||a.aoMapVertexColor)l+=this._addMap("ao",a,s,B,a.aoMapVertexColor?s.aoVertPS:s.aoTexPS),a.occludeSpecular&&(l=a.occludeSpecular===pc.SPECOCC_AO?l+(a.occludeSpecularFloat?
s.aoSpecOccSimplePS:s.aoSpecOccConstSimplePS):l+(a.occludeSpecularFloat?s.aoSpecOccPS:s.aoSpecOccConstPS));A=a.rgbmReflection?"decodeRGBM":a.hdrReflection?"":"gammaCorrectInput";if(g||a.prefilteredCubemap)l=a.prefilteredCubemap?m?l+s.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g,A):l+s.reflectionPrefilteredCubePS.replace(/\$DECODE/g,A):l+s.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,a.rgbmReflection?"textureCubeRGBM":a.hdrReflection?"textureCube":"textureCubeSRGB");a.sphereMap&&(b=16<f.fragmentUniformsCount?
s.reflectionSpherePS:s.reflectionSphereLowPS,b=b.replace(/\$texture2DSAMPLE/g,a.rgbmReflection?"texture2DRGBM":a.hdrReflection?"texture2D":"texture2DSRGB"),l+=b);a.dpAtlas&&(l+=s.reflectionDpAtlasPS.replace(/\$texture2DSAMPLE/g,a.rgbmReflection?"texture2DRGBM":a.hdrReflection?"texture2D":"texture2DSRGB"));if((g||a.sphereMap||a.dpAtlas)&&a.refraction)l+=s.refractionPS;b=!0;if(a.lightMap||a.lightMapVertexColor)l+=this._addMap("light",a,s,B,a.lightMapVertexColor?s.lightmapSingleVertPS:s.lightmapSinglePS,
a.lightMapFormat),b=a.lightMapWithoutAmbient;b&&(l=a.ambientSH?l+s.ambientSHPS:a.prefilteredCubemap?m?l+s.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g,A):l+s.ambientPrefilteredCubePS.replace(/\$DECODE/g,A):l+s.ambientConstantPS);0<n&&(l+=s.shadowCoordPS+s.shadowPS,0<=x&&(l+=s.shadowVSPS));e&&(l+=s.lightDiffuseLambertPS);B=!1;a.useSpecular?(l+=a.shadingModel===pc.SPECULAR_PHONG?s.lightSpecularPhongPS:s.lightSpecularBlinnPS,a.sphereMap||g||a.dpAtlas||0<a.fresnelModel?l=0<a.fresnelModel?a.conserveEnergy?
l+s.combineDiffuseSpecularPS:l+s.combineDiffuseSpecularNoConservePS:l+s.combineDiffuseSpecularOldPS:a.diffuseMap?l+=s.combineDiffuseSpecularNoReflPS:(l+=s.combineDiffuseSpecularNoReflSeparateAmbientPS,B=!0)):l+=s.combineDiffusePS;a.modulateAmbient&&!B&&(l+="uniform vec3 material_ambient;\n");a.alphaTest&&(l+="   uniform float alpha_ref;\n");r&&(l+=s.viewDirPS,a.useSpecular&&(l+=s.reflDirPS));C=A=n=m=!1;l+=s.startPS;z=!1;a.blendType===pc.BLEND_NONE&&!a.alphaTest?l+="   dAlpha = 1.0;\n":a.heightMap&&
a.opacityMap?z=!0:(l+="   getOpacity();\n",a.alphaTest&&(l+="   if (dAlpha < alpha_ref) discard;\n"));if(r){l+="   getViewDir();\n";if(a.heightMap||a.normalMap)l+="   getTBN();\n";a.heightMap&&(l+="   getParallax();\n");z&&(l+="   getOpacity();\n",a.alphaTest&&(l+="   if (dAlpha < alpha_ref) discard;\n"));l+="   getNormal();\n";a.useSpecular&&(l+="   getReflDir();\n")}l+="   getAlbedo();\n";if(e&&a.useSpecular||h)l+="   getSpecularity();\n",l+="   getGlossiness();\n",0<a.fresnelModel&&(l+="   getFresnel();\n");
b&&(l+="   addAmbient();\n");a.modulateAmbient&&!B&&(l+="   dDiffuseLight *= material_ambient;\n");k&&!a.occludeDirect&&(l+="    applyAO();\n");if(a.lightMap||a.lightMapVertexColor)l+="   addLightMap();\n";if(e||h){if(g||a.sphereMap||a.dpAtlas)l+="   addReflection();\n";for(b=0;b<a.lights.length;b++)h=a.lights[b],B=h.getType(),B===pc.LIGHTTYPE_DIRECTIONAL?(l+="   dLightDirNormW = light"+b+"_direction;\n",l+="   dAtten = 1.0;\n"):(l+="   getLightDirPoint(light"+b+"_position);\n",m=!0,h.getFalloffMode()==
pc.LIGHTFALLOFF_LINEAR?(l+="   dAtten = getFalloffLinear(light"+b+"_radius);\n",n=!0):(l+="   dAtten = getFalloffInvSquared(light"+b+"_radius);\n",A=!0),B===pc.LIGHTTYPE_SPOT&&(l+="   dAtten *= getSpotEffect(light"+b+"_spotDirection, light"+b+"_innerConeAngle, light"+b+"_outerConeAngle);\n",C=!0)),l+="   dAtten *= getLightDiffuse();\n",h.getCastShadows()&&!a.noShadow&&(r=null,a.shadowSampleType===pc.SHADOWSAMPLE_HARD?r="Hard":h._shadowType===pc.SHADOW_DEPTH&&a.shadowSampleType===pc.SHADOWSAMPLE_PCF3X3&&
(r="PCF3x3"),null!==r&&(B===pc.LIGHTTYPE_POINT?(e="(light"+b+"_shadowMap, light"+b+"_shadowParams);\n",h.getNormalOffsetBias()&&(l+="   normalOffsetPointShadow(light"+b+"_shadowParams);\n"),l+="   dAtten *= getShadowPoint"+r+e):(x===b?r+="VS":(e="(light"+b+"_shadowMatrix, light"+b+"_shadowParams);\n",l+=this._nonPointShadowMapProjection(a.lights[b],e)),B===pc.LIGHTTYPE_SPOT&&(r="Spot"+r),l+="   dAtten *= getShadow"+r+"(light"+b+"_shadowMap, light"+b+"_shadowParams);\n"))),l+="   dDiffuseLight += dAtten * light"+
b+"_color;\n",a.useSpecular&&(l+="   dAtten *= getLightSpecular();\n",l+="   dSpecularLight += dAtten * light"+b+"_color;\n"),l+="\n";if((g||a.sphereMap||a.dpAtlas)&&a.refraction)l+="   addRefraction();\n"}l+="\n";k&&(a.occludeDirect&&(l+="    applyAO();\n"),a.occludeSpecular&&(l+="    occludeSpecular();\n"));l+=s.endPS;l=a.blendType===pc.BLEND_NORMAL||a.blendType===pc.BLEND_ADDITIVEALPHA?l+s.outputAlphaPS:a.blendType===pc.BLEND_PREMULTIPLIED?l+s.outputAlphaPremulPS:l+s.outputAlphaOpaquePS;l+="\n";
l+=u(f,"common_main_end");m&&(l=s.lightDirPointPS+l);n&&(l=s.falloffLinearPS+l);A&&(l=s.falloffInvSquaredPS+l);C&&(l=s.spotPS+l);g="";l.includes("dReflection")&&(g+="vec4 dReflection;\n");l.includes("dTBN")&&(g+="mat3 dTBN;\n");l.includes("dAlbedo")&&(g+="vec3 dAlbedo;\n");l.includes("dEmission")&&(g+="vec3 dEmission;\n");l.includes("dNormalW")&&(g+="vec3 dNormalW;\n");l.includes("dViewDirW")&&(g+="vec3 dViewDirW;\n");l.includes("dReflDirW")&&(g+="vec3 dReflDirW;\n");l.includes("dDiffuseLight")&&
(g+="vec3 dDiffuseLight;\n");l.includes("dSpecularLight")&&(g+="vec3 dSpecularLight;\n");l.includes("dLightDirNormW")&&(g+="vec3 dLightDirNormW;\n");l.includes("dLightDirW")&&(g+="vec3 dLightDirW;\n");l.includes("dLightPosW")&&(g+="vec3 dLightPosW;\n");l.includes("dShadowCoord")&&(g+="vec3 dShadowCoord;\n");l.includes("dNormalMap")&&(g+="vec3 dNormalMap;\n");l.includes("dSpecularity")&&(g+="vec3 dSpecularity;\n");l.includes("dUvOffset")&&(g+="vec2 dUvOffset;\n");l.includes("dGlossiness")&&(g+="float dGlossiness;\n");
l.includes("dAlpha")&&(g+="float dAlpha;\n");l.includes("dAtten")&&(g+="float dAtten;\n");l.includes("dAo")&&(g+="float dAo;\n");l=w+g+l;return{attributes:y,vshader:d,fshader:l,tag:pc.SHADERTAG_MATERIAL}}};pc.programlib.pick={generateKey:function(f,a){var b="pick";a.skin&&(b+="_skin");return b},createShaderDefinition:function(f,a){var b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);var d=pc.programlib.getSnippet,e;e=""+d(f,"vs_transform_decl");a.skin&&(e+=d(f,"vs_skin_decl"));e+=d(f,"common_main_begin");a.skin?(e+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",
e+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",e+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n",e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n",e+="    positionW.xyz += skinPosOffset;\n"):(e+="    mat4 modelMatrix = matrix_model;\n",e+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n");e+="\n";e+="    gl_Position = matrix_viewProjection * positionW;\n\n";var g=e+=d(f,"common_main_end");
e=d(f,"fs_precision");e+=d(f,"fs_flat_color_decl");e+=d(f,"common_main_begin");e+=d(f,"fs_flat_color");e+=d(f,"common_main_end");return{attributes:b,vshader:g,fshader:e}}};pc.programlib.skybox={generateKey:function(f,a){return"skybox"+a.rgbm+" "+a.hdr+" "+a.fixSeams+""+a.toneMapping+""+a.gamma+""+a.useIntensity+""+a.mip},createShaderDefinition:function(f,a){var b=pc.programlib.getSnippet,d=pc.shaderChunks;return{attributes:{aPosition:pc.SEMANTIC_POSITION},vshader:"attribute vec3 aPosition;\n\nuniform mat4 matrix_view;\nuniform mat4 matrix_projection;\n\nvarying vec3 vViewDir;\n\nvoid main(void)\n{\n    mat4 view = matrix_view;\n    view[3][0] = view[3][1] = view[3][2] = 0.0;\n    gl_Position = matrix_projection * view * vec4(aPosition, 1.0);\n    gl_Position.z = gl_Position.w - 0.00001;\n    vViewDir = aPosition;\n    vViewDir.x *= -1.0;\n}",
fshader:b(f,"fs_precision")+(a.mip?d.fixCubemapSeamsStretchPS:d.fixCubemapSeamsNonePS)+(a.useIntensity?d.envMultiplyPS:d.envConstPS)+pc.programlib.gammaCode(a.gamma)+pc.programlib.tonemapCode(a.toneMapping)+d.rgbmPS+d.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,a.rgbm?"textureCubeRGBM":a.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/[128,64,16,8,4,2][a.mip]+"")}}};pc.extend(pc,function(){var f=function(a){this.device=a;this.depthMap=this.shader=null;this.vertexBuffer=pc.createFullscreenQuad(a);this.needsDepthBuffer=!1};f.prototype={render:function(){}};return{PostEffect:f,createFullscreenQuad:function(a){var b=new pc.VertexFormat(a,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.ELEMENTTYPE_FLOAT32}]),a=new pc.VertexBuffer(a,b,4),b=new pc.VertexIterator(a);b.element[pc.SEMANTIC_POSITION].set(-1,-1);b.next();b.element[pc.SEMANTIC_POSITION].set(1,-1);b.next();
b.element[pc.SEMANTIC_POSITION].set(-1,1);b.next();b.element[pc.SEMANTIC_POSITION].set(1,1);b.end();return a},drawFullscreenQuad:function(a,b,d,e,g){a.setRenderTarget(b);a.updateBegin();var f=null!==b?b.width:a.width,b=null!==b?b.height:a.height,k=0,m=0;g&&(k=g.x*f,m=g.y*b,f*=g.z,b*=g.w);a.setViewport(k,m,f,b);a.setScissor(k,m,f,b);var g=a.getBlending(),f=a.getDepthTest(),b=a.getDepthWrite(),k=a.getCullMode(),m=a.writeRed,r=a.writeGreen,u=a.writeBlue,l=a.writeAlpha;a.setBlending(!1);a.setDepthTest(!1);
a.setDepthWrite(!1);a.setCullMode(pc.CULLFACE_BACK);a.setColorWrite(!0,!0,!0,!0);a.setVertexBuffer(d,0);a.setShader(e);a.draw({type:pc.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1});a.setBlending(g);a.setDepthTest(f);a.setDepthWrite(b);a.setCullMode(k);a.setColorWrite(m,r,u,l);a.updateEnd()}}}());(function(){var f={BLEND_SUBTRACTIVE:0,BLEND_ADDITIVE:1,BLEND_NORMAL:2,BLEND_NONE:3,BLEND_PREMULTIPLIED:4,BLEND_MULTIPLICATIVE:5,BLEND_ADDITIVEALPHA:6,BLEND_MULTIPLICATIVE2X:7,BLEND_SCREEN:8,FOG_NONE:"none",FOG_LINEAR:"linear",FOG_EXP:"exp",FOG_EXP2:"exp2",FRESNEL_NONE:0,FRESNEL_SCHLICK:2,LAYER_HUD:0,LAYER_GIZMO:1,LAYER_FX:2,LAYER_WORLD:3,LIGHTTYPE_DIRECTIONAL:0,LIGHTTYPE_POINT:1,LIGHTTYPE_SPOT:2,LIGHTFALLOFF_LINEAR:0,LIGHTFALLOFF_INVERSESQUARED:1,SHADOW_DEPTH:0,SHADOWSAMPLE_HARD:0,SHADOWSAMPLE_PCF3X3:1,
SHADOWSAMPLE_MASK:2,PARTICLESORT_NONE:0,PARTICLESORT_DISTANCE:1,PARTICLESORT_NEWER_FIRST:2,PARTICLESORT_OLDER_FIRST:3,PARTICLEMODE_GPU:0,PARTICLEMODE_CPU:1,EMITTERSHAPE_BOX:0,EMITTERSHAPE_SPHERE:1,PROJECTION_PERSPECTIVE:0,PROJECTION_ORTHOGRAPHIC:1,RENDERSTYLE_SOLID:0,RENDERSTYLE_WIREFRAME:1,RENDERSTYLE_POINTS:2,CUBEPROJ_NONE:0,CUBEPROJ_BOX:1,SPECULAR_PHONG:0,SPECULAR_BLINN:1,GAMMA_NONE:0,GAMMA_SRGB:1,GAMMA_SRGBFAST:2,TONEMAP_LINEAR:0,TONEMAP_FILMIC:1,SPECOCC_NONE:0,SPECOCC_AO:1,SPECOCC_GLOSSDEPENDENT:2,
SHADERDEF_NOSHADOW:1,SHADERDEF_SKIN:2,SHADERDEF_UV0:4,SHADERDEF_UV1:8,SHADERDEF_VCOLOR:16,SHADERDEF_INSTANCING:32,SHADERDEF_LM:64,LINEBATCH_WORLD:0,LINEBATCH_OVERLAY:1,LINEBATCH_GIZMO:2,SHADOWUPDATE_NONE:0,SHADOWUPDATE_THISFRAME:1,SHADOWUPDATE_REALTIME:2};pc.extend(pc,f);pc.scene={};pc.extend(pc.scene,f)})();
pc.extend(pc,function(){var f=function(){this.root=null;this._gravity=new pc.Vec3(0,-9.8,0);this.drawCalls=[];this.shadowCasters=[];this.immediateDrawCalls=[];this.fog=pc.FOG_NONE;this.fogColor=new pc.Color(0,0,0);this.fogStart=1;this.fogEnd=1E3;this.fogDensity=0;this.ambientLight=new pc.Color(0,0,0);this._gammaCorrection=pc.GAMMA_NONE;this._toneMapping=0;this.exposure=1;this._skyboxModel=this._skyboxCubeMap=this._skyboxPrefiltered4=this._skyboxPrefiltered8=this._skyboxPrefiltered16=this._skyboxPrefiltered32=
this._skyboxPrefiltered64=this._skyboxPrefiltered128=null;this._skyboxIntensity=1;this._skyboxMip=0;this.lightmapSizeMultiplier=1;this.lightmapMaxResolution=2048;this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0};this._models=[];this._lights=[];this._globalLights=[];this._localLights=[[],[]];this._updateShaders=!0;this._sceneShadersVersion=0};Object.defineProperty(f.prototype,"updateShaders",{get:function(){return this._updateShaders},set:function(a){if(a!==this._updateShaders&&
(this._updateShaders=a,this._models)){a&&this._sceneShadersVersion++;for(a=0;a<this._models.length;a++)this._models[a]._shadersVersion=this._sceneShadersVersion}}});Object.defineProperty(f.prototype,"fog",{get:function(){return this._fog},set:function(a){a!==this._fog&&(this._fog=a,this.updateShaders=!0)}});Object.defineProperty(f.prototype,"gammaCorrection",{get:function(){return this._gammaCorrection},set:function(a){a!==this._gammaCorrection&&(this._gammaCorrection=a,this.updateShaders=!0)}});
Object.defineProperty(f.prototype,"toneMapping",{get:function(){return this._toneMapping},set:function(a){a!==this._toneMapping&&(this._toneMapping=a,this.updateShaders=!0)}});Object.defineProperty(f.prototype,"skybox",{get:function(){return this._skyboxCubeMap},set:function(a){this._skyboxCubeMap=a;this._resetSkyboxModel();this.updateShaders=!0}});Object.defineProperty(f.prototype,"skyboxIntensity",{get:function(){return this._skyboxIntensity},set:function(a){this._skyboxIntensity=a;this._resetSkyboxModel();
this.updateShaders=!0}});Object.defineProperty(f.prototype,"skyboxMip",{get:function(){return this._skyboxMip},set:function(a){this._skyboxMip=a;this._resetSkyboxModel();this.updateShaders=!0}});Object.defineProperty(f.prototype,"skyboxPrefiltered128",{get:function(){return this._skyboxPrefiltered128},set:function(a){this._skyboxPrefiltered128=a;this.updateShaders=!0}});Object.defineProperty(f.prototype,"skyboxPrefiltered64",{get:function(){return this._skyboxPrefiltered64},set:function(a){this._skyboxPrefiltered64=
a;this.updateShaders=!0}});Object.defineProperty(f.prototype,"skyboxPrefiltered32",{get:function(){return this._skyboxPrefiltered32},set:function(a){this._skyboxPrefiltered32=a;this.updateShaders=!0}});Object.defineProperty(f.prototype,"skyboxPrefiltered16",{get:function(){return this._skyboxPrefiltered16},set:function(a){this._skyboxPrefiltered16=a;this.updateShaders=!0}});Object.defineProperty(f.prototype,"skyboxPrefiltered8",{get:function(){return this._skyboxPrefiltered8},set:function(a){this._skyboxPrefiltered8=
a;this.updateShaders=!0}});Object.defineProperty(f.prototype,"skyboxPrefiltered4",{get:function(){return this._skyboxPrefiltered4},set:function(a){this._skyboxPrefiltered4=a;this.updateShaders=!0}});f.prototype.applySettings=function(a){this._gravity.set(a.physics.gravity[0],a.physics.gravity[1],a.physics.gravity[2]);var b=a.render.global_ambient;this.ambientLight=new pc.Color(b[0],b[1],b[2]);this.fog=a.render.fog;b=a.render.fog_color;this.fogColor=new pc.Color(b[0],b[1],b[2]);this.fogStart=a.render.fog_start;
this.fogEnd=a.render.fog_end;this.fogDensity=a.render.fog_density;this.gammaCorrection=a.render.gamma_correction;this.toneMapping=a.render.tonemapping;this.lightmapSizeMultiplier=a.render.lightmapSizeMultiplier;this.lightmapMaxResolution=a.render.lightmapMaxResolution;this.exposure=a.render.exposure;this.skyboxIntensity=void 0===a.render.skyboxIntensity?1:a.render.skyboxIntensity;this.skyboxMip=void 0===a.render.skyboxMip?0:a.render.skyboxMip};f.prototype.updateShadersFunc=function(a){var b;if(this._skyboxCubeMap&&
!this._skyboxModel){var d=new pc.Material,e=this;d.updateShader=function(){var b=a.getProgramLibrary().getProgram("skybox",{rgbm:e._skyboxCubeMap.rgbm,hdr:e._skyboxCubeMap.rgbm||e._skyboxCubeMap.format===pc.PIXELFORMAT_RGBA32F,useIntensity:1!==e.skyboxIntensity,mip:e._skyboxCubeMap.fixCubemapSeams?e.skyboxMip:0,fixSeams:e._skyboxCubeMap.fixCubemapSeams,gamma:e.gammaCorrection,toneMapping:e.toneMapping});this.setShader(b)};d.updateShader();!this._skyboxCubeMap.fixCubemapSeams||!e._skyboxMip?d.setParameter("texture_cubeMap",
this._skyboxCubeMap):(b=this["skyboxPrefiltered"+[null,"64","16","8","4"][e._skyboxMip]])&&d.setParameter("texture_cubeMap",b);d.cull=pc.CULLFACE_NONE;b=new pc.GraphNode;var g=pc.createBox(a),d=new pc.MeshInstance(b,g,d);d.updateKey=function(){this.key=pc._getDrawcallSortKey(this.layer,this.material.blendType,!1,0)};d.updateKey();d.cull=!1;d.drawToDepth=!1;g=new pc.Model;g.graph=b;g.meshInstances=[d];this._skyboxModel=g;this.addModel(g)}d=[];g=this.drawCalls;for(b=0;b<g.length;b++){var f=g[b];void 0!==
f.material&&-1===d.indexOf(f.material)&&d.push(f.material)}for(b=0;b<d.length;b++)g=d[b],g.updateShader!==pc.Material.prototype.updateShader&&(g.clearVariants(),g.shader=null)};f.prototype.getModels=function(){return this._models};f.prototype._updateStats=function(){this._stats.meshInstances=this.drawCalls.length;this._updateLightStats()};f.prototype._updateLightStats=function(){var a=this._stats;a.lights=this._lights.length;a.dynamicLights=0;a.bakedLights=0;for(var b,d=0;d<a.lights;d++)b=this._lights[d],
b._enabled&&((b.mask&pc.MASK_DYNAMIC||b.mask&pc.MASK_BAKED)&&a.dynamicLights++,b.mask&pc.MASK_LIGHTMAP&&a.bakedLights++)};f.prototype.addModel=function(a){var b,d=a._shadersVersion!==this._sceneShadersVersion;a._shadersVersion=this._sceneShadersVersion;if(-1===this._models.indexOf(a)){this._models.push(a);var e=a.getMaterials();for(b=0;b<e.length;b++)e[b].scene=this;var g=a.meshInstances.length;for(b=0;b<g;b++)e=a.meshInstances[b],d&&e.material.clearVariants(),-1===this.drawCalls.indexOf(e)&&this.drawCalls.push(e),
e.castShadow&&-1===this.shadowCasters.indexOf(e)&&this.shadowCasters.push(e);a=a.getLights();b=0;for(len=a.length;b<len;b++)this.addLight(a[b]);this._updateStats()}};f.prototype.removeModel=function(a){var b,d=this._models.indexOf(a);if(-1!==d){this._models.splice(d,1);d=a.getMaterials();for(b=0;b<d.length;b++)d[b].scene=null;var e,g=a.meshInstances.length;for(b=0;b<g;b++)e=a.meshInstances[b],d=this.drawCalls.indexOf(e),-1!==d&&this.drawCalls.splice(d,1),e.castShadow&&(d=this.shadowCasters.indexOf(e),
-1!==d&&this.shadowCasters.splice(d,1));a=a.getLights();b=0;for(len=a.length;b<len;b++)this.removeLight(a[b]);this._updateStats()}};f.prototype.containsModel=function(a){return 0<=this._models.indexOf(a)};f.prototype.addLight=function(a){-1!==this._lights.indexOf(a)?console.warn("pc.Scene#addLight: light is already in the scene"):(this._lights.push(a),a._scene=this,this.updateShaders=!0);this._updateLightStats()};f.prototype.removeLight=function(a){var b=this._lights.indexOf(a);-1===b?console.warn("pc.Scene#removeLight: light is not in the scene"):
(this._lights.splice(b,1),a._scene=null,this.updateShaders=!0);this._updateLightStats()};f.prototype._resetSkyboxModel=function(){this._skyboxModel&&this.containsModel(this._skyboxModel)&&this.removeModel(this._skyboxModel);this._skyboxModel=null};f.prototype.setSkybox=function(a){null!==a?(this._skyboxPrefiltered128=a[1],this._skyboxPrefiltered64=a[2],this._skyboxPrefiltered32=a[3],this._skyboxPrefiltered16=a[4],this._skyboxPrefiltered8=a[5],this._skyboxPrefiltered4=a[6],this.skybox=a[0]):this.skybox=
this._skyboxPrefiltered4=this._skyboxPrefiltered8=this._skyboxPrefiltered16=this._skyboxPrefiltered32=this._skyboxPrefiltered64=this._skyboxPrefiltered128=null};f.prototype.update=function(){for(var a=0,b=this._models.length;a<b;a++)this._models[a].getGraph().syncHierarchy()};f.prototype.destroy=function(){var a,b=this.getModels();for(a=0;a<b.length;a++)this.removeModel(b[a]);for(a=0;a<this._lights.length;a++)this.removeLight(this._lights[a]);this.skybox=null};return{Scene:f}}());pc.extend(pc,function(){function f(a,b){return a.zdist&&b.zdist?b.zdist-a.zdist:b.key-a.key}function a(a){var b=Array(a),a=function(a){return b[a]};a.size=0;a.push=function(a){b[this.size]=a;++this.size};a.data=b;return a}function b(a,b,d){b=new pc.Texture(a,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:b,height:d,autoMipmap:!1});b.minFilter=pc.FILTER_NEAREST;b.magFilter=pc.FILTER_NEAREST;b.addressU=pc.ADDRESS_CLAMP_TO_EDGE;b.addressV=pc.ADDRESS_CLAMP_TO_EDGE;return new pc.RenderTarget(a,b,!0)}function d(a,
b){var d=new pc.Texture(a,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:b,height:b,cubemap:!0,autoMipmap:!1});d.minFilter=pc.FILTER_NEAREST;d.magFilter=pc.FILTER_NEAREST;d.addressU=pc.ADDRESS_CLAMP_TO_EDGE;d.addressV=pc.ADDRESS_CLAMP_TO_EDGE;for(var e=[],g=0;6>g;g++){var f=new pc.RenderTarget(a,d,{face:g,depth:!0});e.push(f)}return e}function e(a,e){var g;e.getType()===pc.LIGHTTYPE_POINT?(e._cacheShadowMap?(g=D[e._shadowResolution],g||(g=d(a,e._shadowResolution),D[e._shadowResolution]=g)):g=d(a,e._shadowResolution),
e._shadowCamera.setRenderTarget(g[0]),e._shadowCubeMap=g):(e._cacheShadowMap?(g=A[e._shadowResolution],g||(g=b(a,e._shadowResolution,e._shadowResolution),A[e._shadowResolution]=g)):g=b(a,e._shadowResolution,e._shadowResolution),e._shadowCamera.setRenderTarget(g))}function g(a){this.device=a;this._cullTime=this._forwardTime=this._shadowMapTime=this._shadowMapUpdates=this._materialSwitches=this._camerasRendered=this._removedByInstancing=this._immediateRendered=this._instancedDrawCalls=this._skinDrawCalls=
this._forwardDrawCalls=this._shadowDrawCalls=this._depthDrawCalls=0;a=this.device.getProgramLibrary();this._depthShaderStatic=a.getProgram("depth",{skin:!1});this._depthShaderSkin=a.getProgram("depth",{skin:!0});this._depthProgStatic=[];this._depthProgSkin=[];this._depthProgStaticOp=[];this._depthProgSkinOp=[];this._depthProgStaticPoint=[];this._depthProgSkinPoint=[];this._depthProgStaticOpPoint=[];this._depthProgSkinOpPoint=[];for(var b=["r","g","b","a"],d=0;d<pc.SHADOW_DEPTH+1;d++){this._depthProgStatic[d]=
a.getProgram("depthrgba",{skin:!1,opacityMap:!1,shadowType:d});this._depthProgSkin[d]=a.getProgram("depthrgba",{skin:!0,opacityMap:!1,shadowType:d});this._depthProgStaticPoint[d]=a.getProgram("depthrgba",{skin:!1,opacityMap:!1,point:!0});this._depthProgSkinPoint[d]=a.getProgram("depthrgba",{skin:!0,opacityMap:!1,point:!0});this._depthProgStaticOp[d]={};this._depthProgSkinOp[d]={};this._depthProgStaticOpPoint[d]={};this._depthProgSkinOpPoint[d]={};for(var e=0;4>e;e++)this._depthProgStaticOp[d][b[e]]=
a.getProgram("depthrgba",{skin:!1,opacityMap:!0,shadowType:d,opacityChannel:b[e]}),this._depthProgSkinOp[d][b[e]]=a.getProgram("depthrgba",{skin:!0,opacityMap:!0,shadowType:d,opacityChannel:b[e]}),this._depthProgStaticOpPoint[d][b[e]]=a.getProgram("depthrgba",{skin:!1,opacityMap:!0,point:!0,opacityChannel:b[e]}),this._depthProgSkinOpPoint[d][b[e]]=a.getProgram("depthrgba",{skin:!0,opacityMap:!0,point:!0,opacityChannel:b[e]})}a=this.device.scope;this.projId=a.resolve("matrix_projection");this.viewId=
a.resolve("matrix_view");this.viewId3=a.resolve("matrix_view3");this.viewInvId=a.resolve("matrix_viewInverse");this.viewProjId=a.resolve("matrix_viewProjection");this.viewPosId=a.resolve("view_position");this.nearClipId=a.resolve("camera_near");this.farClipId=a.resolve("camera_far");this.lightRadiusId=a.resolve("light_radius");this.fogColorId=a.resolve("fog_color");this.fogStartId=a.resolve("fog_start");this.fogEndId=a.resolve("fog_end");this.fogDensityId=a.resolve("fog_density");this.modelMatrixId=
a.resolve("matrix_model");this.normalMatrixId=a.resolve("matrix_normal");this.poseMatrixId=a.resolve("matrix_pose[0]");this.boneTextureId=a.resolve("texture_poseMap");this.boneTextureSizeId=a.resolve("texture_poseMapSize");this.skinPosOffsetId=a.resolve("skinPosOffset");this.alphaTestId=a.resolve("alpha_ref");this.depthMapId=a.resolve("uDepthMap");this.screenSizeId=a.resolve("uScreenSize");this._screenSize=new pc.Vec4;this.fogColor=new Float32Array(3);this.ambientColor=new Float32Array(3)}var h=(new pc.Mat4).mul2((new pc.Mat4).setTranslate(0.5,
0.5,0.5),(new pc.Mat4).setScale(0.5,0.5,0.5)),k=new pc.Mat4,m=new pc.Mat4,r=new pc.Mat4,u=new pc.Mat4,l=new pc.Mat4,n=new pc.Mat3,w=new pc.Mat4,s=new pc.Vec3,B={},y,x=new pc.BoundingBox,A={},D={},C=[];for(i=0;8>i;i++)C.push(new pc.Vec3);new pc.Vec3;new pc.Vec3;new pc.Vec3;new a(3);new a(3);new a(3);new a(36);var z=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3];pc.extend(g.prototype,{_isVisible:function(a,b){y=b.aabb.center;var d=b._aabb.halfExtents;
B.radius=Math.max(Math.max(d.x,d.y),d.z);B.center=y;return a._frustum.containsSphere(B)},getShadowCamera:function(a,b){var d=b._shadowCamera,g;null===d?(d=pc.CLEARFLAG_DEPTH,a.extDepthTexture||(d|=pc.CLEARFLAG_COLOR),g=new pc.Camera,g.setClearOptions({color:[1,1,1,1],depth:1,flags:d}),g._node=new pc.GraphNode,d=b._shadowCamera=g,e(a,b)):(g=d.getRenderTarget(),(g.width!==b._shadowResolution||g.height!==b._shadowResolution)&&e(a,b));return d},updateCameraFrustum:function(a){var b=a.getProjectionMatrix(),
d=a._node.getPosition(),e=a._node.getRotation();u.setTRS(d,e,pc.Vec3.ONE);this.viewInvId.setValue(u.data);l.copy(u).invert();a._frustum.update(b,l)},setCamera:function(a,b){var d=a.getProjectionMatrix();this.projId.setValue(d.data);var e=a._node.getPosition(),g=a._node.getRotation();u.setTRS(e,g,pc.Vec3.ONE);this.viewInvId.setValue(u.data);l.copy(u).invert();this.viewId.setValue(l.data);n.data[0]=l.data[0];n.data[1]=l.data[1];n.data[2]=l.data[2];n.data[3]=l.data[4];n.data[4]=l.data[5];n.data[5]=l.data[6];
n.data[6]=l.data[8];n.data[7]=l.data[9];n.data[8]=l.data[10];this.viewId3.setValue(n.data);w.mul2(d,l);this.viewProjId.setValue(w.data);this.viewPosId.setValue(a._node.getPosition().data);this.nearClipId.setValue(a.getNearClip());this.farClipId.setValue(a.getFarClip());a._frustum.update(d,l);var d=this.device,f=a.getRenderTarget();d.setRenderTarget(f);d.updateBegin();var g=a.getRect(),e=f?f.width:d.width,f=f?f.height:d.height,h=Math.floor(g.x*e),k=Math.floor(g.y*f),r=Math.floor(g.width*e),g=Math.floor(g.height*
f);d.setViewport(h,k,r,g);d.setScissor(h,k,r,g);d.clear(a.getClearOptions());b&&d.setScissor(1,1,e-2,f-2)},dispatchGlobalLights:function(a){var b;this.mainLight=-1;var d=this.device.scope;this.ambientColor[0]=a.ambientLight.r;this.ambientColor[1]=a.ambientLight.g;this.ambientColor[2]=a.ambientLight.b;if(a.gammaCorrection)for(b=0;3>b;b++)this.ambientColor[b]=Math.pow(this.ambientColor[b],2.2);d.resolve("light_globalAmbient").setValue(this.ambientColor);d.resolve("exposure").setValue(a.exposure);a._skyboxModel&&
d.resolve("skyboxIntensity").setValue(a.skyboxIntensity)},dispatchDirectLights:function(a,b){var d=a._globalLights,e=d.length,g,f,h,k,r=0,l=this.device.scope;for(g=0;g<e;g++)if(d[g].mask&b){f=d[g];h=f._node.getWorldTransform();k="light"+r;l.resolve(k+"_color").setValue(a.gammaCorrection?f._linearFinalColor.data:f._finalColor.data);h.getY(f._direction).scale(-1);l.resolve(k+"_direction").setValue(f._direction.normalize().data);if(f.getCastShadows()){h=this.device.extDepthTexture?f._shadowCamera._renderTarget._depthTexture:
f._shadowCamera._renderTarget.colorBuffer;var m=100*(f._shadowBias/f._shadowCamera.getFarClip());l.resolve(k+"_shadowMap").setValue(h);l.resolve(k+"_shadowMatrix").setValue(f._shadowMatrix.data);l.resolve(k+"_shadowParams").setValue([f._shadowResolution,f._normalOffsetBias,m]);0>this.mainLight&&(l.resolve(k+"_shadowMatrixVS").setValue(f._shadowMatrix.data),l.resolve(k+"_shadowParamsVS").setValue([f._shadowResolution,f._normalOffsetBias,m]),l.resolve(k+"_directionVS").setValue(f._direction.normalize().data),
this.mainLight=g)}r++}return r},dispatchLocalLights:function(a,b,d){var e,g,f,h,k;e=a._localLights;var r=0;h=e[pc.LIGHTTYPE_POINT-1];var l=e[pc.LIGHTTYPE_SPOT-1],m=h.length,s=l.length,n=this.device.scope;for(e=0;e<m;e++)h[e].mask&b&&(f=h[e],g=f._node.getWorldTransform(),k="light"+(d+r),n.resolve(k+"_radius").setValue(f._attenuationEnd),n.resolve(k+"_color").setValue(a.gammaCorrection?f._linearFinalColor.data:f._finalColor.data),g.getTranslation(f._position),n.resolve(k+"_position").setValue(f._position.data),
f.getCastShadows()&&(g=this.device.extDepthTexture?f._shadowCamera._renderTarget._depthTexture:f._shadowCamera._renderTarget.colorBuffer,n.resolve(k+"_shadowMap").setValue(g),n.resolve(k+"_shadowMatrix").setValue(f._shadowMatrix.data),n.resolve(k+"_shadowParams").setValue([f._shadowResolution,f._normalOffsetBias,f._shadowBias,1/f.getAttenuationEnd()])),r++);for(e=0;e<s;e++)l[e].mask&b&&(h=l[e],g=h._node.getWorldTransform(),k="light"+(d+r),n.resolve(k+"_innerConeAngle").setValue(h._innerConeAngleCos),
n.resolve(k+"_outerConeAngle").setValue(h._outerConeAngleCos),n.resolve(k+"_radius").setValue(h._attenuationEnd),n.resolve(k+"_color").setValue(a.gammaCorrection?h._linearFinalColor.data:h._finalColor.data),g.getTranslation(h._position),n.resolve(k+"_position").setValue(h._position.data),g.getY(h._direction).scale(-1),n.resolve(k+"_spotDirection").setValue(h._direction.normalize().data),h.getCastShadows()&&(f=20*h._shadowBias,g=this.device.extDepthTexture?h._shadowCamera._renderTarget._depthTexture:
h._shadowCamera._renderTarget.colorBuffer,n.resolve(k+"_shadowMap").setValue(g),n.resolve(k+"_shadowMatrix").setValue(h._shadowMatrix.data),n.resolve(k+"_shadowParams").setValue([h._shadowResolution,h._normalOffsetBias,f,1/h.getAttenuationEnd()]),0>this.mainLight&&(n.resolve(k+"_shadowMatrixVS").setValue(h._shadowMatrix.data),n.resolve(k+"_shadowParamsVS").setValue([h._shadowResolution,h._normalOffsetBias,f,1/h.getAttenuationEnd()]),n.resolve(k+"_positionVS").setValue(h._position.data),this.mainLight=
e)),r++)},render:function(a,b){var d,e,g=this.device,l=g.scope;a._activeCamera=b;a.updateShaders&&(a.updateShadersFunc(g),a.updateShaders=!1);var n=b.getRenderTarget(),u=!1,w=a._gammaCorrection,A=a._toneMapping,D=a.exposure;if(n&&(n=n.colorBuffer.format,n===pc.PIXELFORMAT_RGB16F||n===pc.PIXELFORMAT_RGB32F))u=!0,a._gammaCorrection=pc.GAMMA_NONE,a._toneMapping=pc.TONEMAP_LINEAR,a.exposure=1;var I,Q,Y,G,W=a._lights,n=a.drawCalls,ga=n.length,ia=a.shadowCasters,V,T=null,P;a._globalLights.length=0;a._localLights[0].length=
0;for(I=a._localLights[1].length=0;I<W.length;I++)G=W[I],G.getEnabled()&&(G.getType()===pc.LIGHTTYPE_DIRECTIONAL?a._globalLights.push(G):a._localLights[G.getType()===pc.LIGHTTYPE_POINT?0:1].push(G));var aa=[],ea;V=pc.now();this.updateCameraFrustum(b);for(I=0;I<ga;I++)G=n[I],G.skinInstance&&G.skinInstance.updateMatrices();var da=b._node.getPosition(),U=b._node.forward;for(I=0;I<ga;I++){G=n[I];d=!0;y=null;if(!G.command){if(G._hidden)continue;e=G;e.layer===pc.LAYER_WORLD&&(b.frustumCulling&&G.cull&&
(d=this._isVisible(b,e)),d&&(ea=e.material.blendType,ea!==pc.BLEND_NONE?(y||(y=e.aabb.center),e.zdist=(y.x-da.x)*U.x+(y.y-da.y)*U.y+(y.z-da.z)*U.z):void 0!==e.zdist&&delete e.zdist))}d&&aa.push(G)}this._cullTime+=pc.now()-V;for(I=0;I<a.immediateDrawCalls.length;I++)aa.push(a.immediateDrawCalls[I]);this._immediateRendered+=a.immediateDrawCalls.length;n=aa;ga=aa.length;for(I=0;I<ga;I++)G=n[I],G.skinInstance&&G.skinInstance.updateMatrixPalette();n.sort(f);if(b._renderDepthRequests){G=b._rect;I=Math.floor(G.width*
g.width);G=Math.floor(G.height*g.height);b._depthTarget&&(b._depthTarget.width!==I&&b._depthTarget.height!==G)&&(b._depthTarget.destroy(),b._depthTarget=null);b._depthTarget||(I=new pc.Texture(g,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:I,height:G}),I.minFilter=pc.FILTER_NEAREST,I.magFilter=pc.FILTER_NEAREST,I.addressU=pc.ADDRESS_CLAMP_TO_EDGE,I.addressV=pc.ADDRESS_CLAMP_TO_EDGE,b._depthTarget=new pc.RenderTarget(g,I,{depth:!0}));ea=b.getRenderTarget();b.setRenderTarget(b._depthTarget);this.setCamera(b);
da=g.getBlending();g.setBlending(!1);for(I=0;I<ga;I++)G=n[I],!G.command&&(G.drawToDepth&&e.material.blendType===pc.BLEND_NONE)&&(e=G,d=e.mesh,this.modelMatrixId.setValue(e.node.worldTransform.data),e.skinInstance?(this._skinDrawCalls++,this.skinPosOffsetId.setValue(e.skinInstance.rootNode.getPosition().data),g.supportsBoneTextures?(P=e.skinInstance.boneTexture,this.boneTextureId.setValue(P),this.boneTextureSizeId.setValue([P.width,P.height])):this.poseMatrixId.setValue(e.skinInstance.matrixPalette),
g.setShader(this._depthShaderSkin)):g.setShader(this._depthShaderStatic),P=e.renderStyle,g.setVertexBuffer(d.vertexBuffer,0),g.setIndexBuffer(d.indexBuffer[P]),g.draw(d.primitive[P]),this._depthDrawCalls++),b.setRenderTarget(ea);g.setBlending(da)}else b._depthTarget&&(b._depthTarget.destroy(),b._depthTarget=null);var ba,X,R,ca;ea=pc.now();for(I=0;I<W.length;I++)if(G=W[I],da=G.getType(),G.getCastShadows()&&G.getEnabled()&&G.shadowUpdateMode!==pc.SHADOWUPDATE_NONE){G.shadowUpdateMode===pc.SHADOWUPDATE_THISFRAME&&
(G.shadowUpdateMode=pc.SHADOWUPDATE_NONE);var U=this.getShadowCamera(g,G),ja=1;U._node.setPosition(G._node.getPosition());U._node.setRotation(G._node.getRotation());U._node.rotateLocal(-90,0,0);if(da===pc.LIGHTTYPE_DIRECTIONAL){R=b;ba=G.getShadowDistance()||b.getFarClip();X=C;e=R.getNearClip();aa=R.getFov()*Math.PI/180;Q=R.getAspectRatio();ca=R.getProjection();var Z=void 0;d=void 0;d=ca===pc.PROJECTION_PERSPECTIVE?Math.tan(aa/2)*e:R._orthoHeight;Z=d*Q;X[0].x=Z;X[0].y=-d;X[0].z=-e;X[1].x=Z;X[1].y=
d;X[1].z=-e;X[2].x=-Z;X[2].y=d;X[2].z=-e;X[3].x=-Z;X[3].y=-d;X[3].z=-e;ca===pc.PROJECTION_PERSPECTIVE&&(d=Math.tan(aa/2)*ba,Z=d*Q);X[4].x=Z;X[4].y=-d;X[4].z=-ba;X[5].x=Z;X[5].y=d;X[5].z=-ba;X[6].x=-Z;X[6].y=d;X[6].z=-ba;X[7].x=-Z;X[7].y=-d;X[7].z=-ba;frustumSize=s.sub2(C[0],C[6]).length();frustumSize=Math.max(frustumSize,s.sub2(C[4],C[6]).length());k.copy(U._node.getWorldTransform()).invert();r.copy(k).mul(b._node.worldTransform);for(Q=0;8>Q;Q++)r.transformPoint(C[Q],C[Q]);ba=X=R=1E6;ca=aa=e=-1E6;
for(Q=0;8>Q;Q++)Z=C[Q],Z.x<ba&&(ba=Z.x),Z.x>ca&&(ca=Z.x),Z.y<X&&(X=Z.y),Z.y>aa&&(aa=Z.y),Z.z<R&&(R=Z.z),Z.z>e&&(e=Z.z);e=frustumSize/G.getShadowResolution();Q=0.5*(frustumSize-(ca-ba));ba=Math.floor((ba-Q)/e)*e;Q=0.5*(frustumSize-(aa-X));X=Math.floor((X-Q)/e)*e;ca=ba+frustumSize;aa=X+frustumSize;ba=0.5*(ca+ba);X=0.5*(aa+X);U._node.translateLocal(ba,X,1E5);U.setProjection(pc.PROJECTION_ORTHOGRAPHIC);U.setNearClip(0);U.setFarClip(2E5);U.setAspectRatio(1);U.setOrthoHeight(0.5*frustumSize)}else if(da===
pc.LIGHTTYPE_SPOT){if(b.frustumCulling&&(G._node.getWorldTransform(),G.getBoundingSphere(B),!b._frustum.containsSphere(B)))continue;U.setProjection(pc.PROJECTION_PERSPECTIVE);U.setNearClip(G.getAttenuationEnd()/1E3);U.setFarClip(G.getAttenuationEnd());U.setAspectRatio(1);U.setFov(2*G.getOuterConeAngle());this.viewPosId.setValue(U._node.getPosition().data);this.lightRadiusId.setValue(G.getAttenuationEnd())}else if(da===pc.LIGHTTYPE_POINT){if(b.frustumCulling&&(G._node.getWorldTransform(),G.getBoundingSphere(B),
!b._frustum.containsSphere(B)))continue;U.setProjection(pc.PROJECTION_PERSPECTIVE);U.setNearClip(G.getAttenuationEnd()/1E3);U.setFarClip(G.getAttenuationEnd());U.setAspectRatio(1);U.setFov(90);ja=6;this.viewPosId.setValue(U._node.getPosition().data);this.lightRadiusId.setValue(G.getAttenuationEnd())}this._shadowMapUpdates+=ja;Z="r";for(ca=0;ca<ja;ca++){da===pc.LIGHTTYPE_POINT&&(0===ca?U._node.setEulerAngles(0,90,180):1===ca?U._node.setEulerAngles(0,-90,180):2===ca?U._node.setEulerAngles(90,0,0):3===
ca?U._node.setEulerAngles(-90,0,0):4===ca?U._node.setEulerAngles(0,180,180):5===ca&&U._node.setEulerAngles(0,0,180),U._node.setPosition(G._node.getPosition()),U.setRenderTarget(G._shadowCubeMap[ca]));this.setCamera(U,da!==pc.LIGHTTYPE_POINT);aa=[];V=pc.now();Q=0;for(Y=ia.length;Q<Y;Q++)e=ia[Q],d=!0,e.cull&&(d=this._isVisible(U,e)),d&&aa.push(e);this._cullTime+=pc.now()-V;if(da===pc.LIGHTTYPE_DIRECTIONAL){d=!0;for(Q=0;Q<aa.length;Q++)e=aa[Q],e=e.aabb,d?(x.copy(e),d=!1):x.add(e);e=k;Q=x.getMin();d=
x.getMax();z[0].x=z[1].x=z[2].x=z[3].x=Q.x;z[1].y=z[3].y=z[7].y=z[5].y=Q.y;z[2].z=z[3].z=z[6].z=z[7].z=Q.z;z[4].x=z[5].x=z[6].x=z[7].x=d.x;z[0].y=z[2].y=z[4].y=z[6].y=d.y;z[0].z=z[1].z=z[4].z=z[5].z=d.z;d=9999999999;Q=-9999999999;V=void 0;for(P=0;8>P;++P)e.transformPoint(z[P],z[P]),V=z[P].z,V<d&&(d=V),V>Q&&(Q=V);e=Q;d>R&&(R=d);U._node.setPosition(G._node.getPosition());U._node.translateLocal(ba,X,e);U.setFarClip(e-R);this.setCamera(U,!0)}da!==pc.LIGHTTYPE_POINT&&(k.setTRS(U._node.getPosition(),U._node.getRotation(),
pc.Vec3.ONE).invert(),m.mul2(U.getProjectionMatrix(),k),G._shadowMatrix.mul2(h,m));g.setBlending(!1);g.setColorWrite(!0,!0,!0,!0);g.setDepthWrite(!0);g.setDepthTest(!0);g.extDepthTexture&&g.setColorWrite(!1,!1,!1,!1);Q=0;for(Y=aa.length;Q<Y;Q++)e=aa[Q],d=e.mesh,V=e.material,g.setCullMode(V.cull),this.modelMatrixId.setValue(e.node.worldTransform.data),V.opacityMap&&(l.resolve("texture_opacityMap").setValue(V.opacityMap),V.opacityMapChannel&&(Z=V.opacityMapChannel)),e.skinInstance?(this._skinDrawCalls++,
this.skinPosOffsetId.setValue(e.skinInstance.rootNode.getPosition().data),g.supportsBoneTextures?(P=e.skinInstance.boneTexture,this.boneTextureId.setValue(P),this.boneTextureSizeId.setValue([P.width,P.height])):this.poseMatrixId.setValue(e.skinInstance.matrixPalette),da!==pc.LIGHTTYPE_DIRECTIONAL?g.setShader(V.opacityMap?this._depthProgSkinOpPoint[G._shadowType][Z]:this._depthProgSkinPoint[G._shadowType]):g.setShader(V.opacityMap?this._depthProgSkinOp[G._shadowType][Z]:this._depthProgSkin[G._shadowType])):
da!==pc.LIGHTTYPE_DIRECTIONAL?g.setShader(V.opacityMap?this._depthProgStaticOpPoint[G._shadowType][Z]:this._depthProgStaticPoint[G._shadowType]):g.setShader(V.opacityMap?this._depthProgStaticOp[G._shadowType][Z]:this._depthProgStatic[G._shadowType]),P=e.renderStyle,g.setVertexBuffer(d.vertexBuffer,0),g.setIndexBuffer(d.indexBuffer[P]),g.draw(d.primitive[P]),this._shadowDrawCalls++}}this._shadowMapTime=pc.now()-ea;this.setCamera(b);this.dispatchGlobalLights(a);if(a.fog!==pc.FOG_NONE){this.fogColor[0]=
a.fogColor.r;this.fogColor[1]=a.fogColor.g;this.fogColor[2]=a.fogColor.b;if(a.gammaCorrection)for(I=0;3>I;I++)this.fogColor[I]=Math.pow(this.fogColor[I],2.2);this.fogColorId.setValue(this.fogColor);a.fog===pc.FOG_LINEAR?(this.fogStartId.setValue(a.fogStart),this.fogEndId.setValue(a.fogEnd)):this.fogDensityId.setValue(a.fogDensity)}pc._instanceVertexFormat||(pc._instanceVertexFormat=new pc.VertexFormat(g,[{semantic:pc.SEMANTIC_TEXCOORD2,components:4,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD3,
components:4,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD4,components:4,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD5,components:4,type:pc.ELEMENTTYPE_FLOAT32}]));g.enableAutoInstancing&&!pc._autoInstanceBuffer&&(pc._autoInstanceBuffer=new pc.VertexBuffer(g,pc._instanceVertexFormat,g.autoInstancingMaxObjects,pc.BUFFER_DYNAMIC),pc._autoInstanceBufferData=new Float32Array(pc._autoInstanceBuffer.lock()));var fa,ka,ha;this._screenSize.x=g.width;this._screenSize.y=g.height;
this._screenSize.z=1/g.width;this._screenSize.w=1/g.height;this.screenSizeId.setValue(this._screenSize.data);b._depthTarget&&this.depthMapId.setValue(b._depthTarget.colorBuffer);ia=pc.now();for(I=0;I<ga;I++)if(G=n[I],G.command)G.command();else{e=G;d=e.mesh;V=e.material;l=e._shaderDefs;W=e.mask;if(g.enableAutoInstancing&&(I!==ga-1&&g.extInstancing)&&(R=I+1,n[R].mesh===d&&n[R].material===V)){for(Q=0;16>Q;Q++)pc._autoInstanceBufferData[Q]=G.node.worldTransform.data[Q];for(I=1;R!==ga&&n[R].mesh===d&&
n[R].material===V;){for(Q=0;16>Q;Q++)pc._autoInstanceBufferData[16*I+Q]=n[R].node.worldTransform.data[Q];I++;R++}e.instancingData={};e.instancingData.count=I;e.instancingData._buffer=pc._autoInstanceBuffer;e.instancingData._buffer.unlock();I=R-1}e.instancingData&&g.extInstancing?(l|=pc.SHADERDEF_INSTANCING,e.instancingData._buffer||(e.instancingData._buffer=new pc.VertexBuffer(g,pc._instanceVertexFormat,G.instancingData.count,G.instancingData.usage,e.instancingData.buffer))):(l&=~pc.SHADERDEF_INSTANCING,
R=e.node.worldTransform,ea=e.normalMatrix,R.invertTo3x3(ea),ea.transpose(),this.modelMatrixId.setValue(R.data),this.normalMatrixId.setValue(ea.data));e.skinInstance&&(this._skinDrawCalls++,this.skinPosOffsetId.setValue(e.skinInstance.rootNode.getPosition().data),g.supportsBoneTextures?(P=e.skinInstance.boneTexture,this.boneTextureId.setValue(P),this.boneTextureSizeId.setValue([P.width,P.height])):this.poseMatrixId.setValue(e.skinInstance.matrixPalette));V&&(V===T&&l!==fa)&&(T=null);if(V!==T){this._materialSwitches++;
if(!e._shader||e._shaderDefs!==l)e._shader=V.variants[l],e._shader||(V.updateShader(g,a,l),e._shader=V.variants[l]=V.shader),e._shaderDefs=l;g.setShader(e._shader);fa=V.parameters;for(ha in fa)R=fa[ha],R.scopeId||(R.scopeId=g.scope.resolve(ha)),R.scopeId.setValue(R.data);if(!T||W!==ka)usedDirLights=this.dispatchDirectLights(a,W),this.dispatchLocalLights(a,W,usedDirLights);this.alphaTestId.setValue(V.alphaTest);g.setBlending(V.blend);g.setBlendFunction(V.blendSrc,V.blendDst);g.setBlendEquation(V.blendEquation);
g.setColorWrite(V.redWrite,V.greenWrite,V.blueWrite,V.alphaWrite);g.setCullMode(V.cull);g.setDepthWrite(V.depthWrite);g.setDepthTest(V.depthTest)}fa=e.parameters;for(ha in fa)R=fa[ha],R.scopeId||(R.scopeId=g.scope.resolve(ha)),R.scopeId.setValue(R.data);g.setVertexBuffer(d.vertexBuffer,0);P=e.renderStyle;g.setIndexBuffer(d.indexBuffer[P]);e.instancingData?(this._instancedDrawCalls++,this._removedByInstancing+=G.instancingData.count,g.setVertexBuffer(e.instancingData._buffer,1),g.draw(d.primitive[P],
G.instancingData.count),e.instancingData._buffer===pc._autoInstanceBuffer&&(e.instancingData=null)):g.draw(d.primitive[P]);this._forwardDrawCalls++;if(I<ga-1&&n[I+1].material===V)for(ha in fa)(R=V.parameters[ha])&&R.scopeId.setValue(R.data);T=V;fa=l;ka=W}this._forwardTime=pc.now()-ia;g.setColorWrite(!0,!0,!0,!0);0<a.immediateDrawCalls.length&&(a.immediateDrawCalls=[]);u&&(a._gammaCorrection=w,a._toneMapping=A,a.exposure=D);this._camerasRendered++}});return{ForwardRenderer:g}}());pc.extend(pc,function(){var f=function(){this.name="Untitled";this._labels={};this.localPosition=new pc.Vec3(0,0,0);this.localRotation=new pc.Quat(0,0,0,1);this.localScale=new pc.Vec3(1,1,1);this.localEulerAngles=new pc.Vec3(0,0,0);this.position=new pc.Vec3(0,0,0);this.rotation=new pc.Quat(0,0,0,1);this.eulerAngles=new pc.Vec3(0,0,0);this.localTransform=new pc.Mat4;this.dirtyLocal=!1;this.worldTransform=new pc.Mat4;this.dirtyWorld=!1;this._right=new pc.Vec3;this._up=new pc.Vec3;this._forward=new pc.Vec3;
this._parent=null;this._children=[];this._enabled=!0;this._enabledInHierarchy=!1};Object.defineProperty(f.prototype,"right",{get:function(){return this.getWorldTransform().getX(this._right).normalize()}});Object.defineProperty(f.prototype,"up",{get:function(){return this.getWorldTransform().getY(this._up).normalize()}});Object.defineProperty(f.prototype,"forward",{get:function(){return this.getWorldTransform().getZ(this._forward).normalize().scale(-1)}});Object.defineProperty(f.prototype,"enabled",
{get:function(){return this._enabled&&this._enabledInHierarchy},set:function(a){this._enabled!==a&&(this._enabled=a,(!this._parent||this._parent.enabled)&&this._notifyHierarchyStateChanged(this,a))}});pc.extend(f.prototype,{_notifyHierarchyStateChanged:function(a,b){a._onHierarchyStateChanged(b);for(var d=a._children,e=0,g=d.length;e<g;e++)d[e]._enabled&&this._notifyHierarchyStateChanged(d[e],b)},_onHierarchyStateChanged:function(a){this._enabledInHierarchy=a},_cloneInternal:function(a){a.name=this.name;
a._labels=pc.extend(this._labels,{});a.localPosition.copy(this.localPosition);a.localRotation.copy(this.localRotation);a.localScale.copy(this.localScale);a.localEulerAngles.copy(this.localEulerAngles);a.position.copy(this.position);a.rotation.copy(this.rotation);a.eulerAngles.copy(this.eulerAngles);a.localTransform.copy(this.localTransform);a.dirtyLocal=this.dirtyLocal;a.worldTransform.copy(this.worldTransform);a.dirtyWorld=this.dirtyWorld;a._enabled=this._enabled;a._enabledInHierarchy=!1},clone:function(){var a=
new pc.GraphNode;this._cloneInternal(a);return a},find:function(a,b){var d,e=this.getChildren(),g=e.length,f=[];this[a]&&(d=this[a]instanceof Function?this[a]():this[a],d===b&&f.push(this));for(d=0;d<g;++d)f=f.concat(e[d].find(a,b));return f},findOne:function(a,b){var d,e=this.getChildren(),g=e.length,f=null;if(this[a]&&(d=this[a]instanceof Function?this[a]():this[a],d===b))return this;for(d=0;d<g;++d)if(f=e[d].findOne(a,b),null!==f)return f;return null},findByName:function(a){if(this.name===a)return this;
for(var b=0;b<this._children.length;b++){var d=this._children[b].findByName(a);if(null!==d)return d}return null},findByPath:function(a){for(var a=a.split("/"),b=this,d=null,e=0,g=a.length;e<g&&b;e++){for(var f=a[e],d=null,b=b._children,k=0,m=b.length;k<m;k++)if(b[k].name==f){d=b[k];break}b=d}return d},getPath:function(){var a=this._parent;if(a){for(var b=this.name;a&&a._parent;)b=pc.string.format("{0}/{1}",a.name,b),a=a._parent;return b}return""},getRoot:function(){var a=this.getParent();if(!a)return this;
for(;a.getParent();)a=a.getParent();return a},getParent:function(){return this._parent},getChildren:function(){return this._children},getEulerAngles:function(){this.getWorldTransform().getEulerAngles(this.eulerAngles);return this.eulerAngles},getLocalEulerAngles:function(){this.localRotation.getEulerAngles(this.localEulerAngles);return this.localEulerAngles},getLocalPosition:function(){return this.localPosition},getLocalRotation:function(){return this.localRotation},getLocalScale:function(){return this.localScale},
getLocalTransform:function(){this.dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this.dirtyLocal=!1,this.dirtyWorld=!0);return this.localTransform},getName:function(){return this.name},getPosition:function(){this.getWorldTransform().getTranslation(this.position);return this.position},getRotation:function(){this.rotation.setFromMat4(this.getWorldTransform());return this.rotation},getWorldTransform:function(){var a=[];return function(){var b=this;for(a.length=
0;null!==b;)a.push(b),b=b._parent;for(b=a.length-1;0<=b;b--)a[b].sync();return this.worldTransform}}(),reparent:function(a,b){var d=this.getParent();d&&d.removeChild(this);a&&(0<=b?a.insertChild(this,b):a.addChild(this))},setLocalEulerAngles:function(){var a,b,d;switch(arguments.length){case 1:a=arguments[0].x;b=arguments[0].y;d=arguments[0].z;break;case 3:a=arguments[0],b=arguments[1],d=arguments[2]}this.localRotation.setFromEulerAngles(a,b,d);this.dirtyLocal=!0},setLocalPosition:function(){1===
arguments.length?this.localPosition.copy(arguments[0]):this.localPosition.set(arguments[0],arguments[1],arguments[2]);this.dirtyLocal=!0},setLocalRotation:function(a){1===arguments.length?this.localRotation.copy(arguments[0]):this.localRotation.set(arguments[0],arguments[1],arguments[2],arguments[3]);this.dirtyLocal=!0},setLocalScale:function(){1===arguments.length?this.localScale.copy(arguments[0]):this.localScale.set(arguments[0],arguments[1],arguments[2]);this.dirtyLocal=!0},setName:function(a){this.name=
a},setPosition:function(){var a=new pc.Vec3,b=new pc.Mat4;return function(){1===arguments.length?a.copy(arguments[0]):a.set(arguments[0],arguments[1],arguments[2]);null===this._parent?this.localPosition.copy(a):(b.copy(this._parent.getWorldTransform()).invert(),b.transformPoint(a,this.localPosition));this.dirtyLocal=!0}}(),setRotation:function(){var a=new pc.Quat,b=new pc.Quat;return function(){1===arguments.length?a.copy(arguments[0]):a.set(arguments[0],arguments[1],arguments[2],arguments[3]);if(null===
this._parent)this.localRotation.copy(a);else{var d=this._parent.getRotation();b.copy(d).invert();this.localRotation.copy(b).mul(a)}this.dirtyLocal=!0}}(),setEulerAngles:function(){var a=new pc.Quat;return function(){var b,d,e;switch(arguments.length){case 1:b=arguments[0].x;d=arguments[0].y;e=arguments[0].z;break;case 3:b=arguments[0],d=arguments[1],e=arguments[2]}this.localRotation.setFromEulerAngles(b,d,e);null!==this._parent&&(b=this._parent.getRotation(),a.copy(b).invert(),this.localRotation.mul2(a,
this.localRotation));this.dirtyLocal=!0}}(),addChild:function(a){if(null!==a.getParent())throw Error("GraphNode is already parented");this._children.push(a);this._onInsertChild(a)},addChildAndSaveTransform:function(a){var b=a.getPosition(),d=a.getRotation(),e=a.getParent();e&&e.removeChild(a);void 0===this.tmpMat4&&(this.tmpMat4=new pc.Mat4,this.tmpQuat=new pc.Quat);a.setPosition(this.tmpMat4.copy(this.worldTransform).invert().transformPoint(b));a.setRotation(this.tmpQuat.copy(this.getRotation()).invert().mul(d));
this._children.push(a);this._onInsertChild(a)},insertChild:function(a,b){if(null!==a.getParent())throw Error("GraphNode is already parented");this._children.splice(b,0,a);this._onInsertChild(a)},_onInsertChild:function(a){a._parent=this;var b=a._enabled&&this.enabled;a._enabledInHierarchy!==b&&(a._enabledInHierarchy=b,a._notifyHierarchyStateChanged(a,b));a.dirtyWorld=!0},removeChild:function(a){var b,d=this._children.length;a._parent=null;for(b=0;b<d;++b)if(this._children[b]===a){this._children.splice(b,
1);break}},addLabel:function(a){this._labels[a]=!0},getLabels:function(){return Object.keys(this._labels)},hasLabel:function(a){return!!this._labels[a]},removeLabel:function(a){delete this._labels[a]},findByLabel:function(a,b){var d,e=this._children.length,b=b||[];this.hasLabel(a)&&b.push(this);for(d=0;d<e;++d)b=this._children[d].findByLabel(a,b);return b},sync:function(){this.dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this.dirtyLocal=!1,this.dirtyWorld=
!0);if(this.dirtyWorld){null===this._parent?this.worldTransform.copy(this.localTransform):this.worldTransform.mul2(this._parent.worldTransform,this.localTransform);this.dirtyWorld=!1;for(var a=0,b=this._children.length;a<b;a++)this._children[a].dirtyWorld=!0}},syncHierarchy:function(){var a=function(){if(this._enabled){this.sync();for(var b=this._children,d=0,e=b.length;d<e;d++)a.call(b[d])}};return a}(),lookAt:function(){var a=new pc.Mat4,b=new pc.Vec3,d=new pc.Vec3,e=new pc.Quat;return function(){switch(arguments.length){case 1:b.copy(arguments[0]);
d.copy(pc.Vec3.UP);break;case 2:b.copy(arguments[0]);d.copy(arguments[1]);break;case 3:b.set(arguments[0],arguments[1],arguments[2]);d.copy(pc.Vec3.UP);break;case 6:b.set(arguments[0],arguments[1],arguments[2]),d.set(arguments[3],arguments[4],arguments[5])}a.setLookAt(this.getPosition(),b,d);e.setFromMat4(a);this.setRotation(e)}}(),translate:function(){var a=new pc.Vec3;return function(){switch(arguments.length){case 1:a.copy(arguments[0]);break;case 3:a.set(arguments[0],arguments[1],arguments[2])}a.add(this.getPosition());
this.setPosition(a)}}(),translateLocal:function(){var a=new pc.Vec3;return function(){switch(arguments.length){case 1:a.copy(arguments[0]);break;case 3:a.set(arguments[0],arguments[1],arguments[2])}this.localRotation.transformVector(a,a);this.localPosition.add(a);this.dirtyLocal=!0}}(),rotate:function(){var a=new pc.Quat,b=new pc.Quat;return function(){var d,e,g;switch(arguments.length){case 1:d=arguments[0].x;e=arguments[0].y;g=arguments[0].z;break;case 3:d=arguments[0],e=arguments[1],g=arguments[2]}a.setFromEulerAngles(d,
e,g);null===this._parent?this.localRotation.mul2(a,this.localRotation):(d=this.getRotation(),e=this._parent.getRotation(),b.copy(e).invert(),a.mul2(b,a),this.localRotation.mul2(a,d));this.dirtyLocal=!0}}(),rotateLocal:function(){var a=new pc.Quat;return function(){var b,d,e;switch(arguments.length){case 1:b=arguments[0].x;d=arguments[0].y;e=arguments[0].z;break;case 3:b=arguments[0],d=arguments[1],e=arguments[2]}a.setFromEulerAngles(b,d,e);this.localRotation.mul(a);this.dirtyLocal=!0}}()});return{GraphNode:f}}());pc.extend(pc,function(){var f=function(){this._projection=pc.PROJECTION_PERSPECTIVE;this._nearClip=0.1;this._farClip=1E4;this._fov=45;this._orthoHeight=10;this._aspect=16/9;this.frustumCulling=this._horizontalFov=!1;this._renderDepthRequests=0;this._projMatDirty=!0;this._projMat=new pc.Mat4;this._viewMat=new pc.Mat4;this._viewProjMat=new pc.Mat4;this._rect={x:0,y:0,width:1,height:1};this._frustum=new pc.Frustum(this._projMat,this._viewMat);this._depthTarget=this._renderTarget=null;this._clearOptions=
{color:[186/255,186/255,177/255,1],depth:1,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH};this._node=null};f.prototype={clone:function(){var a=new pc.Camera;a.setProjection(this.getProjection());a.setNearClip(this.getNearClip());a.setFarClip(this.getFarClip());a.setFov(this.getFov());a.setAspectRatio(this.getAspectRatio());a.setRenderTarget(this.getRenderTarget());a.setClearOptions(this.getClearOptions());a.frustumCulling=this.frustumCulling;return a},worldToScreen:function(a,b,d,e){void 0===e&&(e=
new pc.Vec3);var g=this.getProjectionMatrix(),f=this._node.getWorldTransform();this._viewMat.copy(f).invert();this._viewProjMat.mul2(g,this._viewMat);this._viewProjMat.transformPoint(a,e);a=a.data;g=this._viewProjMat.data;a=a[0]*g[3]+a[1]*g[7]+a[2]*g[11]+1*g[15];e.x=0.5*(e.x/a+1)*b;e.y=0.5*(1-e.y/a)*d;return e},screenToWorld:function(a,b,d,e,g,f){void 0===f&&(f=new pc.Vec3);var k=this.getProjectionMatrix(),m=this._node.getWorldTransform();this._viewMat.copy(m).invert();this._viewProjMat.mul2(k,this._viewMat);
k=this._viewProjMat.clone().invert();this._projection===pc.PROJECTION_PERSPECTIVE?(b=new pc.Vec3(2*(a/e)-1,2*((g-b)/g)-1,1),a=k.transformPoint(b),a.scale(1/(b.x*k.data[3]+b.y*k.data[7]+b.z*k.data[11]+k.data[15])),d/=this._farClip,f.lerp(this._node.getPosition(),a,d)):(d=new pc.Vec3(2*(a/e)-1,2*((g-b)/g)-1,2*((this._farClip-d)/(this._farClip-this._nearClip))-1),k.transformPoint(d,f));return f},getAspectRatio:function(){return this._aspect},getClearOptions:function(){return this._clearOptions},getFarClip:function(){return this._farClip},
getFov:function(){return this._fov},getFrustum:function(){return this._frustum},getNearClip:function(){return this._nearClip},getOrthoHeight:function(){return this._orthoHeight},getProjection:function(){return this._projection},getProjectionMatrix:function(){if(this._projMatDirty){if(this._projection===pc.PROJECTION_PERSPECTIVE)this._projMat.setPerspective(this._fov,this._aspect,this._nearClip,this._farClip,this._horizontalFov);else{var a=this._orthoHeight,b=a*this._aspect;this._projMat.setOrtho(-b,
b,-a,a,this._nearClip,this._farClip)}this._projMatDirty=!1}return this._projMat},getRect:function(){return this._rect},getRenderTarget:function(){return this._renderTarget},setAspectRatio:function(a){this._aspect=a;this._projMatDirty=!0},setClearOptions:function(a){this._clearOptions=a},setFarClip:function(a){this._farClip=a;this._projMatDirty=!0},setFov:function(a){this._fov=a;this._projMatDirty=!0},setNearClip:function(a){this._nearClip=a;this._projMatDirty=!0},setOrthoHeight:function(a){this._orthoHeight=
a;this._projMatDirty=!0},setHorizontalFov:function(a){this._horizontalFov=a;this._projMatDirty=!0},setProjection:function(a){this._projection=a;this._projMatDirty=!0},setRect:function(a,b,d,e){this._rect.x=a;this._rect.y=b;this._rect.width=d;this._rect.height=e},setRenderTarget:function(a){this._renderTarget=a},requestDepthMap:function(){this._renderDepthRequests++},releaseDepthMap:function(){this._renderDepthRequests--}};return{Camera:f}}());pc.extend(pc,function(){var f=new pc.Vec3,a=new pc.Vec3,b=new pc.Vec3,d=function(){this._type=pc.LIGHTTYPE_DIRECTIONAL;this._color=new pc.Color(0.8,0.8,0.8);this._intensity=1;this._enabled=this._castShadows=!1;this._attenuationEnd=this._attenuationStart=10;this._falloffMode=0;this._shadowType=pc.SHADOW_DEPTH;this.mask=1;this._innerConeAngle=40;this._outerConeAngle=45;this._finalColor=new pc.Vec3(0.8,0.8,0.8);this._linearFinalColor=new pc.Vec3;this._position=new pc.Vec3(0,0,0);this._direction=new pc.Vec3(0,
0,0);this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180);this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180);this._shadowCamera=null;this._shadowMatrix=new pc.Mat4;this._shadowDistance=40;this._shadowResolution=1024;this._shadowBias=-5E-4;this._normalOffsetBias=0;this.shadowUpdateMode=pc.SHADOWUPDATE_REALTIME;this._node=this._scene=null};d.prototype={clone:function(){var a=new pc.Light;a.setType(this.getType());a.setColor(this.getColor());a.setIntensity(this.getIntensity());
a.setCastShadows(this.getCastShadows());a.setEnabled(this.getEnabled());a.setAttenuationStart(this.getAttenuationStart());a.setAttenuationEnd(this.getAttenuationEnd());a.setFalloffMode(this.getFalloffMode());a.setShadowType(this.getShadowType());a.shadowUpdateMode=this.shadowUpdateMode;a.mask=this.mask;a.setInnerConeAngle(this.getInnerConeAngle());a.setOuterConeAngle(this.getOuterConeAngle());a.setShadowBias(this.getShadowBias());a.setNormalOffsetBias(this.getNormalOffsetBias());a.setShadowResolution(this.getShadowResolution());
a.setShadowDistance(this.getShadowDistance());return a},getAttenuationEnd:function(){return this._attenuationEnd},getAttenuationStart:function(){return this._attenuationStart},getFalloffMode:function(){return this._falloffMode},getShadowType:function(){return this._shadowType},getCastShadows:function(){return this._castShadows&&this.mask!==pc.MASK_LIGHTMAP&&0!==this.mask},getColor:function(){return this._color},getEnabled:function(){return this._enabled},getInnerConeAngle:function(){return this._innerConeAngle},
getIntensity:function(){return this._intensity},getOuterConeAngle:function(){return this._outerConeAngle},getShadowBias:function(){return this._shadowBias},getNormalOffsetBias:function(){return this._normalOffsetBias},getShadowDistance:function(){return this._shadowDistance},getShadowResolution:function(){return this._shadowResolution},getType:function(){return this._type},setAttenuationEnd:function(a){this._attenuationEnd=a},setAttenuationStart:function(a){this._attenuationStart=a},setFalloffMode:function(a){this._falloffMode=
a;null!==this._scene&&(this._scene.updateShaders=!0)},setShadowType:function(a){this._shadowType=a;null!==this._scene&&(this._scene.updateShaders=!0)},setMask:function(a){this.mask=a;null!==this._scene&&(this._scene.updateShaders=!0)},getBoundingSphere:function(d){if(this._type===pc.LIGHTTYPE_SPOT){var g=this.getAttenuationEnd(),h=this.getOuterConeAngle(),k=Math.cos(h*pc.math.DEG_TO_RAD);f.copy(this._node.up);f.scale(0.5*-g*k);f.add(this._node.getPosition());d.center=f;a.copy(this._node.up);a.scale(-g);
b.copy(this._node.right);b.scale(Math.sin(h*pc.math.DEG_TO_RAD)*g);a.add(b);d.radius=0.5*a.length()}else this._type===pc.LIGHTTYPE_POINT&&(d.center=this._node.getPosition(),d.radius=this.getAttenuationEnd())},setCastShadows:function(a){this._castShadows=a;null!==this._scene&&(this._scene.updateShaders=!0)},setColor:function(){var a,b,d;1===arguments.length?(a=arguments[0].r,b=arguments[0].g,d=arguments[0].b):3===arguments.length&&(a=arguments[0],b=arguments[1],d=arguments[2]);this._color.set(a,b,
d);var f=this._intensity;this._finalColor.set(a*f,b*f,d*f);for(a=0;3>a;a++)this._linearFinalColor.data[a]=1<=f?Math.pow(this._finalColor.data[a]/f,2.2)*f:Math.pow(this._finalColor.data[a],2.2)},setEnabled:function(a){this._enabled!==a&&(this._enabled=a,null!==this._scene&&(this._scene.updateShaders=!0))},setInnerConeAngle:function(a){this._innerConeAngle=a;this._innerConeAngleCos=Math.cos(a*Math.PI/180)},setIntensity:function(a){this._intensity=a;var b=this._color,a=this._intensity;this._finalColor.set(b.r*
a,b.g*a,b.b*a);for(b=0;3>b;b++)this._linearFinalColor.data[b]=1<=a?Math.pow(this._finalColor.data[b]/a,2.2)*a:Math.pow(this._finalColor.data[b],2.2)},setOuterConeAngle:function(a){this._outerConeAngle=a;this._outerConeAngleCos=Math.cos(a*Math.PI/180)},setShadowBias:function(a){this._shadowBias=a},setNormalOffsetBias:function(a){if(!this._normalOffsetBias&&a||this._normalOffsetBias&&!a)this._scene.updateShaders=!0;this._normalOffsetBias=a},setShadowDistance:function(a){this._shadowDistance=a},setShadowResolution:function(a){var b=
pc.Application.getApplication().graphicsDevice;this._shadowResolution=a=this._type===pc.LIGHTTYPE_POINT?Math.min(a,b.maxCubeMapSize):Math.min(a,b.maxTextureSize)},setType:function(a){this._type=a;this._destroyShadowMap()},_destroyShadowMap:function(){if(this._shadowCamera){var a=this._shadowCamera._renderTarget,b;if(a)if(a.length)for(b=0;b<a.length;b++)a[b].colorBuffer&&a[b].colorBuffer.destroy(),a[b].destroy();else a.colorBuffer&&a.colorBuffer.destroy(),a.destroy();this._shadowCubeMap=this._shadowCamera=
this._shadowCamera._renderTarget=null}},updateShadow:function(){this.shadowUpdateMode!==pc.SHADOWUPDATE_REALTIME&&(this.shadowUpdateMode=pc.SHADOWUPDATE_THISFRAME)}};return{Light:d}}());pc.extend(pc,function(){var f=0,a=function(){this.name="Untitled";this.id=f++;this.shader=null;this.variants={};this.parameters={};this.alphaTest=0;this.blend=!1;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ZERO;this.blendEquation=pc.BLENDEQUATION_ADD;this.cull=pc.CULLFACE_BACK;this.alphaWrite=this.blueWrite=this.greenWrite=this.redWrite=this.depthWrite=this.depthTest=!0;this.meshInstances=[]};Object.defineProperty(a.prototype,"blendType",{get:function(){return!this.blend&&this.blendSrc===
pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ZERO&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_NONE:this.blend&&this.blendSrc===pc.BLENDMODE_SRC_ALPHA&&this.blendDst===pc.BLENDMODE_ONE_MINUS_SRC_ALPHA&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_NORMAL:this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_ADDITIVE:this.blend&&this.blendSrc===pc.BLENDMODE_SRC_ALPHA&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===
pc.BLENDEQUATION_ADD?pc.BLEND_ADDITIVEALPHA:this.blend&&this.blendSrc===pc.BLENDMODE_DST_COLOR&&this.blendDst===pc.BLENDMODE_SRC_COLOR&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_MULTIPLICATIVE2X:this.blend&&this.blendSrc===pc.BLENDMODE_ONE_MINUS_DST_COLOR&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_SCREEN:this.blend&&this.blendSrc===pc.BLENDMODE_DST_COLOR&&this.blendDst===pc.BLENDMODE_ZERO&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_MULTIPLICATIVE:
this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE_MINUS_SRC_ALPHA&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_PREMULTIPLIED:pc.BLEND_NORMAL},set:function(a){switch(a){case pc.BLEND_NONE:this.blend=!1;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ZERO;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_NORMAL:this.blend=!0;this.blendSrc=pc.BLENDMODE_SRC_ALPHA;this.blendDst=pc.BLENDMODE_ONE_MINUS_SRC_ALPHA;this.blendEquation=pc.BLENDEQUATION_ADD;
break;case pc.BLEND_PREMULTIPLIED:this.blend=!0;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ONE_MINUS_SRC_ALPHA;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_ADDITIVE:this.blend=!0;this.blendDst=this.blendSrc=pc.BLENDMODE_ONE;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_ADDITIVEALPHA:this.blend=!0;this.blendSrc=pc.BLENDMODE_SRC_ALPHA;this.blendDst=pc.BLENDMODE_ONE;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_MULTIPLICATIVE2X:this.blend=!0;
this.blendSrc=pc.BLENDMODE_DST_COLOR;this.blendDst=pc.BLENDMODE_SRC_COLOR;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_SCREEN:this.blend=!0;this.blendSrc=pc.BLENDMODE_ONE_MINUS_DST_COLOR;this.blendDst=pc.BLENDMODE_ONE;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_MULTIPLICATIVE:this.blend=!0,this.blendSrc=pc.BLENDMODE_DST_COLOR,this.blendDst=pc.BLENDMODE_ZERO,this.blendEquation=pc.BLENDEQUATION_ADD}this._updateMeshInstanceKeys()}});a.prototype._cloneInternal=function(a){a.name=
this.name;a.id=f++;a.shader=null;a.variants={};a.parameters={};a.alphaTest=this.alphaTest;a.blend=this.blend;a.blendSrc=this.blendSrc;a.blendDst=this.blendDst;a.blendEquation=this.blendEquation;a.cull=this.cull;a.depthTest=this.depthTest;a.depthWrite=this.depthWrite;a.redWrite=this.redWrite;a.greenWrite=this.greenWrite;a.blueWrite=this.blueWrite;a.alphaWrite=this.alphaWrite;a.meshInstances=[]};a.prototype.clone=function(){var a=new pc.Material;this._cloneInternal(a);return a};a.prototype._updateMeshInstanceKeys=
function(){var a,d=this.meshInstances;for(a=0;a<d.length;a++)d[a].updateKey()};a.prototype.updateShader=function(){};a.prototype.clearParameters=function(){this.parameters={}};a.prototype.getParameters=function(){return this.parameters};a.prototype.clearVariants=function(){this.variants={};for(i=0;i<this.meshInstances.length;i++)this.meshInstances[i]._shader=null};a.prototype.getParameter=function(a){return this.parameters[a]};a.prototype.setParameter=function(a,d){var e;if(void 0===d){if(a.length){for(e=
0;e<a.length;e++)this.setParameter(a[e]);return}e=a.name;d=a.value}else e=a;var g=this.parameters[e];g?g.data=d:this.parameters[e]={scopeId:null,data:d}};a.prototype.deleteParameter=function(a){this.parameters[a]&&delete this.parameters[a]};a.prototype.setParameters=function(){for(var a in this.parameters){var d=this.parameters[a];d.scopeId||(d.scopeId=device.scope.resolve(a));d.scopeId.setValue(d.data)}};a.prototype.update=function(){throw Error("Not Implemented in base class");};a.prototype.init=
function(){throw Error("Not Implemented in base class");};a.prototype.getName=function(){return this.name};a.prototype.setName=function(a){this.name=a};a.prototype.getShader=function(){return this.shader};a.prototype.setShader=function(a){this.shader=a};return{Material:a}}());pc.extend(pc,function(){var f;f=pc.inherits(function(){this.color=new pc.Color(1,1,1,1);this.colorMap=null;this.vertexColors=!1;this.update()},pc.Material);pc.extend(f.prototype,{clone:function(){var a=new pc.BasicMaterial;pc.Material.prototype._cloneInternal.call(this,a);a.color.copy(this.color);a.colorMap=this.colorMap;a.vertexColors=this.vertexColors;a.update();return a},update:function(){this.clearParameters();this.setParameter("uColor",this.color.data);this.colorMap&&this.setParameter("texture_diffuseMap",
this.colorMap)},updateShader:function(a){var b={skin:!!this.meshInstances[0].skinInstance,vertexColors:this.vertexColors,diffuseMap:this.colorMap};this.shader=a.getProgramLibrary().getProgram("basic",b)}});return{BasicMaterial:f}}());pc.extend(pc,function(){var f;f=pc.inherits(function(){},pc.Material);pc.extend(f.prototype,{clone:function(){var a=new pc.DepthMaterial;Material.prototype._cloneInternal.call(this,a);a.update();return a},update:function(){},updateShader:function(a){var b={skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("depth",b)}});return{DepthMaterial:f}}());pc.extend(pc,function(){new pc.Vec3;new pc.Vec3;var f=function(){this.reset();this.update()},a=[],b=[],d=[],e=[],g={},h=function(b,e,h,k){var l="_"+e+"Map",r=l+"Tiling",m=l+"Offset",n=l.substring(1)+"Transform",u=l+"Uv",E=l+"Channel",F=l+"VertexColor";b[l]=null;b[r]=new pc.Vec2(1,1);b[m]=new pc.Vec2(0,0);b[n]=null;b[u]=h;0<k&&(b[E]=1<k?"rgb":"g");b[F]=!1;pc._matTex2D||(pc._matTex2D=[]);pc._matTex2D[e]=k;Object.defineProperty(f.prototype,l.substring(1),{get:function(){return this[l]},set:function(a){var b=
this[l];if(!b&&a||b&&!a)this.dirtyShader=!0;if(b&&a&&(b.rgbm!==a.rgbm||b.fixCubemapSeams!==a.fixCubemapSeams||b.format!==a.format))this.dirtyShader=!0;this[l]=a}});b=r.substring(1);e=m.substring(1);Object.defineProperty(f.prototype,b,{get:function(){this.dirtyShader=!0;return this[r]},set:function(a){this.dirtyShader=!0;this[r]=a}});g[b]=function(a,b,d){a=a._updateMapTransform(d?a[n]:null,b,a[m]);return{name:"texture_"+n,value:a.data}};Object.defineProperty(f.prototype,e,{get:function(){this.dirtyShader=
!0;return this[m]},set:function(a){this.dirtyShader=!0;this[m]=a}});g[e]=function(a,b,d){a=a._updateMapTransform(d?a[n]:null,a[r],b);return{name:"texture_"+n,value:a.data}};Object.defineProperty(f.prototype,u.substring(1),{get:function(){return this[u]},set:function(a){this.dirtyShader=!0;this[u]=a}});Object.defineProperty(f.prototype,E.substring(1),{get:function(){return this[E]},set:function(a){this.dirtyShader=!0;this[E]=a}});Object.defineProperty(f.prototype,F.substring(1),{get:function(){return this[F]},
set:function(a){this.dirtyShader=!0;this[F]=a}});a.push(l.substring(1));a.push(r.substring(1));a.push(m.substring(1));a.push(u.substring(1));a.push(E.substring(1));a.push(F.substring(1));d.push(n)},k=[],m=function(b,d,h,l){var r="_"+d,m=d+"Uniform",n=d+"Intensity",u="_"+n;b[r]=h;b[m]=new Float32Array(3);Object.defineProperty(f.prototype,d,{get:function(){this.dirtyShader=this.dirtyColor=!0;return this[r]},set:function(a){var b=this[r],d=0===a.r&&0===a.g&&0===a.b||1===a.r&&1===a.g&&1===a.b;if(0===
b.r&&0===b.g&&0===b.b||1===b.r&&1===b.g&&1===b.b||d)this.dirtyShader=!0;this.dirtyColor=!0;this[r]=a}});a.push(d);e.push(m);k.push(d);g[d]=function(a,b,e){for(var e=e?a[m]:new Float32Array(3),g=a._scene||pc.Application.getApplication().scene,f=0;3>f;f++)e[f]=g.gammaCorrection?Math.pow(b.data[f],2.2):b.data[f],l&&(e[f]*=a[u]);return{name:"material_"+d,value:e}};l&&(b[u]=1,Object.defineProperty(f.prototype,n,{get:function(){return this[u]},set:function(a){var b=this[u];if(0===b||1===b||0===a||1===a)this.dirtyShader=
!0;this.dirtyColor=!0;this[u]=a}}),a.push(n),g[n]=function(a,b,e){for(var b=e?a[m]:new Float32Array(3),e=a._scene||pc.Application.getApplication().scene,g=0;3>g;g++)b[g]=e.gammaCorrection?Math.pow(a[r].data[g],2.2):a[r].data[g],b[g]*=a[u];return{name:"material_"+d,value:b}})},r=function(b,d,e,h){var k="_"+d;b[k]=e;Object.defineProperty(f.prototype,d,{get:function(){return this[k]},set:function(a){var b=this[k];if(0===b||1===b||0===a||1===a)this.dirtyShader=!0;this[k]=a}});a.push(d);g[d]=void 0!==
h?h:function(a,b){return{name:"material_"+d,value:b}}},u=function(b,d,e){var h="_"+d;b[h]=null;Object.defineProperty(f.prototype,d,{get:function(){return this[h]},set:function(a){var b=this[h];if(!b&&a||b&&!a)this.dirtyShader=!0;this[h]=a}});a.push(d);g[d]=e},l=function(b,d,e){var g="_"+d;b[g]=e;Object.defineProperty(f.prototype,d,{get:function(){return this[g]},set:function(a){this.dirtyShader=!0;this[g]=a}});a.push(d)},f=pc.inherits(f,pc.Material);pc.extend(f.prototype,{reset:function(){this.blendType=
pc.BLEND_NONE;var g;for(g=0;g<a.length;g++){var f=b[g];this[a[g]]=f?f.clone?f.clone():f:f}for(g=0;g<d.length;g++)this[d[g]]=null;for(g=0;g<e.length;g++)this[e[g]]=new Float32Array(3);this._chunks={};this._chunks.copy=function(a){for(var b in a)a.hasOwnProperty(b)&&"copy"!==b&&(this[b]=a[b])};this.cubeMapMinUniform=new Float32Array(3);this.cubeMapMaxUniform=new Float32Array(3)},clone:function(){var b=new pc.StandardMaterial;pc.Material.prototype._cloneInternal.call(this,b);for(var d,e=0;e<a.length;e++)d=
a[e],void 0!==this[d]&&(this[d]&&this[d].copy?b[d]?b[d].copy(this[d]):b[d]=this[d].clone():b[d]=this[d]);b.update();return b},init:function(a){this.reset();this.name=a.name;for(var b=0;b<a.parameters.length;b++){var d=a.parameters[b];if("vec3"===d.type)this[d.name]=new pc.Color(d.data[0],d.data[1],d.data[2]);else if("vec2"===d.type)this[d.name]=new pc.Vec2(d.data[0],d.data[1]);else if("texture"===d.type){var e=d.name;d=d.data?d.data instanceof pc.Texture?d.data:null:null;this[e]=d}else"cubemap"===
d.type?(e=d.name,d=d.data&&d.data instanceof pc.Texture?d.data:null,this[e]=d):"bumpMapFactor"===d.name?this.bumpiness=d.data:this[d.name]=d.data}this.update()},_updateMapTransform:function(a,b,d){a=a||new pc.Vec4;a.set(b.x,b.y,d.x,d.y);return 1===a.x&&1===a.y&&0===a.z&&0===a.w?null:a},_collectLights:function(a,b,d,e){for(var g=0;g<b.length;g++)b[g].getEnabled()&&b[g].mask&e&&b[g].getType()==a&&d.push(b[g])},_setParameter:function(a,b){this.setParameter(a,b);this._propsSet.push(a)},_clearParameters:function(){for(var a=
this._propsSet,b=0;b<a.length;b++)delete this.parameters[a[b]];this._propsSet=[]},_updateMap:function(a){a+="Map";if(this[a]){this._setParameter("texture_"+a,this[a]);var b=a+"Transform";this[b]=this._updateMapTransform(this[b],this[a+"Tiling"],this[a+"Offset"]);this[b]&&this._setParameter("texture_"+b,this[b].data)}},getUniform:function(a,b,d){return(a=g[a])?a(this,b,d):null},update:function(){this._clearParameters();this._setParameter("material_ambient",this.ambientUniform);(!this.diffuseMap||this.diffuseMapTint)&&
this._setParameter("material_diffuse",this.diffuseUniform);this.useMetalness?(!this.metalnessMap||1>this.metalness)&&this._setParameter("material_metalness",this.metalness):(!this.specularMap||this.specularMapTint)&&this._setParameter("material_specular",this.specularUniform);this._setParameter(this.getUniform("shininess",this.shininess,!0));(!this.emissiveMap||this.emissiveMapTint)&&this._setParameter("material_emissive",this.emissiveUniform);0<this.refraction&&(this._setParameter("material_refraction",
this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex));this._setParameter("material_opacity",this.opacity);this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity);this.cubeMapProjection===pc.CUBEPROJ_BOX&&this._setParameter(this.getUniform("cubeMapProjectionBox",this.cubeMapProjectionBox,!0));for(var a in pc._matTex2D)this._updateMap(a);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH);this.normalMap&&
this._setParameter("material_bumpiness",this.bumpiness);this.heightMap&&this._setParameter(this.getUniform("heightMapFactor",this.heightMapFactor,!0));this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap);this.prefilteredCubeMap128&&this._setParameter("texture_prefilteredCubeMap128",this.prefilteredCubeMap128);this.prefilteredCubeMap64&&this._setParameter("texture_prefilteredCubeMap64",this.prefilteredCubeMap64);this.prefilteredCubeMap32&&this._setParameter("texture_prefilteredCubeMap32",
this.prefilteredCubeMap32);this.prefilteredCubeMap16&&this._setParameter("texture_prefilteredCubeMap16",this.prefilteredCubeMap16);this.prefilteredCubeMap8&&this._setParameter("texture_prefilteredCubeMap8",this.prefilteredCubeMap8);this.prefilteredCubeMap4&&this._setParameter("texture_prefilteredCubeMap4",this.prefilteredCubeMap4);this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap);this.dpAtlas&&this._setParameter("texture_sphereMap",this.dpAtlas);this._setParameter("material_reflectivity",
this.reflectivity);if(this.dirtyShader||!this._scene)this.shader=null,this.clearVariants();this._processColor()},_processColor:function(){if(this._scene&&this.dirtyColor){for(i=0;i<k.length;i++){var a=this["_"+k[i]],b=this[k[i]+"Uniform"];for(c=0;3>c;c++)b[c]=this._scene.gammaCorrection?Math.pow(a.data[c],2.2):a.data[c]}for(c=0;3>c;c++)this.emissiveUniform[c]*=this.emissiveIntensity;this.dirtyColor=!1}},_getMapTransformID:function(a,b){if(!a)return 0;this._mapXForms[b]||(this._mapXForms[b]=[]);var d,
e,g;for(d=0;d<this._mapXForms[b].length;d++){g=!0;for(e=0;e<a.data.length;e++)if(this._mapXForms[b][d][e]!=a.data[e]){g=!1;break}if(g)return d+1}d=this._mapXForms[b].length;this._mapXForms[b][d]=[];for(e=0;e<a.data.length;e++)this._mapXForms[b][d][e]=a.data[e];return d+1},updateShader:function(a,b,d){this._scene||(this._scene=b,this._processColor());var e=b._lights;this._mapXForms=[];var g=a.useTexCubeLod,f=!a.extTextureLod,h=this.prefilteredCubeMap128||b.skyboxPrefiltered128,k=this.prefilteredCubeMap64||
b.skyboxPrefiltered64,l=this.prefilteredCubeMap32||b.skyboxPrefiltered32,r=this.prefilteredCubeMap16||b.skyboxPrefiltered16,m=this.prefilteredCubeMap8||b.skyboxPrefiltered8,n=this.prefilteredCubeMap4||b.skyboxPrefiltered4;if(h){var u=h&&k&&l&&r&&m&&n;f&&u?(h.dpAtlas||(h.dpAtlas=pc.generateDpAtlas(a,[h,k,l,r,m,n]),h.sh=pc.shFromCubemap(r)),this.dpAtlas=h.dpAtlas,this.ambientSH=h.sh,this._setParameter("ambientSH[0]",this.ambientSH),this._setParameter("texture_sphereMap",this.dpAtlas)):g?6>h._levels.length?
u?this._setParameter("texture_prefilteredCubeMap128",h):console.log("Can't use prefiltered cubemap: "+u+", "+g+", "+h._levels):this._setParameter("texture_prefilteredCubeMap128",h):u?(this._setParameter("texture_prefilteredCubeMap128",h),this._setParameter("texture_prefilteredCubeMap64",k),this._setParameter("texture_prefilteredCubeMap32",l),this._setParameter("texture_prefilteredCubeMap16",r),this._setParameter("texture_prefilteredCubeMap8",m),this._setParameter("texture_prefilteredCubeMap4",n)):
console.log("Can't use prefiltered cubemap: "+u+", "+g+", "+h._levels)}f=!1;(k=(k=(this.useMetalness?!0:!!this.specularMap)||!!this.sphereMap||!!this.cubeMap||!!this.dpAtlas)||(this.useMetalness?!0:!(0===this.specular.r&&0===this.specular.g&&0===this.specular.b)))&&this.specularMapTint&&!this.useMetalness&&(f=1!==this.specular.r||1!==this.specular.g||1!==this.specular.b);l=(h?h.rgbm:!1)||(this.cubeMap?this.cubeMap.rgbm:!1)||(this.sphereMap?this.sphereMap.rgbm:!1)||(this.dpAtlas?this.dpAtlas.rgbm:
!1);b={fog:this.noFog?"none":b.fog,gamma:b.gammaCorrection,toneMap:b.toneMapping,blendMapsWithColors:!0,modulateAmbient:this.ambientTint,diffuseTint:(1!=this.diffuse.r||1!=this.diffuse.g||1!=this.diffuse.b)&&this.diffuseMapTint,specularTint:f,metalnessTint:this.useMetalness&&1>this.metalness,glossTint:!0,emissiveTint:(1!=this.emissive.r||1!=this.emissive.g||1!=this.emissive.b||1!=this.emissiveIntensity)&&this.emissiveMapTint,opacityTint:1!=this.opacity&&this.blendType!==pc.BLEND_NONE,alphaTest:0<
this.alphaTest,needsNormalFloat:this.normalizeNormalMap,sphereMap:!!this.sphereMap,cubeMap:!!this.cubeMap,dpAtlas:!!this.dpAtlas,ambientSH:!!this.ambientSH,useSpecular:k,rgbmReflection:l,hdrReflection:(h?h.rgbm||h.format===pc.PIXELFORMAT_RGBA32F:!1)||(this.cubeMap?this.cubeMap.rgbm||this.cubeMap.format===pc.PIXELFORMAT_RGBA32F:!1)||(this.sphereMap?this.sphereMap.rgbm||this.sphereMap.format===pc.PIXELFORMAT_RGBA32F:!1)||(this.dpAtlas?this.dpAtlas.rgbm||this.dpAtlas.format===pc.PIXELFORMAT_RGBA32F:
!1),fixSeams:h?h.fixCubemapSeams:this.cubeMap?this.cubeMap.fixCubemapSeams:!1,prefilteredCubemap:!!h,emissiveFormat:this.emissiveMap?this.emissiveMap.rgbm?1:this.emissiveMap.format===pc.PIXELFORMAT_RGBA32F?2:0:null,lightMapFormat:this.lightMap?this.lightMap.rgbm?1:this.lightMap.format===pc.PIXELFORMAT_RGBA32F?2:0:null,useRgbm:l||(this.emissiveMap?this.emissiveMap.rgbm:0)||(this.lightMap?this.lightMap.rgbm:0),specularAA:this.specularAntialias,conserveEnergy:this.conserveEnergy,occludeSpecular:this.occludeSpecular,
occludeSpecularFloat:1!==this.occludeSpecularIntensity,occludeDirect:this.occludeDirect,shadingModel:this.shadingModel,fresnelModel:this.fresnelModel,packedNormal:this.normalMap?this.normalMap.format===pc.PIXELFORMAT_DXT5:!1,shadowSampleType:this.shadowSampleType,forceFragmentPrecision:this.forceFragmentPrecision,fastTbn:this.fastTbn,cubeMapProjection:this.cubeMapProjection,chunks:this.chunks,customFragmentShader:this.customFragmentShader,refraction:!!this.refraction,useMetalness:this.useMetalness,
blendType:this.blendType,skyboxIntensity:h===b.skyboxPrefiltered128&&h&&1!==b.skyboxIntensity,forceUv1:this.forceUv1,useTexCubeLod:g};f=h=g=!1;d&&(b.noShadow=0!==(d&pc.SHADERDEF_NOSHADOW),b.skin=0!==(d&pc.SHADERDEF_SKIN),b.useInstancing=0!==(d&pc.SHADERDEF_INSTANCING),0!==(d&pc.SHADERDEF_LM)&&(b.lightMapFormat=1,b.lightMap=!0,b.lightMapChannel="rgb",b.lightMapUv=1,b.lightMapTransform=0,b.lightMapWithoutAmbient=!0,b.useRgbm=!0),g=0!==(d&pc.SHADERDEF_UV0),h=0!==(d&pc.SHADERDEF_UV1),f=0!==(d&pc.SHADERDEF_VCOLOR));
for(var M in pc._matTex2D)"opacity"===M&&this.blendType===pc.BLEND_NONE&&0===this.alphaTest||(k=M+"Map",l=k+"VertexColor","height"!==M&&this[l]?f&&(k+="Channel",b[l]=this[l],b[k]=this[k],b.vertexColors=!0):this[k]&&(l=k+"Uv",r=!0,0===this[l]&&!g&&(r=!1),1===this[l]&&!h&&(r=!1),r&&(b[k]=!!this[k],r=k+"Transform",k+="Channel",b[r]=this._getMapTransformID(this[r],this[l]),b[k]=this[k],b[l]=this[l])));b.aoMapUv=b.aoMapUv||this.aoUvSet;this._mapXForms=null;M=[];g=d?d>>8:1;this._collectLights(pc.LIGHTTYPE_DIRECTIONAL,
e,M,g);this._collectLights(pc.LIGHTTYPE_POINT,e,M,g);this._collectLights(pc.LIGHTTYPE_SPOT,e,M,g);b.lights=M;this.shader=a.getProgramLibrary().getProgram("standard",b);d||(this.clearVariants(),this.variants[0]=this.shader);this.dirtyShader=!1}});var n=f.prototype;n.dirtyShader=!0;n.dirtyColor=!0;n._scene=null;m(n,"ambient",new pc.Color(0.7,0.7,0.7));m(n,"diffuse",new pc.Color(1,1,1));m(n,"specular",new pc.Color(0,0,0));m(n,"emissive",new pc.Color(0,0,0),!0);r(n,"shininess",25,function(a,b){return{name:"material_shininess",
value:a.shadingModel===pc.SPECULAR_PHONG?Math.pow(2,0.11*b):0.01*b}});r(n,"heightMapFactor",1,function(a,b){return{name:"material_heightMapFactor",value:0.025*b}});r(n,"opacity",1);r(n,"alphaTest",0);r(n,"bumpiness",1);r(n,"reflectivity",1);r(n,"occludeSpecularIntensity",1);r(n,"refraction",0);r(n,"refractionIndex",1/1.5);r(n,"metalness",1);r(n,"aoUvSet",0,null);u(n,"ambientSH",function(a,b){return{name:"ambientSH[0]",value:b}});u(n,"cubeMapProjectionBox",function(a,b,d){var e=d?a.cubeMapMinUniform:
new Float32Array(3),a=d?a.cubeMapMaxUniform:new Float32Array(3);e[0]=b.center.x-b.halfExtents.x;e[1]=b.center.y-b.halfExtents.y;e[2]=b.center.z-b.halfExtents.z;a[0]=b.center.x+b.halfExtents.x;a[1]=b.center.y+b.halfExtents.y;a[2]=b.center.z+b.halfExtents.z;return[{name:"envBoxMin",value:e},{name:"envBoxMax",value:a}]});(function(){this._chunks=null;Object.defineProperty(f.prototype,"chunks",{get:function(){this.dirtyShader=!0;return this._chunks},set:function(a){this.dirtyShader=!0;this._chunks=a}});
a.push("chunks")})(n);l(n,"ambientTint",!1);l(n,"diffuseMapTint",!1);l(n,"specularMapTint",!1);l(n,"emissiveMapTint",!1);l(n,"fastTbn",!1);l(n,"specularAntialias",!1);l(n,"useMetalness",!1);l(n,"occludeDirect",!1);l(n,"normalizeNormalMap",!0);l(n,"conserveEnergy",!0);l(n,"occludeSpecular",pc.SPECOCC_AO);l(n,"shadingModel",pc.SPECULAR_PHONG);l(n,"fresnelModel",pc.FRESNEL_NONE);l(n,"cubeMapProjection",pc.CUBEPROJ_NONE);l(n,"shadowSampleType",pc.SHADOWSAMPLE_PCF3X3);l(n,"customFragmentShader",null);
l(n,"forceFragmentPrecision",null);l(n,"noFog",!1);l(n,"forceUv1",!1);h(n,"diffuse",0,3);h(n,"specular",0,3);h(n,"emissive",0,3);h(n,"normal",0,-1);h(n,"metalness",0,1);h(n,"gloss",0,1);h(n,"opacity",0,1);h(n,"height",0,1);h(n,"ao",0,1);h(n,"light",1,3);u(n,"cubeMap");u(n,"sphereMap");u(n,"dpAtlas");u(n,"prefilteredCubeMap128");u(n,"prefilteredCubeMap64");u(n,"prefilteredCubeMap32");u(n,"prefilteredCubeMap16");u(n,"prefilteredCubeMap8");u(n,"prefilteredCubeMap4");for(h=0;h<a.length;h++)b[h]=n[a[h]];
n._propsSet=[];return{StandardMaterial:f}}());pc.extend(pc,function(){function f(a,b,g,f){return(a&7)<<28|(b&3)<<26|(g?1:0)<<25|(f&33554431)<<0}var a=function(a,b,g){this.buffer=new Float32Array(a*(g||16));this.count=a;this.usage=b?pc.BUFFER_DYNAMIC:pc.BUFFER_STATIC;this._buffer=null};a.prototype={update:function(){this._buffer&&this._buffer.setData(this.buffer)}};var b=function(a,b,g){this.node=a;this.mesh=b;this.material=g;this._shader=null;this._shaderDefs=256;this._shaderDefs|=b.vertexBuffer.format.hasUv0?pc.SHADERDEF_UV0:0;this._shaderDefs|=
b.vertexBuffer.format.hasUv1?pc.SHADERDEF_UV1:0;this._shaderDefs|=b.vertexBuffer.format.hasColor?pc.SHADERDEF_VCOLOR:0;this.layer=pc.LAYER_WORLD;this.renderStyle=pc.RENDERSTYLE_SOLID;this.castShadow=!1;this.pick=this.cull=this.drawToDepth=this._receiveShadow=!0;this.key=0;this.updateKey();this._skinInstance=null;this.aabb=new pc.BoundingBox;this.normalMatrix=new pc.Mat3;this._boneAabb=null;this.parameters={}};Object.defineProperty(b.prototype,"aabb",{get:function(){if(this.skinInstance){var a=this.mesh.skin.boneNames.length,
b;if(!this.mesh.boneAabb){this.mesh.boneAabb=[];this.mesh.boneUsed=[];var g=this.mesh.vertexBuffer.format.elements,f=this.mesh.vertexBuffer.numVertices,k=this.mesh.vertexBuffer.format.size,m,r,u,l,n;for(b=0;b<g.length;b++)g[b].name===pc.SEMANTIC_POSITION?m=g[b].offset:g[b].name===pc.SEMANTIC_BLENDINDICES?r=g[b].offset:g[b].name===pc.SEMANTIC_BLENDWEIGHT&&(u=g[b].offset);var g=new Uint8Array(this.mesh.vertexBuffer.storage),w=new Float32Array(this.mesh.vertexBuffer.storage);m/=4;var s=u/4,B=k/4,y,x,
A,D,C;u=[];var z=[],E=this.mesh.boneUsed;for(b=0;b<a;b++)u[b]=new pc.Vec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),z[b]=new pc.Vec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(l=0;l<f;l++)for(n=0;4>n;n++)0<w[l*B+s+n]&&(b=g[l*k+r+n],A=w[l*B+m],D=w[l*B+m+1],C=w[l*B+m+2],y=z[b],x=u[b],x.x>A&&(x.x=A),x.y>D&&(x.y=D),x.z>C&&(x.z=C),y.x<A&&(y.x=A),y.y<D&&(y.y=D),y.z<C&&(y.z=C),E[b]=!0);for(b=0;b<a;b++)f=new pc.BoundingBox,f.setMinMax(u[b],z[b]),this.mesh.boneAabb.push(f)}if(!this._boneAabb){this._boneAabb=
[];for(b=0;b<this.mesh.boneAabb.length;b++)this._boneAabb[b]=new pc.BoundingBox}E=this.mesh.boneUsed;for(b=0;b<this.mesh.boneAabb.length;b++)E[b]&&(this._boneAabb[b].setFromTransformedAabb(this.mesh.boneAabb[b],this.skinInstance.matrices[b]),this._boneAabb[b].center.add(this.skinInstance.rootNode.getPosition()));a=!0;for(b=0;b<this.mesh.boneAabb.length;b++)E[b]&&(a?(this._aabb.center.copy(this._boneAabb[b].center),this._aabb.halfExtents.copy(this._boneAabb[b].halfExtents),a=!1):this._aabb.add(this._boneAabb[b]))}else this._aabb.setFromTransformedAabb(this.mesh.aabb,
this.node.worldTransform);return this._aabb},set:function(a){this._aabb=a}});Object.defineProperty(b.prototype,"material",{get:function(){return this._material},set:function(a){this._shader=null;if(this._material){var b=this._material.meshInstances,g=b.indexOf(this);-1!==g&&b.splice(g,1)}this._material=a;this._material.meshInstances.push(this);this.updateKey()}});Object.defineProperty(b.prototype,"layer",{get:function(){return this._layer},set:function(a){this._layer=a;this.updateKey()}});Object.defineProperty(b.prototype,
"receiveShadow",{get:function(){return this._receiveShadow},set:function(a){this._shaderDefs=(this._receiveShadow=a)?this._shaderDefs&~pc.SHADERDEF_NOSHADOW:this._shaderDefs|pc.SHADERDEF_NOSHADOW;this._shader=null}});Object.defineProperty(b.prototype,"skinInstance",{get:function(){return this._skinInstance},set:function(a){this._shaderDefs=(this._skinInstance=a)?this._shaderDefs|pc.SHADERDEF_SKIN:this._shaderDefs&~pc.SHADERDEF_SKIN;this._shader=null}});Object.defineProperty(b.prototype,"mask",{get:function(){return this._shaderDefs>>
8},set:function(a){this._shaderDefs=this._shaderDefs&255|a<<8;this._shader=null}});pc.extend(b.prototype,{syncAabb:function(){},updateKey:function(){var a=this.material;this.key=f(this.layer,a.blendType,!1,a.id)},setParameter:pc.Material.prototype.setParameter,setParameters:pc.Material.prototype.setParameters,deleteParameter:pc.Material.prototype.deleteParameter,getParameter:pc.Material.prototype.getParameter,getParameters:pc.Material.prototype.getParameters,clearParameters:pc.Material.prototype.clearParameters});
return{Command:function(a,b,g){this.key=f(a,b,!0,0);this.command=g},Mesh:function(){this.vertexBuffer=null;this.indexBuffer=[null];this.primitive=[{type:0,base:0,count:0}];this.skin=null;this.aabb=new pc.BoundingBox;this.boneAabb=null},MeshInstance:b,InstancingData:a,_getDrawcallSortKey:f}}());pc.extend(pc,function(){var f=function(a,b){this.skin=a;this.rootNode=b;this.bones=[];var d=a.inverseBindPose.length,e=a.device;if(e.supportsBoneTextures){var g;g=256<d?64:64<d?32:16<d?16:8;this.matrixPalette=new Float32Array(4*g*g);this.boneTexture=new pc.Texture(e,{width:g,height:g,format:pc.PIXELFORMAT_RGBA32F,autoMipmap:!1});this.boneTexture.minFilter=pc.FILTER_NEAREST;this.boneTexture.magFilter=pc.FILTER_NEAREST;this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(16*
d);this.matrices=[];for(e=0;e<d;e++)this.matrices[e]=new pc.Mat4};f.prototype={updateMatrices:function(){for(var a=this.rootNode.getPosition(),b=this.bones.length-1;0<=b;b--)this.matrices[b].mul2(this.bones[b].getWorldTransform(),this.skin.inverseBindPose[b]),this.matrices[b].data[12]-=a.x,this.matrices[b].data[13]-=a.y,this.matrices[b].data[14]-=a.z},updateMatrixPalette:function(){for(var a,b=this.matrixPalette,d,e=this.bones.length-1;0<=e;e--)a=this.matrices[e].data,d=16*e,b[d]=a[0],b[d+1]=a[1],
b[d+2]=a[2],b[d+3]=a[3],b[d+4]=a[4],b[d+5]=a[5],b[d+6]=a[6],b[d+7]=a[7],b[d+8]=a[8],b[d+9]=a[9],b[d+10]=a[10],b[d+11]=a[11],b[d+12]=a[12],b[d+13]=a[13],b[d+14]=a[14],b[d+15]=a[15];this.skin.device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}};return{Skin:function(a,b,d){this.device=a;this.inverseBindPose=b;this.boneNames=d},SkinInstance:f}}());pc.extend(pc,function(){function f(){this.index=0;this.boneIndices=[0,0,0,0]}function a(){this.indexCount=this.indexStart=this.vertexCount=this.vertexStart=this.partition=0;this.boneIndices=[];this.vertices=[];this.indices=[];this.indexMap={}}a.prototype={addVertex:function(a,d,e){var g=-1;if(void 0!==this.indexMap[d])g=this.indexMap[d],this.indices.push(g);else{for(g=0;4>g;g++)0!==e.blendWeight.data[4*d+g]&&(a.boneIndices[g]=this.getBoneRemap(e.blendIndices.data[4*a.index+g]));g=this.vertices.length;
this.indices.push(g);this.vertices.push(a);this.indexMap[d]=g}},addPrimitive:function(a,d,e,g){var f,k,m=[],r=0,u=a.length;for(f=0;f<u;f++)for(var l=a[f].index,n=0;4>n;n++)if(0<e.blendWeight.data[4*l+n]){var w=e.blendIndices.data[4*l+n],s=!0;for(k=0;k<r;k++)if(m[k]==w){s=!1;break}s&&(m[r]=w,k=this.getBoneRemap(w),r+=-1===k?1:0)}if(this.boneIndices.length+r>g)return!1;for(f=0;f<r;f++)this.boneIndices.push(m[f]);for(f=0;f<u;f++)this.addVertex(a[f],d[f],e);return!0},getBoneRemap:function(a){for(var d=
0;d<this.boneIndices.length;d++)if(this.boneIndices[d]===a)return d;return-1}};return{partitionSkin:function(b,d,e){var g,h,k,m,r=b.vertices,u=b.skins,l=b.meshes,n=b.meshInstances;for(g=0;g<l.length;g++)l[g].vertices=r[l[g].vertices],void 0!==l[g].skin&&(l[g].skin=u[l[g].skin]);for(g=0;g<n.length;g++)n[g].mesh=l[n[g].mesh];var r=b.vertices,u=b.skins,w,l=b.meshes,n=b.meshInstances,s=function(a){var b=new f;b.index=a;return b};for(g=u.length-1;0<=g;g--)if(u[g].boneNames.length>e){var B=u.splice(g,1)[0],
y=[];for(h=0;h<l.length;h++)l[h].skin===B&&y.push(l[h]);for(h=0;h<y.length;h++)m=l.indexOf(y[h]),-1!==m&&l.splice(m,1);if(0===y.length)throw Error("partitionSkin: There should be at least one mesh that references a skin");var x=y[0].vertices;for(h=1;h<y.length;h++)if(y[h].vertices!==x)throw Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");var A=[],D=[];k=[];var C=0;for(h=0;h<y.length;h++){w=y[h];for(var z=w.indices,E=w.base;E<w.base+w.count;){m=z[E++];
D[0]=s(m);k[0]=m;m=z[E++];D[1]=s(m);k[1]=m;m=z[E++];D[2]=s(m);k[2]=m;for(var F=!1,N=C;N<A.length;N++)if(m=A[N],m.addPrimitive(D,k,x,e)){F=!0;break}F||(m=new a,m.originalMesh=w,m.addPrimitive(D,k,x,e),A.push(m))}C=A.length}w=[];y=[];for(h=0;h<A.length;h++)if(m=A[h],m.vertices.length&&m.indices.length){D=w.length;k=m.vertices.length;C=y.length;z=m.indices.length;m.partition=h;m.vertexStart=D;m.vertexCount=k;m.indexStart=C;m.indexCount=z;E=0;for(F=D;E<k;)w[F++]=m.vertices[E++];E=0;for(F=C;E<z;)y[F++]=
m.indices[E++]+D}D=[];for(h=0;h<A.length;h++){m=A[h];C=[];z=[];for(k=0;k<m.boneIndices.length;k++)C.push(B.inverseBindMatrices[m.boneIndices[k]]),z.push(B.boneNames[m.boneIndices[k]]);m={inverseBindMatrices:C,boneNames:z};D.push(m);u.push(m)}var J,B={};for(J in x)B[J]={components:x[J].components,data:[],type:x[J].type};for(J in x)if("blendIndices"===J){m=B[J].data;for(h=0;h<w.length;h++)k=w[h].boneIndices,m.push(k[0],k[1],k[2],k[3])}else{h=x[J];data=h.data;components=h.components;for(h=0;h<w.length;h++){m=
w[h].index;for(k=0;k<components;k++)B[J].data.push(data[m*components+k])}}r[r.indexOf(x)]=B;for(h=0;h<A.length;h++){m=A[h];w={aabb:{min:[0,0,0],max:[0,0,0]},vertices:B,skin:D[h],indices:y.splice(0,m.indexCount),type:"triangles",base:0,count:m.indexCount};l.push(w);for(k=n.length-1;0<=k;k--)n[k].mesh===m.originalMesh&&(n.push({mesh:w,node:n[k].node}),d&&d.push({material:d[k].material,path:d[k].path}))}for(h=0;h<A.length;h++){m=A[h];for(k=n.length-1;0<=k;k--)n[k].mesh===m.originalMesh&&(n.splice(k,
1),d&&d.splice(k,1))}}d=b.vertices;e=b.skins;J=b.meshes;g=b.meshInstances;for(b=0;b<J.length;b++)J[b].vertices=d.indexOf(J[b].vertices),void 0!==J[b].skin&&(J[b].skin=e.indexOf(J[b].skin));for(b=0;b<g.length;b++)g[b].mesh=J.indexOf(g[b].mesh)}}}());pc.extend(pc,function(){var f=function(){this.graph=null;this.meshInstances=[];this.skinInstances=[];this.cameras=[];this.lights=[];this._shadersVersion=0};f.prototype={getGraph:function(){return this.graph},setGraph:function(a){this.graph=a},getCameras:function(){return this.cameras},setCameras:function(a){this.cameras=a},getLights:function(){return this.lights},setLights:function(a){this.lights=a},getMaterials:function(){var a,b=[];for(a=0;a<this.meshInstances.length;a++){var d=this.meshInstances[a];
-1===b.indexOf(d.material)&&b.push(d.material)}return b},clone:function(){var a,b=[],d=[],e=function(a){var g=a.clone();b.push(a);d.push(g);for(var a=a.getChildren(),f=0;f<a.length;f++)g.addChild(e(a[f]));return g},g=e(this.graph),f=[],k=[];for(a=0;a<this.skinInstances.length;a++){var m=this.skinInstances[a].skin,r=new pc.SkinInstance(m,g),u=[];for(j=0;j<m.boneNames.length;j++){var l=g.findByName(m.boneNames[j]);u.push(l)}r.bones=u;k.push(r)}for(a=0;a<this.meshInstances.length;a++)m=this.meshInstances[a],
r=b.indexOf(m.node),r=new pc.MeshInstance(d[r],m.mesh,m.material),m.skinInstance&&(m=this.skinInstances.indexOf(m.skinInstance),r.skinInstance=k[m]),f.push(r);a=new pc.Model;a.graph=g;a.meshInstances=f;a.skinInstances=k;a.getGraph().syncHierarchy();return a},generateWireframe:function(){var a,b,d,e,g,f,k,m,r,u,l=[];for(a=0;a<this.meshInstances.length;a++)f=this.meshInstances[a].mesh,-1===l.indexOf(f)&&l.push(f);var n=[[0,1],[1,2],[2,0]];for(a=0;a<l.length;a++){f=l[a];k=f.primitive[pc.RENDERSTYLE_SOLID].base;
m=f.primitive[pc.RENDERSTYLE_SOLID].count;r=f.indexBuffer[pc.RENDERSTYLE_SOLID];u=new Uint16Array(r.lock());var w={},s=[];for(b=k;b<k+m;b+=3)for(d=0;3>d;d++){e=u[b+n[d][0]];g=u[b+n[d][1]];var B=e>g?g<<16|e:e<<16|g;void 0===w[B]&&(w[B]=0,s.push(e,g))}r.unlock();b=new pc.IndexBuffer(r.device,pc.INDEXFORMAT_UINT16,s.length);d=new Uint16Array(b.lock());d.set(s);b.unlock();f.primitive[pc.RENDERSTYLE_WIREFRAME]={type:pc.PRIMITIVE_LINES,base:0,count:s.length,indexed:!0};f.indexBuffer[pc.RENDERSTYLE_WIREFRAME]=
b}}};return{Model:f}}());pc.extend(pc,function(){function f(a){return Math.max(Math.min(a,1),0)}function a(a,b,d,e){var g,f,h;if(void 0===d||2>d)return b*=a.length-1,g=a[Math.floor(b)],f=a[Math.ceil(b)],pc.math.lerp(g,f,b%1);b*=a.length/d-1;e||(e=[]);for(var k=0;k<d;k++)g=a[Math.floor(b)*d+k],f=a[Math.ceil(b)*d+k],h=b%1,e[k]=pc.math.lerp(g,f,h);return e}function b(a,b){S[a]=void 0!==$[a]&&null!==$[a]?$[a]:b}function d(a,b){for(var d=a.length/3,e=Array(4*d),g=0;g<d;g++)e[4*g]=a[3*g],e[4*g+1]=a[3*g+1],e[4*g+2]=a[3*g+2],e[4*
g+3]=(255*b[3*g]<<16|255*b[3*g+1]<<8|255*b[3*g+2])/16777216;return e}function e(a,b,d){for(var e=new Float32Array(b.length),g=0;g<b.length;g++)e[g]=b[g]-a[g];for(var g=d.length,f=e.length/g,a=0;a<f;a++)for(b=0;b<g;b++){var h=Math.abs(e[a*g+b]);d[b]=Math.max(d[b],h)}a=d.length;f=e.length/a;for(b=0;b<f;b++)for(g=0;g<a;g++)e[b*a+g]/=d[g],e[b*a+g]*=0.5,e[b*a+g]+=0.5;return e}function g(a,b){b.data[0]=a.data[0];b.data[1]=a.data[1];b.data[2]=a.data[2];b.data[3]=a.data[4];b.data[4]=a.data[5];b.data[5]=a.data[6];
b.data[6]=a.data[8];b.data[7]=a.data[9];b.data[8]=a.data[10]}var h=[[-1,-1],[1,-1],[1,1],[-1,1]],k=function(a,b,d,e,g,f){g||(g=pc.PIXELFORMAT_RGBA32F);a=new pc.Texture(a,{width:b,height:d,format:g,cubemap:!1,autoMipmap:!1});a.addressU=pc.ADDRESS_CLAMP_TO_EDGE;a.addressV=pc.ADDRESS_CLAMP_TO_EDGE;a.minFilter=pc.FILTER_NEAREST;a.magFilter=pc.FILTER_NEAREST;b=a.lock();if(g==pc.PIXELFORMAT_R8_G8_B8_A8){a.minFilter=pc.FILTER_LINEAR;a.magFilter=pc.FILTER_LINEAR;g=new Uint8Array(e.length);for(d=0;d<e.length;d++)g[d]=
255*e[d]*f;e=g}b.set(e);a.unlock();return a},m=new pc.Curve([0,0,1,0]),r=new pc.Curve([0,1,1,1]),u=new pc.CurveSet([0,0,1,0],[0,0,1,0],[0,0,1,0]),l=new pc.CurveSet([0,1,1,1],[0,1,1,1],[0,1,1,1]),n=null,w=new pc.Vec3,s=new pc.Vec3,B=new pc.Vec3,y=new pc.Vec3,x=new pc.Vec3,A=new pc.Vec3,D=new pc.Vec3,C=new pc.Vec3,z=new pc.Vec3,E=new pc.Mat4,F=new pc.Mat3,N=new pc.Mat3,J=1,M,O=new pc.Mat4,K=new pc.Vec3,H=new pc.Vec3,L=new pc.Vec3;new pc.Vec3;var S,$,I=function(a,d){this.graphicsDevice=a;this.precision=
32;if(!n){var e=new Float32Array(1024),g,h,s,w;for(h=0;16>h;h++)for(g=0;16>g;g++)s=g+1-8.5,w=h+1-8.5,w=f(1-f(Math.sqrt(s*s+w*w)/16)-0.5),s=16*h+g,e[4*s]=1,e[4*s+1]=1,e[4*s+2]=1,e[4*s+3]=w;n=k(a,16,16,e,pc.PIXELFORMAT_R8_G8_B8_A8,1);n.minFilter=pc.FILTER_LINEAR;n.magFilter=pc.FILTER_LINEAR}S=this;$=d;b("numParticles",1);b("rate",1);b("rate2",this.rate);b("lifetime",50);b("emitterExtents",new pc.Vec3(0,0,0));b("emitterRadius",0);b("emitterShape",pc.EMITTERSHAPE_BOX);b("initialVelocity",1);b("wrap",
!1);b("wrapBounds",null);b("colorMap",n);b("normalMap",null);b("loop",!0);b("preWarm",!1);b("sort",pc.PARTICLESORT_NONE);b("mode",pc.PARTICLEMODE_GPU);b("scene",null);b("lighting",!1);b("halfLambert",!1);b("intensity",1);b("stretch",0);b("alignToMotion",!1);b("depthSoftening",0);b("mesh",null);b("depthWrite",!1);b("noFog",!1);b("blendType",pc.BLEND_NORMAL);b("node",null);b("startAngle",0);b("startAngle2",this.startAngle);b("animTilesX",1);b("animTilesY",1);b("animNumFrames",1);b("animSpeed",1);b("animLoop",
!0);this.frameRandom=new pc.Vec3(0,0,0);b("colorGraph",l);b("colorGraph2",this.colorGraph);b("scaleGraph",r);b("scaleGraph2",this.scaleGraph);b("alphaGraph",r);b("alphaGraph2",this.alphaGraph);b("localVelocityGraph",u);b("localVelocityGraph2",this.localVelocityGraph);b("velocityGraph",u);b("velocityGraph2",this.velocityGraph);b("rotationSpeedGraph",m);b("rotationSpeedGraph2",this.rotationSpeedGraph);this.constantParticleTexIN=a.scope.resolve("particleTexIN");this.constantParticleTexOUT=a.scope.resolve("particleTexOUT");
this.constantEmitterPos=a.scope.resolve("emitterPos");this.constantEmitterScale=a.scope.resolve("emitterScale");this.constantSpawnBounds=a.scope.resolve("spawnBounds");this.constantSpawnBoundsSphere=a.scope.resolve("spawnBoundsSphere");this.constantInitialVelocity=a.scope.resolve("initialVelocity");this.constantFrameRandom=a.scope.resolve("frameRandom");this.constantDelta=a.scope.resolve("delta");this.constantRate=a.scope.resolve("rate");this.constantRateDiv=a.scope.resolve("rateDiv");this.constantLifetime=
a.scope.resolve("lifetime");this.constantLightCube=a.scope.resolve("lightCube[0]");this.constantGraphSampleSize=a.scope.resolve("graphSampleSize");this.constantGraphNumSamples=a.scope.resolve("graphNumSamples");this.constantInternalTex0=a.scope.resolve("internalTex0");this.constantInternalTex1=a.scope.resolve("internalTex1");this.constantInternalTex2=a.scope.resolve("internalTex2");this.constantEmitterMatrix=a.scope.resolve("emitterMatrix");this.constantNumParticles=a.scope.resolve("numParticles");
this.constantNumParticlesPot=a.scope.resolve("numParticlesPot");this.constantLocalVelocityDivMult=a.scope.resolve("localVelocityDivMult");this.constantVelocityDivMult=a.scope.resolve("velocityDivMult");this.constantRotSpeedDivMult=a.scope.resolve("rotSpeedDivMult");this.constantSeed=a.scope.resolve("seed");this.constantStartAngle=a.scope.resolve("startAngle");this.constantStartAngle2=a.scope.resolve("startAngle2");this.lightCube=new Float32Array(18);this.lightCubeDir=Array(6);this.lightCubeDir[0]=
new pc.Vec3(-1,0,0);this.lightCubeDir[1]=new pc.Vec3(1,0,0);this.lightCubeDir[2]=new pc.Vec3(0,-1,0);this.lightCubeDir[3]=new pc.Vec3(0,1,0);this.lightCubeDir[4]=new pc.Vec3(0,0,-1);this.lightCubeDir[5]=new pc.Vec3(0,0,1);this.animParams=new pc.Vec4;this.camera=this.particleDistance=this.vbOld=this.vbToSort=this.internalTex3=this.internalTex2=this.internalTex1=this.internalTex0=null;this.swapTex=!1;this.useMesh=!0;this.useCpu=!1;this.shaderParticleUpdateOnStop=this.shaderParticleUpdateNoRespawn=this.shaderParticleUpdateRespawn=
null;this.numParticleIndices=this.numParticleVerts=0;this.meshInstance=this.material=null;this.seed=0;this.fixedTimeStep=1/60;this.maxSubSteps=10;this.simTime=0;this.beenReset=!1;this.rebuild()};I.prototype={onChangeCamera:function(){0<this.depthSoftening&&this.camera&&this.camera.requestDepthMap();this.regenShader();this.resetMaterial()},rebuild:function(){var a,b=this.graphicsDevice;null===this.colorMap&&(this.colorMap=n);this.spawnBounds=this.emitterShape===pc.EMITTERSHAPE_BOX?this.emitterExtents:
this.emitterRadius;this.useCpu=this.useCpu||this.sort>pc.PARTICLESORT_NONE||!(b.extTextureFloat&&1<=b.maxVertexTextures&&b.extTextureFloatRenderable)||100>b.fragmentUniformsCount;this.vertexBuffer=void 0;this.useMesh=!1;this.mesh&&(65535<this.numParticles*this.mesh.vertexBuffer.numVertices?console.warn("WARNING: particle system can't render mesh particles because numParticles * numVertices is more than 65k. Reverting to quad particles."):this.useMesh=!0);this.numParticlesPot=pc.math.nextPowerOfTwo(this.numParticles);
this.rebuildGraphs();this.vbToSort=Array(this.numParticles);this.particleDistance=new Float32Array(this.numParticles);this.frameRandom.x=Math.random();this.frameRandom.y=Math.random();this.frameRandom.z=Math.random();this.particleTex=new Float32Array(16*this.numParticlesPot);var d=null===this.node?pc.Vec3.ZERO:this.node.getPosition();this.emitterShape===pc.EMITTERSHAPE_BOX&&(null===this.node?O.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,this.spawnBounds):O.setTRS(pc.Vec3.ZERO,this.node.getRotation(),L.copy(this.spawnBounds).mul(this.node.getLocalScale())));
for(a=0;a<this.numParticles;a++)this.calcSpawnPosition(d,a),this.particleTex[4*a+3+8*this.numParticlesPot]=1;this.particleTexStart=new Float32Array(16*this.numParticlesPot);for(a=0;a<this.particleTexStart.length;a++)this.particleTexStart[a]=this.particleTex[a];this.useCpu||(this.particleTexIN=k(b,this.numParticlesPot,4,this.particleTex),this.particleTexOUT=k(b,this.numParticlesPot,4,this.particleTex),this.particleTexStart=k(b,this.numParticlesPot,4,this.particleTexStart),this.rtParticleTexIN=new pc.RenderTarget(b,
this.particleTexIN,{depth:!1}),this.rtParticleTexOUT=new pc.RenderTarget(b,this.particleTexOUT,{depth:!1}),this.swapTex=!1);a=pc.shaderChunks;var d=a.particleUpdaterInitPS+(this.emitterShape===pc.EMITTERSHAPE_BOX?a.particleUpdaterAABBPS:a.particleUpdaterSpherePS)+a.particleUpdaterStartPS,e=d+a.particleUpdaterNoRespawnPS+a.particleUpdaterEndPS,g=d+a.particleUpdaterOnStopPS+a.particleUpdaterEndPS;this.shaderParticleUpdateRespawn=a.createShaderFromCode(b,a.fullscreenQuadVS,d+a.particleUpdaterRespawnPS+
a.particleUpdaterEndPS,"fsQuad0"+this.emitterShape);this.shaderParticleUpdateNoRespawn=a.createShaderFromCode(b,a.fullscreenQuadVS,e,"fsQuad1"+this.emitterShape);this.shaderParticleUpdateOnStop=a.createShaderFromCode(b,a.fullscreenQuadVS,g,"fsQuad2"+this.emitterShape);this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4;this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6;this._allocate(this.numParticles);b=new pc.Mesh;b.vertexBuffer=this.vertexBuffer;b.indexBuffer[0]=
this.indexBuffer;b.primitive[0].type=pc.PRIMITIVE_TRIANGLES;b.primitive[0].base=0;b.primitive[0].count=this.numParticles*this.numParticleIndices;b.primitive[0].indexed=!0;this.material=new pc.Material;this.material.cullMode=pc.CULLFACE_NONE;this.material.alphaWrite=!1;this.material.blend=!0;this.material.blendType=this.blendType;this.material.depthWrite=this.depthWrite;this.material.emitter=this;this.regenShader();this.resetMaterial();this.meshInstance=new pc.MeshInstance(this.node,b,this.material);
this.meshInstance.updateKey();this.meshInstance.drawToDepth=!1;this._initializeTextures();this.addTime(0);this.preWarm&&this.prewarm(this.lifetime);this.resetTime()},_isAnimated:function(){return 1<=this.animNumFrames&&(1<this.animTilesX||1<this.animTilesY)&&(this.colorMap&&this.colorMap!==n||this.normalMap)},calcSpawnPosition:function(a,b){var d=Math.random(),e=Math.random(),g=Math.random(),f=Math.random();this.particleTex[4*b+0+8*this.numParticlesPot]=d;this.particleTex[4*b+1+8*this.numParticlesPot]=
e;this.particleTex[4*b+2+8*this.numParticlesPot]=g;K.data[0]=d-0.5;K.data[1]=e-0.5;K.data[2]=g-0.5;this.emitterShape===pc.EMITTERSHAPE_BOX?H.copy(a).add(O.transformPoint(K)):(K.normalize(),H.copy(a).add(K.scale(f*this.spawnBounds)));this.particleTex[4*b]=H.data[0];this.particleTex[4*b+1]=H.data[1];this.particleTex[4*b+2]=H.data[2];this.particleTex[4*b+3]=pc.math.lerp(this.startAngle*pc.math.DEG_TO_RAD,this.startAngle2*pc.math.DEG_TO_RAD,d);d=-pc.math.lerp(this.rate,this.rate2,d)*b;this.particleTex[4*
b+3+4*this.numParticlesPot]=d},rebuildGraphs:function(){var a=this.precision,b=this.graphicsDevice,g;this.qLocalVelocity=this.localVelocityGraph.quantize(a);this.qVelocity=this.velocityGraph.quantize(a);this.qColor=this.colorGraph.quantize(a);this.qRotSpeed=this.rotationSpeedGraph.quantize(a);this.qScale=this.scaleGraph.quantize(a);this.qAlpha=this.alphaGraph.quantize(a);this.qLocalVelocity2=this.localVelocityGraph2.quantize(a);this.qVelocity2=this.velocityGraph2.quantize(a);this.qColor2=this.colorGraph2.quantize(a);
this.qRotSpeed2=this.rotationSpeedGraph2.quantize(a);this.qScale2=this.scaleGraph2.quantize(a);this.qAlpha2=this.alphaGraph2.quantize(a);for(g=0;g<a;g++)this.qRotSpeed[g]*=pc.math.DEG_TO_RAD,this.qRotSpeed2[g]*=pc.math.DEG_TO_RAD;this.localVelocityUMax=new pc.Vec3(0,0,0);this.velocityUMax=new pc.Vec3(0,0,0);this.colorUMax=new pc.Vec3(0,0,0);this.rotSpeedUMax=[0];this.scaleUMax=[0];this.alphaUMax=[0];this.qLocalVelocityDiv=e(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax.data);this.qVelocityDiv=
e(this.qVelocity,this.qVelocity2,this.velocityUMax.data);this.qColorDiv=e(this.qColor,this.qColor2,this.colorUMax.data);this.qRotSpeedDiv=e(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax);this.qScaleDiv=e(this.qScale,this.qScale2,this.scaleUMax);this.qAlphaDiv=e(this.qAlpha,this.qAlpha2,this.alphaUMax);if(!this.useCpu){this.internalTex0=k(b,a,1,d(this.qLocalVelocity,this.qLocalVelocityDiv));this.internalTex1=k(b,a,1,d(this.qVelocity,this.qVelocityDiv));g=this.qRotSpeed;for(var f=this.qScale,h=this.qScaleDiv,
l=this.qRotSpeedDiv,r=this.qAlphaDiv,m=Array(4*g.length),n=0;n<g.length;n++)m[4*n]=g[n],m[4*n+1]=f[n],m[4*n+2]=0,m[4*n+3]=(255*h[n]<<16|255*l[n]<<8|255*r[n])/16777216;this.internalTex2=k(b,a,1,m)}g=this.qColor;f=this.qAlpha;h=Array(4*f.length);for(l=0;l<f.length;l++)h[4*l]=g[3*l],h[4*l+1]=g[3*l+1],h[4*l+2]=g[3*l+2],h[4*l+3]=f[l];this.internalTex3=k(b,a,1,h,pc.PIXELFORMAT_R8_G8_B8_A8,1)},_initializeTextures:function(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&
this.normalMap&&this.material.setParameter("normalMap",this.normalMap))},regenShader:function(){var a=this.graphicsDevice.getProgramLibrary(),b=null!==this.normalMap;this.normalOption=0;this.lighting&&(this.normalOption=b?2:1);this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!=this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());var b=a.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,
halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop});
this.setShader(b)};this.material.updateShader()},resetMaterial:function(){var a=this.material;a.setParameter("stretch",this.stretch);this._isAnimated()&&a.setParameter("animTexParams",this.animParams.data);a.setParameter("colorMult",this.intensity);this.useCpu||(a.setParameter("internalTex0",this.internalTex0),a.setParameter("internalTex1",this.internalTex1),a.setParameter("internalTex2",this.internalTex2));a.setParameter("internalTex3",this.internalTex3);a.setParameter("numParticles",this.numParticles);
a.setParameter("numParticlesPot",this.numParticlesPot);a.setParameter("lifetime",this.lifetime);a.setParameter("rate",this.rate);a.setParameter("rateDiv",this.rate2-this.rate);a.setParameter("seed",this.seed);a.setParameter("scaleDivMult",this.scaleUMax[0]);a.setParameter("alphaDivMult",this.alphaUMax[0]);a.setParameter("graphNumSamples",this.precision);a.setParameter("graphSampleSize",1/this.precision);a.setParameter("emitterScale",pc.Vec3.ONE.data);this.wrap&&this.wrapBounds&&a.setParameter("wrapBounds",
this.wrapBounds.data);this.colorMap&&a.setParameter("colorMap",this.colorMap);this.lighting&&this.normalMap&&a.setParameter("normalMap",this.normalMap);0<this.depthSoftening&&a.setParameter("softening",1/(100*this.depthSoftening*this.depthSoftening));0<this.stretch&&(a.cull=pc.CULLFACE_NONE)},_allocate:function(a){var b=a*this.numParticleVerts,d=a*this.numParticleIndices,e;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==b){e=this.useCpu?[{semantic:pc.SEMANTIC_ATTR0,components:4,
type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR1,components:4,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR2,components:4,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR3,components:2,type:pc.ELEMENTTYPE_FLOAT32}]:[{semantic:pc.SEMANTIC_ATTR0,components:4,type:pc.ELEMENTTYPE_FLOAT32}];e=new pc.VertexFormat(this.graphicsDevice,e);this.vertexBuffer=new pc.VertexBuffer(this.graphicsDevice,e,b,pc.BUFFER_DYNAMIC);this.indexBuffer=new pc.IndexBuffer(this.graphicsDevice,pc.INDEXFORMAT_UINT16,
d);e=new Float32Array(this.vertexBuffer.lock());var g,f;this.useMesh&&(g=new Float32Array(this.mesh.vertexBuffer.lock()),f=g.length/this.mesh.vertexBuffer.numVertices);for(d=0;d<b;d++){id=Math.floor(d/this.numParticleVerts);if(this.useMesh){var k=d%this.numParticleVerts;e[4*d]=g[k*f];e[4*d+1]=g[k*f+1];e[4*d+2]=g[k*f+2]}else k=d%4,e[4*d]=h[k][0],e[4*d+1]=h[k][1],e[4*d+2]=0;e[4*d+3]=id}this.useCpu&&(this.vbCPU=new Float32Array(e),this.vbOld=new Float32Array(this.vbCPU.length));this.vertexBuffer.unlock();
this.useMesh&&this.mesh.vertexBuffer.unlock();b=0;indices=new Uint16Array(this.indexBuffer.lock());this.useMesh&&(g=new Uint16Array(this.mesh.indexBuffer[0].lock()));for(d=0;d<a;d++)if(this.useMesh)for(f=0;f<this.numParticleIndices;f++)indices[d*this.numParticleIndices+f]=g[f]+d*this.numParticleVerts;else f=4*d,indices[b++]=f,indices[b++]=f+1,indices[b++]=f+2,indices[b++]=f,indices[b++]=f+2,indices[b++]=f+3;this.indexBuffer.unlock();this.useMesh&&this.mesh.indexBuffer[0].unlock()}},reset:function(){this.beenReset=
!0;this.seed=Math.random();this.material.setParameter("seed",this.seed);if(this.useCpu)for(var a=0;a<this.particleTexStart.length;a++)this.particleTex[a]=this.particleTexStart[a];else this._initializeTextures();this.resetTime();a=this.loop;this.loop=!0;this.addTime(0);this.loop=a;this.preWarm&&this.prewarm(this.lifetime)},prewarm:function(a){for(var b=Math.min(Math.floor(a/this.lifetime*this.precision),this.precision),a=a/b,d=0;d<b;d++)this.addTime(a)},resetTime:function(){var a=Math.max(this.rate,
this.rate2)*this.numParticles+this.lifetime;this.endTime=Date.now()+1E3*a},onEnableDepth:function(){0<this.depthSoftening&&this.camera&&this.camera.requestDepthMap()},onDisableDepth:function(){0<this.depthSoftening&&this.camera&&this.camera.releaseDepthMap()},addTime:function(b,d){var e,h,k=this.graphicsDevice;this._isAnimated()&&(e=this.animParams,e.x=1/this.animTilesX,e.y=1/this.animTilesY,e.z=this.animNumFrames*this.animSpeed,e.w=this.animNumFrames-1);if(this.lighting){if(!this.scene){console.error("There is no scene defined for lighting particles");
return}for(e=0;6>e;e++)this.lightCube[3*e]=this.scene.ambientLight.r,this.lightCube[3*e+1]=this.scene.ambientLight.g,this.lightCube[3*e+2]=this.scene.ambientLight.b;h=this.scene._globalLights;for(e=0;e<h.length;e++)for(var l=0;6>l;l++){var r=Math.max(this.lightCubeDir[l].dot(h[e]._direction),0)*h[e]._intensity;this.lightCube[3*l]+=h[e]._color.r*r;this.lightCube[3*l+1]+=h[e]._color.g*r;this.lightCube[3*l+2]+=h[e]._color.b*r}this.constantLightCube.setValue(this.lightCube)}this.scene&&this.camera!=this.scene._activeCamera&&
(this.camera=this.scene._activeCamera,this.onChangeCamera());this.emitterShape===pc.EMITTERSHAPE_BOX&&(null===this.meshInstance.node?O.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,this.emitterExtents):O.setTRS(pc.Vec3.ZERO,this.meshInstance.node.getRotation(),L.copy(this.emitterExtents).mul(this.meshInstance.node.getLocalScale())));e=null===this.meshInstance.node?pc.Vec3.ONE.data:this.meshInstance.node.getLocalScale().data;this.material.setParameter("emitterScale",e);if(this.useCpu){k=new Float32Array(this.vertexBuffer.lock());
if(this.meshInstance.node){e=this.meshInstance.node.worldTransform;for(h=0;12>h;h++)E.data[h]=e.data[h];M=this.meshInstance.node.getLocalScale();J=Math.max(Math.max(M.x,M.y),M.z)}h=null===this.meshInstance.node?pc.Vec3.ZERO:this.meshInstance.node.getPosition();l=this.camera?this.camera._node.getPosition():pc.Vec3.ZERO;for(e=0;e<this.numParticles;e++){var r=Math.floor(this.vbCPU[4*e*this.numParticleVerts+3]),m=this.particleTex[4*r+0+8*this.numParticlesPot];x.x=m;x.y=this.particleTex[4*r+1+8*this.numParticlesPot];
x.z=this.particleTex[4*r+2+8*this.numParticlesPot];var n=pc.math.lerp(this.rate,this.rate2,m),u=this.lifetime,H=this.particleTex[4*r+3+4*this.numParticlesPot]+b,I=f(H/u),U=0,S=0,X=0<H&&H<u;if(X){s.data=a(this.qLocalVelocity,I,3,s.data);y.data=a(this.qLocalVelocity2,I,3,y.data);w.data=a(this.qVelocity,I,3,w.data);B.data=a(this.qVelocity2,I,3,B.data);var R=a(this.qRotSpeed,I),S=a(this.qRotSpeed2,I),U=a(this.qScale,I),$=a(this.qScale2,I),ja=a(this.qAlpha,I),Z=a(this.qAlpha2,I);s.x=pc.math.lerp(s.x,y.x,
x.x);s.y=pc.math.lerp(s.y,y.y,x.y);s.z=pc.math.lerp(s.z,y.z,x.z);0<this.initialVelocity&&(this.emitterShape===pc.EMITTERSHAPE_SPHERE?(K.copy(x).scale(2).sub(pc.Vec3.ONE).normalize(),s.add(K.scale(this.initialVelocity))):s.add(pc.Vec3.FORWARD.scale(this.initialVelocity)));w.x=pc.math.lerp(w.x,B.x,x.x);w.y=pc.math.lerp(w.y,B.y,x.y);w.z=pc.math.lerp(w.z,B.z,x.z);R=pc.math.lerp(R,S,x.y);U=pc.math.lerp(U,$,1E4*m%1)*J;S=(Z-ja)*(1E3*m%1);this.meshInstance.node&&E.transformPoint(s,s);s.add(w.mul(M));z.copy(s);
A.x=this.particleTex[4*r];A.y=this.particleTex[4*r+1];A.z=this.particleTex[4*r+2];D.copy(A).add(s.scale(b));C.copy(D);this.particleTex[4*r]=C.x;this.particleTex[4*r+1]=C.y;this.particleTex[4*r+2]=C.z;this.particleTex[4*r+3]+=R*b;this.wrap&&this.wrapBounds&&(C.sub(h),C.x=C.x-this.wrapBounds.x*Math.floor(C.x/this.wrapBounds.x)-0.5*this.wrapBounds.x,C.y=C.y-this.wrapBounds.y*Math.floor(C.y/this.wrapBounds.y)-0.5*this.wrapBounds.y,C.z=C.z-this.wrapBounds.z*Math.floor(C.z/this.wrapBounds.z)-0.5*this.wrapBounds.z,
C.add(h));0<this.sort&&(1===this.sort?(L.copy(C).sub(l),this.particleDistance[r]=-(L.x*L.x+L.y*L.y+L.z*L.z)):2===this.sort?this.particleDistance[r]=H:3===this.sort&&(this.particleDistance[r]=-H))}else this.calcSpawnPosition(h,r);d?0>H&&(this.particleTex[4*r+3+8*this.numParticlesPot]=-1):(H>=u&&(H-=Math.max(u,(this.numParticles-1)*n),this.particleTex[4*r+3+8*this.numParticlesPot]=this.loop?1:-1),0>H&&this.loop&&(this.particleTex[4*r+3+8*this.numParticlesPot]=1));0>this.particleTex[4*r+3+8*this.numParticlesPot]&&
(X=!1);this.particleTex[4*r+3+4*this.numParticlesPot]=H;for(m=0;m<this.numParticleVerts;m++)n=this.vbCPU[4*e*this.numParticleVerts+4*m],u=this.vbCPU[4*e*this.numParticleVerts+4*m+1],H=this.vbCPU[4*e*this.numParticleVerts+4*m+2],X||(n=u=H=0),R=14*e*this.numParticleVerts+14*m,k[R]=C.x,k[R+1]=C.y,k[R+2]=C.z,k[R+3]=I,k[R+4]=this.alignToMotion?0:this.particleTex[4*r+3],k[R+5]=U,k[R+6]=S,k[R+7]=z.x,k[R+8]=n,k[R+9]=u,k[R+10]=H,k[R+11]=z.y,k[R+12]=z.z}if(this.sort>pc.PARTICLESORT_NONE&&this.camera){for(e=
0;e<this.numParticles;e++)this.vbToSort[e]=[e,Math.floor(this.vbCPU[4*e*this.numParticleVerts+3])];for(e=0;e<this.vbCPU.length;e++)this.vbOld[e]=this.vbCPU[e];var fa=this.particleDistance;this.vbToSort.sort(function(a,b){return fa[a[1]]-fa[b[1]]});for(e=0;e<this.numParticles;e++){k=this.vbToSort[e][0];for(l=0;l<this.numParticleVerts;l++)for(h=0;4>h;h++)this.vbCPU[4*e*this.numParticleVerts+4*l+h]=this.vbOld[4*k*this.numParticleVerts+4*l+h]}}this.vertexBuffer.unlock()}else k.setBlending(!1),k.setColorWrite(!0,
!0,!0,!0),k.setCullMode(pc.CULLFACE_NONE),k.setDepthTest(!1),k.setDepthWrite(!1),this.frameRandom.x=Math.random(),this.frameRandom.y=Math.random(),this.frameRandom.z=Math.random(),this.constantGraphSampleSize.setValue(1/this.precision),this.constantGraphNumSamples.setValue(this.precision),this.constantNumParticles.setValue(this.numParticles),this.constantNumParticlesPot.setValue(this.numParticlesPot),this.constantInternalTex0.setValue(this.internalTex0),this.constantInternalTex1.setValue(this.internalTex1),
this.constantInternalTex2.setValue(this.internalTex2),h=null===this.meshInstance.node?pc.Vec3.ZERO.data:this.meshInstance.node.getPosition().data,l=null===this.meshInstance.node?pc.Mat4.IDENTITY:this.meshInstance.node.getWorldTransform(),this.emitterShape===pc.EMITTERSHAPE_BOX?(g(O,F),this.constantSpawnBounds.setValue(F.data)):this.constantSpawnBoundsSphere.setValue(this.emitterRadius),this.constantInitialVelocity.setValue(this.initialVelocity),g(l,N),this.constantEmitterPos.setValue(h),this.constantFrameRandom.setValue(this.frameRandom.data),
this.constantDelta.setValue(b),this.constantRate.setValue(this.rate),this.constantRateDiv.setValue(this.rate2-this.rate),this.constantStartAngle.setValue(this.startAngle*pc.math.DEG_TO_RAD),this.constantStartAngle2.setValue(this.startAngle2*pc.math.DEG_TO_RAD),this.constantSeed.setValue(this.seed),this.constantLifetime.setValue(this.lifetime),this.constantEmitterScale.setValue(e),this.constantEmitterMatrix.setValue(N.data),this.constantLocalVelocityDivMult.setValue(this.localVelocityUMax.data),this.constantVelocityDivMult.setValue(this.velocityUMax.data),
this.constantRotSpeedDivMult.setValue(this.rotSpeedUMax[0]),e=this.swapTex?this.particleTexOUT:this.particleTexIN,e=this.beenReset?this.particleTexStart:e,h=this.swapTex?this.particleTexIN:this.particleTexOUT,this.constantParticleTexIN.setValue(e),d?pc.drawQuadWithShader(k,this.swapTex?this.rtParticleTexIN:this.rtParticleTexOUT,this.shaderParticleUpdateOnStop):pc.drawQuadWithShader(k,this.swapTex?this.rtParticleTexIN:this.rtParticleTexOUT,this.loop?this.shaderParticleUpdateRespawn:this.shaderParticleUpdateNoRespawn),
this.constantParticleTexOUT.setValue(h),this.material.setParameter("particleTexOUT",h),this.material.setParameter("particleTexIN",e),this.beenReset=!1,this.swapTex=!this.swapTex,k.setDepthTest(!0),k.setDepthWrite(!0);if(!this.loop&&this.onFinished&&Date.now()>this.endTime)this.onFinished()}};return{ParticleEmitter:I}}());pc.extend(pc,function(){function f(a,d){return d.key-a.key}var a=function(a,d,e){this.device=a;a=a.getProgramLibrary();this.pickProgStatic=a.getProgram("pick",{skin:!1});this.pickProgSkin=a.getProgram("pick",{skin:!0});this.pickColor=new Float32Array(4);this.scene=null;this.drawCalls=[];this.clearOptions={color:[1,1,1,1],depth:1,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH};this.resize(d,e)};a.prototype.getSelection=function(a){var d=this.device;a.width=a.width||1;a.height=a.height||1;var e=d.getRenderTarget();
d.setRenderTarget(this._pickBufferTarget);d.updateBegin();var g=new Uint8Array(4*a.width*a.height);d.readPixels(a.x,a.y,a.width,a.height,g);d.updateEnd();d.setRenderTarget(e);d=[];for(e=0;e<a.width*a.height;e++){var f=g[4*e+0]<<16|g[4*e+1]<<8|g[4*e+2];16777215!==f&&(f=this.drawCalls[f],-1===d.indexOf(f)&&d.push(f))}return d};a.prototype.prepare=function(a,d){var e=this.device;this.scene=d;var g=e.getRenderTarget();e.setRenderTarget(this._pickBufferTarget);e.updateBegin();e.setViewport(0,0,this._pickBufferTarget.width,
this._pickBufferTarget.height);e.setScissor(0,0,this._pickBufferTarget.width,this._pickBufferTarget.height);e.clear(this.clearOptions);var h,k,m,r,u;k=e.scope;var l=k.resolve("matrix_model"),n=k.resolve("texture_poseMap"),w=k.resolve("texture_poseMapSize"),s=k.resolve("skinPosOffset"),B=k.resolve("matrix_pose[0]"),y=k.resolve("uColor");h=k.resolve("matrix_projection");k=k.resolve("matrix_viewProjection");r=a._node.getWorldTransform();m=a.getProjectionMatrix();r=r.clone().invert();u=new pc.Mat4;u.mul2(m,
r);h.setValue(m.data);k.setValue(u.data);this.drawCalls=d.drawCalls.slice(0);this.drawCalls.sort(f);for(h=0;h<this.drawCalls.length;h++)if(this.drawCalls[h].command)this.drawCalls[h].command();else if(this.drawCalls[h].pick){m=this.drawCalls[h];k=m.mesh;r=m.material;u=k.primitive[pc.RENDERSTYLE_SOLID].type;var x=r instanceof pc.StandardMaterial||r instanceof pc.BasicMaterial;if((u===pc.PRIMITIVE_TRIANGLES||u===pc.PRIMITIVE_TRISTRIP||u===pc.PRIMITIVE_TRIFAN)&&x)e.setBlending(!1),e.setCullMode(r.cull),
e.setDepthWrite(r.depthWrite),e.setDepthTest(r.depthTest),l.setValue(m.node.worldTransform.data),m.skinInstance&&(s.setValue(m.node.getPosition().data),e.supportsBoneTextures?(n.setValue(m.skinInstance.boneTexture),w.setValue([m.skinInstance.boneTexture.width,m.skinInstance.boneTexture.height])):B.setValue(m.skinInstance.matrixPalette)),this.pickColor[0]=(h>>16&255)/255,this.pickColor[1]=(h>>8&255)/255,this.pickColor[2]=(h&255)/255,this.pickColor[3]=1,y.setValue(this.pickColor),e.setShader(k.skin?
this.pickProgSkin:this.pickProgStatic),e.setVertexBuffer(k.vertexBuffer,0),e.setIndexBuffer(k.indexBuffer[pc.RENDERSTYLE_SOLID]),e.draw(k.primitive[pc.RENDERSTYLE_SOLID])}e.setViewport(0,0,e.width,e.height);e.setScissor(0,0,e.width,e.height);e.updateEnd();e.setRenderTarget(g)};a.prototype.resize=function(a,d){var e=new pc.Texture(this.device,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:a,height:d,autoMipmap:!1});e.minFilter=pc.FILTER_NEAREST;e.magFilter=pc.FILTER_NEAREST;e.addressU=pc.ADDRESS_CLAMP_TO_EDGE;
e.addressV=pc.ADDRESS_CLAMP_TO_EDGE;this._pickBufferTarget=new pc.RenderTarget(this.device,e,{depth:!0})};Object.defineProperty(a.prototype,"renderTarget",{get:function(){return this._pickBufferTarget}});Object.defineProperty(a.prototype,"width",{get:function(){return this._pickBufferTarget.width}});Object.defineProperty(a.prototype,"height",{get:function(){return this._pickBufferTarget.height}});return{Picker:a}}());var primitiveUv1Padding=0.0625,primitiveUv1PaddingScale=1-2*primitiveUv1Padding;
pc.calculateNormals=function(f,a){var b=a.length/3,d=f.length/3,e,g,h,k,m=new pc.Vec3,r=new pc.Vec3,u=new pc.Vec3,l=new pc.Vec3,n=new pc.Vec3,w=new pc.Vec3;new pc.Vec3;var s=[];for(k=0;k<f.length;k++)s[k]=0;for(k=0;k<b;k++)e=a[3*k],g=a[3*k+1],h=a[3*k+2],m.set(f[3*e],f[3*e+1],f[3*e+2]),r.set(f[3*g],f[3*g+1],f[3*g+2]),u.set(f[3*h],f[3*h+1],f[3*h+2]),l.sub2(r,m),n.sub2(u,m),w.cross(l,n).normalize(),s[3*e]+=w.x,s[3*e+1]+=w.y,s[3*e+2]+=w.z,s[3*g]+=w.x,s[3*g+1]+=w.y,s[3*g+2]+=w.z,s[3*h]+=w.x,s[3*h+1]+=
w.y,s[3*h+2]+=w.z;for(k=0;k<d;k++)b=s[3*k],e=s[3*k+1],g=s[3*k+2],b=1/Math.sqrt(b*b+e*e+g*g),s[3*k]*=b,s[3*k+1]*=b,s[3*k+2]*=b;return s};
pc.calculateTangents=function(f,a,b,d){var e=d.length/3,g=f.length/3,h,k,m,r,u,l,n,w,s,B,y,x,A,D,C=new pc.Vec3,z=new pc.Vec3,E=new pc.Vec3,F=new pc.Vec3,N=new pc.Vec3,J=new pc.Vec2,M=new pc.Vec2,O=new pc.Vec2,K,H=new Float32Array(3*g),L=new Float32Array(3*g),S=[];for(K=0;K<e;K++)h=d[3*K],k=d[3*K+1],m=d[3*K+2],E.set(f[3*h],f[3*h+1],f[3*h+2]),F.set(f[3*k],f[3*k+1],f[3*k+2]),N.set(f[3*m],f[3*m+1],f[3*m+2]),J.set(b[2*h],b[2*h+1]),M.set(b[2*k],b[2*k+1]),O.set(b[2*m],b[2*m+1]),r=F.x-E.x,u=N.x-E.x,l=F.y-
E.y,n=N.y-E.y,w=F.z-E.z,s=N.z-E.z,B=M.x-J.x,y=O.x-J.x,x=M.y-J.y,A=O.y-J.y,D=1/(B*A-y*x),C.set((A*r-x*u)*D,(A*l-x*n)*D,(A*w-x*s)*D),z.set((B*u-y*r)*D,(B*n-y*l)*D,(B*s-y*w)*D),H[3*h+0]+=C.x,H[3*h+1]+=C.y,H[3*h+2]+=C.z,H[3*k+0]+=C.x,H[3*k+1]+=C.y,H[3*k+2]+=C.z,H[3*m+0]+=C.x,H[3*m+1]+=C.y,H[3*m+2]+=C.z,L[3*h+0]+=z.x,L[3*h+1]+=z.y,L[3*h+2]+=z.z,L[3*k+0]+=z.x,L[3*k+1]+=z.y,L[3*k+2]+=z.z,L[3*m+0]+=z.x,L[3*m+1]+=z.y,L[3*m+2]+=z.z;x=new pc.Vec3;A=new pc.Vec3;f=new pc.Vec3;b=new pc.Vec3;for(K=0;K<g;K++)f.set(a[3*
K],a[3*K+1],a[3*K+2]),x.set(H[3*K],H[3*K+1],H[3*K+2]),A.set(L[3*K],L[3*K+1],L[3*K+2]),d=f.dot(x),b.copy(f).scale(d),b.sub2(x,b).normalize(),S[4*K]=b.x,S[4*K+1]=b.y,S[4*K+2]=b.z,b.cross(f,x),S[4*K+3]=0>b.dot(A)?-1:1;return S};
pc.createMesh=function(f,a,b){var d=b&&void 0!==b.normals?b.normals:null,e=b&&void 0!==b.tangents?b.tangents:null,g=b&&void 0!==b.colors?b.colors:null,h=b&&void 0!==b.uvs?b.uvs:null,k=b&&void 0!==b.uvs1?b.uvs1:null,b=b&&void 0!==b.indices?b.indices:null,m=[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}];null!==d&&m.push({semantic:pc.SEMANTIC_NORMAL,components:3,type:pc.ELEMENTTYPE_FLOAT32});null!==e&&m.push({semantic:pc.SEMANTIC_TANGENT,components:4,type:pc.ELEMENTTYPE_FLOAT32});
null!==g&&m.push({semantic:pc.SEMANTIC_COLOR,components:4,type:pc.ELEMENTTYPE_UINT8,normalize:!0});null!==h&&m.push({semantic:pc.SEMANTIC_TEXCOORD0,components:2,type:pc.ELEMENTTYPE_FLOAT32});null!==k&&m.push({semantic:pc.SEMANTIC_TEXCOORD1,components:2,type:pc.ELEMENTTYPE_FLOAT32});for(var r=new pc.VertexFormat(f,m),m=a.length/3,r=new pc.VertexBuffer(f,r,m),u=new pc.VertexIterator(r),l=0;l<m;l++)u.element[pc.SEMANTIC_POSITION].set(a[3*l],a[3*l+1],a[3*l+2]),null!==d&&u.element[pc.SEMANTIC_NORMAL].set(d[3*
l],d[3*l+1],d[3*l+2]),null!==e&&u.element[pc.SEMANTIC_TANGENT].set(e[4*l],e[4*l+1],e[4*l+2],e[4*l+3]),null!==g&&u.element[pc.SEMANTIC_COLOR].set(g[4*l],g[4*l+1],g[4*l+2],g[4*l+3]),null!==h&&u.element[pc.SEMANTIC_TEXCOORD0].set(h[2*l],h[2*l+1]),null!==k&&u.element[pc.SEMANTIC_TEXCOORD1].set(k[2*l],k[2*l+1]),u.next();u.end();d=null;if(e=null!==b)d=new pc.IndexBuffer(f,pc.INDEXFORMAT_UINT16,b.length),(new Uint16Array(d.lock())).set(b),d.unlock();f=new pc.BoundingBox;f.compute(a);a=new pc.Mesh;a.vertexBuffer=
r;a.indexBuffer[0]=d;a.primitive[0].type=pc.PRIMITIVE_TRIANGLES;a.primitive[0].base=0;a.primitive[0].count=e?b.length:m;a.primitive[0].indexed=e;a.aabb=f;return a};
pc.createTorus=function(f,a){var b=a&&void 0!==a.tubeRadius?a.tubeRadius:0.2,d=a&&void 0!==a.ringRadius?a.ringRadius:0.3,e=a&&void 0!==a.segments?a.segments:30,g=a&&void 0!==a.sides?a.sides:20,h,k,m,r,u,l,n,w,s,B,y=[],x=[],A=[],D=[];for(h=0;h<=g;h++)for(k=0;k<=e;k++)m=Math.cos(2*Math.PI*k/e)*(d+b*Math.cos(2*Math.PI*h/g)),r=Math.sin(2*Math.PI*h/g)*b,u=Math.sin(2*Math.PI*k/e)*(d+b*Math.cos(2*Math.PI*h/g)),l=Math.cos(2*Math.PI*k/e)*Math.cos(2*Math.PI*h/g),n=Math.sin(2*Math.PI*h/g),w=Math.sin(2*Math.PI*
k/e)*Math.cos(2*Math.PI*h/g),s=h/g,B=1-k/e,y.push(m,r,u),x.push(l,n,w),A.push(s,B),h<g&&k<e&&(m=h*(e+1)+k,r=(h+1)*(e+1)+k,u=h*(e+1)+(k+1),l=(h+1)*(e+1)+(k+1),D.push(m,r,u),D.push(r,l,u));b={normals:x,uvs:A,indices:D};pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(y,x,A,D));return pc.createMesh(f,y,b)};
pc._createConeData=function(f,a,b,d,e,g){var h,k,m,r,u,l=new pc.Vec3;m=new pc.Vec3;var n=new pc.Vec3,w,s=[],B=[],y=[],x=[],A=[],D;if(0<b)for(h=0;h<=d;h++)for(k=0;k<=e;k++)theta=2*(k/e)*Math.PI-Math.PI,D=Math.sin(theta),w=Math.cos(theta),u=new pc.Vec3(D*f,-b/2,w*f),r=new pc.Vec3(D*a,b/2,w*a),l.lerp(u,r,h/d),m.sub2(r,u).normalize(),w=new pc.Vec3(w,0,-D),n.cross(w,m).normalize(),s.push(l.x,l.y,l.z),B.push(n.x,n.y,n.z),r=k/e,u=h/d,y.push(r,u),w=u,u=r,r=w,r/=3,r=r*primitiveUv1PaddingScale+primitiveUv1Padding,
u=u*primitiveUv1PaddingScale+primitiveUv1Padding,x.push(r,u),h<d&&k<e&&(w=h*(e+1)+k,D=h*(e+1)+(k+1),r=(h+1)*(e+1)+k,u=(h+1)*(e+1)+(k+1),A.push(w,D,r),A.push(D,u,r));if(g){f=Math.floor(e/2);l=b/2;for(b=0;b<=f;b++){theta=0.5*b*Math.PI/f;D=Math.sin(theta);w=Math.cos(theta);for(h=0;h<=e;h++)phi=2*h*Math.PI/e-Math.PI/2,r=Math.sin(phi),u=Math.cos(phi),g=u*D,k=w,m=r*D,r=1-h/e,u=1-b/f,s.push(g*a,k*a+l,m*a),B.push(g,k,m),y.push(r,u),r/=3,u/=3,r=r*primitiveUv1PaddingScale+primitiveUv1Padding,u=u*primitiveUv1PaddingScale+
primitiveUv1Padding,r+=1/3,x.push(r,u)}n=(d+1)*(e+1);for(b=0;b<f;++b)for(h=0;h<e;++h)w=b*(e+1)+h,D=w+e+1,A.push(n+w+1,n+D,n+w),A.push(n+w+1,n+D+1,n+D);for(b=0;b<=f;b++){theta=0.5*Math.PI+0.5*b*Math.PI/f;D=Math.sin(theta);w=Math.cos(theta);for(h=0;h<=e;h++)phi=2*h*Math.PI/e-Math.PI/2,r=Math.sin(phi),u=Math.cos(phi),g=u*D,k=w,m=r*D,r=1-h/e,u=1-b/f,s.push(g*a,k*a-l,m*a),B.push(g,k,m),y.push(r,u),r/=3,u/=3,r=r*primitiveUv1PaddingScale+primitiveUv1Padding,u=u*primitiveUv1PaddingScale+primitiveUv1Padding,
r+=2/3,x.push(r,u)}n=(d+1)*(e+1)+(e+1)*(f+1);for(b=0;b<f;++b)for(h=0;h<e;++h)w=b*(e+1)+h,D=w+e+1,A.push(n+w+1,n+D,n+w),A.push(n+w+1,n+D+1,n+D)}else{n=(d+1)*(e+1);if(0<f)for(h=0;h<e;h++)theta=2*(h/e)*Math.PI,g=Math.sin(theta),k=-b/2,m=Math.cos(theta),r=1-(g+1)/2,u=(m+1)/2,s.push(g*f,k,m*f),B.push(0,-1,0),y.push(r,u),r/=3,u/=3,r=r*primitiveUv1PaddingScale+primitiveUv1Padding,u=u*primitiveUv1PaddingScale+primitiveUv1Padding,r+=1/3,x.push(r,u),1<h&&A.push(n,n+h,n+h-1);n+=e;if(0<a)for(h=0;h<e;h++)theta=
2*(h/e)*Math.PI,g=Math.sin(theta),k=b/2,m=Math.cos(theta),r=1-(g+1)/2,u=(m+1)/2,s.push(g*a,k,m*a),B.push(0,1,0),y.push(r,u),r/=3,u/=3,r=r*primitiveUv1PaddingScale+primitiveUv1Padding,u=u*primitiveUv1PaddingScale+primitiveUv1Padding,r+=2/3,x.push(r,u),1<h&&A.push(n,n+h-1,n+h)}return{positions:s,normals:B,uvs:y,uvs1:x,indices:A}};
pc.createCylinder=function(f,a){var b=a&&void 0!==a.baseRadius?a.baseRadius:0.5,b=pc._createConeData(b,b,a&&void 0!==a.height?a.height:1,a&&void 0!==a.heightSegments?a.heightSegments:5,a&&void 0!==a.capSegments?a.capSegments:20,!1);pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.createMesh(f,b.positions,b)};
pc.createCapsule=function(f,a){var b=a&&void 0!==a.radius?a.radius:0.3,b=pc._createConeData(b,b,(a&&void 0!==a.height?a.height:1)-2*b,a&&void 0!==a.heightSegments?a.heightSegments:1,a&&void 0!==a.sides?a.sides:20,!0);pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.createMesh(f,b.positions,b)};
pc.createCone=function(f,a){var b=pc._createConeData(a&&void 0!==a.baseRadius?a.baseRadius:0.5,a&&void 0!==a.peakRadius?a.peakRadius:0,a&&void 0!==a.height?a.height:1,a&&void 0!==a.heightSegments?a.heightSegments:5,a&&void 0!==a.capSegments?a.capSegments:18,!1);pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.createMesh(f,b.positions,b)};
pc.createSphere=function(f,a){var b=a&&void 0!==a.radius?a.radius:0.5,d=a&&void 0!==a.latitudeBands?a.latitudeBands:16,e=a&&void 0!==a.longitudeBands?a.longitudeBands:16,g,h,k,m,r,u,l,n,w,s=[],B=[],y=[],x=[];for(h=0;h<=d;h++){g=h*Math.PI/d;k=Math.sin(g);m=Math.cos(g);for(g=0;g<=e;g++)r=2*g*Math.PI/e-Math.PI/2,u=Math.sin(r),r=Math.cos(r),r*=k,l=m,u*=k,n=1-g/e,w=1-h/d,s.push(r*b,l*b,u*b),B.push(r,l,u),y.push(n,w)}for(h=0;h<d;++h)for(g=0;g<e;++g)b=h*(e+1)+g,k=b+e+1,x.push(b+1,k,b),x.push(b+1,k+1,k);
d={normals:B,uvs:y,uvs1:y,indices:x};pc.precalculatedTangents&&(d.tangents=pc.calculateTangents(s,B,y,x));return pc.createMesh(f,s,d)};
pc.createPlane=function(f,a){var b=a&&void 0!==a.halfExtents?a.halfExtents:new pc.Vec2(0.5,0.5),d=a&&void 0!==a.widthSegments?a.widthSegments:5,e=a&&void 0!==a.lengthSegments?a.lengthSegments:5,g,h,k,m,r,u,l=[],n=[],w=[],s=[];for(g=0;g<=d;g++)for(h=0;h<=e;h++)k=-b.x+2*b.x*g/d,m=-(-b.y+2*b.y*h/e),r=g/d,u=h/e,l.push(k,0,m),n.push(0,1,0),w.push(r,u),g<d&&h<e&&(s.push(h+g*(d+1),h+(g+1)*(d+1),h+g*(d+1)+1),s.push(h+(g+1)*(d+1),h+(g+1)*(d+1)+1,h+g*(d+1)+1));b={normals:n,uvs:w,uvs1:w,indices:s};pc.precalculatedTangents&&
(b.tangents=pc.calculateTangents(l,n,w,s));return pc.createMesh(f,l,b)};
pc.createBox=function(f,a){var b=a&&void 0!==a.halfExtents?a.halfExtents:new pc.Vec3(0.5,0.5,0.5),d=a&&void 0!==a.widthSegments?a.widthSegments:1,e=a&&void 0!==a.lengthSegments?a.lengthSegments:1,g=a&&void 0!==a.heightSegments?a.heightSegments:1,h=[new pc.Vec3(-b.x,-b.y,b.z),new pc.Vec3(b.x,-b.y,b.z),new pc.Vec3(b.x,b.y,b.z),new pc.Vec3(-b.x,b.y,b.z),new pc.Vec3(b.x,-b.y,-b.z),new pc.Vec3(-b.x,-b.y,-b.z),new pc.Vec3(-b.x,b.y,-b.z),new pc.Vec3(b.x,b.y,-b.z)],k=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,
2],[5,0,6]],m=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],r=[],u=[],l=[],n=[],w=[],b=function(a,b,d){var e,g,f,C,z=r.length/3;for(f=0;f<=b;f++)for(C=0;C<=d;C++){e=new pc.Vec3;g=new pc.Vec3;var E=new pc.Vec3,F=new pc.Vec3;e.lerp(h[k[a][0]],h[k[a][1]],f/b);g.lerp(h[k[a][0]],h[k[a][2]],C/d);E.sub2(g,h[k[a][0]]);F.add2(e,E);e=f/b;g=C/d;r.push(F.x,F.y,F.z);u.push(m[a][0],m[a][1],m[a][2]);l.push(e,g);e/=3;g/=3;e=e*primitiveUv1PaddingScale+primitiveUv1Padding;g=g*primitiveUv1PaddingScale+primitiveUv1Padding;
e+=a%3/3;g+=Math.floor(a/3)/3;n.push(e,g);f<b&&C<d&&(w.push(z+C+f*(b+1),z+C+(f+1)*(b+1),z+C+f*(b+1)+1),w.push(z+C+(f+1)*(b+1),z+C+(f+1)*(b+1)+1,z+C+f*(b+1)+1))}};b(0,d,g);b(1,d,g);b(2,d,e);b(3,d,e);b(4,e,g);b(5,e,g);d={normals:u,uvs:l,uvs1:n,indices:w};pc.precalculatedTangents&&(d.tangents=pc.calculateTangents(r,u,l,w));return pc.createMesh(f,r,d)};pc.extend(pc,function(){var f=function(){this._name="";this._duration=0;this._nodes=[];this._nodeDict={}};f.prototype.getDuration=function(){return this._duration};f.prototype.getName=function(){return this._name};f.prototype.getNode=function(a){return this._nodeDict[a]};f.prototype.getNodes=function(){return this._nodes};f.prototype.setDuration=function(a){this._duration=a};f.prototype.setName=function(a){this._name=a};f.prototype.addNode=function(a){this._nodes.push(a);this._nodeDict[a._name]=a};
return{Animation:f,Key:function(a,b,d,e){this.time=a;this.position=b;this.rotation=d;this.scale=e},Node:function(){this._name="";this._keys=[]}}}());pc.extend(pc,function(){function f(){this._written=!1;this._name="";this._keyFrames=[];this._quat=new pc.Quat;this._pos=new pc.Vec3;this._scale=new pc.Vec3;this._targetNode=null}f.prototype={getTarget:function(){return this._targetNode},setTarget:function(a){this._targetNode=a}};var a=function(a){function d(a){var b=a.getName(),k=new f;k._name=b;e._interpolatedKeys.push(k);e._interpolatedKeyDict[b]=k;e._currKeyIndices[b]=0;a=a.getChildren();for(b=0;b<a.length;b++)d(a[b])}this._animation=null;this._time=
0;this.looping=!0;this._interpolatedKeys=[];this._interpolatedKeyDict={};this._currKeyIndices={};this.graph=null;var e=this;d(a)};a.prototype.addTime=function(a){if(null!==this._animation&&(this._time!==r||this.looping)){var d,e,g,f,k,m=this._animation.getNodes();this._time+=a;var r=this._animation.getDuration();if(this._time>r){this._time=this.looping?0:r;for(r=0;r<m.length;r++)d=m[r],e=d._name,this._currKeyIndices[e]=0}else if(0>this._time){this._time=this.looping?r:0;for(r=0;r<m.length;r++)d=m[r],
e=d._name,this._currKeyIndices[e]=d._keys.length-2}a=0<=a?1:-1;for(r=0;r<m.length;r++)if(d=m[r],e=d._name,g=d._keys,d=this._interpolatedKeyDict[e],1===g.length)d._pos.copy(g[0].position),d._quat.copy(g[0].rotation),d._scale(g[0].scale);else for(var u=this._currKeyIndices[e];u<g.length-1&&0<=u;u+=a)if(f=g[u],k=g[u+1],f.time<=this._time&&k.time>=this._time){g=(this._time-f.time)/(k.time-f.time);d._pos.lerp(f.position,k.position,g);d._quat.slerp(f.rotation,k.rotation,g);d._scale.lerp(f.scale,k.scale,
g);d._written=!0;this._currKeyIndices[e]=u;break}}};a.prototype.blend=function(a,d,e){for(var g=this._interpolatedKeys.length,f=0;f<g;f++){var k=a._interpolatedKeys[f],m=d._interpolatedKeys[f],r=this._interpolatedKeys[f];k._written&&m._written?(r._quat.slerp(k._quat,d._interpolatedKeys[f]._quat,e),r._pos.lerp(k._pos,d._interpolatedKeys[f]._pos,e),r._scale.lerp(k._scale,m._scale,e),r._written=!0):k._written?(r._quat.copy(k._quat),r._pos.copy(k._pos),r._scale.copy(k._scale),r._written=!0):m._written&&
(r._quat.copy(m._quat),r._pos.copy(m._pos),r._scale.copy(m._scale),r._written=!0)}};a.prototype.getAnimation=function(){return this._animation};a.prototype.getCurrentTime=function(){return this._time};a.prototype.setCurrentTime=function(a){this._time=a;for(var a=this._interpolatedKeys.length,d=0;d<a;d++)this._currKeyIndices[this._interpolatedKeys[d]._name]=0;this.addTime(0);this.updateGraph()};a.prototype.getNumNodes=function(){return this._interpolatedKeys.length};a.prototype.setAnimation=function(a){this._animation=
a;this.setCurrentTime(0)};a.prototype.setGraph=function(a){var d;if(this.graph=a)for(d=0;d<this._interpolatedKeys.length;d++){var e=a.findByName(this._interpolatedKeys[d]._name);this._interpolatedKeys[d].setTarget(e)}else for(d=0;d<this._interpolatedKeys.length;d++)this._interpolatedKeys[d].setTarget(null)};a.prototype.updateGraph=function(){if(this.graph)for(var a=0;a<this._interpolatedKeys.length;a++){var d=this._interpolatedKeys[a];if(d._written){var e=d.getTarget();e.localPosition.copy(d._pos);
e.localRotation.copy(d._quat);e.localScale.copy(d._scale);e.dirtyLocal=!0;d._written=!1}}};a.prototype.setLooping=function(a){this.looping=a};a.prototype.getLooping=function(){return this.looping};return{Skeleton:a}}());pc.extend(pc,function(){function f(){return!!("undefined"!==typeof AudioContext||"undefined"!==typeof webkitAudioContext)}var a=function(){if(f()&&("undefined"!==typeof AudioContext?this.context=new AudioContext:"undefined"!==typeof webkitAudioContext&&(this.context=new webkitAudioContext),this.context)){var a=this.context;if(/iPad|iPhone|iPod/.test(navigator.platform)){var d=function(){var e=a.createBuffer(1,1,44100),g=a.createBufferSource();g.buffer=e;g.connect(a.destination);g.start(0);g.disconnect();
window.removeEventListener("touchend",d)};window.addEventListener("touchend",d)}}this.listener=new pc.Listener(this);this._volume=1;this.suspended=!1;pc.events.attach(this)};a.hasAudio=function(){return"undefined"!==typeof Audio};a.hasAudioContext=f;a.prototype={suspend:function(){this.suspended=!0;this.fire("suspend")},resume:function(){this.suspended=!1;this.fire("resume")},destroy:function(){this.fire("destroy");this.context&&this.context.close&&(this.context.close(),this.context=null)},getListener:function(){console.warn('DEPRECATED: getListener is deprecated. Get the "listener" field instead.');
return this.listener},getVolume:function(){console.warn('DEPRECATED: getVolume is deprecated. Get the "volume" property instead.');return this.volume},setVolume:function(a){console.warn('DEPRECATED: setVolume is deprecated. Set the "volume" property instead.');this.volume=a},playSound:function(a,d){var d=d||{},e=null;pc.Channel&&(e=new pc.Channel(this,a,d),e.play());return e},playSound3d:function(a,d,e){var e=e||{},g=null;pc.Channel3d&&(g=new pc.Channel3d(this,a,e),g.setPosition(d),e.volume&&g.setVolume(e.volume),
e.loop&&g.setLoop(e.loop),e.maxDistance&&g.setMaxDistance(e.maxDistance),e.minDistance&&g.setMinDistance(e.minDistance),e.rollOffFactor&&g.setRollOffFactor(e.rollOffFactor),e.distanceModel&&g.setDistanceModel(e.distanceModel),g.play());return g}};Object.defineProperty(a.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=a=pc.math.clamp(a,0,1);this.fire("volumechange",a)}});pc.AudioManager=a;return{SoundManager:a}}());pc.extend(pc,function(){var f=function(a){a instanceof Audio?this.audio=a:this.buffer=a};Object.defineProperty(f.prototype,"duration",{get:function(){var a=0;this.buffer?a=this.buffer.duration:this.audio&&(a=this.audio.duration);return a||0}});return{Sound:f}}());pc.extend(pc,function(){var f=function(a){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.orientation=new pc.Mat4;pc.AudioManager.hasAudioContext()&&(this.listener=a.context.listener)};f.prototype={getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);this.listener&&this.listener.setPosition(a.x,a.y,a.z)},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a);this.listener&&this.listener.setPosition(a.x,a.y,a.z)},setOrientation:function(a){this.orientation.copy(a);
this.listener&&this.listener.setOrientation(-a.data[8],-a.data[9],-a.data[10],a.data[4],a.data[5],a.data[6])},getOrientation:function(){return this.orientation}};return{Listener:f}}());pc.extend(pc,function(){var f;pc.SoundManager.hasAudioContext()?(f=function(a,b,d){pc.events.attach(this);d=d||{};this._volume=void 0!==d.volume?pc.math.clamp(Number(d.volume)||0,0,1):1;this._pitch=void 0!==d.pitch?Math.max(0.01,Number(d.pitch)||0):1;this._loop=!!(void 0!==d.loop&&d.loop);this._sound=b;this._state=2;this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1;this._startTime=Math.max(0,Number(d.startTime)||0);this._duration=Math.max(0,Number(d.duration)||0);this._startedAt=
0;this._startOffset=null;this._calculatedCurrentTimeAt=this._currentTime=0;this._playWhenLoaded=!0;this._manager=a;this._lastNode=this._firstNode=this._connectorNode=this._inputNode=null;this._initializeNodes();this._endedHandler=this._onEnded.bind(this);this.source=null;this._createSource()},f.prototype={_initializeNodes:function(){this._connectorNode=this._inputNode=this.gain=this._manager.context.createGain();this._connectorNode.connect(this._manager.context.destination)},play:function(){2!==this._state&&
this.stop();if(!this.source)return!1;var a=this._startOffset%this.duration||0,a=(this._startTime+a)%this._sound.duration||0;this._startOffset=null;this._duration?this.source.start(0,a,this._duration):this.source.start(0,a);this._startedAt=this._manager.context.currentTime-a;this._currentTime=0;this._calculatedCurrentTimeAt=this._manager.context.currentTime;this._state=0;this._playWhenLoaded=!1;this.volume=this._volume;this.loop=this._loop;this.pitch=this._pitch;this._manager.on("volumechange",this._onManagerVolumeChange,
this);this._manager.on("suspend",this._onManagerSuspend,this);this._manager.on("resume",this._onManagerResume,this);this._manager.on("destroy",this._onManagerDestroy,this);this._manager.suspended&&this._onManagerSuspend();this._suspendInstanceEvents||this.fire("play",this);return!0},pause:function(){if(0!==this._state||!this.source)return!1;this._state=1;this._currentTime=(this._currentTime+(this._manager.context.currentTime-this._calculatedCurrentTimeAt)*this.pitch)%this.duration||0;this._calculatedCurrentTimeAt=
this._manager.context.currentTime;this._suspendEndEvent=!0;this.source.stop(0);this._createSource();this._playWhenLoaded=!1;this._startOffset=null;this._suspendInstanceEvents||this.fire("pause",this);return!0},resume:function(){if(1!==this._state||!this.source)return!1;var a=(this._startTime+this._currentTime)%this._sound.duration||0;null!==this._startOffset&&(a=this._startOffset%this.duration||0,a=(this._startTime+a)%this._sound.duration||0,this._startOffset=null);this._duration?this.source.start(0,
a,this._duration):this.source.start(0,a);this._state=0;this.volume=this._volume;this.loop=this._loop;this.pitch=this._pitch;this._playWhenLoaded=!1;this._suspendInstanceEvents||this.fire("resume",this);return!0},stop:function(){if(2===this._state||!this.source)return!1;this._manager.off("volumechange",this._onManagerVolumeChange,this);this._manager.off("suspend",this._onManagerSuspend,this);this._manager.off("resume",this._onManagerResume,this);this._manager.off("destroy",this._onManagerDestroy,this);
this._startedAt=0;this._startOffset=null;this._playWhenLoaded=!1;this._suspendEndEvent=!0;0===this._state&&this.source.stop(0);this._state=2;this._createSource();this._suspendInstanceEvents||this.fire("stop",this);return!0},setExternalNodes:function(a,b){if(a){b||(b=a);var d=this._manager.context.destination;this._firstNode!==a&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(d),this._firstNode=a,this._connectorNode.connect(a));this._lastNode!==b&&(this._lastNode&&
this._lastNode.disconnect(d),this._lastNode=b,this._lastNode.connect(d))}else logError("The firstNode must be a valid Audio Node")},clearExternalNodes:function(){var a=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null);this._lastNode&&(this._lastNode.disconnect(a),this._lastNode=null);this._connectorNode.connect(a)},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_createSource:function(){if(!this._sound)return null;
var a=this._manager.context;this._sound.buffer&&(this.source=a.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=this._startTime%this.source.buffer.duration||0,this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,(this._startTime+this._duration)%this.source.buffer.duration||0)),this._suspendInstanceEvents||this.fire("ready",this));return this.source},_onEnded:function(){this._suspendEndEvent?
this._suspendEndEvent=!1:(this.fire("end",this),this.stop())},_onManagerDestroy:function(){this.source&&this.isPlaying&&(this.source.stop(0),this.source=null)}},Object.defineProperty(f.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=a=pc.math.clamp(a,0,1);this.gain&&(this.gain.gain.value=a*this._manager.volume)}}),Object.defineProperty(f.prototype,"pitch",{get:function(){return this._pitch},set:function(a){var b=this._pitch;this._calculatedCurrentTimeAt&&(this._currentTime=
(this._currentTime+(this._manager.context.currentTime-this._calculatedCurrentTimeAt)*b)%this.duration||0,this._calculatedCurrentTimeAt=this._manager.context.currentTime);this._pitch=Math.max(Number(a)||0,0.01);this.source&&(this.source.playbackRate.value=this._pitch)}}),Object.defineProperty(f.prototype,"loop",{get:function(){return this._loop},set:function(a){this._loop=!!a;this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(f.prototype,"sound",{get:function(){return this._sound},
set:function(a){this._sound=a;this.isStopped?this._createSource():this.stop()}}),Object.defineProperty(f.prototype,"currentTime",{get:function(){if(null!==this._startOffset)return this._startOffset;if(this.isStopped||!this.source)return 0;if(this.isPaused)return this._currentTime;this._currentTime=(this._currentTime+(this._manager.context.currentTime-this._calculatedCurrentTimeAt)*this.pitch)%this.duration||0;this._calculatedCurrentTimeAt=this._manager.context.currentTime;return this._currentTime},
set:function(a){if(!(0>a))if(this.isPlaying){this.stop();var b=this._suspendInstanceEvents;this._suspendInstanceEvents=!0;this._startOffset=a;this.play();this._suspendInstanceEvents=b}else this._currentTime=this._startOffset=a,this._calculatedCurrentTimeAt=this._manager.context.currentTime}})):pc.SoundManager.hasAudio()?(f=function(a,b,d){pc.events.attach(this);d=d||{};this._volume=void 0!==d.volume?pc.math.clamp(Number(d.volume)||0,0,1):1;this._pitch=void 0!==d.pitch?Math.max(0.01,Number(d.pitch)||
0):1;this._loop=!!(void 0!==d.loop&&d.loop);this._sound=b;this._state=2;this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1;this._playWhenLoaded=!0;this._startTime=Math.max(0,Number(d.startTime)||0);this._duration=Math.max(0,Number(d.duration)||0);this._startOffset=null;this._isReady=!1;this._manager=a;this._loadedMetadataHandler=this._onLoadedMetadata.bind(this);this._timeUpdateHandler=this._onTimeUpdate.bind(this);this._endedHandler=this._onEnded.bind(this);this.source=null;this._createSource()},
f.prototype={play:function(){2!==this._state&&this.stop();if(!this.source)return!1;this.volume=this._volume;this.pitch=this._pitch;this.loop=this._loop;this.source.play();this._state=0;this._playWhenLoaded=!1;this._manager.on("volumechange",this._onManagerVolumeChange,this);this._manager.on("suspend",this._onManagerSuspend,this);this._manager.on("resume",this._onManagerResume,this);this._manager.on("destroy",this._onManagerDestroy,this);this._manager.suspended&&this._onManagerSuspend();this._suspendInstanceEvents||
this.fire("play",this);return!0},pause:function(){if(!this.source||0!==this._state)return!1;this._suspendEndEvent=!0;this.source.pause();this._playWhenLoaded=!1;this._state=1;this._startOffset=null;this._suspendInstanceEvents||this.fire("pause",this);return!0},resume:function(){if(!this.source||1!==this._state)return!1;this._state=0;this._playWhenLoaded=!1;this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this.fire("resume",this));return!0},stop:function(){if(!this.source||2===
this._state)return!1;this._manager.off("volumechange",this._onManagerVolumeChange,this);this._manager.off("suspend",this._onManagerSuspend,this);this._manager.off("resume",this._onManagerResume,this);this._manager.off("destroy",this._onManagerDestroy,this);this._suspendEndEvent=!0;this.source.pause();this._playWhenLoaded=!1;this._state=2;this._startOffset=null;this._suspendInstanceEvents||this.fire("stop",this);return!0},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,
null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler);this._isReady=!0;var a=this._startOffset%this.duration||0,a=(this._startTime+a)%this._sound.duration||0;this._startOffset=null;this.source.currentTime=a},_createSource:function(){this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",
this._timeUpdateHandler),this.source.onended=this._endedHandler,this._suspendInstanceEvents||this.fire("ready",this.source));return this.source},_onTimeUpdate:function(){if(this._duration&&this.source.currentTime>((this._startTime+this._duration)%this.source.duration||0))this.loop?this.source.currentTime=this._startTime%this.source.duration||0:(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded())},_onEnded:function(){this._suspendEndEvent?this._suspendEndEvent=
!1:(this.fire("end",this),this.stop())},_onManagerDestroy:function(){this.source&&this.source.pause()}},Object.defineProperty(f.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=a=pc.math.clamp(a,0,1);this.source&&(this.source.volume=a*this._manager.volume)}}),Object.defineProperty(f.prototype,"pitch",{get:function(){return this._pitch},set:function(a){this._pitch=Math.max(Number(a)||0,0.01);this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(f.prototype,
"loop",{get:function(){return this._loop},set:function(a){this._loop=!!a;this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(f.prototype,"sound",{get:function(){return this._sound},set:function(a){this.stop();this._sound=a;this._createSource()}}),Object.defineProperty(f.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:this.isStopped||!this.source?0:this.source.currentTime-this._startTime},set:function(a){0>a||(this._startOffset=a,this.source&&
this._isReady&&(this.source.currentTime=(this._startTime+(a%this.duration||0))%this._sound.duration||0,this._startOffset=null))}})):(console.warn("No support for 2D audio found"),f=function(){});pc.extend(f.prototype,{_onManagerVolumeChange:function(){this.volume=this._volume},_onManagerSuspend:function(){this.isPlaying&&!this._suspended&&(this._suspended=!0,this.pause())},_onManagerResume:function(){this._suspended&&(this._suspended=!1,this.resume())}});Object.defineProperty(f.prototype,"startTime",
{get:function(){return this._startTime},set:function(a){this._startTime=Math.max(0,Number(a)||0);a=this.isPlaying;this.stop();a&&this.play()}});Object.defineProperty(f.prototype,"duration",{get:function(){return!this._sound?0:this._duration?this._duration%this._sound.duration||0:this._sound.duration},set:function(a){this._duration=Math.max(0,Number(a)||0);a=this.isPlaying;this.stop();a&&this.play()}});Object.defineProperty(f.prototype,"isPlaying",{get:function(){return 0===this._state}});Object.defineProperty(f.prototype,
"isPaused",{get:function(){return 1===this._state}});Object.defineProperty(f.prototype,"isStopped",{get:function(){return 2===this._state}});Object.defineProperty(f.prototype,"isSuspended",{get:function(){return this._suspended}});return{SoundInstance:f}}());pc.extend(pc,function(){var f;if(pc.SoundManager.hasAudioContext())f=function(a,d,e){e=e||{};this._position=new pc.Vec3;e.position&&(this.position=e.position);this._velocity=new pc.Vec3;e.velocity&&(this.velocity=e.velocity);this.maxDistance=void 0!==e.maxDistance?Number(e.maxDistance):1E4;this.refDistance=void 0!==e.refDistance?Number(e.refDistance):1;this.rollOffFactor=void 0!==e.rollOffFactor?Number(e.rollOffFactor):1;this.distanceModel=void 0!==e.distanceModel?e.distanceModel:pc.DISTANCE_LINEAR},
f=pc.inherits(f,pc.SoundInstance),f.prototype=pc.extend(f.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain();this.panner=this._manager.context.createPanner();this.panner.connect(this.gain);this._inputNode=this.panner;this._connectorNode=this.gain;this._connectorNode.connect(this._manager.context.destination)}}),Object.defineProperty(f.prototype,"position",{get:function(){return this._position},set:function(a){this._position.copy(a);this.panner.setPosition(a.x,a.y,
a.z)}}),Object.defineProperty(f.prototype,"velocity",{get:function(){return this._velocity},set:function(a){this._velocity.copy(a);this.panner.setVelocity(a.x,a.y,a.z)}}),Object.defineProperty(f.prototype,"maxDistance",{get:function(){return this.panner.maxDistance},set:function(a){this.panner.maxDistance=a}}),Object.defineProperty(f.prototype,"refDistance",{get:function(){return this.panner.refDistance},set:function(a){this.panner.refDistance=a}}),Object.defineProperty(f.prototype,"rollOffFactor",
{get:function(){return this.panner.rollOffFactor},set:function(a){this.panner.rollOffFactor=a}}),Object.defineProperty(f.prototype,"distanceModel",{get:function(){return this.panner.distanceModel},set:function(a){this.panner.distanceModel=a}});else if(pc.SoundManager.hasAudio()){var a=new pc.Vec3;f=function(a,d,e){e=e||{};this._position=new pc.Vec3;e.position&&(this.position=e.position);this._velocity=new pc.Vec3;e.velocity&&(this.velocity=e.velocity);this._maxDistance=void 0!==e.maxDistance?Number(e.maxDistance):
1E4;this._refDistance=void 0!==e.refDistance?Number(e.refDistance):1;this._rollOffFactor=void 0!==e.rollOffFactor?Number(e.rollOffFactor):1;this._distanceModel=void 0!==e.distanceModel?e.distanceModel:pc.DISTANCE_LINEAR};f=pc.inherits(f,pc.SoundInstance);Object.defineProperty(f.prototype,"position",{get:function(){return this._position},set:function(b){this._position.copy(b);if(this.source){var d=this._manager.listener.getPosition();var b=this.refDistance,e=this.maxDistance,g=this.rollOffFactor,f=
this.distanceModel;a=a.sub2(d,this._position);d=a.length();if(d<b)b=1;else if(d>e)b=0;else{var k=0;f===pc.DISTANCE_LINEAR?k=1-g*(d-b)/(e-b):f===pc.DISTANCE_INVERSE?k=b/(b+g*(d-b)):f===pc.DISTANCE_EXPONENTIAL&&(k=Math.pow(d/b,-g));b=pc.math.clamp(k,0,1)}this.source.volume=this.volume*b}}});Object.defineProperty(f.prototype,"velocity",{get:function(){return this._velocity},set:function(a){this._velocity.copy(a)}});Object.defineProperty(f.prototype,"maxDistance",{get:function(){return this._maxDistance},
set:function(a){this._maxDistance=a}});Object.defineProperty(f.prototype,"refDistance",{get:function(){return this._refDistance},set:function(a){this._refDistance=a}});Object.defineProperty(f.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(a){this._rollOffFactor=a}});Object.defineProperty(f.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(a){this._distanceModel=a}})}else console.warn("No support for 3D audio found"),f=function(){};
return{SoundInstance3d:f}}());pc.extend(pc,function(){var f;pc.AudioManager.hasAudioContext()?(f=function(a,b,d){d=d||{};this.volume=void 0===d.volume?1:d.volume;this.loop=void 0===d.loop?!1:d.loop;this.pitch=void 0===d.pitch?1:d.pitch;this.sound=b;this.suspended=this.paused=!1;this.startOffset=this.startTime=0;this.manager=a;this.source=null;this.gain=a.context.createGain()},f.prototype={play:function(){if(this.source)throw Error("Call stop() before calling play()");this._createSource();if(this.source&&(this.startTime=this.manager.context.currentTime,
this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended))this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=
null)},unpause:function(){this.source||!this.paused?console.warn("Call pause() before unpausing."):(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1))},stop:function(){this.source&&(this.source.stop(0),this.source=null);this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",
this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setVolume:function(a){this.volume=a=pc.math.clamp(a,0,1);this.gain&&(this.gain.gain.value=a*this.manager.volume)},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate.value=a)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?this.source.buffer.duration:
0},_createSource:function(){var a=this.manager.context;this.sound.buffer&&(this.source=a.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(a.destination),this.loop||(this.source.onended=this.pause.bind(this)))}}):pc.AudioManager.hasAudio()?(f=function(a,b,d){this.volume=d.volume||1;this.loop=d.loop||!1;this.sound=b;this.pitch=void 0!==d.pitch?d.pitch:1;this.suspended=this.paused=!1;this.manager=a;b.audio&&(this.source=b.audio.cloneNode(!1),
this.source.pause())},f.prototype={play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play());this.manager.on("volumechange",this.onManagerVolumeChange,this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this);if(this.manager.suspended)this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=
!1,this.source.play())},stop:function(){this.source&&this.source.pause();this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setVolume:function(a){this.volume=a=pc.math.clamp(a,0,1);this.source&&(this.source.volume=a*this.manager.volume)},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate=
a)},getDuration:function(){if(this.source){var a=this.source.duration;if(a===a)return a}return 0},isPlaying:function(){return!this.source.paused}}):(console.warn("No support for 2D audio found"),f=function(){});pc.extend(f.prototype,{getVolume:function(){return this.volume},getLoop:function(){return this.loop},getPitch:function(){return this.pitch},onManagerVolumeChange:function(){this.setVolume(this.getVolume())},onManagerSuspend:function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},
onManagerResume:function(){this.suspended&&(this.suspended=!1,this.unpause())}});return{Channel:f}}());pc.extend(pc,function(){var f;if(pc.AudioManager.hasAudioContext())f=function(a){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.panner=a.context.createPanner()},f=pc.inherits(f,pc.Channel),f.prototype=pc.extend(f.prototype,{getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);this.panner.setPosition(a.x,a.y,a.z)},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a);this.panner.setVelocity(a.x,a.y,a.z)},getMaxDistance:function(){return this.panner.maxDistance},
setMaxDistance:function(a){this.panner.maxDistance=a},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(a){this.panner.refDistance=a},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(a){this.panner.rolloffFactor=a},getDistanceModel:function(){return this.pannel.distanceModel},setDistanceModel:function(a){this.panner.distanceModel=a},_createSource:function(){var a=this.manager.context;this.source=a.createBufferSource();this.source.buffer=
this.sound.buffer;this.source.connect(this.panner);this.panner.connect(this.gain);this.gain.connect(a.destination);this.loop||(this.source.onended=this.pause.bind(this))}});else if(pc.AudioManager.hasAudio()){var a=new pc.Vec3;f=pc.inherits(function(){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.maxDistance=1E4;this.rollOffFactor=this.minDistance=1;this.distanceModel=pc.DISTANCE_INVERSE},pc.Channel);f.prototype=pc.extend(f.prototype,{getPosition:function(){return this.position},setPosition:function(b){this.position.copy(b);
if(this.source){var d=this.manager.listener.getPosition();var b=this.minDistance,e=this.maxDistance,g=this.rollOffFactor,f=this.distanceModel;a=a.sub2(d,this.position);d=a.length();if(d<b)b=1;else if(d>e)b=0;else{var k=0;f===pc.DISTANCE_LINEAR?k=1-g*(d-b)/(e-b):f===pc.DISTANCE_INVERSE?k=b/(b+g*(d-b)):f===pc.DISTANCE_EXPONENTIAL&&(k=Math.pow(d/b,-g));b=pc.math.clamp(k,0,1)}e=this.getVolume();this.source.volume=e*b}},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a)},
getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(a){this.maxDistance=a},getMinDistance:function(){return this.minDistance},setMinDistance:function(a){this.minDistance=a},getRollOffFactor:function(){return this.rolloffFactor},setRollOffFactor:function(a){this.rolloffFactor=a},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(a){this.distanceModel=a}})}else console.warn("No support for 3D audio found"),f=function(){};return{Channel3d:f}}());(function(){var f={ACTION_MOUSE:"mouse",ACTION_KEYBOARD:"keyboard",ACTION_GAMEPAD:"gamepad",AXIS_MOUSE_X:"mousex",AXIS_MOUSE_Y:"mousey",AXIS_PAD_L_X:"padlx",AXIS_PAD_L_Y:"padly",AXIS_PAD_R_X:"padrx",AXIS_PAD_R_Y:"padry",AXIS_KEY:"key",EVENT_KEYDOWN:"keydown",EVENT_KEYUP:"keyup",EVENT_MOUSEDOWN:"mousedown",EVENT_MOUSEMOVE:"mousemove",EVENT_MOUSEUP:"mouseup",EVENT_MOUSEWHEEL:"mousewheel",EVENT_TOUCHSTART:"touchstart",EVENT_TOUCHEND:"touchend",EVENT_TOUCHMOVE:"touchmove",EVENT_TOUCHCANCEL:"touchcancel",
KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ENTER:13,KEY_SHIFT:16,KEY_CONTROL:17,KEY_ALT:18,KEY_PAUSE:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_SPACE:32,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PRINT_SCREEN:44,KEY_INSERT:45,KEY_DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_SEMICOLON:59,KEY_EQUAL:61,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,
KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_WINDOWS:91,KEY_CONTEXT_MENU:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SEPARATOR:108,KEY_SUBTRACT:109,KEY_DECIMAL:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,
KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_COMMA:188,KEY_PERIOD:190,KEY_SLASH:191,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_META:224,MOUSEBUTTON_NONE:-1,MOUSEBUTTON_LEFT:0,MOUSEBUTTON_MIDDLE:1,MOUSEBUTTON_RIGHT:2,PAD_1:0,PAD_2:1,PAD_3:2,PAD_4:3,PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,
PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3};pc.extend(pc,f);pc.input={};pc.extend(pc.input,f)})();pc.extend(pc,function(){var f=function(a,b){var d={x:0,y:0};if(b){if(b instanceof f)throw Error("Expected MouseEvent");d=a._getTargetCoords(b)}else b={};if(d)this.x=d.x,this.y=d.y;else if(pc.Mouse.isPointerLocked())this.y=this.x=0;else return;this.wheel=b.detail?-1*b.detail:b.wheelDelta?b.wheelDelta/120:0;pc.Mouse.isPointerLocked()?(this.dx=b.movementX||b.webkitMovementX||b.mozMovementX||0,this.dy=b.movementY||b.webkitMovementY||b.mozMovementY||0):(this.dx=this.x-a._lastX,this.dy=this.y-a._lastY);
this.button="mousedown"===b.type||"mouseup"===b.type?b.button:pc.MOUSEBUTTON_NONE;this.buttons=a._buttons.slice(0);this.element=b.target;this.ctrlKey=b.ctrlKey||!1;this.altKey=b.altKey||!1;this.shiftKey=b.shiftKey||!1;this.metaKey=b.metaKey||!1;this.event=b},a=function(a){this._lastY=this._lastX=0;this._buttons=[!1,!1,!1];this._lastbuttons=[!1,!1,!1];this._upHandler=this._handleUp.bind(this);this._downHandler=this._handleDown.bind(this);this._moveHandler=this._handleMove.bind(this);this._wheelHandler=
this._handleWheel.bind(this);this._contextMenuHandler=function(a){a.preventDefault()};this._target=null;this._attached=!1;this.attach(a);pc.events.attach(this)};a.isPointerLocked=function(){return!(!document.pointerLockElement&&!document.mozPointerLockElement&&!document.webkitPointerLockElement)};a.prototype={attach:function(a){this._target=a;this._attached||(this._attached=!0,window.addEventListener("mouseup",this._upHandler,!1),window.addEventListener("mousedown",this._downHandler,!1),window.addEventListener("mousemove",
this._moveHandler,!1),window.addEventListener("mousewheel",this._wheelHandler,!1),window.addEventListener("DOMMouseScroll",this._wheelHandler,!1))},detach:function(){this._attached&&(this._attached=!1,window.removeEventListener("mouseup",this._upHandler),window.removeEventListener("mousedown",this._downHandler),window.removeEventListener("mousemove",this._moveHandler),window.removeEventListener("mousewheel",this._wheelHandler),window.removeEventListener("DOMMouseScroll",this._wheelHandler))},disableContextMenu:function(){this._target&&
this._target.addEventListener("contextmenu",this._contextMenuHandler)},enableContextMenu:function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},enablePointerLock:function(a,b){if(document.body.requestPointerLock){var d=function(){a();document.removeEventListener("pointerlockchange",d)},f=function(){b();document.removeEventListener("pointerlockerror",f)};a&&document.addEventListener("pointerlockchange",d,!1);b&&document.addEventListener("pointerlockerror",
f,!1);document.body.requestPointerLock()}else b&&b()},disablePointerLock:function(a){if(document.exitPointerLock){var b=function(){a();document.removeEventListener("pointerlockchange",b)};a&&document.addEventListener("pointerlockchange",b,!1);document.exitPointerLock()}},update:function(){this._lastbuttons[0]=this._buttons[0];this._lastbuttons[1]=this._buttons[1];this._lastbuttons[2]=this._buttons[2]},isPressed:function(a){return this._buttons[a]},wasPressed:function(a){return this._buttons[a]&&!this._lastbuttons[a]},
wasReleased:function(a){return!this._buttons[a]&&this._lastbuttons[a]},_handleUp:function(a){this._buttons[a.button]=!1;a=new f(this,a);a.event&&this.fire(pc.EVENT_MOUSEUP,a)},_handleDown:function(a){this._buttons[a.button]=!0;a=new f(this,a);a.event&&this.fire(pc.EVENT_MOUSEDOWN,a)},_handleMove:function(a){a=new f(this,a);a.event&&(this.fire(pc.EVENT_MOUSEMOVE,a),this._lastX=a.x,this._lastY=a.y)},_handleWheel:function(a){a=new f(this,a);a.event&&this.fire(pc.EVENT_MOUSEWHEEL,a)},_getTargetCoords:function(a){var b=
this._target.getBoundingClientRect(),d=Math.floor(b.left),b=Math.floor(b.top);return a.clientX<d||a.clientX>=d+this._target.clientWidth||a.clientY<b||a.clientY>=b+this._target.clientHeight?null:{x:a.clientX-d,y:a.clientY-b}}};if(!("undefined"===typeof navigator||"undefined"===typeof document)){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var b=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("pointerlockchange",!0,!1,null);document.dispatchEvent(a)},
d=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("pointerlockerror",!0,!1,null);document.dispatchEvent(a)};document.addEventListener("webkitpointerlockchange",b,!1);document.addEventListener("webkitpointerlocklost",b,!1);document.addEventListener("mozpointerlockchange",b,!1);document.addEventListener("mozpointerlocklost",b,!1);document.addEventListener("webkitpointerlockerror",d,!1);document.addEventListener("mozpointerlockerror",d,!1);Element.prototype.requestPointerLock=
Element.prototype.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock;!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this;navigator.pointer.lock(this,b,d)});document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;document.exitPointerLock||
(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}return{Mouse:a,MouseEvent:f}}());pc.extend(pc,function(){function f(a){return"string"==typeof a?a.toUpperCase().charCodeAt(0):a}var a=function(a,b){this.key=b.keyCode;this.element=b.target;this.event=b},b={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},d=function(a,b){b=b||{};this._element=null;this._keyDownHandler=this._handleKeyDown.bind(this);this._keyUpHandler=this._handleKeyUp.bind(this);this._keyPressHandler=this._handleKeyPress.bind(this);pc.events.attach(this);
this._keymap={};this._lastmap={};a&&this.attach(a);this.preventDefault=b.preventDefault||!1;this.stopPropagation=b.stopPropagation||!1};d.prototype.attach=function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("keydown",this._keyDownHandler,!1);this._element.addEventListener("keypress",this._keyPressHandler,!1);this._element.addEventListener("keyup",this._keyUpHandler,!1)};d.prototype.detach=function(){this._element.removeEventListener("keydown",this._keyDownHandler);
this._element.removeEventListener("keypress",this._keyPressHandler);this._element.removeEventListener("keyup",this._keyUpHandler);this._element=null};d.prototype.toKeyIdentifier=function(a){var a=f(a),d,h;if(d=b[a.toString()])return d;d=a.toString(16).toUpperCase();h=d.length;for(a=0;a<4-h;a++)d="0"+d;return"U+"+d};d.prototype._handleKeyDown=function(b){var d=this.toKeyIdentifier(b.keyCode||b.charCode);this._keymap[d]=!0;this.fire("keydown",new a(this,b));this.preventDefault&&b.preventDefault();this.stopPropagation&&
b.stopPropagation()};d.prototype._handleKeyUp=function(b){var d=this.toKeyIdentifier(b.keyCode||b.charCode);delete this._keymap[d];this.fire("keyup",new a(this,b));this.preventDefault&&b.preventDefault();this.stopPropagation&&b.stopPropagation()};d.prototype._handleKeyPress=function(b){this.toKeyIdentifier(b.keyCode||b.charCode);this.fire("keypress",new a(this,b));this.preventDefault&&b.preventDefault();this.stopPropagation&&b.stopPropagation()};d.prototype.update=function(){var a;this._lastmap={};
for(a in this._keymap)this._keymap.hasOwnProperty(a)&&(this._lastmap[a]=this._keymap[a])};d.prototype.isPressed=function(a){a=f(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]};d.prototype.wasPressed=function(a){a=f(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]&&!this._lastmap[a]};d.prototype.wasReleased=function(a){a=f(a);a=this.toKeyIdentifier(a);return!this._keymap[a]&&!!this._lastmap[a]};return{Keyboard:d}}());pc.extend(pc,function(){var f=function(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads;this.current=[];this.previous=[];this.deadZone=0.25},a={DEFAULT:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_3 PAD_FACE_4 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_4 PAD_FACE_3 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),
axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},b={"Product: 0268":"PS3"};f.prototype={update:function(){var a=this.poll(),b,g=a.length;for(b=0;b<g;b++)this.previous[b]=this.current[b],this.current[b]=a[b]},poll:function(){var a=[];if(this.gamepadsSupported){var b=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads(),g,f=b.length;for(g=0;g<f;g++)b[g]&&a.push({map:this.getMap(b[g]),pad:b[g]})}return a},getMap:function(d){for(var e in b)if(0<=d.id.indexOf(e))return a[b[e]];
return a.DEFAULT},isPressed:function(a,b){return!this.current[a]?!1:this.current[a].pad.buttons[pc[this.current[a].map.buttons[b]]].pressed},wasPressed:function(a,b){if(!this.current[a])return!1;var g=pc[this.current[a].map.buttons[b]];return this.current[a].pad.buttons[g].pressed&&!this.previous[a].pad.buttons[g].pressed},getAxis:function(a,b){if(!this.current[a])return!1;var g=this.current[a].pad.axes[pc[this.current[a].map.axes[b]]];Math.abs(g)<this.deadZone&&(g=0);return g}};return{GamePads:f}}());pc.extend(pc,function(){var f=function(b,e){this.element=e.target;this.event=e;this.touches=[];this.changedTouches=[];if(e){var g,f=e.touches.length;for(g=0;g<f;g++)this.touches.push(new a(e.touches[g]));f=e.changedTouches.length;for(g=0;g<f;g++)this.changedTouches.push(new a(e.changedTouches[g]))}};f.prototype={getTouchById:function(a,b){var g,f=b.length;for(g=0;g<f;g++)if(b[g].id===a)return b[g];return null}};var a=function(a){var b=pc.getTouchTargetCoords(a);this.id=a.identifier;this.x=b.x;this.y=
b.y;this.target=a.target;this.touch=a},b=function(a){this._startHandler=this._handleTouchStart.bind(this);this._endHandler=this._handleTouchEnd.bind(this);this._moveHandler=this._handleTouchMove.bind(this);this._cancelHandler=this._handleTouchCancel.bind(this);this.attach(a);pc.events.attach(this)};b.prototype={attach:function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("touchstart",this._startHandler,!1);this._element.addEventListener("touchend",this._endHandler,
!1);this._element.addEventListener("touchmove",this._moveHandler,!1);this._element.addEventListener("touchcancel",this._cancelHandler,!1)},detach:function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1));this._element=null},_handleTouchStart:function(a){this.fire("touchstart",
new f(this,a))},_handleTouchEnd:function(a){this.fire("touchend",new f(this,a))},_handleTouchMove:function(a){a.preventDefault();this.fire("touchmove",new f(this,a))},_handleTouchCancel:function(a){this.fire("touchcancel",new f(this,a))}};return{getTouchTargetCoords:function(a){for(var b=0,g=0,f=a.target;!(f instanceof HTMLElement);)f=f.parentNode;do b+=f.offsetLeft-f.scrollLeft,g+=f.offsetTop-f.scrollTop,f=f.offsetParent;while(f);return{x:a.pageX-b,y:a.pageY-g}},TouchDevice:b}}());pc.extend(pc,function(){var f=function(a,b){b=b||{};this._keyboard=b.keyboard||null;this._mouse=b.mouse||null;this._gamepads=b.gamepads||null;this._element=null;this._actions={};this._axes={};this._axesValues={};a&&this.attach(a)};f.prototype.attach=function(a){this._element=a;this._keyboard&&this._keyboard.attach(a);this._mouse&&this._mouse.attach(a)};f.prototype.detach=function(){this._keyboard&&this._keyboard.detach();this._mouse&&this._mouse.detach();this._element=null};f.prototype.disableContextMenu=
function(){this._mouse||this._enableMouse();this._mouse.disableContextMenu()};f.prototype.enableContextMenu=function(){this._mouse||this._enableMouse();this._mouse.enableContextMenu()};f.prototype.update=function(a){this._keyboard&&this._keyboard.update(a);this._mouse&&this._mouse.update(a);this._gamepads&&this._gamepads.update(a);this._axesValues={};for(var b in this._axes)this._axesValues[b]=[]};f.prototype.registerKeys=function(a,b){this._keyboard||this._enableKeyboard();if(this._actions[a])throw Error(pc.string.format("Action: {0} already registered",
a));if(void 0===b)throw Error("Invalid button");b.length||(b=[b]);this._actions[a]?this._actions[a].push({type:pc.ACTION_KEYBOARD,keys:b}):this._actions[a]=[{type:pc.ACTION_KEYBOARD,keys:b}]};f.prototype.registerMouse=function(a,b){this._mouse||this._enableMouse();if(void 0===b)throw Error("Invalid button");this._actions[a]?this._actions[a].push({type:pc.ACTION_MOUSE,button:b}):this._actions[a]=[{type:pc.ACTION_MOUSE,button:-b}]};f.prototype.registerPadButton=function(a,b,d){if(void 0===d)throw Error("Invalid button");
this._actions[a]?this._actions[a].push({type:pc.ACTION_GAMEPAD,button:d,pad:b}):this._actions[a]=[{type:pc.ACTION_GAMEPAD,button:d,pad:b}]};f.prototype.registerAxis=function(a){var b=a.name;this._axes[b]||(this._axes[b]=[]);var d=this._axes[b].push(b),a=a||{};a.pad=a.pad||pc.PAD_1;var e=function(e,f,k,m){switch(f){case "mousex":e._mouse.on(pc.EVENT_MOUSEMOVE,function(a){e._axesValues[b][d]=a.dx/10});break;case "mousey":e._mouse.on(pc.EVENT_MOUSEMOVE,function(a){e._axesValues[b][d]=a.dy/10});break;
case "key":e._axes[b].push(function(){return e._keyboard.isPressed(m)?k:0});break;case "padrx":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,pc.PAD_R_STICK_X)});break;case "padry":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,pc.PAD_R_STICK_Y)});break;case "padlx":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,pc.PAD_L_STICK_X)});break;case "padly":e._axes[b].push(function(){return e._gamepads.getAxis(a.pad,pc.PAD_L_STICK_Y)});break;default:throw Error("Unknown axis");
}};e(this,a.positive,1,a.positiveKey);(a.negativeKey||a.negative!==a.positive)&&e(this,a.negative,-1,a.negativeKey)};f.prototype.isPressed=function(a){if(!this._actions[a])return!1;for(var b,d=0,e=this._actions[a].length,d=0;d<e;++d)switch(b=this._actions[a][d],b.type){case pc.ACTION_KEYBOARD:if(this._keyboard){var g,f=b.keys.length;for(g=0;g<f;g++)if(this._keyboard.isPressed(b.keys[g]))return!0}break;case pc.ACTION_MOUSE:if(this._mouse&&this._mouse.isPressed(b.button))return!0;break;case pc.ACTION_GAMEPAD:if(this._gamepads&&
this._gamepads.isPressed(b.pad,b.button))return!0}return!1};f.prototype.wasPressed=function(a){if(!this._actions[a])return!1;for(var b=0,d=this._actions[a].length,b=0;b<d;++b){var e=this._actions[a][b];switch(e.type){case pc.ACTION_KEYBOARD:if(this._keyboard){var g,f=e.keys.length;for(g=0;g<f;g++)if(this._keyboard.wasPressed(e.keys[g]))return!0}break;case pc.ACTION_MOUSE:if(this._mouse&&this._mouse.wasPressed(e.button))return!0;break;case pc.ACTION_GAMEPAD:if(this._gamepads&&this._gamepads.wasPressed(e.pad,
e.button))return!0}}return!1};f.prototype.getAxis=function(a){var b=0;if(this._axes[a]){var d,e=this._axes[a].length;for(d=0;d<e;d++)if("function"===pc.type(this._axes[a][d])){var g=this._axes[a][d]();Math.abs(g)>Math.abs(b)&&(b=g)}else this._axesValues[a]&&Math.abs(this._axesValues[a][d])>Math.abs(b)&&(b=this._axesValues[a][d])}return b};f.prototype._enableMouse=function(){this._mouse=new pc.Mouse;if(!this._element)throw Error("Controller must be attached to an Element");this._mouse.attach(this._element)};
f.prototype._enableKeyboard=function(){this._keyboard=new pc.Keyboard;if(!this._element)throw Error("Controller must be attached to an Element");this._keyboard.attach(this._element)};return{Controller:f}}());pc.extend(pc,function(){var f=function(){};f.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",BIN:"application/octet-stream"};f.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document"};f.binaryExtensions=[".model",".wav",".ogg",".mp3",".dds"];f.prototype={ContentType:f.ContentType,
ResponseType:f.ResponseType,binaryExtensions:f.binaryExtensions,get:function(a,b,d){"function"===typeof b&&(d=b,b={});return this.request("GET",a,b,d)},post:function(a,b,d,e){"function"===typeof d&&(e=d,d={});d.postdata=b;return this.request("POST",a,d,e)},put:function(a,b,d,e){"function"===typeof d&&(e=d,d={});d.postdata=b;return this.request("PUT",a,d,e)},del:function(a,b,d){"function"===typeof b&&(d=b,b={});return this.request("DELETE",a,b,d)},request:function(a,b,d,e){var g,h,k,m=!1;"function"===
typeof d&&(e=d,d={});d.callback=e;null==d.async&&(d.async=!0);null==d.headers&&(d.headers={});if(null!=d.postdata)if(d.postdata instanceof Document)h=d.postdata;else if(d.postdata instanceof FormData)h=d.postdata;else if(d.postdata instanceof Object)switch(h=d.headers["Content-Type"],void 0===h&&(d.headers["Content-Type"]=f.ContentType.FORM_URLENCODED,h=d.headers["Content-Type"]),h){case f.ContentType.FORM_URLENCODED:h="";e=!0;for(g in d.postdata)d.postdata.hasOwnProperty(g)&&(e?e=!1:h+="&",h+=escape(g)+
"="+escape(d.postdata[g]));break;default:null==h&&(d.headers["Content-Type"]=f.ContentType.JSON),h=JSON.stringify(d.postdata)}else h=d.postdata;k||(k=new XMLHttpRequest);!1===d.cache&&(e=pc.time.now(),g=new pc.URI(b),g.query=g.query?g.query+"&ts="+e:"ts="+e,b=g.toString());d.query&&(g=new pc.URI(b),e=pc.extend(g.getQuery(),d.query),g.setQuery(e),b=g.toString());k.open(a,b,d.async);k.withCredentials=void 0!==d.withCredentials?d.withCredentials:!1;k.responseType=d.responseType||this._guessResponseType(b);
for(var r in d.headers)d.headers.hasOwnProperty(r)&&k.setRequestHeader(r,d.headers[r]);k.onreadystatechange=function(){this._onReadyStateChange(a,b,d,k)}.bind(this);k.onerror=function(){this._onError(a,b,d,k);m=!0}.bind(this);try{k.send(h)}catch(u){m||d.error(k.status,k,u)}return k},_guessResponseType:function(a){a=new pc.URI(a);a=pc.path.getExtension(a.path);return 0<=f.binaryExtensions.indexOf(a)?f.ResponseType.ARRAY_BUFFER:f.ResponseType.TEXT},_isBinaryContentType:function(a){return 0<=[f.ContentType.WAV,
f.ContentType.OGG,f.ContentType.MP3,f.ContentType.BIN,f.ContentType.DDS].indexOf(a)?!0:!1},_onReadyStateChange:function(a,b,d,e){if(4===e.readyState)switch(e.status){case 0:"/"!=b[0]&&this._onSuccess(a,b,d,e);break;case 200:case 201:case 206:case 304:this._onSuccess(a,b,d,e);break;default:this._onError(a,b,d,e)}},_onSuccess:function(a,b,d,e){var g;if(a=e.getResponseHeader("Content-Type"))a=a.split(";"),g=a[0].trim(),a[1]&&a[1].trim();g===this.ContentType.JSON||b.split("?")[0].endsWith(".json")?b=
JSON.parse(e.responseText):this._isBinaryContentType(g)?b=e.response:e.responseType===f.ResponseType.ARRAY_BUFFER?(logWARNING(pc.string.format("responseType: {0} being served with Content-Type: {1}",f.ResponseType.ARRAY_BUFFER,g)),b=e.response):b=e.responseType===f.ResponseType.DOCUMENT||g===this.ContentType.XML?e.responseXML:e.responseText;d.callback(null,b)},_onError:function(a,b,d,e){d.callback(e.status,null)}};return{Http:f,http:new f}}());pc.script=function(){var f={app:null,create:function(a,b){void 0===b&&(b=attributes);var d=b(pc.script.app);d._pcScriptName=a;pc.ScriptHandler._push(d);this.fire("created",a,b)},attribute:function(){},createLoadingScreen:function(a){var b=pc.Application.getApplication();a(b)}};pc.events.attach(f);return f}();pc.extend(pc,function(){return{ContentFile:function(f){this.packs=f.packs||{};this.appProperties=f.application_properties||{};this.toc=f.toc||{}}}}());pc.extend(pc,function(){return{Pack:function(f){this.hierarchy=f.hierarchy;this.settings=f.settings}}}());pc.extend(pc,function(){var f=function(a,d){d=d||{};pc.log.open();pc.events.attach(this);f._applications[a.id]=this;f._currentApplication=this;this._time=0;this.timeScale=1;this._librariesLoaded=!1;this._fillMode=pc.FILLMODE_KEEP_ASPECT;this._resolutionMode=pc.RESOLUTION_FIXED;this.context=this;this.graphicsDevice=new pc.GraphicsDevice(a,d.graphicsDeviceOptions);this.stats=new pc.ApplicationStats(this.graphicsDevice);this.systems=new pc.ComponentSystemRegistry;this._audioManager=new pc.SoundManager;
this.loader=new pc.ResourceLoader;this.scene=new pc.Scene;this.root=new pc.Entity(this);this.root._enabledInHierarchy=!0;this.assets=new pc.AssetRegistry(this.loader);this.renderer=new pc.ForwardRenderer(this.graphicsDevice);this.lightmapper=new pc.Lightmapper(this.graphicsDevice,this.root,this.scene,this.renderer,this.assets);this.once("prerender",this._firstBake,this);this.keyboard=d.keyboard||null;this.mouse=d.mouse||null;this.touch=d.touch||null;this.gamepads=d.gamepads||null;this._inTools=!1;
this._skyboxLast=0;this._scriptPrefix=d.scriptPrefix||"";this.loader.addHandler("animation",new pc.AnimationHandler);this.loader.addHandler("model",new pc.ModelHandler(this.graphicsDevice));this.loader.addHandler("material",new pc.MaterialHandler(this.assets));this.loader.addHandler("texture",new pc.TextureHandler(this.graphicsDevice,this.assets,this.loader));this.loader.addHandler("text",new pc.TextHandler);this.loader.addHandler("json",new pc.JsonHandler);this.loader.addHandler("audio",new pc.AudioHandler(this._audioManager));
this.loader.addHandler("script",new pc.ScriptHandler(this));this.loader.addHandler("scene",new pc.SceneHandler(this));this.loader.addHandler("cubemap",new pc.CubemapHandler(this.graphicsDevice,this.assets,this.loader));this.loader.addHandler("html",new pc.HtmlHandler);this.loader.addHandler("css",new pc.CssHandler);this.loader.addHandler("shader",new pc.ShaderHandler);this.loader.addHandler("hierarchy",new pc.HierarchyHandler(this));this.loader.addHandler("scenesettings",new pc.SceneSettingsHandler(this));
this.loader.addHandler("folder",new pc.FolderHandler);new pc.RigidBodyComponentSystem(this);new pc.CollisionComponentSystem(this);new pc.AnimationComponentSystem(this);new pc.ModelComponentSystem(this);new pc.CameraComponentSystem(this);new pc.LightComponentSystem(this);new pc.ScriptComponentSystem(this,d.scriptPrefix);new pc.AudioSourceComponentSystem(this,this._audioManager);new pc.SoundComponentSystem(this,this._audioManager);new pc.AudioListenerComponentSystem(this,this._audioManager);new pc.ParticleSystemComponentSystem(this);
this._visibilityChangeHandler=this.onVisibilityChange.bind(this);void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&
(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))};f._currentApplication=null;f._applications={};f.getApplication=function(a){return a?f._applications[a]:f._currentApplication};var a=function(a){this.length=a;this.count=0;this.inc=function(){this.count++};this.done=function(){return this.count===this.length}};f.prototype={configure:function(a,d){var e=this;pc.http.get(a,function(a,b){if(a)d(a);else{var f=b.assets;e._parseApplicationProperties(b.application_properties,
function(a){e._parseAssets(f);a?d(a):d(null)})}})},preload:function(b){var d=this;d.fire("preload:start");var e=this.assets.list({preload:!0}),g=new a(e.length),f=!1,k=function(){d.graphicsDevice&&(!f&&g.done())&&(f=!0,d.fire("preload:end"),b())},m=e.length,r;if(g.length){var u=function(){g.inc();d.fire("preload:progress",g.count/m);g.done()&&k()},l=function(){g.inc();d.fire("preload:progress",g.count/m);g.done()&&k()};for(r=0;r<g.length;r++)e[r].loaded?(g.inc(),d.fire("preload:progress",g.count/
m),g.done()&&k()):(e[r].once("load",u),e[r].once("error",l),this.assets.load(e[r]))}else k()},loadSceneHierarchy:function(a,d){var e=this,g=this.loader.getHandler("hierarchy");g.load(a,function(f,k){this._preloadScripts(k,function(){var m=g.open(a,k);e.loader.clearCache(a,"hierarchy");e.root.addChild(m);pc.ComponentSystem.initialize(m);pc.ComponentSystem.postInitialize(m);d&&d(f,m)})}.bind(this))},loadSceneSettings:function(a,d){this.loader.load(a,"scenesettings",function(a,b){a?d&&d(a):(this.applySceneSettings(b),
d&&d(null))}.bind(this))},loadScene:function(a,d){var e=this,g=this.loader.getHandler("scene");g.load(a,function(f,k){f?d&&d(f):this._preloadScripts(k,function(){var f=g.open(a,k);e.loader.clearCache(a,"scene");e.loader.patch({resource:f,type:"scene"},e.assets);e.root.addChild(f.root);e.systems.rigidbody&&"undefined"!==typeof Ammo&&e.systems.rigidbody.setGravity(f._gravity.x,f._gravity.y,f._gravity.z);d&&d(null,f)})}.bind(this))},_preloadScripts:function(b,d){var e=this;e.systems.script.preloading=
!0;var g=this._getScriptReferences(b),f=0,k=g.length,m=new a(k),r,u=/^http(s)?:\/\//;if(k)for(var l=function(a){a&&console.error(a);m.inc();m.done()&&(e.systems.script.preloading=!1,d())},f=0;f<k;f++)r=g[f],!u.test(r.toLowerCase())&&e.systems.script._prefix&&(r=pc.path.join(e.systems.script._prefix,g[f])),this.loader.load(r,"script",l);else e.systems.script.preloading=!1,d()},_parseApplicationProperties:function(a,d){this._width=a.width;this._height=a.height;a.use_device_pixel_ratio&&(this.graphicsDevice.maxPixelRatio=
window.devicePixelRatio);this.setCanvasResolution(a.resolution_mode,this._width,this._height);this.setCanvasFillMode(a.fill_mode,this._width,this._height);this._loadLibraries(a.libraries,d)},_loadLibraries:function(a,d){var e=a.length,g=e,f=this;if(e)for(var k=function(a){g--;a?d(a):0===g&&(f.onLibrariesLoaded(),d(null))},m=0;m<e;++m)this.loader.load(a[m],"script",k);else d(null)},_parseAssets:function(a){for(var d in a){var e=a[d],g=new pc.Asset(e.name,e.type,e.file,e.data);g.id=parseInt(d);g.preload=
e.preload?e.preload:!1;g.tags.add(e.tags);this.assets.add(g)}},_getScriptReferences:function(a){var d,e,g=[];a.settings.priority_scripts&&(g=a.settings.priority_scripts);var f=[],k={};for(d=0;d<g.length;d++)f.push(g[d]),k[g[d]]=!0;a=a.entities;for(e in a)if(a[e].components.script){g=a[e].components.script.scripts;for(d=0;d<g.length;d++)k[g[d].url]||(f.push(g[d].url),k[g[d].url]=!0)}return f},start:function(){this.fire("start",{timestamp:pc.now(),target:this});if(!this._librariesLoaded)this.onLibrariesLoaded();
pc.ComponentSystem.initialize(this.root);pc.ComponentSystem.postInitialize(this.root);this.tick()},update:function(a){this.graphicsDevice.updateClientRect();this.stats.frame.updateStart=pc.now();pc.ComponentSystem.fixedUpdate(1/60,this._inTools);pc.ComponentSystem.update(a,this._inTools);pc.ComponentSystem.postUpdate(a,this._inTools);this.fire("update",a);this.controller&&this.controller.update(a);this.mouse&&this.mouse.update(a);this.keyboard&&this.keyboard.update(a);this.gamepads&&this.gamepads.update(a);
this.stats.frame.updateTime=pc.now()-this.stats.frame.updateStart},render:function(){this.stats.frame.renderStart=pc.now();this.fire("prerender",null);var a=this.systems.camera.cameras,d=null,e=this.renderer;this.root.syncHierarchy();for(var g=0,f=a.length;g<f;g++)d=a[g],d.frameBegin(),e.render(this.scene,d.camera),d.frameEnd();this.stats.frame.renderTime=pc.now()-this.stats.frame.renderStart},_fillFrameStats:function(a,d,e){var g=this.stats.frame;g.dt=d;g.ms=e;a>g._timeToCountFrames?(g.fps=g._fpsAccum,
g._fpsAccum=0,g._timeToCountFrames=a+1E3):g._fpsAccum++;g.cameras=this.renderer._camerasRendered;g.materials=this.renderer._materialSwitches;g.shaders=this.graphicsDevice._shaderSwitchesPerFrame;g.shadowMapUpdates=this.renderer._shadowMapUpdates;g.shadowMapTime=this.renderer._shadowMapTime;g.forwardTime=this.renderer._forwardTime;a=this.graphicsDevice._primsPerFrame;g.triangles=a[pc.PRIMITIVE_TRIANGLES]/3+Math.max(a[pc.PRIMITIVE_TRISTRIP]-2,0)+Math.max(a[pc.PRIMITIVE_TRIFAN]-2,0);g.cullTime=this.renderer._cullTime;
for(d=g.otherPrimitives=0;d<a.length;d++)d<pc.PRIMITIVE_TRIANGLES&&(g.otherPrimitives+=a[d]),a[d]=0;this.renderer._camerasRendered=0;this.renderer._materialSwitches=0;this.renderer._shadowMapUpdates=0;this.graphicsDevice._shaderSwitchesPerFrame=0;this.renderer._cullTime=0;g=this.stats.drawCalls;g.forward=this.renderer._forwardDrawCalls;g.depth=this.renderer._depthDrawCalls;g.shadow=this.renderer._shadowDrawCalls;g.skinned=this.renderer._skinDrawCalls;g.immediate=this.renderer._immediateRendered;g.instanced=
this.renderer._instancedDrawCalls;g.removedByInstancing=this.renderer._removedByInstancing;g.total=this.graphicsDevice._drawCallsPerFrame;g.misc=g.total-(g.forward+g.depth+g.shadow);this.renderer._depthDrawCalls=0;this.renderer._shadowDrawCalls=0;this.renderer._forwardDrawCalls=0;this.renderer._skinDrawCalls=0;this.renderer._immediateRendered=0;this.renderer._instancedDrawCalls=0;this.renderer._removedByInstancing=0;this.graphicsDevice._drawCallsPerFrame=0;this.stats.misc.renderTargetCreationTime=
this.graphicsDevice._renderTargetCreationTime},tick:function(){if(this.graphicsDevice){f._currentApplication=this;window.requestAnimationFrame(this.tick.bind(this));var a=pc.now(),d=a-(this._time||a),e;this._time=a;e=pc.math.clamp(d/1E3,0,0.1);e*=this.timeScale;this._fillFrameStats(a,e,d);this.fire("frameEnd",{timestamp:a,target:this});this.update(e);this.render()}},setCanvasFillMode:function(a,d,e){this._fillMode=a;this.resizeCanvas(d,e)},setCanvasResolution:function(a,d,e){this._resolutionMode=
a;a===pc.RESOLUTION_AUTO&&void 0===d&&(d=this.graphicsDevice.canvas.clientWidth,e=this.graphicsDevice.canvas.clientHeight);this.graphicsDevice.resizeCanvas(d,e)},isFullscreen:function(){return!!document.fullscreenElement},enableFullscreen:function(a,d,e){var a=a||this.graphicsDevice.canvas,g=function(){d();document.removeEventListener("fullscreenchange",g)},f=function(){e();document.removeEventListener("fullscreenerror",f)};d&&document.addEventListener("fullscreenchange",g,!1);e&&document.addEventListener("fullscreenerror",
f,!1);a.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT)},disableFullscreen:function(a){var d=function(){a();document.removeEventListener("fullscreenchange",d)};a&&document.addEventListener("fullscreenchange",d,!1);document.exitFullscreen()},isHidden:function(){return document[this._hiddenAttr]},onVisibilityChange:function(){this.isHidden()?this._audioManager.suspend():this._audioManager.resume()},resizeCanvas:function(a,d){var e=window.innerWidth,g=window.innerHeight;if(navigator.isCocoonJS)a=e,d=
g,this.graphicsDevice.resizeCanvas(a,d);else{if(this._fillMode===pc.FILLMODE_KEEP_ASPECT){var f=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;f>e/g?(a=e,d=a/f):(d=g,a=d*f)}else this._fillMode===pc.FILLMODE_FILL_WINDOW&&(a=e,d=g);this.graphicsDevice.canvas.style.width=a+"px";this.graphicsDevice.canvas.style.height=d+"px";this._resolutionMode===pc.RESOLUTION_AUTO&&this.setCanvasResolution(pc.RESOLUTION_AUTO)}return{width:a,height:d}},onLibrariesLoaded:function(){this._librariesLoaded=
!0;this.systems.rigidbody.onLibraryLoaded();this.systems.collision.onLibraryLoaded()},applySceneSettings:function(a){var d;this.systems.rigidbody&&"undefined"!==typeof Ammo&&(d=a.physics.gravity,this.systems.rigidbody.setGravity(d[0],d[1],d[2]));this.scene.applySettings(a);if(a.render.skybox&&this._skyboxLast!==a.render.skybox){this._skyboxLast&&(this.assets.off("add:"+this._skyboxLast,this._onSkyboxAdd,this),this.assets.off("load:"+this._skyboxLast,this._onSkyBoxLoad,this),this.assets.off("remove:"+
this._skyboxLast,this._onSkyboxRemove,this));this._skyboxLast=a.render.skybox;d=this.assets.get(a.render.skybox);this.assets.on("load:"+a.render.skybox,this._onSkyBoxLoad,this);this.assets.once("remove:"+a.render.skybox,this._onSkyboxRemove,this);if(!d)this.assets.once("add:"+a.render.skybox,this._onSkyboxAdd,this);d&&(d.resource&&this.scene.setSkybox(d.resources),this._onSkyboxAdd(d))}else a.render.skybox?0===this.scene.skyboxMip&&a.render.skybox&&(d=this.assets.get(a.render.skybox))&&this._onSkyboxAdd(d):
this._onSkyboxRemove({id:this._skyboxLast})},_onSkyboxAdd:function(a){0===this.scene.skyboxMip&&(a.loadFaces=!0);this.assets.load(a)},_onSkyBoxLoad:function(a){this.scene.setSkybox(a.resources)},_onSkyboxRemove:function(a){this.assets.off("add:"+a.id,this._onSkyboxAdd,this);this.assets.off("load:"+a.id,this._onSkyBoxLoad,this);this.scene.setSkybox(null);this._skyboxLast=null},_firstBake:function(){this.lightmapper.bake()},destroy:function(){f._applications[this.graphicsDevice.canvas.id]=null;this.off("librariesloaded");
document.removeEventListener("visibilitychange",this._visibilityChangeHandler);document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler);document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler);document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler);this.mouse&&(this.mouse.off("mouseup"),this.mouse.off("mousedown"),this.mouse.off("mousewheel"),this.mouse.off("mousemove"),this.mouse=null);this.keyboard&&(this.keyboard.off("keydown"),
this.keyboard.off("keyup"),this.keyboard.off("keypress"),this.keyboard=null);this.touch&&(this.touch.off("touchstart"),this.touch.off("touchend"),this.touch.off("touchmove"),this.touch.off("touchcancel"),this.touch=null);this.controller&&(this.controller=null);this.root.destroy();pc.ComponentSystem.destroy();this.loader.destroy();this.scene=this.loader=null;this.systems=[];this.renderer=this.graphicsDevice=this.context=null;this._audioManager&&(this._audioManager.destroy(),this._audioManager=null);
pc.http=new pc.Http}};return{FILLMODE_NONE:"NONE",FILLMODE_FILL_WINDOW:"FILL_WINDOW",FILLMODE_KEEP_ASPECT:"KEEP_ASPECT",RESOLUTION_AUTO:"AUTO",RESOLUTION_FIXED:"FIXED",Application:f}}());pc.ApplicationStats=function(f){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,forwardTime:0,_timeToCountFrames:0,_fpsAccum:0};this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0};this.misc={renderTargetCreationTime:0};this.vram=f._vram;this.shaders=f._shaderStats;Object.defineProperty(this.vram,
"totalUsed",{get:function(){return this.tex+this.vb+this.ib}});Object.defineProperty(this,"scene",{get:function(){return pc.Application._currentApplication.scene._stats}});Object.defineProperty(this,"lightmapper",{get:function(){return pc.Application._currentApplication.lightmapper._stats}});pc.events.attach(this)};pc.extend(pc,function(){var f=function(){};f.prototype={add:function(a,b){if(this[a])throw Error(pc.string.format("ComponentSystem name '{0}' already registered or not allowed",a));this[a]=b;b.name=a},remove:function(a){if(!this[a])throw Error(pc.string.format("No ComponentSystem named '{0}' registered",a));delete this[a]},list:function(){var a=Object.keys(this),b={collisionrect:0.5,collisioncircle:0.5};a.sort(function(a,e){var g=b[a]||1,f=b[e]||1;return g<f?-1:g>f?1:0});return a.map(function(a){return this[a]},
this)},getComponentSystemOrder:function(){var a,b=Object.keys(this);a=b.indexOf("collisionrect");b.splice(a,1);b.unshift("collisionrect");a=b.indexOf("collisioncircle");b.splice(a,1);b.unshift("collisioncircle");return b}};return{ComponentSystemRegistry:f}}());pc.extend(pc,function(){var f=function(a){this.app=a;this.dataStore={};this.schema=[];pc.events.attach(this)};pc.extend(f,{initialize:function(a){f.fire("initialize",a)},postInitialize:function(a){f.fire("postInitialize",a)},update:function(a,b){b?f.fire("toolsUpdate",a):f.fire("update",a)},fixedUpdate:function(a){f.fire("fixedUpdate",a)},postUpdate:function(a){f.fire("postUpdate",a)}});f.prototype={get store(){return this.dataStore},addComponent:function(a,b){var d=new this.ComponentType(this,a),
e=new this.DataType,b=b||{};this.dataStore[a.getGuid()]={entity:a,data:e};a[this.id]=d;a.c[this.id]=d;this.initializeComponentData(d,b,[]);this.fire("add",a,d);return d},removeComponent:function(a){var b=this.dataStore[a.getGuid()];this.fire("beforeremove",a,a.c[this.id]);delete this.dataStore[a.getGuid()];delete a[this.id];delete a.c[this.id];this.fire("remove",a,b.data)},cloneComponent:function(a,b){var d=this.dataStore[a.getGuid()];return this.addComponent(b,d.data)},initializeComponentData:function(a,
b,d){b=b||{};d.forEach(function(d){a[d]=void 0!==b[d]?b[d]:a.data[d]},this);if(a.enabled&&a.entity.enabled)a.onEnable()}};pc.events.attach(f);f.destroy=function(){f.off("initialize");f.off("postInitialize");f.off("toolsUpdate");f.off("update");f.off("fixedUpdate");f.off("postUpdate")};return{ComponentSystem:f}}());pc.extend(pc,function(){var f=function(a,b){this.system=a;this.entity=b;pc.events.attach(this);this.system.schema&&this.buildAccessors(this.system.schema);this.on("set",function(a,b,g){this.fire("set_"+a,a,b,g)});this.on("set_enabled",this.onSetEnabled,this)};f.prototype={get data(){var a=this.system.store[this.entity.getGuid()];return a?a.data:null},buildAccessors:function(a){var b=this;a.forEach(function(a){Object.defineProperty(b,a,{get:function(){return b.data[a]},set:function(e){var g=b.data,
f=g[a];g[a]=e;b.fire("set",a,f,e)},configurable:!0})})},onSetEnabled:function(a,b,d){if(b!==d&&this.entity.enabled)if(d)this.onEnable();else this.onDisable()},onEnable:function(){},onDisable:function(){}};return{Component:f}}());pc.extend(pc,function(){return{ComponentData:function(){}}}());pc.extend(pc,function(){var f=function(){this.on("set_animations",this.onSetAnimations,this);this.on("set_assets",this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this)},f=pc.inherits(f,pc.Component);pc.extend(f.prototype,{play:function(a,b){if(this.data.animations[a]){if(this.enabled&&this.entity.enabled){var b=b||0,d=this.data;d.prevAnim=d.currAnim;d.currAnim=a;d.model&&(d.blending=0<b&&d.prevAnim,d.blending?(d.blendTime=b,d.blendTimeRemaining=b,d.fromSkel.setAnimation(d.animations[d.prevAnim]),
d.fromSkel.addTime(d.skeleton.getCurrentTime()),d.toSkel.setAnimation(d.animations[d.currAnim])):d.skeleton.setAnimation(d.animations[d.currAnim]));d.playing=!0}}else console.error(pc.string.format("Trying to play animation '{0}' which doesn't exist",a))},getAnimation:function(a){return this.data.animations[a]},setModel:function(a){var b=this.data;if(a){var d=a.getGraph();b.fromSkel=new pc.Skeleton(d);b.toSkel=new pc.Skeleton(d);b.skeleton=new pc.Skeleton(d);b.skeleton.setLooping(b.loop);b.skeleton.setGraph(d)}b.model=
a;b.animations&&(b.currAnim&&b.animations[b.currAnim])&&this.play(b.currAnim)},loadAnimationAssets:function(a){if(a&&a.length){var b=this,d=this.system.app.assets,e,g=a.length,f=function(a){b.animations[a.name]=a.resource;b.animations=b.animations},k=function(a){a.off("change",b.onAssetChanged,b);a.on("change",b.onAssetChanged,b);a.off("remove",b.onAssetRemoved,b);a.on("remove",b.onAssetRemoved,b);a.resource?f(a):(a.once("load",f,b),b.enabled&&b.entity.enabled&&d.load(a))};for(e=0;e<g;e++){var m=
d.get(a[e]);if(m)k(m);else d.on("add:"+a[e],k)}}},onAssetChanged:function(a,b,d){"resource"===b&&(d?(this.animations[a.name]=d,this.data.currAnim===a.name&&this.data.playing&&(this.data.enabled&&this.entity.enabled)&&this.play(a.name,0)):delete this.animations[a.name])},onAssetRemoved:function(a){a.off("remove",this.onAssetRemoved,this);this.animations&&this.animations[a.name]&&(delete this.animations[a.name],this.data.currAnim===a.name&&this._stopCurrentAnimation())},_stopCurrentAnimation:function(){this.data.currAnim=
null;this.data.playing=!1;this.data.skeleton&&(this.data.skeleton.setCurrentTime(0),this.data.skeleton.setAnimation(null))},onSetAnimations:function(){var a=this.data,b=this.entity.model;b&&(b=b.model)&&b!==a.model&&this.entity.animation.setModel(b);if(!a.currAnim&&a.activate&&a.enabled&&this.entity.enabled&&!this.system._inTools)for(var d in a.animations){this.play(d,0);break}},onSetAssets:function(a,b,d){if(b&&b.length)for(a=0;a<b.length;a++)if(b[a]){var e=this.system.app.assets.get(b[a]);e&&(e.off("change",
this.onAssetChanged,this),e.off("remove",this.onAssetRemoved,this),this.data.currAnim===e.name&&this._stopCurrentAnimation())}b=d.map(function(a){return a instanceof pc.Asset?a.id:a});this.loadAnimationAssets(b)},onSetLoop:function(){this.data.skeleton&&this.data.skeleton.setLooping(this.data.loop)},onSetCurrentTime:function(a,b,d){this.data.skeleton.setCurrentTime(d);this.data.skeleton.addTime(0);this.data.skeleton.updateGraph()},onEnable:function(){f._super.onEnable.call(this);var a=this.data.assets,
b=this.system.app.assets;if(a)for(var d=0,e=a.length;d<e;d++){var g=a[d];g instanceof pc.Asset||(g=b.get(g));g&&!g.resource&&b.load(g)}if(this.data.activate&&!this.data.currAnim&&!this.system._inTools)for(var h in this.data.animations){this.play(h,0);break}}});Object.defineProperties(f.prototype,{currentTime:{get:function(){return this.data.skeleton.getCurrentTime()},set:function(a){this.data.skeleton.setCurrentTime(a);this.data.skeleton.addTime(0);this.data.skeleton.updateGraph()}},duration:{get:function(){return this.data.animations[this.data.currAnim].getDuration()}}});
return{AnimationComponent:f}}());pc.extend(pc,function(){var f=function(a){this.id="animation";this.description="Specifies the animation assets that can run on the model specified by the Entity's model Component.";a.systems.add(this.id,this);this.ComponentType=pc.AnimationComponent;this.DataType=pc.AnimationComponentData;this.schema="enabled assets speed loop activate animations skeleton model prevAnim currAnim fromSkel toSkel blending blendTimeRemaining playing".split(" ");this.on("remove",this.onRemove,this);this.on("update",this.onUpdate,
this);pc.ComponentSystem.on("update",this.onUpdate,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,{initializeComponentData:function(a,b,d){d=["activate","enabled","loop","speed","assets"];f._super.initializeComponentData.call(this,a,b,d)},cloneComponent:function(a,b){this.addComponent(b,{});b.animation.data.assets=pc.extend([],a.animation.assets);b.animation.data.speed=a.animation.speed;b.animation.data.loop=a.animation.loop;b.animation.data.activate=a.animation.activate;b.animation.data.enabled=
a.animation.enabled;var d={},e=a.animation.animations,g;for(g in e)e.hasOwnProperty(g)&&(d[g]=e[g]);b.animation.animations=d},onRemove:function(a,b){delete b.animation;delete b.skeleton;delete b.fromSkel;delete b.toSkel},onUpdate:function(a){var b=this.store,d;for(d in b)if(b.hasOwnProperty(d)){var e=b[d],g=e.data;g.enabled&&(g.playing&&e.entity.enabled)&&(e=g.skeleton,null!==e&&null!==g.model&&(g.blending?(g.blendTimeRemaining-=a,0>g.blendTimeRemaining&&(g.blendTimeRemaining=0),e.blend(g.fromSkel,
g.toSkel,1-g.blendTimeRemaining/g.blendTime)):(e.addTime(a*g.speed),e.getCurrentTime()===e.getAnimation().getDuration()&&!g.loop&&(g.playing=!1)),g.blending&&0===g.blendTimeRemaining&&(g.blending=!1,e.setAnimation(g.toSkel.getAnimation())),e.updateGraph()))}}});return{AnimationComponentSystem:f}}());pc.extend(pc,function(){var f;f=pc.inherits(function(){this.assets=[];this.speed=1;this.enabled=this.activate=this.loop=!0;this.animations={};this.toSkel=this.fromSkel=this.currAnim=this.prevAnim=this.model=this.skeleton=null;this.blending=!1;this.blendTimeRemaining=this.blendTime=0;this.playing=!1},pc.ComponentData);return{AnimationComponentData:f}}());pc.extend(pc,function(){var f=function(a){this.id="model";this.description="Renders a 3D model at the location of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.ModelComponent;this.DataType=pc.ModelComponentData;this.schema="enabled type asset materialAsset castShadows receiveShadows castShadowsLightmap lightmapped lightmapSizeMultiplier material model mapping".split(" ");a=a.graphicsDevice;this.box=pc.createBox(a,{halfExtents:new pc.Vec3(0.5,0.5,0.5)});this.capsule=pc.createCapsule(a,
{radius:0.5,height:2});this.sphere=pc.createSphere(a,{radius:0.5});this.cone=pc.createCone(a,{baseRadius:0.5,peakRadius:0,height:1});this.cylinder=pc.createCylinder(a,{radius:0.5,height:1});this.plane=pc.createPlane(a,{halfExtents:new pc.Vec2(0.5,0.5),widthSegments:1,lengthSegments:1});this.defaultMaterial=new pc.StandardMaterial;this.on("beforeremove",this.onRemove,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,{initializeComponentData:function(a,b,d){b.material=this.defaultMaterial;
d="enabled material materialAsset asset castShadows receiveShadows castShadowsLightmap lightmapped lightmapSizeMultiplier type mapping".split(" ");f._super.initializeComponentData.call(this,a,b,d)},removeComponent:function(a){var b=a.model.data;a.model.asset=null;"asset"!==b.type&&b.model&&(this.app.scene.removeModel(b.model),a.removeChild(b.model.getGraph()),b.model=null);f._super.removeComponent.call(this,a)},cloneComponent:function(a,b){var d={type:a.model.type,asset:a.model.asset,castShadows:a.model.castShadows,
receiveShadows:a.model.receiveShadows,castShadowsLightmap:a.model.castShadowsLightmap,lightmapped:a.model.lightmapped,lightmapSizeMultiplier:a.model.lightmapSizeMultiplier,enabled:a.model.enabled,mapping:pc.extend({},a.model.mapping)},e=a.model.materialAsset;!(e instanceof pc.Asset)&&null!=e&&(e=app.assets.get(e));var g=a.model.material;if(!g||g===pc.ModelHandler.DEFAULT_MATERIAL||!e||g===e.resource)d.materialAsset=e;e=this.addComponent(b,d);d.materialAsset||(e.material=g);d=a.model.model.meshInstances;
g=e.model.meshInstances;for(e=0;e<d.length;e++)g[e].mask=d[e].mask},onRemove:function(a,b){b.remove()}});return{ModelComponentSystem:f}}());pc.extend(pc,function(){var f=function(){this.on("set_type",this.onSetType,this);this.on("set_asset",this.onSetAsset,this);this.on("set_castShadows",this.onSetCastShadows,this);this.on("set_receiveShadows",this.onSetReceiveShadows,this);this.on("set_castShadowsLightmap",this.onSetCastShadowsLightmap,this);this.on("set_lightmapped",this.onSetLightmapped,this);this.on("set_lightmapSizeMultiplier",this.onSetLightmapSizeMultiplier,this);this.on("set_model",this.onSetModel,this);this.on("set_material",
this.onSetMaterial,this);this.on("set_mapping",this.onSetMapping,this);Object.defineProperty(this,"materialAsset",{set:this.setMaterialAsset.bind(this),get:this.getMaterialAsset.bind(this)});this._assetOld=0;this._materialEvents=null;this._dirtyMaterialAsset=this._dirtyModelAsset=!1},f=pc.inherits(f,pc.Component);pc.extend(f.prototype,{setVisible:function(a){console.warn("WARNING: setVisible: Function is deprecated. Set enabled property instead.");this.enabled=a},_onAssetLoad:function(a){a.resource&&
this._onModelLoaded(a.resource.clone())},_onAssetChange:function(a,b){"data"===b&&(this.mapping=this.data.mapping)},_onAssetRemove:function(a){this.asset===a.id&&(this.asset=null)},_setModelAsset:function(a){var b=this.system.app.assets,d=null!==a?b.get(a):null;this._dirtyModelAsset=!0;this._onModelAsset(d||null);if(!d&&null!==a)b.once("add:"+a,this._onModelAsset,this)},_onModelAsset:function(a){var b=this.system.app.assets;if(this._assetOld){b.off("add:"+this._assetOld,this._onModelAsset,this);var d=
b.get(this._assetOld);d&&(d.off("load",this._onAssetLoad,this),d.off("change",this._onAssetChange,this),d.off("remove",this._onAssetRemove,this))}this._assetOld=a?a.id:0;a?(a.on("load",this._onAssetLoad,this),a.on("change",this._onAssetChange,this),a.on("remove",this._onAssetRemove,this),a.resource?(this._dirtyModelAsset=!1,this._onModelLoaded(a.resource.clone())):this.enabled&&this.entity.enabled&&(this._dirtyModelAsset=!1,b.load(a))):this._dirtyModelAsset=!1},remove:function(){this._onModelAsset(null)},
_onModelLoaded:function(a){"asset"===this.data.type&&(this.model=a)},onSetType:function(a,b,d){a=this.data;if(d)if(this._area=b=null,"asset"===d)null!==this.data.asset?this._setModelAsset(this.data.asset):this.model=null;else{switch(d){case "box":b=this.system.box;this._area={x:2,y:2,z:2,uv:2/3};break;case "capsule":b=this.system.capsule;this._area={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+2*(1/3/3)};break;case "sphere":b=this.system.sphere;this._area={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case "cone":b=
this.system.cone;this._area={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case "cylinder":b=this.system.cylinder;this._area={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+2*(1/3/3)};break;case "plane":b=this.system.plane;this._area={x:0,y:1,z:0,uv:1};break;default:throw Error("Invalid model type: "+d);}var d=new pc.GraphNode,e=new pc.Model;e.graph=d;e.meshInstances=[new pc.MeshInstance(d,b,a.material)];this.system._inTools&&e.generateWireframe();this.model=e;this.asset=null}},onSetAsset:function(a,b,d){a=null;"asset"===
this.data.type&&(null!==d?(a=d,d instanceof pc.Asset&&(a=this.data.asset=d.id)):this.model=null);null===a&&(this.data.asset=null);this._setModelAsset(a)},onSetCastShadows:function(a,b,d){if(a=this.data.model){var b=this.system.app.scene,e=b.containsModel(a);e&&b.removeModel(a);for(var g=a.meshInstances,f=0;f<g.length;f++)g[f].castShadow=d;e&&b.addModel(a)}},onSetCastShadowsLightmap:function(){},onSetLightmapped:function(a,b,d){if(this.data.model)if(a=this.data.model.meshInstances,d)for(d=0;d<a.length;d++)b=
a[d],b.mask=pc.MASK_BAKED;else for(d=0;d<a.length;d++)b=a[d],b.deleteParameter("texture_lightMap"),b._shaderDefs&=~pc.SHADERDEF_LM,b.mask=pc.MASK_DYNAMIC},onSetLightmapSizeMultiplier:function(a,b,d){this.data.lightmapSizeMultiplier=d},onSetModel:function(a,b,d){b&&(this.system.app.scene.removeModel(b),this.entity.removeChild(b.getGraph()),delete b._entity);if(d){for(var a=this.data,b=d.meshInstances,e=0;e<b.length;e++)b[e].castShadow=a.castShadows,b[e].receiveShadow=a.receiveShadows;this.lightmapped=
a.lightmapped;this.entity.addChild(d.graph);this.enabled&&this.entity.enabled&&this.system.app.scene.addModel(d);d._entity=this.entity;this.entity.animation&&this.entity.animation.setModel(d);"asset"===this.data.type?this.mapping=this.data.mapping:this._unsetMaterialEvents()}else this._unsetMaterialEvents()},_onMaterialAssetRemove:function(a){var b=this.system.app.assets,d=isNaN(a)?a.id:a;a&&(isNaN(a)&&a.resource===this.material)&&(this.material=pc.ModelHandler.DEFAULT_MATERIAL);b.off("add:"+d,this._onMaterialAsset,
this);b.off("load:"+d,this._onMaterialAsset,this);b.off("remove:"+d,this._onMaterialAssetRemove,this)},_onMaterialAsset:function(a){var b=this.system.app.assets;a.resource?(this.material=a.resource,this._dirtyMaterialAsset=!1):this.enabled&&this.entity.enabled&&(this._dirtyMaterialAsset=!1,b.load(a))},setMaterialAsset:function(a){this._dirtyMaterialAsset=!0;var a="number"===typeof a||!a?a:a.id,b=this.system.app.assets;this.data.materialAsset!==a&&(this.data.materialAsset&&this._onMaterialAssetRemove(this.data.materialAsset),
a&&(b.on("load:"+a,this._onMaterialAsset,this),b.on("remove:"+a,this._onMaterialAssetRemove,this)));if(void 0!==a&&null!==a){var d=b.get(a);d&&this._onMaterialAsset(d);b.once("add:"+a,this._onMaterialAsset,this)}else null===a&&(this.material=pc.ModelHandler.DEFAULT_MATERIAL,this._dirtyMaterialAsset=!1);b=this.data.materialAsset;this.data.materialAsset=a;this.fire("set","materialAsset",b,a)},getMaterialAsset:function(){return this.system.app.assets.get(this.data.materialAsset)},onSetMaterial:function(a,
b,d){if(d!==b&&(this.data.material=d,this.data.model&&"asset"!==this.data.type)){a=this.data.model.meshInstances;for(b=0;b<a.length;b++)a[b].material=d}},onSetMapping:function(a,b,d){if("asset"===this.data.type&&this.data.model){this._unsetMaterialEvents();d||(d={});for(var a=this.data.model.meshInstances,b=(b=this.asset?this.system.app.assets.get(this.asset):null)?b.data.mapping:null,e=0,g=a.length;e<g;e++)void 0!==d[e]?d[e]?this._loadAndSetMeshInstanceMaterial(d[e],a[e],e):a[e].material=pc.ModelHandler.DEFAULT_MATERIAL:
b&&(b[e]&&(b[e].material||b[e].path)?this._loadAndSetMeshInstanceMaterial(b[e].material||b[e].path,a[e],e):a[e].material=pc.ModelHandler.DEFAULT_MATERIAL)}},_setMaterialEvent:function(a,b,d,e){b=b+":"+d;this.system.app.assets.on(b,e,this);this._materialEvents||(this._materialEvents=[]);this._materialEvents[a]||(this._materialEvents[a]={});this._materialEvents[a][b]={id:d,handler:e}},_unsetMaterialEvents:function(){var a=this.system.app.assets,b=this._materialEvents;if(b){for(var d=0,e=b.length;d<
e;d++)if(b[d]){var g=b[d],f;for(f in g)a.off(f,g[f].handler,this)}this._materialEvents=null}},_getAssetByIdOrPath:function(a){var b=null;isNaN(parseInt(a,10))?this.asset&&(a=this._getMaterialAssetUrl(a))&&(b=this.system.app.assets.getByUrl(a)):b=this.system.app.assets.get(a);return b},_getMaterialAssetUrl:function(a){if(!this.asset)return null;var b=this.system.app.assets.get(this.asset);if(!b)return null;b=b.getFileUrl();b=pc.path.getDirectory(b);return pc.path.join(b,a)},_loadAndSetMeshInstanceMaterial:function(a,
b,d){var e=this,g=this.system.app.assets,f=this._getAssetByIdOrPath(a);if(f){var k=function(a){a.resource?(b.material=a.resource,e._setMaterialEvent(d,"remove",a.id,function(){b.material=pc.ModelHandler.DEFAULT_MATERIAL})):(e._setMaterialEvent(d,"load",a.id,function(a){b.material=a.resource;e._setMaterialEvent(d,"remove",a.id,function(){b.material=pc.ModelHandler.DEFAULT_MATERIAL})}),e.enabled&&e.entity.enabled&&g.load(a))};f?k(f):(b.material=pc.ModelHandler.DEFAULT_MATERIAL,f=isNaN(parseInt(a,10)),
e._setMaterialEvent(d,f?"add:url":"add",a,k))}},onSetReceiveShadows:function(a,b,d){if(void 0!==d&&(a=this.data,a.model)){a=a.model.meshInstances;for(b=0;b<a.length;b++)a[b].receiveShadow=d}},onEnable:function(){f._super.onEnable.call(this);var a=this.data.model,b="asset"===this.data.type;if(a)this.system.app.scene.containsModel(a)||this.system.app.scene.addModel(a);else if(b&&this._dirtyModelAsset){a=this.data.asset;if(!a)return;(a=this.system.app.assets.get(a))&&this._onModelAsset(a)}if(this._dirtyMaterialAsset&&
(a=this.data.materialAsset))(a=this.system.app.assets.get(a))&&!a.resource&&this._onMaterialAsset(a);if(b&&(b=this.data.mapping))for(var d in b)b[d]&&(a=this._getAssetByIdOrPath(b[d]))&&!a.resource&&this.system.app.assets.load(a)},onDisable:function(){f._super.onDisable.call(this);var a=this.data.model;a&&this.system.app.scene.containsModel(a)&&this.system.app.scene.removeModel(a)}});return{ModelComponent:f}}());pc.extend(pc,function(){var f;f=pc.inherits(function(){this.enabled=!0;this.type="asset";this.asset=null;this.castShadows=!1;this.receiveShadows=!0;this.mapping=this.materialAsset=null;this.castShadowsLightmap=!0;this.lightmapped=!1;this.lightmapSizeMultiplier=1;this.model=this.material=null},pc.ComponentData);return{ModelComponentData:f}}());pc.extend(pc,function(){var f=function(a){this.id="camera";this.description="Renders the scene from the location of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.CameraComponent;this.DataType=pc.CameraComponentData;this.schema="enabled clearColorBuffer clearColor clearDepthBuffer frustumCulling projection fov orthoHeight nearClip farClip priority rect camera aspectRatio horizontalFov model renderTarget".split(" ");this.cameras=[];this.on("beforeremove",this.onBeforeRemove,this);this.on("remove",
this.onRemove,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,{initializeComponentData:function(a,b,d){var d="postEffects enabled model camera aspectRatio horizontalFov renderTarget clearColor fov orthoHeight nearClip farClip projection priority clearColorBuffer clearDepthBuffer frustumCulling rect".split(" "),e={};d.forEach(function(a){e[a]=b[a]});if(e.clearColor&&"array"===pc.type(e.clearColor)){var g=e.clearColor;e.clearColor=new pc.Color(g[0],g[1],g[2],g[3])}e.rect&&"array"===
pc.type(e.rect)&&(g=e.rect,e.rect=new pc.Vec4(g[0],g[1],g[2],g[3]));e.activate&&(console.warn("WARNING: activate: Property is deprecated. Set enabled property instead."),e.enabled=e.activate);e.camera=new pc.Camera;e._node=a.entity;e.postEffects=new pc.PostEffectQueue(this.app,a);f._super.initializeComponentData.call(this,a,e,d)},onBeforeRemove:function(a,b){this.removeCamera(b)},onRemove:function(a,b){b.camera=null},addCamera:function(a){this.cameras.push(a);this.sortCamerasByPriority()},removeCamera:function(a){a=
this.cameras.indexOf(a);0<=a&&(this.cameras.splice(a,1),this.sortCamerasByPriority())},sortCamerasByPriority:function(){this.cameras.sort(function(a,b){return a.priority-b.priority})}});return{CameraComponentSystem:f}}());pc.extend(pc,function(){var f=function(){this.on("set_aspectRatio",this.onSetAspectRatio,this);this.on("set_camera",this.onSetCamera,this);this.on("set_clearColor",this.onSetClearColor,this);this.on("set_fov",this.onSetFov,this);this.on("set_orthoHeight",this.onSetOrthoHeight,this);this.on("set_nearClip",this.onSetNearClip,this);this.on("set_farClip",this.onSetFarClip,this);this.on("set_projection",this.onSetProjection,this);this.on("set_priority",this.onSetPriority,this);this.on("set_clearColorBuffer",
this.updateClearFlags,this);this.on("set_clearDepthBuffer",this.updateClearFlags,this);this.on("set_renderTarget",this.onSetRenderTarget,this);this.on("set_rect",this.onSetRect,this);this.on("set_horizontalFov",this.onSetHorizontalFov,this);this.on("set_frustumCulling",this.onSetFrustumCulling,this)},f=pc.inherits(f,pc.Component);Object.defineProperty(f.prototype,"projectionMatrix",{get:function(){return this.data.camera.getProjectionMatrix()}});Object.defineProperty(f.prototype,"viewMatrix",{get:function(){return this.data.camera._node.getWorldTransform().clone().invert()}});
Object.defineProperty(f.prototype,"frustum",{get:function(){return this.data.camera.getFrustum()}});pc.extend(f.prototype,{screenToWorld:function(a,b,d,e){var g=this.system.app.graphicsDevice;return this.data.camera.screenToWorld(a,b,d,g.clientRect.width,g.clientRect.height,e)},worldToScreen:function(a,b){var d=this.system.app.graphicsDevice;return this.data.camera.worldToScreen(a,d.clientRect.width,d.clientRect.height,b)},onSetAspectRatio:function(a,b,d){this.data.camera.setAspectRatio(d)},onSetCamera:function(a,
b,d){b&&(b._node=null);d._node=this.entity},onSetClearColor:function(a,b,d){a=this.data.camera.getClearOptions();a.color[0]=d.r;a.color[1]=d.g;a.color[2]=d.b;a.color[3]=d.a},onSetFov:function(a,b,d){this.data.camera.setFov(d)},onSetOrthoHeight:function(a,b,d){this.data.camera.setOrthoHeight(d)},onSetNearClip:function(a,b,d){this.data.camera.setNearClip(d)},onSetFarClip:function(a,b,d){this.data.camera.setFarClip(d)},onSetHorizontalFov:function(a,b,d){this.data.camera.setHorizontalFov(d)},onSetFrustumCulling:function(a,
b,d){this.data.camera.frustumCulling=d},onSetProjection:function(a,b,d){this.data.camera.setProjection(d)},onSetPriority:function(){this.system.sortCamerasByPriority()},updateClearFlags:function(){var a=this.data.camera.getClearOptions(),b=0;this.clearColorBuffer&&(b|=pc.CLEARFLAG_COLOR);this.clearDepthBuffer&&(b|=pc.CLEARFLAG_DEPTH);a.flags=b},onSetRenderTarget:function(a,b,d){this.data.camera.setRenderTarget(d)},onSetRect:function(a,b,d){this.data.camera.setRect(d.data[0],d.data[1],d.data[2],d.data[3]);
this._resetAspectRatio()},onEnable:function(){f._super.onEnable.call(this);this.system.addCamera(this);this.postEffects.enable()},onDisable:function(){f._super.onDisable.call(this);this.postEffects.disable();this.system.removeCamera(this)},_resetAspectRatio:function(){var a=this.camera;if(a&&!a.getRenderTarget()){var b=this.system.app.graphicsDevice,d=this.rect,b=b.width*d.z/(b.height*d.w);b!==a.getAspectRatio()&&a.setAspectRatio(b)}},frameBegin:function(){this._resetAspectRatio();this.data.isRendering=
!0},frameEnd:function(){this.data.isRendering=!1}});return{CameraComponent:f}}());pc.extend(pc,function(){CameraComponentData=function(){this.clearColor=new pc.Color(0.722,0.722,0.722,1);this.clearDepthBuffer=this.clearColorBuffer=!0;this.nearClip=0.1;this.farClip=1E3;this.fov=45;this.orthoHeight=100;this.projection=pc.PROJECTION_PERSPECTIVE;this.priority=0;this.rect=new pc.Vec4(0,0,1,1);this.enabled=!0;this.frustumCulling=!1;this.camera=null;this.aspectRatio=16/9;this.postEffects=this.renderTarget=null;this.isRendering=!1};CameraComponentData=pc.inherits(CameraComponentData,pc.ComponentData);
return{CameraComponentData:CameraComponentData}}());pc.extend(pc,function(){function f(a,b){this.app=a;this.camera=b;this.effects=[];this.enabled=!1;this.depthTarget=null;this.renderTargetScale=1;this.resizeTimeout=null;b.on("set_rect",this.onCameraRectChanged,this)}f.prototype={_createOffscreenTarget:function(a,b){var d=this.camera.rect,e=Math.floor(d.z*this.app.graphicsDevice.width*this.renderTargetScale),d=Math.floor(d.w*this.app.graphicsDevice.height*this.renderTargetScale),g=this.app.graphicsDevice,f=b?g.getHdrFormat():pc.PIXELFORMAT_R8_G8_B8_A8,
e=new pc.Texture(g,{format:f,width:e,height:d});e.minFilter=pc.FILTER_NEAREST;e.magFilter=pc.FILTER_NEAREST;e.addressU=pc.ADDRESS_CLAMP_TO_EDGE;e.addressV=pc.ADDRESS_CLAMP_TO_EDGE;return new pc.RenderTarget(this.app.graphicsDevice,e,{depth:a})},setRenderTargetScale:function(a){this.renderTargetScale=a;this.resizeRenderTargets()},addEffect:function(a){var b=0===this.effects.length,d=this.effects,a={effect:a,inputTarget:this._createOffscreenTarget(b,a.hdr),outputTarget:null};b&&(this.camera.renderTarget=
a.inputTarget);d.push(a);b=d.length;1<b&&(d[b-2].outputTarget=a.inputTarget);this.enable()},removeEffect:function(a){for(var b=-1,d=0,e=this.effects.length;d<e;d++)if(this.effects[d].effect===a){b=d;break}0<=b&&(0<b?this.effects[b-1].outputTarget=b+1<this.effects.length?this.effects[b+1].inputTarget:null:1<this.effects.length&&(this.effects[1].inputTarget._depth||(this.effects[1].inputTarget.destroy(),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr)),this.camera.renderTarget=
this.effects[1].inputTarget),this.effects[b].inputTarget.destroy(),this.effects.splice(b,1));this.enabled&&a.needsDepthBuffer&&this.camera.releaseDepthMap();0===this.effects.length&&this.disable()},requestDepthMap:function(){for(var a=0,b=this.effects.length;a<b;a++)this.effects[a].effect.needsDepthBuffer&&this.camera.camera.requestDepthMap()},releaseDepthMap:function(){for(var a=0,b=this.effects.length;a<b;a++)this.effects[a].effect.needsDepthBuffer&&this.camera.releaseDepthMap()},destroy:function(){for(var a=
0,b=this.effects.length;a<b;a++)this.effects[a].inputTarget.destroy();this.effects.length=0;this.disable()},enable:function(){if(!this.enabled&&this.effects.length){this.enabled=!0;var a=this.effects,b=this.camera;this.requestDepthMap();this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this);b.camera.setRect(0,0,1,1);this.command=new pc.Command(pc.LAYER_FX,pc.BLEND_NONE,function(){if(this.enabled&&b.data.isRendering){var d=null,e=a.length;if(e){b.renderTarget=a[0].inputTarget;this.depthTarget=
this.camera.camera._depthTarget;for(var g=0;g<e;g++){var f=a[g];this.depthTarget&&(f.effect.depthMap=this.depthTarget.colorBuffer);g===e-1&&(d=b.rect);f.effect.render(f.inputTarget,f.outputTarget,d)}}}}.bind(this));this.app.scene.drawCalls.push(this.command)}},disable:function(){if(this.enabled){this.enabled=!1;this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this);this.camera.renderTarget=null;this.releaseDepthMap();var a=this.camera.rect;this.camera.camera.setRect(a.x,a.y,a.z,a.w);
a=this.app.scene.drawCalls.indexOf(this.command);0<=a&&this.app.scene.drawCalls.splice(a,1)}},_onCanvasResized:function(){var a=this.camera.rect,b=this.app.graphicsDevice,a=b.width*a.z/(b.height*a.w);a!==this.camera.camera.getAspectRatio()&&this.camera.camera.setAspectRatio(a);this.resizeTimeout&&clearTimeout(this.resizeTimeout);this.resizeTimeout=setTimeout(this.resizeRenderTargets.bind(this),500)},resizeRenderTargets:function(){for(var a=this.camera.rect,b=Math.floor(a.z*this.app.graphicsDevice.width*
this.renderTargetScale),a=Math.floor(a.w*this.app.graphicsDevice.height*this.renderTargetScale),d=this.effects,e=0,g=d.length;e<g;e++){var f=d[e];if(f.inputTarget.width!==b||f.inputTarget.height!==a)f.inputTarget.destroy(),f.inputTarget=this._createOffscreenTarget(f.effect.needsDepthBuffer||0===e,f.hdr),0<e?d[e-1].outputTarget=f.inputTarget:this.camera.renderTarget=f.inputTarget}},onCameraRectChanged:function(){this.enabled&&(this.camera.camera.setRect(0,0,1,1),this.resizeRenderTargets())}};return{PostEffectQueue:f}}());pc.extend(pc,function(){var f={directional:pc.LIGHTTYPE_DIRECTIONAL,point:pc.LIGHTTYPE_POINT,spot:pc.LIGHTTYPE_SPOT},a=function(a){this.id="light";this.description="Enables the Entity to emit light.";a.systems.add(this.id,this);this.ComponentType=pc.LightComponent;this.DataType=pc.LightComponentData;this.schema="enabled type color intensity castShadows shadowDistance shadowResolution shadowBias normalOffsetBias range falloffMode shadowType shadowUpdateMode mask affectDynamic affectLightmapped bake innerConeAngle outerConeAngle light model".split(" ");
this.on("remove",this.onRemove,this)},a=pc.inherits(a,pc.ComponentSystem);pc.extend(a.prototype,{initializeComponentData:function(b,d,e){var e="type light model enabled color intensity range falloffMode innerConeAngle outerConeAngle castShadows shadowDistance shadowResolution shadowUpdateMode shadowBias normalOffsetBias mask affectDynamic affectLightmapped bake".split(" "),g={};e.forEach(function(a){g[a]=d[a]});g.type||(g.type=b.data.type);b.data.type=g.type;g.color&&"array"===pc.type(g.color)&&(g.color=
new pc.Color(g.color[0],g.color[1],g.color[2]));g.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),g.enabled=g.enable);var h=new pc.Light;h.setType(f[g.type]);h._node=b.entity;this.app.scene.addLight(h);b.data.light=h;a._super.initializeComponentData.call(this,b,g,e)},onRemove:function(a,d){this.app.scene.removeLight(d.light)},cloneComponent:function(a,d){var e=a.light;this.addComponent(d,{type:e.type,enabled:e.enabled,color:[e.color.r,e.color.g,e.color.b],
intensity:e.intensity,range:e.range,innerConeAngle:e.innerConeAngle,outerConeAngle:e.outerConeAngle,castShadows:e.castShadows,shadowDistance:e.shadowDistance,shadowResolution:e.shadowResolution,falloffMode:e.falloffMode,shadowUpdateMode:e.shadowUpdateMode,shadowBias:e.shadowBias,normalOffsetBias:e.normalOffsetBias,mask:e.mask,affectDynamic:e.affectDynamic,affectLightmapped:e.affectLightmapped,bake:e.bake})},changeType:function(a,d,e){a.light.setType(f[e])}});return{LightComponentSystem:a}}());pc.extend(pc,function(){var f=function(){this.on("set_type",this.onSetType,this);this.on("set_color",this.onSetColor,this);this.on("set_intensity",this.onSetIntensity,this);this.on("set_castShadows",this.onSetCastShadows,this);this.on("set_shadowDistance",this.onSetShadowDistance,this);this.on("set_shadowResolution",this.onSetShadowResolution,this);this.on("set_shadowBias",this.onSetShadowBias,this);this.on("set_normalOffsetBias",this.onSetNormalOffsetBias,this);this.on("set_range",this.onSetRange,
this);this.on("set_innerConeAngle",this.onSetInnerConeAngle,this);this.on("set_outerConeAngle",this.onSetOuterConeAngle,this);this.on("set_falloffMode",this.onSetFalloffMode,this);this.on("set_shadowType",this.onSetShadowType,this);this.on("set_shadowUpdateMode",this.onSetShadowUpdateMode,this);this.on("set_mask",this.onSetMask,this);this.on("set_affectDynamic",this.onSetAffectDynamic,this);this.on("set_affectLightmapped",this.onSetAffectLightmapped,this);this.on("set_bake",this.onSetBake,this)},
f=pc.inherits(f,pc.Component);Object.defineProperty(f.prototype,"enable",{get:function(){console.warn("WARNING: enable: Property is deprecated. Query enabled property instead.");return this.enabled},set:function(a){console.warn("WARNING: enable: Property is deprecated. Set enabled property instead.");this.enabled=a}});pc.extend(f.prototype,{onSetType:function(a,b,d){b!==d&&(this.system.changeType(this,b,d),this.refreshProperties())},refreshProperties:function(){this.onSetCastShadows("castShadows",
this.castShadows,this.castShadows);this.onSetColor("color",this.color,this.color);this.onSetIntensity("intensity",this.intensity,this.intensity);this.onSetShadowDistance("shadowDistance",this.shadowDistance,this.shadowDistance);this.onSetShadowResolution("shadowResolution",this.shadowResolution,this.shadowResolution);this.onSetShadowBias("shadowBias",this.shadowBias,this.shadowBias);this.onSetNormalOffsetBias("normalOffsetBias",this.normalOffsetBias,this.normalOffsetBias);this.onSetRange("range",
this.range,this.range);this.onSetInnerConeAngle("innerConeAngle",this.innerConeAngle,this.innerConeAngle);this.onSetOuterConeAngle("outerConeAngle",this.outerConeAngle,this.outerConeAngle);this.onSetFalloffMode("falloffMode",this.falloffMode,this.falloffMode);this.onSetShadowType("shadowType",this.shadowType,this.shadowType);this.onSetShadowUpdateMode("shadowUpdateMode",this.shadowUpdateMode,this.shadowUpdateMode);this.onSetMask("mask",this.light.mask,this.light.mask);this.onSetAffectDynamic("affectDynamic",
this.affectDynamic,this.affectDynamic);this.onSetAffectLightmapped("affectLightmapped",this.affectLightmapped,this.affectLightmapped);this.onSetBake("bake",this.bake,this.bake);if(this.enabled&&this.entity.enabled)this.onEnable()},updateShadow:function(){this.light.updateShadow()},onSetCastShadows:function(a,b,d){this.light.setCastShadows(d)},onSetColor:function(a,b,d){this.light.setColor(d)},onSetIntensity:function(a,b,d){this.light.setIntensity(d)},onSetShadowDistance:function(a,b,d){"directional"===
this.data.type&&this.light.setShadowDistance(d)},onSetShadowResolution:function(a,b,d){this.light.setShadowResolution(d)},onSetShadowBias:function(a,b,d){this.light.setShadowBias(-0.01*d)},onSetNormalOffsetBias:function(a,b,d){this.light.setNormalOffsetBias(d)},onSetRange:function(a,b,d){"point"!==this.data.type&&"spot"!==this.data.type||this.light.setAttenuationEnd(d)},onSetInnerConeAngle:function(a,b,d){"spot"===this.data.type&&this.light.setInnerConeAngle(d)},onSetOuterConeAngle:function(a,b,d){"spot"===
this.data.type&&this.light.setOuterConeAngle(d)},onSetFalloffMode:function(a,b,d){"point"!==this.data.type&&"spot"!==this.data.type||this.light.setFalloffMode(d)},onSetShadowType:function(a,b,d){this.light.setShadowType(d)},onSetShadowUpdateMode:function(a,b,d){this.light.shadowUpdateMode=d},onSetMask:function(a,b,d){this.light.setMask(d)},onSetAffectDynamic:function(a,b,d){this.light.mask=d?this.light.mask|pc.MASK_DYNAMIC:this.light.mask&~pc.MASK_DYNAMIC;this.light.setMask(this.light.mask)},onSetAffectLightmapped:function(a,
b,d){d?(this.light.mask|=pc.MASK_BAKED,this.bake&&(this.light.mask&=~pc.MASK_LIGHTMAP)):(this.light.mask&=~pc.MASK_BAKED,this.bake&&(this.light.mask|=pc.MASK_LIGHTMAP));this.light.setMask(this.light.mask)},onSetBake:function(a,b,d){d?(this.light.mask|=pc.MASK_LIGHTMAP,this.affectLightmapped&&(this.light.mask&=~pc.MASK_BAKED)):(this.light.mask&=~pc.MASK_LIGHTMAP,this.affectLightmapped&&(this.light.mask|=pc.MASK_BAKED));this.light.setMask(this.light.mask)},onEnable:function(){f._super.onEnable.call(this);
this.light.setEnabled(!0);var a=this.data.model;if(a){var b=this.system.app.scene;b.containsModel(a)||b.addModel(a)}},onDisable:function(){f._super.onDisable.call(this);this.light.setEnabled(!1);var a=this.data.model;a&&this.system.app.scene.removeModel(a)}});return{LightComponent:f}}());pc.extend(pc,function(){var f;f=pc.inherits(function(){this.type="directional";this.enabled=!0;this.color=new pc.Color(1,1,1);this.intensity=1;this.castShadows=!1;this.shadowDistance=40;this.shadowResolution=1024;this.shadowBias=0.05;this.normalOffsetBias=0;this.range=10;this.innerConeAngle=40;this.outerConeAngle=45;this.falloffMode=pc.LIGHTFALLOFF_LINEAR;this.shadowType=pc.SHADOW_DEPTH;this.shadowUpdateMode=pc.SHADOWUPDATE_REALTIME;this.mask=1;this.affectDynamic=!0;this.bake=this.affectLightmapped=
!1;this.model=this.light=null},pc.ComponentData);return{LightComponentData:f}}());pc.extend(pc,function(){var f=function(a,b){this.id="script";this.description="Allows the Entity to run JavaScript fragments to implement custom behavior.";a.systems.add(this.id,this);this.ComponentType=pc.ScriptComponent;this.DataType=pc.ScriptComponentData;this._prefix=b||null;this.schema=["enabled","scripts","instances","runInTools"];this.preloading=!1;this.instancesWithUpdate=[];this.instancesWithFixedUpdate=[];this.instancesWithPostUpdate=[];this.instancesWithToolsUpdate=[];this.on("beforeremove",
this.onBeforeRemove,this);pc.ComponentSystem.on("initialize",this.onInitialize,this);pc.ComponentSystem.on("postInitialize",this.onPostInitialize,this);pc.ComponentSystem.on("update",this.onUpdate,this);pc.ComponentSystem.on("fixedUpdate",this.onFixedUpdate,this);pc.ComponentSystem.on("postUpdate",this.onPostUpdate,this);pc.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,{initializeComponentData:function(a,b,d){d=["runInTools","enabled",
"scripts"];b.scripts&&b.scripts.length&&b.scripts.forEach(function(a){if(a.attributes&&"array"===pc.type(a.attributes)){for(var b={},d=0;d<a.attributes.length;d++)b[a.attributes[d].name]=a.attributes[d];a.attributes=b}});f._super.initializeComponentData.call(this,a,b,d)},cloneComponent:function(a,b){for(var d=this.dataStore[a.getGuid()],e={runInTools:d.data.runInTools,scripts:[],enabled:d.data.enabled},d=d.data.scripts,g=0,f=d.length;g<f;g++){var k=d[g].attributes;k&&delete d[g].attributes;e.scripts.push(pc.extend({},
d[g]));k&&(e.scripts[g].attributes=this._cloneAttributes(k),d[g].attributes=k)}return this.addComponent(b,e)},onBeforeRemove:function(a,b){b.enabled&&this._disableScriptComponent(b);this._destroyScriptComponent(b)},onInitialize:function(a){this._registerInstances(a);if(a.enabled){a.script&&a.script.enabled&&this._initializeScriptComponent(a.script);var a=a.getChildren(),b,d=a.length;for(b=0;b<d;b++)if(a[b]instanceof pc.Entity)this.onInitialize(a[b])}},onPostInitialize:function(a){if(a.enabled){a.script&&
a.script.enabled&&this._postInitializeScriptComponent(a.script);var a=a.getChildren(),b,d=a.length;for(b=0;b<d;b++)if(a[b]instanceof pc.Entity)this.onPostInitialize(a[b])}},_callInstancesMethod:function(a,b){var d=a.data.instances,e;for(e in d)if(d.hasOwnProperty(e)){var g=d[e].instance;g[b]&&g[b].call(g)}},_initializeScriptComponent:function(a){this._callInstancesMethod(a,"initialize");a.data.initialized=!0;a.enabled&&a.entity.enabled&&this._enableScriptComponent(a)},_enableScriptComponent:function(a){this._callInstancesMethod(a,
"onEnable")},_disableScriptComponent:function(a){this._callInstancesMethod(a,"onDisable")},_destroyScriptComponent:function(a){var b,d=a.data.instances,e;for(e in d)if(d.hasOwnProperty(e)){var g=d[e].instance;g.destroy&&g.destroy();g.update&&(b=this.instancesWithUpdate.indexOf(g),0<=b&&this.instancesWithUpdate.splice(b,1));g.fixedUpdate&&(b=this.instancesWithFixedUpdate.indexOf(g),0<=b&&this.instancesWithFixedUpdate.splice(b,1));g.postUpdate&&(b=this.instancesWithPostUpdate.indexOf(g),0<=b&&this.instancesWithPostUpdate.splice(b,
1));g.toolsUpdate&&(b=this.instancesWithToolsUpdate.indexOf(g),0<=b&&this.instancesWithToolsUpdate.splice(b,1));a.instances[e].instance===a[e]&&delete a[e];delete a.instances[e]}},_postInitializeScriptComponent:function(a){this._callInstancesMethod(a,"postInitialize");a.data.postInitialized=!0},_updateInstances:function(a,b,d){for(var e,g=0,f=b.length;g<f;g++)(e=b[g])&&(e.entity&&e.entity.enabled&&e.entity.script.enabled)&&e[a].call(e,d)},onUpdate:function(a){this._updateInstances("update",this.instancesWithUpdate,
a)},onFixedUpdate:function(a){this._updateInstances("fixedUpdate",this.instancesWithFixedUpdate,a)},onPostUpdate:function(a){this._updateInstances("postUpdate",this.instancesWithPostUpdate,a)},onToolsUpdate:function(a){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,a)},broadcast:function(a,b){console.warn("DEPRECATED: ScriptComponentSystem.broadcast() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");var d=
pc.makeArray(arguments).slice(2),e,g,f,k=this.store;for(e in k)k.hasOwnProperty(e)&&(g=k[e].data,g.instances[a]&&(f=g.instances[a].instance[b])&&f.apply(g.instances[a].instance,d))},_preRegisterInstance:function(a,b,d,e){if(a.script){a.script.data._instances=a.script.data._instances||{};if(a.script.data._instances[d])throw Error(pc.string.format("Script name collision '{0}'. Scripts from '{1}' and '{2}' {{3}}",d,b,a.script.data._instances[d].url,a.getGuid()));a.script.data._instances[d]={url:b,name:d,
instance:e}}},_registerInstances:function(a){var b,d,e;if(a.script&&a.script.data._instances){a.script.instances=a.script.data._instances;for(e in a.script.instances){b=a.script.instances[e];d=b.instance;pc.events.attach(d);d.update&&this.instancesWithUpdate.push(d);d.fixedUpdate&&this.instancesWithFixedUpdate.push(d);d.postUpdate&&this.instancesWithPostUpdate.push(d);d.toolsUpdate&&this.instancesWithToolsUpdate.push(d);a.script.scripts&&this._createAccessors(a,b);if(a.script[e])throw Error(pc.string.format("Script with name '{0}' is already attached to Script Component",
e));a.script[e]=d}delete a.script.data._instances}a=a.getChildren();d=a.length;for(b=0;b<d;b++)a[b]instanceof pc.Entity&&this._registerInstances(a[b])},_cloneAttributes:function(a){var b={},d;for(d in a)if(a.hasOwnProperty(d))if("entity"!==a[d].type)b[d]=pc.extend({},a[d]);else{var e=a[d].value;delete a[d].value;b[d]=pc.extend({},a[d]);b[d].value=e;a[d].value=e}return b},_createAccessors:function(a,b){var d,e=a.script.scripts.length,g=b.url;for(d=0;d<e;d++){var f=a.script.scripts[d];if(f.url===g){d=
f.attributes;if(f.name&&d){for(var k in d)d.hasOwnProperty(k)&&this._createAccessor(d[k],b);a.script.data.attributes[f.name]=this._cloneAttributes(d)}break}}},_createAccessor:function(a,b){var d=this,a={name:a.name,value:a.value,type:a.type};d._convertAttributeValue(a);Object.defineProperty(b.instance,a.name,{get:function(){return a.value},set:function(e){var g=a.value;a.value=e;d._convertAttributeValue(a);b.instance.fire("set",a.name,g,a.value)},configurable:!0})},_updateAccessors:function(a,b){var d,
e=a.script.scripts.length,g,f=b.url,k,m;for(d=0;d<e;d++)if(k=a.script,m=k.scripts[d],m.url===f){d=m.name;m=m.attributes;if(d){if(m)for(g in m)m.hasOwnProperty(g)&&this._createAccessor(m[g],b);if(e=k.data.attributes[d])for(g in e)if(f=e[g],g in m){if(m[g].value!==f.value&&b.instance.onAttributeChanged)b.instance.onAttributeChanged(f.name,f.value,m[g].value)}else delete b.instance[f.name];m?k.data.attributes[d]=this._cloneAttributes(m):delete k.data.attributes[d]}break}},_convertAttributeValue:function(a){if("rgb"===
a.type||"rgba"===a.type)"array"===pc.type(a.value)&&(a.value=3===a.value.length?new pc.Color(a.value[0],a.value[1],a.value[2]):new pc.Color(a.value[0],a.value[1],a.value[2],a.value[3]));else if("vec2"===a.type)"array"===pc.type(a.value)&&(a.value=new pc.Vec2(a.value[0],a.value[1]));else if("vec3"===a.type||"vector"===a.type)"array"===pc.type(a.value)&&(a.value=new pc.Vec3(a.value[0],a.value[1],a.value[2]));else if("vec4"===a.type)"array"===pc.type(a.value)&&(a.value=new pc.Vec4(a.value[0],a.value[1],
a.value[2],a.value[3]));else if("entity"===a.type)null!==a.value&&"string"===typeof a.value&&(a.value=this.app.root.findByGuid(a.value));else if("curve"===a.type||"colorcurve"===a.type)a.value=new (a.value.keys[0]instanceof Array?pc.CurveSet:pc.Curve)(a.value.keys),a.value.type=a.value.type}});return{ScriptComponentSystem:f}}());pc.extend(pc,function(){var f=function(){this.on("set_scripts",this.onSetScripts,this)},f=pc.inherits(f,pc.Component);pc.extend(f.prototype,{send:function(a,b){console.warn("DEPRECATED: ScriptComponent.send() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");var d=pc.makeArray(arguments).slice(2),e=this.entity.script.instances,g;if(e&&e[a]&&(g=e[a].instance[b]))return g.apply(e[a].instance,d)},onEnable:function(){f._super.onEnable.call(this);
this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))},onDisable:function(){f._super.onDisable.call(this);this.system._disableScriptComponent(this)},onSetScripts:function(a,b,d){if((!this.system._inTools||this.runInTools)&&!this._updateScriptAttributes(b,d))this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),
this.data.areScriptsLoaded=!1,a=d.map(function(a){return a.url}),this._loadFromCache(a)||this._loadScripts(a)},_updateScriptAttributes:function(a,b){var d=!0;if(a.length!==b.length)d=!1;else{var e;len=b.length;for(e=0;e<len;e++)if(a[e].url!==b[e].url){d=!1;break}}if(d)for(var g in this.instances)this.instances.hasOwnProperty(g)&&this.system._updateAccessors(this.entity,this.instances[g]);return d},_loadFromCache:function(a){var b,d,e=[],g=this.system._prefix||"",f=/^http(s)?:\/\//i;b=0;for(d=a.length;b<
d;b++){var k=a[b];f.test(k)||(k=pc.path.join(g,k));if(k=this.system.app.loader.getFromCache(k,"script"))e.push(k);else return!1}b=0;for(d=e.length;b<d;b++)g=e[b],!0!==g&&(g&&this.entity.script&&!this.entity.script.instances[g._pcScriptName])&&(f=new g(this.entity),this.system._preRegisterInstance(this.entity,a[b],g._pcScriptName,f));this.data&&(this.data.areScriptsLoaded=!0);this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity));return!0},_loadScripts:function(a){var b=
a.length,d=this.system._prefix||"";a.forEach(function(a){var g=null,f=null;a.toLowerCase().startsWith("http://")||a.toLowerCase().startsWith("https://")?g=f=a:(f=a,g=pc.path.join(d,a));this.system.app.loader.load(g,"script",function(a,d){b--;if(a)console.error(a);else if(d&&this.entity.script&&!this.entity.script.instances[d._pcScriptName]){var e=new d(this.entity);this.system._preRegisterInstance(this.entity,f,d._pcScriptName,e)}0===b&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),
this.system.onPostInitialize(this.entity)))}.bind(this))}.bind(this))}});return{ScriptComponent:f}}());pc.extend(pc,function(){var f;f=pc.inherits(function(){this.scripts=[];this.enabled=!0;this.instances={};this._instances={};this.runInTools=!1;this.attributes={};this.areScriptsLoaded=this.postInitialized=this.initialized=!1},pc.ComponentData);return{ScriptComponentData:f}}());pc.extend(pc,{DISTANCE_LINEAR:"linear",DISTANCE_INVERSE:"inverse",DISTANCE_EXPONENTIAL:"exponential"});pc.extend(pc,function(){var f=function(a,b,d){d=d||{};this._component=a;this._assets=a.system.app.assets;this._manager=a.system.manager;this._name=b||"Untitled";this._volume=void 0!==d.volume?pc.math.clamp(Number(d.volume)||0,0,1):1;this._pitch=void 0!==d.pitch?Math.max(0.01,Number(d.pitch)||0):1;this._loop=!!(void 0!==d.loop&&d.loop);this._duration=0<d.duration?d.duration:null;this._startTime=Math.max(0,Number(d.startTime)||0);this._overlap=!!d.overlap;this._autoPlay=!!d.autoPlay;this._lastNode=
this._firstNode=null;this._asset=d.asset;this._asset instanceof pc.Asset&&(this._asset=this._asset.id);this.instances=[];pc.events.attach(this)};f.prototype={play:function(){!this.overlap&&(this.isPlaying||this.isPaused)&&this.stop();var a=this._createInstance();this.instances.push(a);if(this.isLoaded)a.play();else{var b=function(b,e){a.sound=e;a._playWhenLoaded&&a.play()};this.off("load",b);this.once("load",b);this.load()}this.fire("play",this,a);return a},pause:function(){for(var a=!1,b=this.instances,
d=0,e=b.length;d<e;d++)b[d].pause()&&(a=!0);a&&this.fire("pause",this);return a},resume:function(){for(var a=!1,b=this.instances,d=0,e=b.length;d<e;d++)b[d].resume()&&(a=!0);a&&this.fire("resume",this);return a},stop:function(){for(var a=!1,b=this.instances,d=0,e=b.length;d<e;d++)b[d].stop()&&(a=!0);b.length=0;a&&this.fire("stop",this);return a},load:function(){if(this._hasAsset()){var a=this._assets.get(this._asset);a?(a.off("remove",this._onAssetRemoved,this),a.on("remove",this._onAssetRemoved,
this),a.resource?this.fire("load",this,a.resource):(a.off("load",this._onAssetLoad,this),a.once("load",this._onAssetLoad,this),this._assets.load(a))):(this._assets.off("add:"+this._asset,this._onAssetAdd,this),this._assets.once("add:"+this._asset,this._onAssetAdd,this))}},setExternalNodes:function(a,b){if(a){if(b||(b=a),this._firstNode=a,this._lastNode=b,!this._overlap)for(var d=this.instances,e=0,g=d.length;e<g;e++)d[e].setExternalNodes(a,b)}else logError("The firstNode must have a valid AudioNode")},
clearExternalNodes:function(){this._lastNode=this._firstNode=null;if(!this._overlap)for(var a=this.instances,b=0,d=a.length;b<d;b++)a[b].clearExternalNodes()},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_hasAsset:function(){return null!=this._asset},_createInstance:function(){var a=null,a=this._component,b=null;if(this._hasAsset()){var d=this._assets.get(this._asset);d&&(b=d.resource)}d={volume:this._volume*a.volume,pitch:this._pitch*a.pitch,loop:this._loop,startTime:this._startTime,
duration:this._duration};a.positional?(d.position=a.entity.getPosition(),d.maxDistance=a.maxDistance,d.refDistance=a.refDistance,d.rollOffFactor=a.rollOffFactor,d.distanceModel=a.distanceModel,a=new pc.SoundInstance3d(this._manager,b,d)):a=new pc.SoundInstance(this._manager,b,d);a.once("end",this._onInstanceEnd,this);this._firstNode&&a.setExternalNodes(this._firstNode,this._lastNode);return a},_onInstanceEnd:function(a){a=this.instances.indexOf(a);-1!==a&&this.instances.splice(a,1)},_onAssetAdd:function(){this.load()},
_onAssetLoad:function(){this.load()},_onAssetRemoved:function(a){a.off("remove",this._onAssetRemoved,this);this._assets.off("add:"+a.id,this._onAssetAdd,this);this.stop()},updatePosition:function(a){for(var b=this.instances,d=0,e=b.length;d<e;d++)b[d].position=a}};Object.defineProperty(f.prototype,"name",{get:function(){return this._name},set:function(a){this._name=a}});Object.defineProperty(f.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=pc.math.clamp(Number(a)||
0,0,1);if(!this._overlap)for(var a=this.instances,b=0,d=a.length;b<d;b++)a[b].volume=this._volume*this._component.volume}});Object.defineProperty(f.prototype,"pitch",{get:function(){return this._pitch},set:function(a){this._pitch=Math.max(Number(a)||0,0.01);if(!this._overlap)for(var a=this.instances,b=0,d=a.length;b<d;b++)a[b].pitch=this.pitch*this._component.pitch}});Object.defineProperty(f.prototype,"loop",{get:function(){return this._loop},set:function(a){this._loop=!!a;for(var a=this.instances,
b=0,d=a.length;b<d;b++)a[b].loop=this._loop}});Object.defineProperty(f.prototype,"autoPlay",{get:function(){return this._autoPlay},set:function(a){this._autoPlay=!!a}});Object.defineProperty(f.prototype,"overlap",{get:function(){return this._overlap},set:function(a){this._overlap=!!a}});Object.defineProperty(f.prototype,"startTime",{get:function(){return this._startTime},set:function(a){this._startTime=Math.max(0,Number(a)||0);if(!this._overlap)for(var a=this.instances,b=0,d=a.length;b<d;b++)a[b].startTime=
this._startTime}});Object.defineProperty(f.prototype,"duration",{get:function(){var a=0;this._hasAsset()&&(a=this._assets.get(this._asset),a=a.resource?a.resource.duration:0);return null!=this._duration?this._duration%(a||1):a},set:function(a){this._duration=Math.max(0,Number(a)||0)||null;if(!this._overlap)for(var a=this.instances,b=0,d=a.length;b<d;b++)a[b].duration=this._duration}});Object.defineProperty(f.prototype,"asset",{get:function(){return this._asset},set:function(a){var b=this._asset;b&&
(this._assets.off("add:"+b,this._onAssetAdd,this),(b=this._assets.get(b))&&b.off("remove",this._onAssetRemoved,this));this._asset=a;this._asset instanceof pc.Asset&&(this._asset=this._asset.id);this._hasAsset()&&(this._component.enabled&&this._component.entity.enabled)&&this.load()}});Object.defineProperty(f.prototype,"isLoaded",{get:function(){if(this._hasAsset()){var a=this._assets.get(this._asset);if(a)return!!a.resource}return!1}});Object.defineProperty(f.prototype,"isPlaying",{get:function(){for(var a=
this.instances,b=0,d=a.length;b<d;b++)if(a[b].isPlaying)return!0;return!1}});Object.defineProperty(f.prototype,"isPaused",{get:function(){var a=this.instances,b=a.length;if(0===b)return!1;for(var d=0;d<b;d++)if(!a[d].isPaused)return!1;return!0}});Object.defineProperty(f.prototype,"isStopped",{get:function(){for(var a=this.instances,b=0,d=a.length;b<d;b++)if(!a[b].isStopped)return!1;return!0}});return{SoundSlot:f}}());pc.extend(pc,function(){var f=function(a,b){this.id="sound";this.description="Allows an Entity to play sounds";a.systems.add(this.id,this);this.ComponentType=pc.SoundComponent;this.DataType=pc.SoundComponentData;this.schema="enabled volume pitch positional refDistance maxDistance rollOffFactor distanceModel slots".split(" ");this.manager=b;pc.ComponentSystem.on("update",this.onUpdate,this);this.on("beforeremove",this.onBeforeRemove,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,
{initializeComponentData:function(a,b,d){d="volume pitch positional refDistance maxDistance rollOffFactor distanceModel slots enabled".split(" ");f._super.initializeComponentData.call(this,a,b,d)},cloneComponent:function(a,b){var d=a.sound.data,e={},g;for(g in d)d.hasOwnProperty(g)&&(e[g]=d[g]);e.slots={};for(g in d.slots){var f=d.slots[g];e.slots[g]=f instanceof pc.SoundSlot?{name:f.name,volume:f.volume,pitch:f.pitch,loop:f.loop,duration:f.duration,startTime:f.startTime,overlap:f.overlap,autoPlay:f.autoPlay,
asset:f.asset}:f}e.playingBeforeDisable={};return this.addComponent(b,e)},onUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var d=a[b],e=d.entity,d=d.data;if(d.enabled&&e.enabled&&d.positional){var e=e.getPosition(),d=d.slots,g;for(g in d)d[g].updatePosition(e)}}},onBeforeRemove:function(a,b){var d=b.slots,e;for(e in d)d[e].overlap||d[e].stop()}});Object.defineProperty(f.prototype,"volume",{get:function(){return this.manager.volume},set:function(a){this.manager.volume=a}});
Object.defineProperty(f.prototype,"context",{get:function(){return!pc.SoundManager.hasAudioContext()?(console.warn("WARNING: Audio context is not supported on this browser"),null):this.manager.context}});return{SoundComponentSystem:f}}());pc.extend(pc,function(){var f=function(){this.on("set_slots",this.onSetSlots,this);this.on("set_volume",this.onSetVolume,this);this.on("set_pitch",this.onSetPitch,this);this.on("set_refDistance",this.onSetRefDistance,this);this.on("set_maxDistance",this.onSetMaxDistance,this);this.on("set_rollOffFactor",this.onSetRollOffFactor,this);this.on("set_distanceModel",this.onSetDistanceModel,this);this.on("set_positional",this.onSetPositional,this)},f=pc.inherits(f,pc.Component);pc.extend(f.prototype,{onSetSlots:function(a,
b,d){if(b)for(var e in b)b[e].stop();a={};for(e in d)d[e]instanceof pc.SoundSlot?a[d[e].name]=d[e]:d[e].name&&(a[d[e].name]=new pc.SoundSlot(this,d[e].name,d[e]));this.data.slots=a;if(this.enabled&&this.entity.enabled)this.onEnable()},onSetVolume:function(a,b,d){var a=this.data.slots,e;for(e in a)if(b=a[e],!b.overlap)for(var g=b.instances,f=0,k=g.length;f<k;f++)g[f].volume=b.volume*d},onSetPitch:function(a,b,d){var a=this.data.slots,e;for(e in a)if(b=a[e],!b.overlap)for(var g=b.instances,f=0,k=g.length;f<
k;f++)g[f].pitch=b.pitch*d},onSetRefDistance:function(a,b,d){var a=this.data.slots,e;for(e in a)if(b=a[e],!b.overlap)for(var b=b.instances,g=0,f=b.length;g<f;g++)b[g].refDistance=d},onSetMaxDistance:function(a,b,d){var a=this.data.slots,e;for(e in a)if(b=a[e],!b.overlap)for(var b=b.instances,g=0,f=b.length;g<f;g++)b[g].maxDistance=d},onSetRollOffFactor:function(a,b,d){var a=this.data.slots,e;for(e in a)if(b=a[e],!b.overlap)for(var b=b.instances,g=0,f=b.length;g<f;g++)b[g].rollOffFactor=d},onSetDistanceModel:function(a,
b,d){var a=this.data.slots,e;for(e in a)if(b=a[e],!b.overlap)for(var b=b.instances,f=0,h=b.length;f<h;f++)b[f].distanceModel=d},onSetPositional:function(){var a=this.data.slots,b;for(b in a){var d=a[b];if(!d.overlap)for(var e=d.instances,f=0,h=e.length;f<h;f++){var k=e[f].isPlaying||e[f].isSuspended,m=e[f].currentTime;k&&e[f].stop();e[f]=d._createInstance();k&&(e[f].play(),e[f].currentTime=m)}}},onEnable:function(){f._super.onEnable.call(this);if(!this.system._inTools){var a=this.data.slots,b=this.data.playingBeforeDisable,
d;for(d in a){var e=a[d];e.autoPlay&&e.isStopped?e.play():b[d]?e.resume():e.isLoaded||e.load()}}},onDisable:function(){f._super.onDisable.call(this);var a=this.data.slots,b={},d;for(d in a)!a[d].overlap&&a[d].isPlaying&&(a[d].pause(),b[d]=!0);this.data.playingBeforeDisable=b},addSlot:function(a,b){var d=this.data.slots;if(d[a])return logWARNING("A sound slot with name "+a+" already exists on Entity "+this.entity.getPath()),null;var e=new pc.SoundSlot(this,a,b);d[a]=e;e.autoPlay&&(this.enabled&&this.entity.enabled)&&
e.play();return e},removeSlot:function(a){var b=this.data.slots;b[a]&&(b[a].stop(),delete b[a])},slot:function(a){return this.data.slots[a]},play:function(a){if(!this.enabled||!this.entity.enabled)return null;var b=this.slots[a];if(!b)return logWARNING("Trying to play sound slot with name "+a+" which does not exist"),null;a=b.play();this.fire("play",this,b,a);return a},pause:function(a){var b;b=this.data.slots;if(a)(b=b[a])?(b.pause(),this.fire("pause",this,b)):logWARNING("Trying to pause sound slot with name "+
a+" which does not exist");else{for(var d in b)b[d].pause();this.fire("pause",this)}},resume:function(a){var b;b=this.data.slots;if(a)(b=b[a])?b.isPaused&&b.resume()&&this.fire("resume",this,b):logWARNING("Trying to resume sound slot with name "+a+" which does not exist");else{for(var d in b)b[d].resume();this.fire("resume",this)}},stop:function(a){var b;b=this.data.slots;if(a)(b=b[a])?b.stop()&&this.fire("stop",this,b):logWARNING("Trying to stop sound slot with name "+a+" which does not exist");
else{for(var d in b)b[d].stop();this.fire("stop",this)}}});return{SoundComponent:f}}());pc.SoundComponentData=function(){this.enabled=!0;this.pitch=this.volume=1;this.positional=!0;this.refDistance=1;this.maxDistance=1E4;this.rollOffFactor=1;this.distanceModel=pc.DISTANCE_LINEAR;this.slots={};this.playingBeforeDisable={}};pc.extend(pc,function(){var f=function(a,b){this.id="audiosource";this.description="Specifies audio assets that can be played at the position of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.AudioSourceComponent;this.DataType=pc.AudioSourceComponentData;this.schema="enabled assets volume pitch loop activate 3d minDistance maxDistance rollOffFactor distanceModel sources currentSource channel".split(" ");this.manager=b;this.initialized=!1;pc.ComponentSystem.on("initialize",this.onInitialize,
this);pc.ComponentSystem.on("update",this.onUpdate,this);this.on("remove",this.onRemove,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,{initializeComponentData:function(a,b,d){d="activate volume pitch loop 3d minDistance maxDistance rollOffFactor distanceModel enabled assets".split(" ");f._super.initializeComponentData.call(this,a,b,d);a.paused=!(a.enabled&&a.activate)},onInitialize:function(a){a.audiosource&&(a.enabled&&a.audiosource.enabled&&a.audiosource.activate)&&a.audiosource.play(a.audiosource.currentSource);
var a=a.getChildren(),b,d=a.length;for(b=0;b<d;b++)if(a[b]instanceof pc.Entity)this.onInitialize(a[b]);this.initialized=!0},onUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var d=a[b],e=d.entity,d=d.data;d.enabled&&(e.enabled&&d.channel instanceof pc.Channel3d)&&(e=e.getPosition(),d.channel.setPosition(e))}},onRemove:function(a,b){b.channel&&(b.channel.stop(),b.channel=null)},setVolume:function(a){this.manager.setVolume(a)}});return{AudioSourceComponentSystem:f}}());pc.extend(pc,function(){var f=function(){this.on("set_assets",this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this);this.on("set_volume",this.onSetVolume,this);this.on("set_pitch",this.onSetPitch,this);this.on("set_minDistance",this.onSetMinDistance,this);this.on("set_maxDistance",this.onSetMaxDistance,this);this.on("set_rollOffFactor",this.onSetRollOffFactor,this);this.on("set_distanceModel",this.onSetDistanceModel,this);this.on("set_3d",this.onSet3d,this)},f=pc.inherits(f,pc.Component);
pc.extend(f.prototype,{play:function(a){if(this.enabled&&this.entity.enabled){this.channel&&this.stop();var b,d=this.data;d.sources[a]&&(d["3d"]?(b=this.entity.getPosition(),b=this.system.manager.playSound3d(d.sources[a],b,d)):b=this.system.manager.playSound(d.sources[a],d),d.currentSource=a,d.channel=b)}},pause:function(){this.channel&&this.channel.pause()},unpause:function(){this.channel&&this.channel.paused&&this.channel.unpause()},stop:function(){this.channel&&(this.channel.stop(),this.channel=
null)},onSetAssets:function(a,b,d){var a=[],e,f=d.length;if(b&&b.length)for(e=0;e<b.length;e++)if(b[e]){var h=this.system.app.assets.get(b[e]);h&&(h.off("change",this.onAssetChanged,this),h.off("remove",this.onAssetRemoved,this),this.currentSource===h.name&&this.stop())}if(f)for(e=0;e<f;e++)0>b.indexOf(d[e])&&(d[e]instanceof pc.Asset?a.push(d[e].id):a.push(d[e]));!this.system._inTools&&a.length&&this.loadAudioSourceAssets(a)},onAssetChanged:function(a,b,d){"resource"===b&&this.data.sources&&(this.data.sources[a.name]=
d,this.data.currentSource===a.name&&this.channel&&(this.channel.paused?(this.play(a.name),this.pause()):this.play(a.name)))},onAssetRemoved:function(a){a.off("remove",this.onAssetRemoved,this);this.data.sources[a.name]&&(delete this.data.sources[a.name],this.data.currentSource===a.name&&(this.stop(),this.data.currentSource=null))},onSetLoop:function(a,b,d){b!=d&&this.channel&&this.channel.setLoop(d)},onSetVolume:function(a,b,d){b!=d&&this.channel&&this.channel.setVolume(d)},onSetPitch:function(a,
b,d){b!=d&&this.channel&&this.channel.setPitch(d)},onSetMaxDistance:function(a,b,d){b!=d&&this.channel instanceof pc.Channel3d&&this.channel.setMaxDistance(d)},onSetMinDistance:function(a,b,d){b!=d&&this.channel instanceof pc.Channel3d&&this.channel.setMinDistance(d)},onSetRollOffFactor:function(a,b,d){b!=d&&this.channel instanceof pc.Channel3d&&this.channel.setRollOffFactor(d)},onSetDistanceModel:function(a,b,d){b!==d&&this.channel instanceof pc.Channel3d&&this.channel.setDistanceModel(d)},onSet3d:function(a,
b,d){b!==d&&(this.system.initialized&&this.currentSource)&&(b=a=!1,this.channel&&(a=this.channel.paused,b=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=a,this.channel.suspended=b))},onEnable:function(){f._super.onEnable.call(this);var a=this.data.assets;if(a)for(var b=this.system.app.assets,d=0,e=a.length;d<e;d++){var g=a[d];g instanceof pc.Asset||(g=b.get(g));g&&!g.resource&&b.load(g)}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):
this.unpause())},onDisable:function(){f._super.onDisable.call(this);this.pause()},loadAudioSourceAssets:function(a){var b=this,d=a.map(function(a){return this.system.app.assets.get(a)},this),e={},f=null,h=d.length,k=function(){h--},m=function(){this.data.sources=e;this.data.currentSource=f;if(this.enabled&&this.activate&&f)this.onEnable()}.bind(this);d.forEach(function(d,u){d?(f=f||d.name,d.off("change",this.onAssetChanged,this),d.on("change",this.onAssetChanged,this),d.off("remove",this.onAssetRemoved,
this),d.on("remove",this.onAssetRemoved,this),d.off("error",k,this),d.on("error",k,this),d.ready(function(a){e[a.name]=a.resource;h--;0===h&&m()}),!d.resource&&(b.enabled&&b.entity.enabled)&&this.system.app.assets.load(d)):(h--,0===h&&m(),this.system.app.assets.on("add:"+a[u],function(a){a.ready(function(a){b.data.sources[a.name]=a.resource});a.resource||b.system.app.assets.load(a)}))},this)}});return{AudioSourceComponent:f}}());pc.AudioSourceComponentData=function(){this.enabled=!0;this.assets=[];this.activate=!0;this.pitch=this.volume=1;this.loop=!1;this["3d"]=!0;this.minDistance=1;this.maxDistance=1E4;this.rollOffFactor=1;this.distanceModel=pc.DISTANCE_INVERSE;this.paused=!0;this.sources={};this.channel=this.currentSource=null};pc.extend(pc,function(){var f=function(a,b){this.id="audiolistener";this.description="Specifies the location of the listener for 3D audio playback.";a.systems.add(this.id,this);this.ComponentType=pc.AudioListenerComponent;this.DataType=pc.AudioListenerComponentData;this.schema=["enabled"];this.manager=b;this.current=null;pc.ComponentSystem.on("update",this.onUpdate,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,{initializeComponentData:function(a,b,d){d=["enabled"];f._super.initializeComponentData.call(this,
a,b,d)},onUpdate:function(){if(this.current){var a=this.current.getPosition();this.manager.listener.setPosition(a);a=this.current.getWorldTransform();this.manager.listener.setOrientation(a)}}});return{AudioListenerComponentSystem:f}}());pc.extend(pc,function(){var f=function(){},f=pc.inherits(f,pc.Component);pc.extend(f.prototype,{setCurrentListener:function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var a=this.system.current.getPosition();this.system.manager.listener.setPosition(a)}},onEnable:function(){f._super.onEnable.call(this);this.setCurrentListener()},onDisable:function(){f._super.onDisable.call(this);this.system.current===this.entity&&(this.system.current=null)}});
return{AudioListenerComponent:f}}());pc.extend(pc,function(){var f;f=pc.inherits(function(){this.enabled=!0},pc.ComponentData);return{AudioListenerComponentData:f}}());pc.extend(pc,{BODYTYPE_STATIC:"static",BODYTYPE_DYNAMIC:"dynamic",BODYTYPE_KINEMATIC:"kinematic",BODYFLAG_STATIC_OBJECT:1,BODYFLAG_KINEMATIC_OBJECT:2,BODYFLAG_NORESPONSE_OBJECT:4,BODYSTATE_ACTIVE_TAG:1,BODYSTATE_ISLAND_SLEEPING:2,BODYSTATE_WANTS_DEACTIVATION:3,BODYSTATE_DISABLE_DEACTIVATION:4,BODYSTATE_DISABLE_SIMULATION:5,BODYGROUP_NONE:0,BODYGROUP_DEFAULT:1,BODYGROUP_DYNAMIC:1,BODYGROUP_STATIC:2,BODYGROUP_KINEMATIC:4,BODYGROUP_ENGINE_1:8,BODYGROUP_TRIGGER:16,BODYGROUP_ENGINE_2:32,BODYGROUP_ENGINE_3:64,
BODYGROUP_USER_1:128,BODYGROUP_USER_2:256,BODYGROUP_USER_3:512,BODYGROUP_USER_4:1024,BODYGROUP_USER_5:2048,BODYGROUP_USER_6:4096,BODYGROUP_USER_7:8192,BODYGROUP_USER_8:16384,BODYMASK_NONE:0,BODYMASK_ALL:65535,BODYMASK_STATIC:2,BODYMASK_NOT_STATIC:65533,BODYMASK_NOT_STATIC_KINEMATIC:65529});pc.extend(pc,function(){new pc.Mat4;new pc.Mat4;new pc.Vec3;new pc.Vec3;new pc.Vec3;var f,a,b={},d={},e=function(a,b,d){this.entity=a;this.point=b;this.normal=d},g=function(a,b,d){0===arguments.length?(this.b=this.a=null,this.localPointA=new pc.Vec3,this.localPointB=new pc.Vec3,this.pointA=new pc.Vec3,this.pointB=new pc.Vec3,this.normal=new pc.Vec3):(this.a=a,this.b=b,this.localPointA=d.localPoint,this.localPointB=d.localPointOther,this.pointA=d.point,this.pointB=d.pointOther,this.normal=d.normal)},
h=function(a,b,d,e,f){0===arguments.length?(this.localPoint=new pc.Vec3,this.localPointOther=new pc.Vec3,this.point=new pc.Vec3,this.pointOther=new pc.Vec3,this.normal=new pc.Vec3):(this.localPoint=a,this.localPointOther=b,this.point=d,this.pointOther=e,this.normal=f)},k=function(a,b){this.other=a;this.contacts=b},m=function(a){this.id="rigidbody";this.description="Adds the entity to the scene's physical simulation.";a.systems.add(this.id,this);this._stats=a.stats.frame;this.ComponentType=pc.RigidBodyComponent;
this.DataType=pc.RigidBodyComponentData;this.contactPointPool=new pc.AllocatePool(h,1);this.contactResultPool=new pc.AllocatePool(k,1);this.singleContactResultPool=new pc.AllocatePool(g,1);this.schema="enabled type mass linearDamping angularDamping linearFactor angularFactor friction restitution group mask body".split(" ");this.maxSubSteps=10;this.fixedTimeStep=1/60;this.on("remove",this.onRemove,this)},m=pc.inherits(m,pc.ComponentSystem);pc.extend(m.prototype,{onLibraryLoaded:function(){if("undefined"!==
typeof Ammo){var b=new Ammo.btDefaultCollisionConfiguration,d=new Ammo.btCollisionDispatcher(b),e=new Ammo.btDbvtBroadphase,g=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(d,e,g,b);this._ammoGravity=new Ammo.btVector3(0,-9.82,0);this.dynamicsWorld.setGravity(this._ammoGravity);f=new Ammo.btVector3;a=new Ammo.btVector3;pc.ComponentSystem.on("update",this.onUpdate,this)}else pc.ComponentSystem.off("update",this.onUpdate,this)},initializeComponentData:function(a,
b,d){var d="enabled mass linearDamping angularDamping linearFactor angularFactor friction restitution type group mask".split(" "),e={};d.forEach(function(a){e[a]=b[a]});b.bodyType&&(e.type=b.bodyType,console.warn("WARNING: rigidbody.bodyType: Property is deprecated. Use type instead."));e.linearFactor&&"array"===pc.type(e.linearFactor)&&(e.linearFactor=new pc.Vec3(e.linearFactor[0],e.linearFactor[1],e.linearFactor[2]));e.angularFactor&&"array"===pc.type(e.angularFactor)&&(e.angularFactor=new pc.Vec3(e.angularFactor[0],
e.angularFactor[1],e.angularFactor[2]));m._super.initializeComponentData.call(this,a,e,d)},cloneComponent:function(a,b){this.addComponent(b,{enabled:a.rigidbody.enabled,mass:a.rigidbody.mass,linearDamping:a.rigidbody.linearDamping,angularDamping:a.rigidbody.angularDamping,linearFactor:[a.rigidbody.linearFactor.x,a.rigidbody.linearFactor.y,a.rigidbody.linearFactor.z],angularFactor:[a.rigidbody.angularFactor.x,a.rigidbody.angularFactor.y,a.rigidbody.angularFactor.z],friction:a.rigidbody.friction,restitution:a.rigidbody.restitution,
type:a.rigidbody.type,group:a.rigidbody.group,mask:a.rigidbody.mask})},onRemove:function(a,b){b.body&&(this.removeBody(b.body),Ammo.destroy(b.body));b.body=null},addBody:function(a,b,d){void 0!==b&&void 0!==d?this.dynamicsWorld.addRigidBody(a,b,d):this.dynamicsWorld.addRigidBody(a);return a},removeBody:function(a){this.dynamicsWorld.removeRigidBody(a)},addConstraint:function(a){this.dynamicsWorld.addConstraint(a);return a},removeConstraint:function(a){this.dynamicsWorld.removeConstraint(a)},setGravity:function(){var a,
b,d;1===arguments.length?(a=arguments[0].x,b=arguments[0].y,d=arguments[0].z):(a=arguments[0],b=arguments[1],d=arguments[2]);this._ammoGravity.setValue(a,b,d);this.dynamicsWorld.setGravity(this._ammoGravity)},raycastFirst:function(b,d,g){f.setValue(b.x,b.y,b.z);a.setValue(d.x,d.y,d.z);b=new Ammo.ClosestRayResultCallback(f,a);this.dynamicsWorld.rayTest(f,a,b);if(b.hasHit()){var d=b.get_m_collisionObject(),d=Ammo.castObject(d,Ammo.btRigidBody),h=b.get_m_hitPointWorld(),k=b.get_m_hitNormalWorld();d&&
g(new e(d.entity,new pc.Vec3(h.x(),h.y(),h.z()),new pc.Vec3(k.x(),k.y(),k.z())))}Ammo.destroy(b)},_storeCollision:function(a,e){var f=!1,g=a.getGuid();b[g]=b[g]||{others:[],entity:a};0>b[g].others.indexOf(e)&&(b[g].others.push(e),f=!0);d[g]=d[g]||{others:[],entity:a};d[g].others.push(e);return f},_createContactPointFromAmmo:function(a){var b=this.contactPointPool.allocate();b.localPoint.set(a.get_m_localPointA().x(),a.get_m_localPointA().y(),a.get_m_localPointA().z());b.localPointOther.set(a.get_m_localPointB().x(),
a.get_m_localPointB().y(),a.get_m_localPointB().z());b.point.set(a.getPositionWorldOnA().x(),a.getPositionWorldOnA().y(),a.getPositionWorldOnA().z());b.pointOther.set(a.getPositionWorldOnB().x(),a.getPositionWorldOnB().y(),a.getPositionWorldOnB().z());b.normal.set(a.get_m_normalWorldOnB().x(),a.get_m_normalWorldOnB().y(),a.get_m_normalWorldOnB().z());return b},_createReverseContactPointFromAmmo:function(a){var b=this.contactPointPool.allocate();b.localPointOther.set(a.get_m_localPointA().x(),a.get_m_localPointA().y(),
a.get_m_localPointA().z());b.localPoint.set(a.get_m_localPointB().x(),a.get_m_localPointB().y(),a.get_m_localPointB().z());b.pointOther.set(a.getPositionWorldOnA().x(),a.getPositionWorldOnA().y(),a.getPositionWorldOnA().z());b.point.set(a.getPositionWorldOnB().x(),a.getPositionWorldOnB().y(),a.getPositionWorldOnB().z());b.normal.set(a.get_m_normalWorldOnB().x(),a.get_m_normalWorldOnB().y(),a.get_m_normalWorldOnB().z());return b},_createSingleContactResult:function(a,b,d){var e=this.singleContactResultPool.allocate();
e.a=a;e.b=b;e.localPointA=d.localPoint;e.localPointB=d.localPointOther;e.pointA=d.point;e.pointB=d.pointOther;e.normal=d.normal;return e},_createContactResult:function(a,b){var d=this.contactResultPool.allocate();d.other=a;d.contacts=b;return d},_cleanOldCollisions:function(){for(var a in b)if(b.hasOwnProperty(a)){for(var e=b[a].entity,f=e.collision,g=b[a].others,h=g.length;h--;){var k=g[h];if(!d[a]||0>d[a].others.indexOf(k))g.splice(h,1),f&&k.collision&&(e.rigidbody&&k.rigidbody?f.fire("collisionend",
k):e.trigger&&f.fire("triggerleave",k))}0===g.length&&delete b[a]}},onUpdate:function(a){this._stats.physicsStart=pc.now();frameContacts=0;this.dynamicsWorld.stepSimulation(a,this.maxSubSteps,this.fixedTimeStep);var b=this.store,e;for(e in b)if(b.hasOwnProperty(e)){var f=b[e].entity,g=b[e].data;g.body&&(g.body.isActive()&&g.enabled&&f.enabled)&&(g.type===pc.BODYTYPE_DYNAMIC?f.rigidbody.syncBodyToEntity():g.type===pc.BODYTYPE_KINEMATIC&&f.rigidbody._updateKinematic(a))}var a=this.dynamicsWorld.getDispatcher(),
b=a.getNumManifolds(),h;d={};for(e=0;e<b;e++){var k=a.getManifoldByIndexInternal(e),m=k.getBody0(),x=k.getBody1(),f=Ammo.castObject(m,Ammo.btRigidBody),g=Ammo.castObject(x,Ammo.btRigidBody),f=f.entity,g=g.entity;if(f&&g){h=m.getCollisionFlags();var A=x.getCollisionFlags(),D=k.getNumContacts(),C=[],x=[],z;if(0<D)if(h&pc.BODYFLAG_NORESPONSE_OBJECT||A&pc.BODYFLAG_NORESPONSE_OBJECT)z=f.collision?f.collision.hasEvent("triggerenter")||f.collision.hasEvent("triggerleave"):!1,m=g.collision?g.collision.hasEvent("triggerenter")||
g.collision.hasEvent("triggerleave"):!1,z&&(k=this._storeCollision(f,g))&&f.collision&&!(A&pc.BODYFLAG_NORESPONSE_OBJECT)&&f.collision.fire("triggerenter",g),m&&(k=this._storeCollision(g,f))&&g.collision&&!(h&pc.BODYFLAG_NORESPONSE_OBJECT)&&g.collision.fire("triggerenter",f);else if(z=f.collision?f.collision.hasEvent("collisionstart")||f.collision.hasEvent("collisionend")||f.collision.hasEvent("contact"):!1,m=g.collision?g.collision.hasEvent("collisionstart")||g.collision.hasEvent("collisionend")||
g.collision.hasEvent("contact"):!1,(A=this.hasEvent("contact"))||z||m){for(h=0;h<D;h++){var E=k.getContactPoint(h),F=this._createContactPointFromAmmo(E),N=null;if(z||m)N=this._createReverseContactPointFromAmmo(E),C.push(F),x.push(N);A&&(E=this._createSingleContactResult(f,g,F),this.fire("contact",E))}z&&(D=this._createContactResult(g,C),f.collision&&f.collision.fire("contact",D),(k=this._storeCollision(f,g))&&f.collision&&f.collision.fire("collisionstart",D));m&&(x=this._createContactResult(f,x),
g.collision&&g.collision.fire("contact",x),(k=this._storeCollision(g,f))&&g.collision&&g.collision.fire("collisionstart",x))}}}this._cleanOldCollisions();this.contactPointPool.freeAll();this.contactResultPool.freeAll();this.singleContactResultPool.freeAll();this._stats.physicsTime=pc.now()-this._stats.physicsStart}});return{RIGIDBODY_TYPE_STATIC:"static",RIGIDBODY_TYPE_DYNAMIC:"dynamic",RIGIDBODY_TYPE_KINEMATIC:"kinematic",RIGIDBODY_CF_STATIC_OBJECT:1,RIGIDBODY_CF_KINEMATIC_OBJECT:2,RIGIDBODY_CF_NORESPONSE_OBJECT:4,
RIGIDBODY_ACTIVE_TAG:1,RIGIDBODY_ISLAND_SLEEPING:2,RIGIDBODY_WANTS_DEACTIVATION:3,RIGIDBODY_DISABLE_DEACTIVATION:4,RIGIDBODY_DISABLE_SIMULATION:5,RigidBodyComponentSystem:m}}());pc.extend(pc,function(){var f,a,b,d,e,g=function(){"undefined"!==typeof Ammo&&!f&&(f=new Ammo.btTransform,a=new Ammo.btVector3,b=new Ammo.btVector3,d=new Ammo.btQuaternion,e=new Ammo.btVector3(0,0,0));this.on("set_mass",this.onSetMass,this);this.on("set_linearDamping",this.onSetLinearDamping,this);this.on("set_angularDamping",this.onSetAngularDamping,this);this.on("set_linearFactor",this.onSetLinearFactor,this);this.on("set_angularFactor",this.onSetAngularFactor,this);this.on("set_friction",this.onSetFriction,
this);this.on("set_restitution",this.onSetRestitution,this);this.on("set_type",this.onSetType,this);this.on("set_group",this.onSetGroupOrMask,this);this.on("set_mask",this.onSetGroupOrMask,this);this.on("set_body",this.onSetBody,this);this._displacement=new pc.Vec3(0,0,0);this._linearVelocity=new pc.Vec3(0,0,0);this._angularVelocity=new pc.Vec3(0,0,0)},g=pc.inherits(g,pc.Component);Object.defineProperty(g.prototype,"bodyType",{get:function(){console.warn("WARNING: bodyType: Function is deprecated. Query type property instead.");
return this.type},set:function(a){console.warn("WARNING: bodyType: Function is deprecated. Set type property instead.");this.type=a}});Object.defineProperty(g.prototype,"linearVelocity",{get:function(){if(this.isKinematic())return this._linearVelocity;if(this.body){var a=this.body.getLinearVelocity();this._linearVelocity.set(a.x(),a.y(),a.z());return this._linearVelocity}},set:function(b){this.activate();if(this.isKinematic())this._linearVelocity.copy(b);else{var d=this.body;d&&(a.setValue(b.x,b.y,
b.z),d.setLinearVelocity(a))}}});Object.defineProperty(g.prototype,"angularVelocity",{get:function(){if(this.isKinematic())return this._angularVelocity;if(this.body){var a=this.body.getAngularVelocity();this._angularVelocity.set(a.x(),a.y(),a.z());return this._angularVelocity}},set:function(b){this.activate();if(this.isKinematic())this._angularVelocity.copy(b);else{var d=this.body;d&&(a.setValue(b.x,b.y,b.z),d.setAngularVelocity(a))}}});pc.extend(g.prototype,{createBody:function(){var b=this.entity,
e;b.collision&&(e=b.collision.shape,b.trigger&&(b.trigger.destroy(),delete b.trigger));if(e){this.body&&(this.system.removeBody(this.body),Ammo.destroy(this.body));var f=this.isStaticOrKinematic(),g=f?0:this.mass,u=new Ammo.btVector3(0,0,0);f||e.calculateLocalInertia(g,u);var f=b.getPosition(),l=b.getRotation();d.setValue(l.x,l.y,l.z,l.w);l=new Ammo.btTransform;l.setIdentity();l.getOrigin().setValue(f.x,f.y,f.z);l.setRotation(d);f=new Ammo.btDefaultMotionState(l);e=new Ammo.btRigidBodyConstructionInfo(g,
f,e,u);e=new Ammo.btRigidBody(e);e.setRestitution(this.restitution);e.setFriction(this.friction);e.setDamping(this.linearDamping,this.angularDamping);g=this.linearFactor;a.setValue(g.x,g.y,g.z);e.setLinearFactor(a);g=this.angularFactor;a.setValue(g.x,g.y,g.z);e.setAngularFactor(a);e.entity=b;this.isKinematic()&&(e.setCollisionFlags(e.getCollisionFlags()|pc.BODYFLAG_KINEMATIC_OBJECT),e.setActivationState(pc.BODYSTATE_DISABLE_DEACTIVATION));b.rigidbody.body=e;this.enabled&&this.entity.enabled&&this.enableSimulation()}},
isActive:function(){return this.body?this.body.isActive():!1},activate:function(){this.body&&this.body.activate()},enableSimulation:function(){if(this.entity.collision&&this.entity.collision.enabled&&!this.data.simulationEnabled){var a=this.body;a&&(this.system.addBody(a,this.group,this.mask),this.isKinematic()?(a.forceActivationState(pc.BODYSTATE_DISABLE_DEACTIVATION),a.activate()):(a.forceActivationState(pc.BODYFLAG_ACTIVE_TAG),this.syncEntityToBody()),this.data.simulationEnabled=!0)}},disableSimulation:function(){var a=
this.body;a&&this.data.simulationEnabled&&(this.system.removeBody(a),a.forceActivationState(pc.BODYSTATE_DISABLE_SIMULATION),this.data.simulationEnabled=!1)},applyForce:function(){var d,f,g,r,u,l;switch(arguments.length){case 1:d=arguments[0].x;f=arguments[0].y;g=arguments[0].z;break;case 2:d=arguments[0].x;f=arguments[0].y;g=arguments[0].z;r=arguments[1].x;u=arguments[1].y;l=arguments[1].z;break;case 3:d=arguments[0];f=arguments[1];g=arguments[2];break;case 6:d=arguments[0],f=arguments[1],g=arguments[2],
r=arguments[3],u=arguments[4],l=arguments[5]}var n=this.body;n&&(n.activate(),a.setValue(d,f,g),void 0!==r?(b.setValue(r,u,l),n.applyForce(a,b)):n.applyForce(a,e))},applyTorque:function(){var b,d,e;switch(arguments.length){case 1:b=arguments[0].x;d=arguments[0].y;e=arguments[0].z;break;case 3:b=arguments[0];d=arguments[1];e=arguments[2];break;default:console.error("ERROR: applyTorque: function takes 1 or 3 arguments");return}var f=this.body;f&&(f.activate(),a.setValue(b,d,e),f.applyTorque(a))},applyImpulse:function(){var d,
f,g,r,u,l;switch(arguments.length){case 1:d=arguments[0].x;f=arguments[0].y;g=arguments[0].z;break;case 2:d=arguments[0].x;f=arguments[0].y;g=arguments[0].z;r=arguments[1].x;u=arguments[1].y;l=arguments[1].z;break;case 3:d=arguments[0];f=arguments[1];g=arguments[2];break;case 6:d=arguments[0],f=arguments[1],g=arguments[2],r=arguments[0],u=arguments[1],l=arguments[2]}var n=this.body;n&&(n.activate(),a.setValue(d,f,g),void 0!==r?(b.setValue(r,u,l),n.applyImpulse(a,b)):n.applyImpulse(a,e))},applyTorqueImpulse:function(){var b,
d,e;switch(arguments.length){case 1:b=arguments[0].x;d=arguments[0].y;e=arguments[0].z;break;case 3:b=arguments[0];d=arguments[1];e=arguments[2];break;default:console.error("ERROR: applyTorqueImpulse: function takes 1 or 3 arguments");return}var f=this.body;f&&(f.activate(),a.setValue(b,d,e),f.applyTorqueImpulse(a))},isStatic:function(){return this.type===pc.BODYTYPE_STATIC},isStaticOrKinematic:function(){return this.type===pc.BODYTYPE_STATIC||this.type===pc.BODYTYPE_KINEMATIC},isKinematic:function(){return this.type===
pc.BODYTYPE_KINEMATIC},syncEntityToBody:function(){var a=this.body;if(a){var b=this.entity.getPosition(),e=this.entity.getRotation(),f=a.getWorldTransform();f.getOrigin().setValue(b.x,b.y,b.z);d.setValue(e.x,e.y,e.z,e.w);f.setRotation(d);this.isKinematic()&&(b=this.body.getMotionState())&&b.setWorldTransform(f);a.activate()}},syncBodyToEntity:function(){var a=this.body;if(a.isActive()&&(a=a.getMotionState())){a.getWorldTransform(f);var a=f.getOrigin(),b=f.getRotation();this.entity.setPosition(a.x(),
a.y(),a.z());this.entity.setRotation(b.x(),b.y(),b.z(),b.w())}},teleport:function(){3>arguments.length?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof pc.Quat?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2]));this.syncEntityToBody()},_updateKinematic:function(a){this._displacement.copy(this._linearVelocity).scale(a);
this.entity.translate(this._displacement);this._displacement.copy(this._angularVelocity).scale(a);this.entity.rotate(this._displacement.x,this._displacement.y,this._displacement.z);if(this.body.getMotionState()){var a=this.entity.getPosition(),b=this.entity.getRotation();f.getOrigin().setValue(a.x,a.y,a.z);d.setValue(b.x,b.y,b.z,b.w);f.setRotation(d);this.body.getMotionState().setWorldTransform(f)}},onEnable:function(){g._super.onEnable.call(this);this.body||this.createBody();this.enableSimulation()},
onDisable:function(){g._super.onDisable.call(this);this.disableSimulation()},onSetMass:function(a,b,d){if(a=this.data.body){(b=this.enabled&&this.entity.enabled)&&this.disableSimulation();var e=new Ammo.btVector3(0,0,0);a.getCollisionShape().calculateLocalInertia(d,e);a.setMassProps(d,e);a.updateInertiaTensor();b&&this.enableSimulation()}},onSetLinearDamping:function(a,b,d){(a=this.data.body)&&a.setDamping(d,this.data.angularDamping)},onSetAngularDamping:function(a,b,d){(a=this.data.body)&&a.setDamping(this.data.linearDamping,
d)},onSetLinearFactor:function(b,d,e){if(b=this.data.body)a.setValue(e.x,e.y,e.z),b.setLinearFactor(a)},onSetAngularFactor:function(b,d,e){if(b=this.data.body)a.setValue(e.x,e.y,e.z),b.setAngularFactor(a)},onSetFriction:function(a,b,d){(a=this.data.body)&&a.setFriction(d)},onSetRestitution:function(a,b,d){(a=this.data.body)&&a.setRestitution(d)},onSetType:function(a,b,d){d!==b&&(this.disableSimulation(),d===pc.BODYTYPE_DYNAMIC?(this.data.group=pc.BODYGROUP_DYNAMIC,this.data.mask=pc.BODYMASK_ALL):
d===pc.BODYTYPE_KINEMATIC?(this.data.group=pc.BODYGROUP_KINEMATIC,this.data.mask=pc.BODYMASK_ALL):(this.data.group=pc.BODYGROUP_STATIC,this.data.mask=pc.BODYMASK_NOT_STATIC),this.createBody())},onSetGroupOrMask:function(a,b,d){d!==b&&(this.enabled&&this.entity.enabled)&&(this.disableSimulation(),this.enableSimulation())},onSetBody:function(){this.body&&this.data.simulationEnabled&&this.body.activate()}});return{RigidBodyComponent:g}}());pc.extend(pc,function(){var f;f=pc.inherits(function(){this.enabled=!0;this.mass=1;this.angularDamping=this.linearDamping=0;this.linearFactor=new pc.Vec3(1,1,1);this.angularFactor=new pc.Vec3(1,1,1);this.friction=0.5;this.restitution=0;this.type=pc.BODYTYPE_STATIC;this.group=pc.BODYGROUP_STATIC;this.mask=pc.BODYMASK_NOT_STATIC;this.body=null;this.simulationEnabled=!1},pc.ComponentData);return{RigidBodyComponentData:f}}());pc.extend(pc,function(){var f,a,b=function(b,e,g){this.entity=e.entity;this.component=e;this.app=b;"undefined"!==typeof Ammo&&(f=new Ammo.btVector3,a=new Ammo.btQuaternion);this.initialize(g)};b.prototype={initialize:function(b){var e=this.entity;if((b=b.shape)&&"undefined"!==typeof Ammo){e.trigger&&e.trigger.destroy();var g=new Ammo.btVector3(0,0,0);b.calculateLocalInertia(1,g);var h=e.getPosition(),k=e.getRotation();a.setValue(k.x,k.y,k.z,k.w);k=new Ammo.btTransform;k.setIdentity();k.getOrigin().setValue(h.x,
h.y,h.z);k.setRotation(a);h=new Ammo.btDefaultMotionState(k);b=new Ammo.btRigidBodyConstructionInfo(1,h,b,g);this.body=b=new Ammo.btRigidBody(b);b.setRestitution(0);b.setFriction(0);b.setDamping(0,0);f.setValue(0,0,0);b.setLinearFactor(f);b.setAngularFactor(f);b.setCollisionFlags(b.getCollisionFlags()|pc.BODYFLAG_NORESPONSE_OBJECT);b.entity=e;this.component.enabled&&e.enabled&&this.enable()}},destroy:function(){this.body&&this.app.systems.rigidbody.removeBody(this.body)},syncEntityToBody:function(){var b=
this.body;if(b){var e=this.entity.getPosition(),f=this.entity.getRotation(),h=b.getWorldTransform();h.getOrigin().setValue(e.x,e.y,e.z);a.setValue(f.x,f.y,f.z,f.w);h.setRotation(a);b.activate()}},enable:function(){var a=this.body;a&&(this.app.systems.rigidbody.addBody(a,pc.BODYGROUP_TRIGGER,pc.BODYMASK_NOT_STATIC^pc.BODYGROUP_TRIGGER),a.forceActivationState(pc.BODYSTATE_ACTIVE_TAG),a.activate(),this.syncEntityToBody())},disable:function(){var a=this.body;a&&(this.app.systems.rigidbody.removeBody(a),
a.forceActivationState(pc.BODYSTATE_DISABLE_SIMULATION))}};return{Trigger:b}}());pc.extend(pc,function(){var f=function(a){this.id="collision";this.description="Specifies a collision volume.";a.systems.add(this.id,this);this.ComponentType=pc.CollisionComponent;this.DataType=pc.CollisionComponentData;this.schema="enabled type halfExtents radius axis height asset shape model".split(" ");this.implementations={};this.on("remove",this.onRemove,this);pc.ComponentSystem.on("update",this.onUpdate,this)},f=pc.inherits(f,pc.ComponentSystem);f.prototype=pc.extend(f.prototype,{onLibraryLoaded:function(){"undefined"===
typeof Ammo&&pc.ComponentSystem.off("update",this.onUpdate,this)},initializeComponentData:function(a,b,d){var e={},d="type halfExtents radius axis height shape model asset enabled".split(" ");d.forEach(function(a){e[a]=b[a]});if(b.hasOwnProperty("asset")){var g=d.indexOf("model");-1!==g&&d.splice(g,1)}else b.hasOwnProperty("model")&&(g=d.indexOf("asset"),-1!==g&&d.splice(g,1));e.type||(e.type=a.data.type);a.data.type=e.type;e.halfExtents&&"array"===pc.type(e.halfExtents)&&(e.halfExtents=new pc.Vec3(e.halfExtents[0],
e.halfExtents[1],e.halfExtents[2]));g=this._createImplementation(e.type);g.beforeInitialize(a,e);f._super.initializeComponentData.call(this.system,a,e,d);g.afterInitialize(a,e)},_createImplementation:function(a){if(void 0===this.implementations[a]){var b;switch(a){case "box":b=new CollisionBoxSystemImpl(this);break;case "sphere":b=new CollisionSphereSystemImpl(this);break;case "capsule":b=new CollisionCapsuleSystemImpl(this);break;case "cylinder":b=new CollisionCylinderSystemImpl(this);break;case "mesh":b=
new CollisionMeshSystemImpl(this);break;default:throw"Invalid collision system type: "+a;}this.implementations[a]=b}return this.implementations[a]},_getImplementation:function(a){return this.implementations[a.collision.data.type]},cloneComponent:function(a,b){return this._getImplementation(a).clone(a,b)},onRemove:function(a,b){this.implementations[b.type].remove(a,b)},onUpdate:function(){var a,b,d,e=this.store;for(a in e)b=e[a].entity,d=e[a].data,d.enabled&&b.enabled&&!b.rigidbody&&b.trigger&&b.trigger.syncEntityToBody()},
onTransformChanged:function(a,b,d,e){this.implementations[a.data.type].updateTransform(a,b,d,e)},changeType:function(a,b,d){this.implementations[b].remove(a.entity,a.data);this._createImplementation(d).reset(a,a.data)},recreatePhysicalShapes:function(a){this.implementations[a.data.type].recreatePhysicalShapes(a)}});CollisionSystemImpl=function(a){this.system=a};CollisionSystemImpl.prototype={beforeInitialize:function(a,b){b.shape=this.createPhysicalShape(a.entity,b);b.model=new pc.Model;b.model.graph=
new pc.GraphNode},afterInitialize:function(a){this.recreatePhysicalShapes(a);a.data.initialized=!0},reset:function(a,b){this.beforeInitialize(a,b);this.afterInitialize(a,b)},recreatePhysicalShapes:function(a){var b=a.entity,d=a.data;"undefined"!==typeof Ammo&&(d.shape=this.createPhysicalShape(a.entity,d),b.rigidbody?(b.rigidbody.disableSimulation(),b.rigidbody.createBody()):b.trigger?b.trigger.initialize(d):b.trigger=new pc.Trigger(this.system.app,a,d))},createPhysicalShape:function(){},updateTransform:function(a){a.entity.trigger&&
a.entity.trigger.syncEntityToBody()},remove:function(a,b){var d=this.system.app;a.rigidbody&&a.rigidbody.body&&(d.systems.rigidbody.removeBody(a.rigidbody.body),a.rigidbody.disableSimulation());a.trigger&&(a.trigger.destroy(),delete a.trigger);d.scene.containsModel(b.model)&&(d.root.removeChild(b.model.graph),d.scene.removeModel(b.model))},clone:function(a,b){var d=this.system.dataStore[a.getGuid()];return this.system.addComponent(b,{enabled:d.data.enabled,type:d.data.type,halfExtents:[d.data.halfExtents.x,
d.data.halfExtents.y,d.data.halfExtents.z],radius:d.data.radius,axis:d.data.axis,height:d.data.height,asset:d.data.asset,model:d.data.model})}};CollisionBoxSystemImpl=function(){};CollisionBoxSystemImpl=pc.inherits(CollisionBoxSystemImpl,CollisionSystemImpl);CollisionBoxSystemImpl.prototype=pc.extend(CollisionBoxSystemImpl.prototype,{createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo){var d=b.halfExtents,d=new Ammo.btVector3(d.x,d.y,d.z);return new Ammo.btBoxShape(d)}}});CollisionSphereSystemImpl=
function(){};CollisionSphereSystemImpl=pc.inherits(CollisionSphereSystemImpl,CollisionSystemImpl);CollisionSphereSystemImpl.prototype=pc.extend(CollisionSphereSystemImpl.prototype,{createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo)return new Ammo.btSphereShape(b.radius)}});CollisionCapsuleSystemImpl=function(){};CollisionCapsuleSystemImpl=pc.inherits(CollisionCapsuleSystemImpl,CollisionSystemImpl);CollisionCapsuleSystemImpl.prototype=pc.extend(CollisionCapsuleSystemImpl.prototype,{createPhysicalShape:function(a,
b){var d=null,e=void 0!==b.axis?b.axis:1,f=b.radius||0.5,h=Math.max((b.height||2)-2*f,0);if("undefined"!==typeof Ammo)switch(e){case 0:d=new Ammo.btCapsuleShapeX(f,h);break;case 1:d=new Ammo.btCapsuleShape(f,h);break;case 2:d=new Ammo.btCapsuleShapeZ(f,h)}return d}});CollisionCylinderSystemImpl=function(){};CollisionCylinderSystemImpl=pc.inherits(CollisionCylinderSystemImpl,CollisionSystemImpl);CollisionCylinderSystemImpl.prototype=pc.extend(CollisionCylinderSystemImpl.prototype,{createPhysicalShape:function(a,
b){var d=null,d=null,e=void 0!==b.axis?b.axis:1,f=void 0!==b.radius?b.radius:0.5,h=void 0!==b.height?b.height:1;if("undefined"!==typeof Ammo)switch(e){case 0:d=new Ammo.btVector3(0.5*h,f,f);d=new Ammo.btCylinderShapeX(d);break;case 1:d=new Ammo.btVector3(f,0.5*h,f);d=new Ammo.btCylinderShape(d);break;case 2:d=new Ammo.btVector3(f,f,0.5*h),d=new Ammo.btCylinderShapeZ(d)}return d}});CollisionMeshSystemImpl=function(){};CollisionMeshSystemImpl=pc.inherits(CollisionMeshSystemImpl,CollisionSystemImpl);
CollisionMeshSystemImpl.prototype=pc.extend(CollisionMeshSystemImpl.prototype,{beforeInitialize:function(){},createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo&&b.model){var d=b.model,e=new Ammo.btCompoundShape,f,h;for(f=0;f<d.meshInstances.length;f++){var k=d.meshInstances[f],m=k.mesh,r=m.indexBuffer[pc.RENDERSTYLE_SOLID],u=m.vertexBuffer,l=u.getFormat(),n=l.size/4,w;for(h=0;h<l.elements.length;h++){var s=l.elements[h];s.name===pc.SEMANTIC_POSITION&&(w=new Float32Array(u.lock(),s.offset))}var r=
new Uint16Array(r.lock()),u=m.primitive[0].count/3,l=new Ammo.btVector3,s=new Ammo.btVector3,B=new Ammo.btVector3,y,x,A=m.primitive[0].base,D=new Ammo.btTriangleMesh;for(h=0;h<u;h++)m=r[A+3*h]*n,y=r[A+3*h+1]*n,x=r[A+3*h+2]*n,l.setValue(w[m],w[m+1],w[m+2]),s.setValue(w[y],w[y+1],w[y+2]),B.setValue(w[x],w[x+1],w[x+2]),D.addTriangle(l,s,B,!0);h=new Ammo.btBvhTriangleMeshShape(D,!0);n=k.node.getWorldTransform().getScale();h.setLocalScaling(new Ammo.btVector3(n.x,n.y,n.z));n=k.node.getPosition();k=k.node.getRotation();
r=new Ammo.btTransform;r.setIdentity();r.getOrigin().setValue(n.x,n.y,n.z);n=new Ammo.btQuaternion;n.setValue(k.x,k.y,k.z,k.w);r.setRotation(n);e.addChildShape(r,h)}d=a.getWorldTransform().getScale();f=new Ammo.btVector3;f.setValue(d.x,d.y,d.z);e.setLocalScaling(f);return e}},recreatePhysicalShapes:function(a){null!==a.data.asset&&a.enabled&&a.entity.enabled?this.loadModelAsset(a):this.doRecreatePhysicalShape(a)},loadModelAsset:function(a){var b=this,d=a.data.asset,e=a.data,f=this.system.app.assets,
h=f.get(d);if(h)h.ready(function(d){e.model=d.resource;b.doRecreatePhysicalShape(a)}),f.load(h);else f.once("add:"+d,function(d){d.ready(function(d){e.model=d.resource;b.doRecreatePhysicalShape(a)});f.load(d)})},doRecreatePhysicalShape:function(a){var b=a.entity,d=a.data;d.model?(d.shape&&Ammo.destroy(d.shape),d.shape=this.createPhysicalShape(b,d),b.rigidbody?b.rigidbody.createBody():b.trigger?b.trigger.initialize(d):b.trigger=new pc.Trigger(this.system.app,a,d)):this.remove(b,d)},updateTransform:function(a,
b,d,e){if(a.shape){var f=a.entity.getWorldTransform().getScale(),h=a.shape.getLocalScaling();(f.x!==h.x()||f.y!==h.y()||f.z!==h.z())&&this.doRecreatePhysicalShape(a)}CollisionMeshSystemImpl._super.updateTransform.call(this,a,b,d,e)}});return{CollisionComponentSystem:f}}());pc.extend(pc,function(){var f=function(){this.on("set_type",this.onSetType,this);this.on("set_halfExtents",this.onSetHalfExtents,this);this.on("set_radius",this.onSetRadius,this);this.on("set_height",this.onSetHeight,this);this.on("set_axis",this.onSetAxis,this);this.on("set_asset",this.onSetAsset,this);this.on("set_model",this.onSetModel,this)},f=pc.inherits(f,pc.Component);pc.extend(f.prototype,{onSetType:function(a,b,d){b!==d&&this.system.changeType(this,b,d)},onSetHalfExtents:function(){this.data.initialized&&
"box"===this.data.type&&this.system.recreatePhysicalShapes(this)},onSetRadius:function(){this.data.initialized&&("sphere"===this.data.type||"capsule"===this.data.type||"cylinder"===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetHeight:function(){this.data.initialized&&("capsule"===this.data.type||"cylinder"===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetAxis:function(){this.data.initialized&&("capsule"===this.data.type||"cylinder"===this.data.type)&&this.system.recreatePhysicalShapes(this)},
onSetAsset:function(a,b,d){a=this.system.app.assets;b&&(b=a.get(b))&&b.off("remove",this.onAssetRemoved,this);if(d&&(d instanceof pc.Asset&&(this.data.asset=d.id),b=a.get(this.data.asset)))b.off("remove",this.onAssetRemoved,this),b.on("remove",this.onAssetRemoved,this);this.data.initialized&&"mesh"===this.data.type&&(d||(this.data.model=null),this.system.recreatePhysicalShapes(this))},onSetModel:function(){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)},
onAssetRemoved:function(a){a.off("remove",this.onAssetRemoved,this);this.data.asset===a.id&&(this.asset=null)},onEnable:function(){f._super.onEnable.call(this);if("mesh"===this.data.type&&this.data.asset&&this.data.initialized){var a=this.system.app.assets.get(this.data.asset);if(a&&(!a.resource||!this.data.shape)){this.system.recreatePhysicalShapes(this);return}}this.entity.trigger?this.entity.trigger.enable():this.entity.rigidbody&&this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation()},
onDisable:function(){f._super.onDisable.call(this);this.entity.trigger?this.entity.trigger.disable():this.entity.rigidbody&&this.entity.rigidbody.disableSimulation()}});return{CollisionComponent:f}}());pc.extend(pc,function(){var f;f=pc.inherits(function(){this.enabled=!0;this.type="box";this.halfExtents=new pc.Vec3(0.5,0.5,0.5);this.radius=0.5;this.axis=1;this.height=2;this.model=this.shape=this.asset=null;this.initialized=!1},pc.ComponentData);return{CollisionComponentData:f}}());pc.extend(pc,function(){var f=function(a){this.id="particlesystem";this.description="Updates and renders particle system in the scene.";a.systems.add(this.id,this);this.ComponentType=pc.ParticleSystemComponent;this.DataType=pc.ParticleSystemComponentData;this.schema="enabled autoPlay numParticles lifetime rate rate2 startAngle startAngle2 loop preWarm lighting halfLambert intensity depthWrite noFog depthSoftening sort blendType stretch alignToMotion emitterShape emitterExtents emitterRadius initialVelocity wrap wrapBounds colorMapAsset normalMapAsset mesh localVelocityGraph localVelocityGraph2 velocityGraph velocityGraph2 rotationSpeedGraph rotationSpeedGraph2 scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 colorMap normalMap animTilesX animTilesY animNumFrames animSpeed animLoop".split(" ");
this.propertyTypes={emitterExtents:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"};this.on("remove",this.onRemove,this);pc.ComponentSystem.on("update",this.onUpdate,this)},f=pc.inherits(f,pc.ComponentSystem);pc.extend(f.prototype,{initializeComponentData:function(a,
b,d){var e={},d=[],g=this.propertyTypes,h,k;for(k in b)b.hasOwnProperty(k)&&(d.push(k),e[k]=b[k]),"vec3"===g[k]?"array"===pc.type(e[k])&&(e[k]=new pc.Vec3(e[k][0],e[k][1],e[k][2])):"curve"===g[k]?e[k]instanceof pc.Curve||(h=e[k].type,e[k]=new pc.Curve(e[k].keys),e[k].type=h):"curveset"===g[k]&&!(e[k]instanceof pc.CurveSet)&&(h=e[k].type,e[k]=new pc.CurveSet(e[k].keys),e[k].type=h);f._super.initializeComponentData.call(this,a,e,d)},cloneComponent:function(a,b){for(var d=a.particlesystem.data,e=this.schema,
f={},h=0,k=e.length;h<k;h++){var m=e[h],r=d[m];r instanceof pc.Vec3||r instanceof pc.Curve||r instanceof pc.CurveSet?(r=r.clone(),f[m]=r):null!==r&&void 0!==r&&(f[m]=r)}return this.addComponent(b,f)},onUpdate:function(a){var b=this.store,d,e,f;for(f in b)if(b.hasOwnProperty(f)){d=b[f];var h=d.entity;d=d.data;if(d.enabled&&h.enabled&&(h=d.model.emitter,!d.paused&&(h.simTime+=a,d=0,h.simTime>h.fixedTimeStep&&(d=Math.floor(h.simTime/h.fixedTimeStep),h.simTime-=d*h.fixedTimeStep),d))){d=Math.min(d,h.maxSubSteps);
for(e=0;e<d;e++)h.addTime(h.fixedTimeStep)}}},onRemove:function(a,b){b.model&&(this.app.scene.removeModel(b.model),a.removeChild(b.model.getGraph()),b.model=null)}});return{ParticleSystemComponentSystem:f}}());pc.extend(pc,function(){var f="emitterExtents emitterRadius loop initialVelocity animSpeed normalMap".split(" "),a="numParticles lifetime rate rate2 startAngle startAngle2 lighting halfLambert intensity wrap wrapBounds depthWrite noFog sort stretch alignToMotion preWarm emitterShape animTilesX animTilesY animFrames animLoop colorMap".split(" "),b="scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 velocityGraph velocityGraph2 localVelocityGraph localVelocityGraph2 rotationSpeedGraph rotationSpeedGraph2".split(" "),
d=["colorMapAsset","normalMapAsset","mesh"],e=function(){this.on("set_colorMapAsset",this.onSetColorMapAsset,this);this.on("set_normalMapAsset",this.onSetNormalMapAsset,this);this.on("set_mesh",this.onSetMesh,this);this.on("set_loop",this.onSetLoop,this);this.on("set_blendType",this.onSetBlendType,this);this.on("set_depthSoftening",this.onSetDepthSoftening,this);f.forEach(function(a){this.on("set_"+a,this.onSetSimpleProperty,this)}.bind(this));a.forEach(function(a){this.on("set_"+a,this.onSetComplexProperty,
this)}.bind(this));b.forEach(function(a){this.on("set_"+a,this.onSetGraphProperty,this)}.bind(this))},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{onSetColorMapAsset:function(a,b,d){var e=this,f=this.system.app.assets;b&&(a=f.get(b))&&a.off("remove",this.onColorMapRemoved,this);if(d)if(d instanceof pc.Asset&&(d=this.data.colorMapAsset=d.id),a=f.get(d))a.on("remove",this.onColorMapRemoved,this),a.ready(function(a){e.colorMap=a.resource}),e.enabled&&e.entity.enabled&&f.load(a);else f.once("add:"+
d,function(a){a.on("remove",this.onColorMapRemoved,this);a.ready(function(a){e.colorMap=a.resource});e.enabled&&e.entity.enabled&&f.load(a)});else this.colorMap=null},onColorMapRemoved:function(a){a.off("remove",this.onColorMapRemoved,this);this.colorMapAsset=null},onSetNormalMapAsset:function(a,b,d){var e=this,f=this.system.app.assets;b&&(a=f.get(b))&&a.off("remove",this.onNormalMapRemoved,this);if(d)if(d instanceof pc.Asset&&(d=this.data.normalMapAsset=d.id),a=f.get(d))a.on("remove",this.onNormalMapRemoved,
this),a.ready(function(a){e.normalMap=a.resource}),e.enabled&&e.entity.enabled&&f.load(a);else f.once("add:"+d,function(a){a.on("remove",this.onNormalMapRemoved,this);a.ready(function(a){e.normalMap=a.resource});e.enabled&&e.entity.enabled&&f.load(a)});else this.normalMap=null},onNormalMapRemoved:function(a){a.off("remove",this.onNormalMapRemoved,this);this.normalMapAsset=null},onSetMesh:function(a,b,d){var e=this,f=this.system.app.assets;b&&"number"===typeof b&&(a=f.get(b))&&a.off("remove",this.onMeshRemoved,
this);if(d)if(d instanceof pc.Asset&&(d=this.data.mesh=d.id),"number"===typeof d)if(a=f.get(d))a.on("remove",this.onMeshRemoved,this),a.ready(function(a){e._onMeshChanged(a.resource)}),e.enabled&&e.entity.enabled&&f.load(a);else f.once("add:"+d,function(a){a.on("remove",this.onMeshRemoved,this);a.ready(function(a){e._onMeshChanged(a.resource)});e.enabled&&e.entity.enabled&&f.load(a)});else this._onMeshChanged(d);else this._onMeshChanged(null)},_onMeshChanged:function(a){a&&!(a instanceof pc.Mesh)&&
(a=a.meshInstances[0]?a.meshInstances[0].mesh:null);this.data.mesh=a;this.emitter&&(this.emitter.mesh=a,this.emitter.resetMaterial(),this.rebuild())},onMeshRemoved:function(a){a.off("remove",this.onMeshRemoved,this);this.mesh=null},onSetLoop:function(a,b,d){this.emitter&&(this.emitter[a]=d,this.emitter.resetTime())},onSetBlendType:function(a,b,d){this.emitter&&(this.emitter[a]=d,this.emitter.material.blendType=d,this.emitter.resetMaterial(),this.rebuild())},onSetDepthSoftening:function(a,b,d){if(this.emitter&&
b!==d){if(d){if(this.emitter[a]=d,this.enabled)this.emitter.onEnableDepth()}else{if(this.enabled)this.emitter.onDisableDepth();this.emitter[a]=d}this.reset();this.emitter.resetMaterial();this.rebuild()}},onSetSimpleProperty:function(a,b,d){this.emitter&&(this.emitter[a]=d,this.emitter.resetMaterial())},onSetComplexProperty:function(a,b,d){this.emitter&&(this.emitter[a]=d,this.reset(),this.emitter.resetMaterial(),this.rebuild())},onSetGraphProperty:function(a,b,d){this.emitter&&(this.emitter[a]=d,
this.emitter.rebuildGraphs(),this.emitter.resetMaterial())},onEnable:function(){for(var a=0,b=d.length;a<b;a++){var f=this.data[d[a]];if(f){if(!(f instanceof pc.Asset))if(0<=parseInt(f,10))f=this.system.app.assets.get(f);else continue;f&&!f.resource&&this.system.app.assets.load(f)}}a=!1;!this.emitter&&!this.system._inTools&&(b=this.data.mesh,b instanceof pc.Mesh||(b=null),a=!0,this.emitter=new pc.ParticleEmitter(this.system.app.graphicsDevice,{numParticles:this.data.numParticles,emitterExtents:this.data.emitterExtents,
emitterRadius:this.data.emitterRadius,emitterShape:this.data.emitterShape,initialVelocity:this.data.initialVelocity,wrap:this.data.wrap,wrapBounds:this.data.wrapBounds,lifetime:this.data.lifetime,rate:this.data.rate,rate2:this.data.rate2,animTilesX:this.data.animTilesX,animTilesY:this.data.animTilesY,animNumFrames:this.data.animNumFrames,animSpeed:this.data.animSpeed,animLoop:this.data.animLoop,startAngle:this.data.startAngle,startAngle2:this.data.startAngle2,scaleGraph:this.data.scaleGraph,scaleGraph2:this.data.scaleGraph2,
colorGraph:this.data.colorGraph,colorGraph2:this.data.colorGraph2,alphaGraph:this.data.alphaGraph,alphaGraph2:this.data.alphaGraph2,localVelocityGraph:this.data.localVelocityGraph,localVelocityGraph2:this.data.localVelocityGraph2,velocityGraph:this.data.velocityGraph,velocityGraph2:this.data.velocityGraph2,rotationSpeedGraph:this.data.rotationSpeedGraph,rotationSpeedGraph2:this.data.rotationSpeedGraph2,colorMap:this.data.colorMap,normalMap:this.data.normalMap,loop:this.data.loop,preWarm:this.data.preWarm,
sort:this.data.sort,stretch:this.data.stretch,alignToMotion:this.data.alignToMotion,lighting:this.data.lighting,halfLambert:this.data.halfLambert,intensity:this.data.intensity,depthSoftening:this.data.depthSoftening,scene:this.system.app.scene,mesh:b,depthWrite:this.data.depthWrite,noFog:this.data.noFog,node:this.entity,blendType:this.data.blendType}),this.emitter.meshInstance.node=this.entity,this.psys=new pc.Model,this.psys.graph=this.entity,this.psys.emitter=this.emitter,this.psys.meshInstances=
[this.emitter.meshInstance],this.data.model=this.psys,this.emitter.psys=this.psys,this.data.autoPlay||this.pause());if(this.data.model&&(!this.system.app.scene.containsModel(this.data.model)&&this.emitter.colorMap)&&(this.system.app.scene.addModel(this.data.model),!a))this.emitter.onEnableDepth();e._super.onEnable.call(this)},onDisable:function(){e._super.onDisable.call(this);this.data.model&&this.system.app.scene.containsModel(this.data.model)&&(this.system.app.scene.removeModel(this.data.model),
this.emitter.onDisableDepth())},reset:function(){this.emitter&&this.emitter.reset()},stop:function(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))},pause:function(){this.data.paused=!0},unpause:function(){this.data.paused=!1},play:function(){this.data.paused=!1;this.emitter&&(this.emitter.loop=this.data.loop,this.emitter.resetTime())},isPlaying:function(){return this.data.paused?!1:this.emitter&&this.emitter.loop?!0:Date.now()<=this.emitter.endTime},rebuild:function(){var a=
this.enabled;this.enabled=!1;this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity,this.data.model.meshInstances=[this.emitter.meshInstance]);this.enabled=a}});return{ParticleSystemComponent:e}}());pc.extend(pc,function(){var f;f=pc.inherits(function(){this.rate=this.numParticles=1;this.rate2=null;this.startAngle=0;this.startAngle2=null;this.lifetime=50;this.emitterExtents=new pc.Vec3;this.emitterRadius=0;this.emitterShape=pc.EMITTERSHAPE_BOX;this.initialVelocity=0;this.wrapBounds=new pc.Vec3;this.normalMapAsset=this.normalMap=this.colorMapAsset=this.colorMap=null;this.loop=!0;this.preWarm=!1;this.sort=0;this.mode=pc.PARTICLEMODE_GPU;this.scene=null;this.halfLambert=this.lighting=!1;this.intensity=
1;this.stretch=0;this.alignToMotion=!1;this.depthSoftening=0;this.mesh=null;this.noFog=this.depthWrite=!1;this.animSpeed=this.animNumFrames=this.animTilesY=this.animTilesX=1;this.animLoop=!0;this.rotationSpeedGraph2=this.rotationSpeedGraph=this.velocityGraph2=this.velocityGraph=this.localVelocityGraph2=this.localVelocityGraph=this.alphaGraph2=this.alphaGraph=this.colorGraph2=this.colorGraph=this.scaleGraph2=this.scaleGraph=null;this.blendType=pc.BLEND_NORMAL;this.model=null;this.enabled=!0;this.paused=
!1;this.autoPlay=!0},pc.ComponentData);return{ParticleSystemComponentData:f}}());pc.extend(pc,function(){var f=function(a){this._guid=pc.guid.create();this._batchHandle=null;this.c={};this._app=a;a||(this._app=pc.Application.getApplication())||console.error("Couldn't find current application");pc.events.attach(this)},f=pc.inherits(f,pc.GraphNode);f.prototype.addComponent=function(a,b){var d=this._app.systems[a];if(d)if(this.c[a])logERROR(pc.string.format("Entity already has {0} Component",a));else return d.addComponent(this,b);else return logERROR(pc.string.format("System: '{0}' doesn't exist",
a)),null};f.prototype.removeComponent=function(a){var b=this._app.systems[a];b?this.c[a]?b.removeComponent(this):logERROR(pc.string.format("Entity doesn't have {0} Component",a)):logERROR(pc.string.format("System: '{0}' doesn't exist",a))};f.prototype.getGuid=function(){return this._guid};f.prototype.setGuid=function(a){this._guid=a};f.prototype._onHierarchyStateChanged=function(a){pc.Entity._super._onHierarchyStateChanged.call(this,a);var b,d=this.c,e;for(e in d)if(d.hasOwnProperty(e)&&(b=d[e],b.enabled))if(a)b.onEnable();
else b.onDisable()};f.prototype.setRequest=function(a){this._request=a};f.prototype.getRequest=function(){return this._request};f.prototype.addChild=function(a){if(a instanceof pc.Entity&&this.getRoot().findOne("getGuid",a.getGuid()))throw Error("GUID already exists in graph");pc.GraphNode.prototype.addChild.call(this,a)};f.prototype.findByGuid=function(a){if(this._guid===a)return this;for(var b=0;b<this._children.length;b++)if(this._children[b].findByGuid){var d=this._children[b].findByGuid(a);if(null!==
d)return d}return null};f.prototype.destroy=function(){var a=this.getParent(),b;for(b in this.c)this.c[b].enabled=!1;for(b in this.c)this.c[b].system.removeComponent(this);a&&a.removeChild(this);a=this.getChildren();for(b=a.shift();b;)b instanceof pc.Entity&&b.destroy(),b=a.shift()};f.prototype.clone=function(){var a,b=new pc.Entity(this._app);pc.Entity._super._cloneInternal.call(this,b);for(a in this.c)this.c[a].system.cloneComponent(this,b);for(a=0;a<this.getChildren().length;a++){var d=this.getChildren()[a];
d instanceof pc.Entity&&b.addChild(d.clone())}return b};f.deserialize=function(a){var b=pc.json.parse(a.template),d=pc.json.parse(a.parent),e=pc.json.parse(a.children),f=pc.json.parse(a.transform),h=pc.json.parse(a.components),k=pc.json.parse(a.labels);return{_id:a._id,resource_id:a.resource_id,_rev:a._rev,name:a.name,enabled:a.enabled,labels:k,template:b,parent:d,children:e,transform:f,components:h}};f.serialize=function(a){var b={_id:a._id,resource_id:a.resource_id,name:a.name,enabled:a.enabled,
labels:pc.json.stringify(a.labels),template:pc.json.stringify(a.template),parent:pc.json.stringify(a.parent),children:pc.json.stringify(a.children),transform:pc.json.stringify(a.transform),components:pc.json.stringify(a.components)};a._rev&&(b._rev=a._rev);return b};return{Entity:f}}());pc.extend(pc,function(){var f=function(){this._handlers={};this._requests={};this._cache={}};f.prototype={addHandler:function(a,b){this._handlers[a]=b},removeHandler:function(a){delete this._handlers[a]},getHandler:function(a){return this._handlers[a]},load:function(a,b,d){var e=this._handlers[b];if(e){var f=a+b;void 0!==this._cache[f]?d(null,this._cache[f]):this._requests[f]?this._requests[f].push(d):(this._requests[f]=[d],e.load(a,function(b,d){if(this._requests[f]){var m,r=this._requests[f].length;
if(b)for(m=0;m<r;m++)this._requests[f][m](b);else{var u=e.open(a,d);this._cache[f]=u;for(m=0;m<r;m++)this._requests[f][m](null,u)}delete this._requests[f]}}.bind(this)))}else d("No handler for asset type: "+b)},open:function(a,b){var d=this._handlers[a];return!d?(console.warn("No resource handler found for: "+a),b):d.open(null,b)},patch:function(a,b){var d=this._handlers[a.type];d?d.patch&&d.patch(a,b):console.warn("No resource handler found for: "+a.type)},clearCache:function(a,b){delete this._cache[a+
b]},getFromCache:function(a,b){if(this._cache[a+b])return this._cache[a+b]},destroy:function(){this._handlers={};this._requests={};this._cache={}}};return{ResourceLoader:f}}());pc.extend(pc,function(){var f=function(){};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b(pc.string.format("Error loading animation resource: {0} [{1}]",a,d)):b(null,e)}.bind(this))},open:function(a,b){return this["_parseAnimationV"+b.animation.version](b)},_parseAnimationV3:function(a){var a=a.animation,b=new pc.Animation;b.setName(a.name);b.setDuration(a.duration);for(var d=0;d<a.nodes.length;d++){var e=new pc.Node,f=a.nodes[d];e._name=f.name;for(var h=0;h<f.keys.length;h++){var k=
f.keys[h],m=k.time,r=k.pos,u=k.rot,k=k.scale,r=new pc.Vec3(r[0],r[1],r[2]),u=(new pc.Quat).setFromEulerAngles(u[0],u[1],u[2]),k=new pc.Vec3(k[0],k[1],k[2]),m=new pc.Key(m,r,u,k);e._keys.push(m)}b.addNode(e)}return b},_parseAnimationV4:function(a){var a=a.animation,b=new pc.Animation;b.setName(a.name);b.setDuration(a.duration);for(var d=0;d<a.nodes.length;d++){var e=new pc.Node,f=a.nodes[d];e._name=f.name;for(var h=f.defaults.p,k=f.defaults.r,m=f.defaults.s,r=0;r<f.keys.length;r++){var u=f.keys[r],
l=u.t,n=h?h:u.p,w=k?k:u.r,u=m?m:u.s,n=new pc.Vec3(n[0],n[1],n[2]),w=(new pc.Quat).setFromEulerAngles(w[0],w[1],w[2]),u=new pc.Vec3(u[0],u[1],u[2]),l=new pc.Key(l,n,w,u);e._keys.push(l)}b.addNode(e)}return b}};return{AnimationHandler:f}}());pc.extend(pc,function(){var f=function(){var a=window.navigator.userAgent,d=a.indexOf("MSIE ");return 0<d?parseInt(a.substring(d+5,a.indexOf(".",d)),10):0<a.indexOf("Trident/")?(d=a.indexOf("rv:"),parseInt(a.substring(d+3,a.indexOf(".",d)),10)):!1}(),a=function(a){this.manager=a;try{this._audio=new Audio}catch(d){}};a.prototype={_isSupported:function(a){var d={".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav"},a=pc.path.getExtension(a);return d[a]?""!==this._audio.canPlayType(d[a]):!1},
load:function(a,d){var e=function(a){d(null,new pc.Sound(a))},f=function(e){e=e||"Error loading audio url: "+a;console.warn(e);d(e)};this._createSound?this._isSupported(a)?this._createSound(a,e,f):f(pc.string.format("Audio format for {0} not supported",a)):f(null)},open:function(a,d){return d}};pc.SoundManager.hasAudioContext()?a.prototype._createSound=function(a,d,e){var f=this.manager;f.context?pc.http.get(a,function(a,b){a&&e();f.context.decodeAudioData(b,d,e)}):e("Audio manager has no audio context")}:
pc.SoundManager.hasAudio()&&(a.prototype._createSound=function(a,d,e){var g=null;try{g=new Audio}catch(h){e("No support for Audio element");return}f&&document.body.appendChild(g);var k=function(){g.removeEventListener("canplaythrough",k);f&&document.body.removeChild(g);d(g)};g.onerror=function(){g.onerror=null;f&&document.body.removeChild(g);e()};g.addEventListener("canplaythrough",k);g.src=a});return{AudioHandler:a}}());pc.extend(pc,function(){var f=function(a,b,d){this._device=a;this._assets=b;this._loader=d};f.prototype={load:function(){},open:function(){},patch:function(a,b){var d=this,e=!1;a.resources[0]||(a.resources[0]=new pc.Texture(this._device,{format:pc.PIXELFORMAT_R8_G8_B8_A8,cubemap:!0,autoMipmap:!0,fixCubemapSeams:!!a._dds}),e=!0);a.file?a.file&&!a._dds&&b._loader.load(a.file.url+"?t="+a.file.hash,"texture",function(e,f){e?(b.fire("error",e,a),b.fire("error:"+a.id,e,a),a.fire("error",e,a)):(b._loader.patch({resource:f,
type:"texture",data:a.data},b),a._dds=f,d.patch(a,b))}):delete a._dds;if((!a.file||!a._dds)&&a.resources[1])a.resources=[a.resources[0]],e=!0;else if(a._dds&&!a.resources[1]){a.resources=[a.resources[0]];a._dds.fixCubemapSeams=!0;a._dds.autoMipmap=this._device.useTexCubeLod?!1:!0;a._dds.minFilter=this._device.useTexCubeLod?pc.FILTER_LINEAR_MIPMAP_LINEAR:pc.FILTER_LINEAR;a._dds.magFilter=pc.FILTER_LINEAR;a._dds.addressU=pc.ADDRESS_CLAMP_TO_EDGE;a._dds.addressV=pc.ADDRESS_CLAMP_TO_EDGE;a.resources.push(a._dds);
for(e=1;6>e;e++){var f=new pc.gfx.Texture(this._device,{cubemap:!0,fixCubemapSeams:!0,autoMipmap:!0,format:a._dds.format,rgbm:a._dds.rgbm,width:Math.pow(2,7-e),height:Math.pow(2,7-e)});f.addressU=pc.ADDRESS_CLAMP_TO_EDGE;f.addressV=pc.ADDRESS_CLAMP_TO_EDGE;f._levels[0]=a._dds._levels[e];f.upload();a.resources.push(f)}e=!0}f=a.resource;f.name!==a.name&&(f.name=a.name);a.data.hasOwnProperty("rgbm")&&f.rgbm!==!!a.data.rgbm&&(f.rgbm=!!a.data.rgbm);f.fixCubemapSeams=!!a._dds;a.data.hasOwnProperty("minFilter")&&
f.minFilter!==a.data.minFilter&&(f.minFilter=a.data.minFilter);a.data.hasOwnProperty("magFilter")&&f.magFilter!==a.data.magFilter&&(f.magFilter=a.data.magFilter);a.data.hasOwnProperty("anisotropy")&&f.anisotropy!==a.data.anisotropy&&(f.anisotropy=a.data.anisotropy);f.addressU!==pc.ADDRESS_CLAMP_TO_EDGE&&(f.addressU=pc.ADDRESS_CLAMP_TO_EDGE);f.addressV!==pc.ADDRESS_CLAMP_TO_EDGE&&(f.addressV=pc.ADDRESS_CLAMP_TO_EDGE);this._patchTextureFaces(a,b);e&&(b.fire("load",a),b.fire("load:"+a.id,a),a.fire("load",
a))},_patchTexture:function(){this.registry._loader._handlers.cubemap._patchTextureFaces(this,this.registry)},_patchTextureFaces:function(a,b){if(a.loadFaces||!a.file){var d=a.resource,e=[],f=0,h=!1,k=this;a._levelsEvents||(a._levelsEvents=[null,null,null,null,null,null]);a.data.textures.forEach(function(m,r){var u=function(l){f++;e[r]=l&&l.resource.getSource()||null;var m=a._levelsEvents[r];if(m!==l){m&&m.off("load",k._patchTexture,a);if(l)l.on("load",k._patchTexture,a);a._levelsEvents[r]=l||null}e[r]!==
d._levels[0][r]&&(h=!0);6===f&&h&&(d.setSource(e),b.fire("load",a),b.fire("load:"+a.id,a),a.fire("load",a))},l=b.get(a.data.textures[r]);if(l)l.ready(u),b.load(l);else if(m)b.once("load:"+m,u);else u(null)})}}};return{CubemapHandler:f}}());pc.extend(pc,function(){var f=function(){};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b(pc.string.format("Error loading JSON resource: {0} [{1}]",a,d)):b(null,e)})},open:function(a,b){return b},patch:function(){}};return{JsonHandler:f}}());pc.extend(pc,function(){var f={ambient:"vec3",ambientTnumber:"boolean",aoMap:"texture",aoMapVertexColor:"boolean",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",occludeSpecular:"boolean",diffuse:"vec3",diffuseMap:"texture",diffuseMapVertexColor:"boolean",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",diffuseMapTnumber:"boolean",specular:"vec3",specularMapVertexColor:"boolean",specularMapChannel:"string",specularMapUv:"number",
specularMap:"texture",specularMapTiling:"vec2",specularMapOffset:"vec2",specularMapTnumber:"boolean",specularAntialias:"boolean",useMetalness:"boolean",metalnessMap:"texture",metalnessMapVertexColor:"boolean",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",metalnessMapTnumber:"boolean",metalness:"number",conserveEnergy:"boolean",shininess:"number",glossMap:"texture",glossMapVertexColor:"boolean",glossMapChannel:"string",glossMapUv:"number",
glossMapTiling:"vec2",glossMapOffset:"vec2",fresnelModel:"number",fresnelFactor:"float",emissive:"vec3",emissiveMap:"texture",emissiveMapVertexColor:"boolean",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveMapTint:"boolean",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapUv:"number",bumpMapFactor:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",
heightMapOffset:"vec2",heightMapFactor:"number",alphaTest:"number",opacity:"number",opacityMap:"texture",opacityMapVertexColor:"boolean",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"boolean",lightMap:"texture",lightMapVertexColor:"boolean",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",
depthTest:"boolean",depthWrite:"boolean",cull:"number",blendType:"number",shadowSampleType:"number",shadingModel:"number"},a=function(a){for(var b="cubeMap prefilteredCubeMap128 prefilteredCubeMap64 prefilteredCubeMap32 prefilteredCubeMap16 prefilteredCubeMap8 prefilteredCubeMap4".split(" "),f=0;f<b.length;f++)this[b[f]]!==a.resources[f]&&(this[b[f]]=a.resources[f]);this.update()},b=function(a){this._assets=a};b.prototype={load:function(a,b){pc.http.get(a,function(f,h){f?b&&b(pc.string.format("Error loading material: {0} [{1}]",
a,f)):b&&b(null,h)})},open:function(a,b){var f=new pc.StandardMaterial;b.parameters||this._createParameters(b);f.init(b);f._data=b;return f},_createParameters:function(a){var b=[];a.shadingModel||(a.shadingModel="blinn"===a.shader?pc.SPECULAR_BLINN:pc.SPECULAR_PHONG);var g=a.shader;delete a.shader;for(var h in a)a.hasOwnProperty(h)&&b.push({name:h,type:f[h],data:a[h]});a.shader=g;a.parameters=b},patch:function(a,b){void 0===a.data.shader&&(a.data=a.resource._data,delete a.resource._data);this._updateStandardMaterial(a,
a.data,b);a.off("change",this._onAssetChange,this);a.on("change",this._onAssetChange,this)},_onAssetChange:function(a,b,f){"data"===b&&this._updateStandardMaterial(a,f,this._assets)},_updateStandardMaterial:function(b,e,f){var h=b.resource,k;b.file&&(k=pc.path.getDirectory(b.getFileUrl()));e.name=b.name;e.parameters||this._createParameters(e);var m="path"===e.mapping_format;e.parameters.forEach(function(r,u){var l;if("texture"===r.type){h._assetHandlers||(h._assetHandlers={});var n=h._assetHandlers[r.name];
if(r.data&&!(r.data instanceof pc.Texture))if(m?b=f.getByUrl(pc.path.join(k,r.data)):(l=r.data,b=f.get(r.data)),n&&(f.off("load:"+n.id,n.bind),f.off("add:"+n.id,n.add),f.off("remove:"+n.id,n.remove),n.url&&(f.off("add:url:"+n.url,n.add),f.off("remove:url:"+n.url,n.remove)),h._assetHandlers[r.name]=null),n=h._assetHandlers[r.name]={id:l,url:m?pc.path.join(k,r.data):"",bind:function(a){e.parameters[u].data=a.resource;h[e.parameters[u].name]=a.resource;h.update()},add:function(a){f.load(a)},remove:function(a){h[e.parameters[u].name]===
a.resource&&(e.parameters[u].data=null,h[e.parameters[u].name]=null,h.update())}},l?(f.on("load:"+l,n.bind),f.on("remove:"+l,n.remove)):m&&(f.on("load:url:"+pc.path.join(k,r.data),n.bind),f.on("remove:url:"+pc.path.join(k,r.data),n.remove)),b)b.resource&&n.bind(b),f.load(b);else if(l)f.once("add:"+l,n.add);else{if(m)f.once("add:url:"+n.url,n.add)}else n&&!r.data&&(f.off("load:"+n.id,n.bind),f.off("add:"+n.id,n.add),f.off("remove:"+n.id,n.remove),n.url&&(f.off("add:url:"+n.url,n.add),f.off("remove:url:"+
n.url,n.remove)),h._assetHandlers[r.name]=null)}else if("cubemap"===r.type&&r.data&&!(r.data instanceof pc.Texture)){m?b=f.getByUrl(pc.path.join(k,r.data)):(l=r.data,b=f.get(r.data));var n=function(a){e.shadingModel===pc.SPECULAR_PHONG&&(a.loadFaces=!0);a.ready(w);f.load(a)},w=function(b){r.data=b.resource;1<b.resources.length&&(e.parameters.push({name:"prefilteredCubeMap128",data:b.resources[1]}),e.parameters.push({name:"prefilteredCubeMap64",data:b.resources[2]}),e.parameters.push({name:"prefilteredCubeMap32",
data:b.resources[3]}),e.parameters.push({name:"prefilteredCubeMap16",data:b.resources[4]}),e.parameters.push({name:"prefilteredCubeMap8",data:b.resources[5]}),e.parameters.push({name:"prefilteredCubeMap4",data:b.resources[6]}));h.init(e);b.off("load",a,h);b.on("load",a,h)};if(b)n(b);else if(l)f.once("add:"+l,n);else if(m)f.once("add:url:"+pc.path.join(k,r.data),function(b){b.ready(function(b){e.parameters[u].data=b.resource;h.init(e);b.off("load",a,h);b.on("load",a,h)});f.load(b)})}});h.init(e)}};
return{MaterialHandler:b,getMaterialParamType:function(a){return f[a]}}}());pc.extend(pc,function(){var f=function(a){this._device=a};f.DEFAULT_MATERIAL=new pc.StandardMaterial;f.DEFAULT_MATERIAL.shadingModel=pc.SPECULAR_BLINN;f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b&&b(pc.string.format("Error loading model: {0} [{1}]",a,d)):b&&b(null,e)})},open:function(a,b){if(b.model){if(1>=b.model.version)logERROR(pc.string.format("Asset: {0}, is an old model format. Upload source assets to re-import.",a));else if(2<=b.model.version)return(new pc.JsonModelParser(this._device)).parse(b);
return null}},patch:function(a,b){if(a.resource){var d=a.data;a.resource.meshInstances.forEach(function(e,f){if(d.mapping){var h=function(a){a.resource?e.material=a.resource:(a.once("load",h),b.load(a));a.once("remove",function(a){e.material===a.resource&&(e.material=pc.ModelHandler.DEFAULT_MATERIAL)})};if(d.mapping[f]){var k=d.mapping[f].material,m=d.mapping[f].path;if(void 0!==k)if(k)if(m=b.get(k))h(m);else b.once("add:"+k,h);else e.material=pc.ModelHandler.DEFAULT_MATERIAL;else if(void 0!==m&&
m)if(k=a.getFileUrl(),k=pc.path.getDirectory(k),k=pc.path.join(k,d.mapping[f].path),m=b.getByUrl(k))h(m);else b.once("add:url:"+k,h)}else e.material=pc.ModelHandler.DEFAULT_MATERIAL}})}}};return{ModelHandler:f}}());pc.extend(pc,function(){var f=function(a){this._app=a;this._scripts={}};f._types=[];f._push=function(a){0<f._types.length?console.assert("Script Ordering Error. Contact support@playcanvas.com"):f._types.push(a)};f.prototype={load:function(a,b){pc.script.app=this._app;this._loadScript(a,function(a,e){if(a)b(a);else{var g=null;f._types.length&&(g=f._types.pop());g?this._scripts[e]=g:g=null;b(null,g)}}.bind(this))},open:function(a,b){return b},patch:function(){},_loadScript:function(a,b){var d=document.getElementsByTagName("head")[0],
e=document.createElement("script");e.async=!1;e.addEventListener("error",function(a){b(pc.string.format("Script: {0} failed to load",a.target.src))});var f=!1;e.onload=e.onreadystatechange=function(){if(!f&&(!this.readyState||"loaded"==this.readyState||"complete"==this.readyState))f=!0,b(null,a)};e.src=a;d.appendChild(e)}};return{ScriptHandler:f}}());pc.extend(pc,function(){var f=function(){};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b(pc.string.format("Error loading text resource: {0} [{1}]",a,d)):b(null,e)})},open:function(a,b){return b},patch:function(){}};return{TextHandler:f}}());pc.extend(pc,function(){var f={repeat:pc.ADDRESS_REPEAT,clamp:pc.ADDRESS_CLAMP_TO_EDGE,mirror:pc.ADDRESS_MIRRORED_REPEAT},a={nearest:pc.FILTER_NEAREST,linear:pc.FILTER_LINEAR,nearest_mip_nearest:pc.FILTER_NEAREST_MIPMAP_NEAREST,linear_mip_nearest:pc.FILTER_LINEAR_MIPMAP_NEAREST,nearest_mip_linear:pc.FILTER_NEAREST_MIPMAP_LINEAR,linear_mip_linear:pc.FILTER_LINEAR_MIPMAP_LINEAR},b=function(a,b,f){this._device=a;this._assets=b;this._loader=f;this.crossOrigin=void 0};b.prototype={load:function(a,b){var f=
0<=a.indexOf("?")?a.split("?")[0]:a,h=pc.path.getExtension(f).toLowerCase();if(".dds"===h||".crn"===h)pc.http.get(a,{cache:!0,responseType:"arraybuffer"},function(a,d){a?b(a):b(null,d)});else if(".jpg"===h||".jpeg"===h||".gif"===h||".png"===h){var k=new Image;void 0!==this.crossOrigin&&(k.crossOrigin=this.crossOrigin);k.onload=function(){b(null,k)};k.onerror=function(){b(pc.string.format("Error loading Texture from: '{0}'",a))};k.src=a}else setTimeout(function(){b(pc.string.format("Error loading Texture: format not supported: '{0}'",
h))},0)},open:function(a,b){if(a){var f,h=pc.path.getExtension(a).toLowerCase(),k=null;if(b instanceof Image||b instanceof HTMLImageElement){var m=b,k=".jpg"===h||".jpeg"===h?pc.PIXELFORMAT_R8_G8_B8:pc.PIXELFORMAT_R8_G8_B8_A8;f=new pc.Texture(this._device,{width:m.width,height:m.height,format:k});f.setSource(m)}else if(b instanceof ArrayBuffer){if(".crn"===h){var h=b.byteLength,r=new Uint8Array(b),m=Module._malloc(h),u=Module.HEAPU8,l,n=m/4,w=h%4,s=new Uint32Array(r.buffer,0,(h-w)/4),B=new Uint32Array(u.buffer);
for(l=0;l<s.length;l++)B[n+l]=s[l];for(l=h-w;l<h;l++)u[m+l]=r[l];r=Module._crn_decompress_get_data(m,h);h=Module._crn_decompress_get_size(m,h);b=Module.HEAPU8.buffer.slice(r,r+h)}f=new Uint32Array(b,0,32);var h=f[4],m=f[3],r=Math.max(f[7],1),y=f[21],x=f[22],u=65024===f[28],B=s=w=n=l=!1;if(4===f[20])if(827611204===y)k=pc.PIXELFORMAT_DXT1,l=!0;else if(894720068===y)k=pc.PIXELFORMAT_DXT5,l=!0;else if(116===y)k=pc.PIXELFORMAT_RGBA32F,n=!0;else if(826496069===y)k=pc.PIXELFORMAT_ETC1,w=l=!0;else if(825438800===
y||825504336===y)k=825438800===y?pc.PIXELFORMAT_PVRTC_2BPP_RGB_1:pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1,s=l=!0;else{if(825439312===y||825504848===y)k=825439312===y?pc.PIXELFORMAT_PVRTC_4BPP_RGB_1:pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1,B=l=!0}else 32===x&&(k=pc.PIXELFORMAT_R8_G8_B8_A8);f=Math.round(Math.log2(Math.max(h,m))+1);if(!k||r!==f&&l)return k?console.error("DDS has "+r+" mips, but engine requires "+f+" for DXT format. . Empty texture will be created instead."):console.error("This DDS pixel format is currently unsupported. Empty texture will be created instead."),
f=new pc.Texture(this._device,{width:4,height:4,format:pc.PIXELFORMAT_R8_G8_B8});f=new pc.Texture(this._device,{width:h,height:m,format:k,cubemap:u});u&&(f.addressU=pc.ADDRESS_CLAMP_TO_EDGE,f.addressV=pc.ADDRESS_CLAMP_TO_EDGE);for(var k=128,x=u?6:1,A,y=827611204===y?8:16,D,C=0;C<x;C++)for(var z=h,E=m,F=0;F<r;F++)l?w?A=8*Math.floor((z+3)/4)*Math.floor((E+3)/4):s?A=Math.max(z,16)*Math.max(E,8)/4:B?A=Math.max(z,8)*Math.max(E,8)/2:(A=Math.floor((z+4-1)/4),D=Math.floor((E+4-1)/4),numBlocks=A*D,A=numBlocks*
y):A=4*z*E,D=n?new Float32Array(b,k,A):new Uint8Array(b,k,A),u?(f._levels[F]||(f._levels[F]=[]),f._levels[F][C]=D):f._levels[F]=D,k+=n?4*A:A,z=Math.max(0.5*z,1),E=Math.max(0.5*E,1);f.upload()}return f}},patch:function(b){var e=b.resource;e&&(e.name!==b.name&&(e.name=b.name),b.data.hasOwnProperty("minfilter")&&e.minFilter!==a[b.data.minfilter]&&(e.minFilter=a[b.data.minfilter]),b.data.hasOwnProperty("magfilter")&&e.magFilter!==a[b.data.magfilter]&&(e.magFilter=a[b.data.magfilter]),b.data.hasOwnProperty("addressu")&&
e.addressU!==f[b.data.addressu]&&(e.addressU=f[b.data.addressu]),b.data.hasOwnProperty("addressv")&&e.addressV!==f[b.data.addressv]&&(e.addressV=f[b.data.addressv]),b.data.hasOwnProperty("anisotropy")&&e.anisotropy!==b.data.anisotropy&&(e.anisotropy=b.data.anisotropy),b.data.hasOwnProperty("rgbm")&&e.rgbm!==!!b.data.rgbm&&(e.rgbm=!!b.data.rgbm))}};return{TextureHandler:b}}());pc.extend(pc,function(){var f=function(){};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b(pc.string.format("Error loading html resource: {0} [{1}]",a,d)):b(null,e)})},open:function(a,b){return b},patch:function(){}};return{HtmlHandler:f}}());pc.extend(pc,function(){var f=function(){};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b(pc.string.format("Error loading css resource: {0} [{1}]",a,d)):b(null,e)})},open:function(a,b){return b},patch:function(){}};return{CssHandler:f,createStyle:function(a){var b=document.createElement("style");b.type="text/css";b.styleSheet?b.styleSheet.cssText=a:b.appendChild(document.createTextNode(a));return b}}}());pc.extend(pc,function(){var f=function(){};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b(pc.string.format("Error loading shader resource: {0} [{1}]",a,d)):b(null,e)})},open:function(a,b){return b},patch:function(){}};return{ShaderHandler:f}}());pc.extend(pc,function(){var f=function(a){this._app=a};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b("Error requesting scene: "+a):b(null,e)})},open:function(a,b){this._app.systems.script.preloading=!0;var d=(new pc.SceneParser(this._app)).parse(b),e=this._app.scene;e.root=d;this._app.applySceneSettings(b.settings);this._app.systems.script.preloading=!1;return e},patch:function(){}};return{SceneHandler:f}}());pc.extend(pc,function(){var f=function(a){this._app=a};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b("Error requesting scene: "+a):b(null,e)})},open:function(a,b){this._app.systems.script.preloading=!0;var d=(new pc.SceneParser(this._app)).parse(b);this._app.systems.script.preloading=!1;return d}};return{HierarchyHandler:f}}());pc.extend(pc,function(){var f=function(a){this._app=a};f.prototype={load:function(a,b){pc.http.get(a,function(d,e){d?b("Error requesting scene: "+a):b(null,e)})},open:function(a,b){return b.settings}};return{SceneSettingsHandler:f}}());pc.extend(pc,function(){var f=function(){};f.prototype={load:function(a,b){b(null,null)},open:function(a,b){return b}};return{FolderHandler:f}}());pc.extend(pc,function(){var f={points:pc.PRIMITIVE_POINTS,lines:pc.PRIMITIVE_LINES,lineloop:pc.PRIMITIVE_LINELOOP,linestrip:pc.PRIMITIVE_LINESTRIP,triangles:pc.PRIMITIVE_TRIANGLES,trianglestrip:pc.PRIMITIVE_TRISTRIP,trianglefan:pc.PRIMITIVE_TRIFAN},a={int8:pc.ELEMENTTYPE_INT8,uint8:pc.ELEMENTTYPE_UINT8,int16:pc.ELEMENTTYPE_INT16,uint16:pc.ELEMENTTYPE_UINT16,int32:pc.ELEMENTTYPE_INT32,uint32:pc.ELEMENTTYPE_UINT32,float32:pc.ELEMENTTYPE_FLOAT32},b=function(a){this._device=a};b.prototype={parse:function(a){var b=
this._parseNodes(a),f=this._parseSkins(a,b),h=this._parseVertexBuffers(a),k=this._parseIndexBuffers(a,h),h=this._parseMeshes(a,f.skins,h,k.buffer,k.data),a=this._parseMeshInstances(a,b,h,f.skins,f.instances),h=new pc.Model;h.graph=b[0];h.meshInstances=a;h.skinInstances=f.instances;h.getGraph().syncHierarchy();return h},_parseNodes:function(a){var a=a.model,b=[],f;for(f=0;f<a.nodes.length;f++){var h=a.nodes[f],k=new pc.GraphNode;k.setName(h.name);k.setLocalPosition(h.position[0],h.position[1],h.position[2]);
k.setLocalEulerAngles(h.rotation[0],h.rotation[1],h.rotation[2]);k.setLocalScale(h.scale[0],h.scale[1],h.scale[2]);b.push(k)}for(f=1;f<a.parents.length;f++)b[a.parents[f]].addChild(b[f]);return b},_parseSkins:function(a,b){var f=a.model,h=[],k=[],m,r;!this._device.supportsBoneTextures&&0<f.skins.length&&(m=this._device.getBoneLimit(),pc.partitionSkin(f,null,m));for(m=0;m<f.skins.length;m++){var u=f.skins[m],l=[];for(r=0;r<u.inverseBindMatrices.length;r++){var n=u.inverseBindMatrices[r];l[r]=new pc.Mat4(n[0],
n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15])}u=new pc.Skin(this._device,l,u.boneNames);h.push(u);l=new pc.SkinInstance(u,b[0]);n=[];for(r=0;r<u.boneNames.length;r++){var w=b[0].findByName(u.boneNames[r]);n.push(w)}l.bones=n;k.push(l)}return{skins:h,instances:k}},_parseVertexBuffers:function(b){var b=b.model,e=[],f,h,k={position:pc.SEMANTIC_POSITION,normal:pc.SEMANTIC_NORMAL,tangent:pc.SEMANTIC_TANGENT,blendWeight:pc.SEMANTIC_BLENDWEIGHT,blendIndices:pc.SEMANTIC_BLENDINDICES,
color:pc.SEMANTIC_COLOR,texCoord0:pc.SEMANTIC_TEXCOORD0,texCoord1:pc.SEMANTIC_TEXCOORD1,texCoord2:pc.SEMANTIC_TEXCOORD2,texCoord3:pc.SEMANTIC_TEXCOORD3,texCoord4:pc.SEMANTIC_TEXCOORD4,texCoord5:pc.SEMANTIC_TEXCOORD5,texCoord6:pc.SEMANTIC_TEXCOORD6,texCoord7:pc.SEMANTIC_TEXCOORD7},m,r;for(m=0;m<b.vertices.length;m++){var u=b.vertices[m];if(u.position&&u.normal&&u.texCoord0){f=[];for(r=0;r<b.meshes.length;r++)b.meshes[r].vertices===m&&(f=f.concat(b.meshes[r].indices));f=pc.calculateTangents(u.position.data,
u.normal.data,u.texCoord0.data,f);u.tangent={type:"float32",components:4,data:f}}r=[];for(h in u){f=u[h];var l=f.type;this._device.supportsUnsignedByte||("uint8"===l&&(l="float32"),"int8"===l&&(l="float32"));r.push({semantic:k[h],components:f.components,type:a[l],normalize:k[h]===pc.SEMANTIC_COLOR})}f=new pc.VertexFormat(this._device,r);var l=u.position.data.length/u.position.components,n=new pc.VertexBuffer(this._device,f,l),w=new pc.VertexIterator(n);for(r=0;r<l;r++){for(h in u)switch(f=u[h],f.components){case 1:w.element[k[h]].set(f.data[r]);
break;case 2:w.element[k[h]].set(f.data[2*r],f.data[2*r+1]);break;case 3:w.element[k[h]].set(f.data[3*r],f.data[3*r+1],f.data[3*r+2]);break;case 4:w.element[k[h]].set(f.data[4*r],f.data[4*r+1],f.data[4*r+2],f.data[4*r+3])}w.next()}w.end();e.push(n)}return e},_parseIndexBuffers:function(a,b){var f=a.model,h=null,k=null,m,r=0;for(m=0;m<f.meshes.length;m++){var u=f.meshes[m];void 0!==u.indices&&(r+=u.indices.length)}for(m=f=0;m<b.length;m++)f=Math.max(f,b[m].numVertices);0<r&&(65535<f&&this._device.extUintElement?
(h=new pc.IndexBuffer(this._device,pc.INDEXFORMAT_UINT32,r),k=new Uint32Array(h.lock())):(h=new pc.IndexBuffer(this._device,pc.INDEXFORMAT_UINT16,r),k=new Uint16Array(h.lock())));return{buffer:h,data:k}},_parseMeshes:function(a,b,g,h,k){var a=a.model,m=[],r=0,u;for(u=0;u<a.meshes.length;u++){var l=a.meshes[u],n=l.aabb,w=n.min,n=n.max,w=new pc.BoundingBox(new pc.Vec3(0.5*(n[0]+w[0]),0.5*(n[1]+w[1]),0.5*(n[2]+w[2])),new pc.Vec3(0.5*(n[0]-w[0]),0.5*(n[1]-w[1]),0.5*(n[2]-w[2]))),n=void 0!==l.indices,
s=new pc.Mesh;s.vertexBuffer=g[l.vertices];s.indexBuffer[0]=n?h:null;s.primitive[0].type=f[l.type];s.primitive[0].base=n?l.base+r:l.base;s.primitive[0].count=l.count;s.primitive[0].indexed=n;s.skin=void 0!==l.skin?b[l.skin]:null;s.aabb=w;n&&(k.set(l.indices,r),r+=l.indices.length);m.push(s)}null!==h&&h.unlock();return m},_parseMeshInstances:function(a,b,f,h,k){var a=a.model,m=[],r;for(r=0;r<a.meshInstances.length;r++){var u=a.meshInstances[r],l=f[u.mesh],u=new pc.MeshInstance(b[u.node],l,pc.ModelHandler.DEFAULT_MATERIAL);
if(l.skin){l=h.indexOf(l.skin);if(-1===l)throw Error("Mesh's skin does not appear in skin array.");u.skinInstance=k[l]}m.push(u)}return m}};return{JsonModelParser:b}}());pc.extend(pc,function(){var f=function(a){this._app=a};f.prototype={parse:function(a){var b={},d,e,f=null;for(d in a.entities)b[d]=this._createEntity(a.entities[d]),null===a.entities[d].parent&&(f=b[d]);for(d in a.entities){var h=a.entities[d].children.length;for(e=0;e<h;e++){var k=a.entities[d].children[e];b[k]&&b[d].addChild(b[k])}}this._openComponentData(f,a.entities);return f},_createEntity:function(a){var b=new pc.Entity,d=a.position,e=a.rotation,f=a.scale;b.setName(a.name);b.setGuid(a.resource_id);
b.setLocalPosition(d[0],d[1],d[2]);b.setLocalEulerAngles(e[0],e[1],e[2]);b.setLocalScale(f[0],f[1],f[2]);b._enabled=void 0!==a.enabled?a.enabled:!0;b._enabledInHierarchy=b._enabled;b.template=a.template;a.labels&&a.labels.forEach(function(a){b.addLabel(a)});return b},_openComponentData:function(a,b){var d=this._app.systems.list(),e,f=d.length,h=b[a.getGuid()];for(e=0;e<f;e++){var k=h.components[d[e].id];k&&this._app.systems[d[e].id].addComponent(a,k)}d=h.children.length;f=a.getChildren();for(e=0;e<
d;e++)f[e]=this._openComponentData(f[e],b);return a}};return{SceneParser:f}}());pc.extend(pc,function(){var f=-1,a=function(a,d,e,g){this._id=++f;this.name=a;this.type=d;this.tags=new pc.Tags(this);this.preload=!1;this._file=e?{filename:e.filename,size:e.size,hash:e.hash,url:e.url}:null;this._data=g||{};this._resources=[];this.loading=this.loaded=!1;pc.events.attach(this)};a.prototype={getFileUrl:function(){return!this.file?null:this.file.url},ready:function(a,d){d=d||this;if(this.resource)a.call(d,this);else this.once("load",function(e){a.call(d,e)})},unload:function(){this.resource=
null;this.loaded=!1}};Object.defineProperty(a.prototype,"id",{get:function(){return this._id},set:function(a){this._id=a;a>f&&(f=a)}});Object.defineProperty(a.prototype,"file",{get:function(){return this._file},set:function(a){var d=this._file;this._file=a;if(!a||!d||a&&d&&a.hash!==d.hash)this.fire("change",this,"file",a,d),this.loaded&&("cubemap"===this.type?this.registry._loader.patch(this,this.registry):(this.loaded=!1,this.registry.load(this)))}});Object.defineProperty(a.prototype,"data",{get:function(){return this._data},
set:function(a){var d=this._data;this._data=a;a!==d&&(this.fire("change",this,"data",a,d),this.loaded&&this.registry._loader.patch(this,this.registry))}});Object.defineProperty(a.prototype,"resource",{get:function(){return this._resources[0]},set:function(a){var d=this._resources[0];this._resources[0]=a;this.fire("change",this,"resource",a,d)}});Object.defineProperty(a.prototype,"resources",{get:function(){return this._resources},set:function(a){var d=this._resources;this._resources=a;this.fire("change",
this,"resources",a,d)}});return{Asset:a,ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SHADER:"shader",ASSET_CSS:"css",ASSET_HTML:"html"}}());pc.extend(pc,function(){var f=function(a){this._loader=a;this._assets=[];this._cache={};this._names={};this._tags=new pc.TagsCache("_id");this._urls={};this.prefix=null;pc.extend(this,pc.events)};f.prototype={list:function(a){a=a||{};return this._assets.filter(function(b){var d=!0;void 0!==a.preload&&(d=b.preload===a.preload);return d})},add:function(a){var b=this._assets.push(a)-1,d;this._cache[a.id]=b;this._names[a.name]||(this._names[a.name]=[]);this._names[a.name].push(b);a.file&&(d=a.getFileUrl(),
this._urls[d]=b);a.registry=this;this._tags.addItem(a);a.tags.on("add",this._onTagAdd,this);a.tags.on("remove",this._onTagRemove,this);this.fire("add",a);this.fire("add:"+a.id,a);d&&this.fire("add:url:"+d,a)},remove:function(a){delete this._cache[a.id];delete this._names[a.name];var b=a.getFileUrl();b&&delete this._urls[b];this._tags.removeItem(a);a.tags.off("add",this._onTagAdd,this);a.tags.off("remove",this._onTagRemove,this);a.fire("remove",a);this.fire("remove",a);this.fire("remove:"+a.id,a);
b&&this.fire("remove:url:"+b,a)},get:function(a){return this._assets[this._cache[a]]},getByUrl:function(a){return this._assets[this._urls[a]]},_compatibleLoad:function(a){var b=this;console.warn("DEPRECATED: Loading arrays of assets is deprecated. Call assets.load with single assets.");return new pc.promise.Promise(function(d){var e=a.length;a.forEach(function(f){f.ready(function(){e--;if(0===e){var b=a.map(function(a){return a.resource});d(b)}});b.load(f)})})},load:function(a){if(a instanceof Array)return this._compatibleLoad(a);
if(!a.loading){var b=this;if(a.loaded)"cubemap"===a.type&&b._loader.patch(a,this);else{var d=!!a.file,e=function(){var d=b._loader.open(a.type,a.data);d instanceof Array?a.resources=d:a.resource=d;a.loaded=!0;b._loader.patch(a,b);b.fire("load",a);b.fire("load:"+a.id,a);a.file&&a.file.url&&b.fire("load:url:"+a.file.url,a);a.fire("load",a)};a.file&&"cubemap"===a.type&&(d=!1,this._loader.load(a.file.url+"?t="+a.file.hash,"texture",function(d,f){d?(b.fire("error",d,a),b.fire("error:"+a.id,d,a),a.fire("error",
d,a)):(b._loader.patch({resource:f,type:"texture",data:a.data},b),a._dds=f,e())}));if(a.file){if(d){this.fire("load:start",a);this.fire("load:"+a.id+":start",a);d=a.file.url;b.prefix&&(d.startsWith("/")&&(d=d.slice(1)),d=pc.path.join(b.prefix,d));var f=-1!==d.indexOf("&")?"&":"?",d=d+(f+"t="+a.file.hash);a.loading=!0;b._loader.load(d,a.type,function(d,e){a.loaded=!0;a.loading=!1;d?(b.fire("error",d,a),b.fire("error:"+a.id,d,a),a.fire("error",d,a)):(e instanceof Array?a.resources=e:a.resource=e,b._loader.patch(a,
b),b.fire("load",a),b.fire("load:"+a.id,a),a.file&&a.file.url&&b.fire("load:url:"+a.file.url,a),a.fire("load",a))})}}else e()}}},loadFromUrl:function(a,b,d){var e=pc.path.getBasename(a),f={url:a},h={},a=this.getByUrl(a);a||(a=new pc.Asset(e,b,f,h),this.add(a));"model"===b?this._loadModel(a,d):(a.once("load",function(a){d(null,a)}),a.once("error",function(a){d(a)}),this.load(a))},_loadModel:function(a,b){var d=this,e=a.getFileUrl(),f=pc.path.getDirectory(e),e=pc.path.getBasename(e);e.replace(".json",
"");var e=pc.path.join(f,e.replace(".json",".mapping.json")),h=function(a){a.once("load",function(a){b(null,a)});a.once("error",function(a){b(a)});d.load(a)};this._loader.load(e,"json",function(b,e){b?(a.data={mapping:[]},h(a)):d._loadMaterials(f,e,function(){a.data=e;h(a)})})},_loadMaterials:function(a,b,d){var e=this,f,h=b.mapping.length,k=[];0===h&&d(null,k);var m=function(a,b){k.push(b);h--;0===h&&e._loadTextures(k,function(){d(null,k)})};for(f=0;f<b.mapping.length;f++){var r=b.mapping[f].path;
r?e.loadFromUrl(pc.path.join(a,r),"material",m):h--}},_loadTextures:function(a,b){var d,e,f={},h=[],k=[],m=0;for(d=0;d<a.length;d++)if(a[d].data.parameters){var r=a[d].data.parameters;for(e=0;e<r.length;e++)if("texture"===r[e].type){var u=pc.path.getDirectory(a[d].getFileUrl()),u=pc.path.join(u,r[e].data);f[u]||(f[u]=!0,h.push(u),m++)}}else console.warn("Update material asset loader to support new material format");if(m){e=function(a,d){k.push(d);m--;a&&console.error(a);0===m&&b(null,k)};for(d=0;d<
h.length;d++)this.loadFromUrl(h[d],"texture",e)}else b(null,k)},findAll:function(a,b){var d=this,e=this._names[a];return e?(e=e.map(function(a){return d._assets[a]}),b?e.filter(function(a){return a.type===b}):e):[]},_onTagAdd:function(a,b){this._tags.add(a,b)},_onTagRemove:function(a,b){this._tags.remove(a,b)},findByTag:function(){return this._tags.find(arguments)},filter:function(a){for(var b=[],d=0,e=this._assets.length;d<e;d++)a(this._assets[d])&&b.push(this._assets[d]);return b},find:function(a,
b){var d=this.findAll(a,b);return d?d[0]:null},getAssetById:function(a){console.warn("DEPRECATED: getAssetById() use get() instead");return this.get(a)}};return{AssetRegistry:f}}());!function(f){var a,b,d={},e={};a=function(a,b,e){d[a]={deps:b,callback:e}};b=function(a){function f(b){if("."!==b.charAt(0))return b;for(var b=b.split("/"),d=a.split("/").slice(0,-1),e=0,h=b.length;h>e;e++){var k=b[e];".."===k?d.pop():"."!==k&&d.push(k)}return d.join("/")}if(e[a])return e[a];if(e[a]={},!d[a])throw Error("Could not find module "+a);for(var k,m=d[a],r=m.deps,m=m.callback,u=[],l=0,n=r.length;n>l;l++)u.push("exports"===r[l]?k={}:b(f(r[l])));r=m.apply(this,u);return e[a]=k||r};b.entries=
d;!0;a("rsvp/all-settled",["./promise","./utils","exports"],function(a,b,d){var e=a["default"],f=b.isArray,u=b.isNonThenable;d["default"]=function(a,b){return new e(function(b){function d(a){return function(b){h(a,{state:"fulfilled",value:b})}}function g(a){return function(b){h(a,{state:"rejected",reason:b})}}function h(a,d){D[a]=d;0===--n&&b(D)}if(!f(a))throw new TypeError("You must pass an array to allSettled.");var k,n=a.length;if(0===n)return void b([]);for(var D=Array(n),C=0;C<a.length;C++)k=
a[C],u(k)?h(C,{state:"fulfilled",value:k}):e.resolve(k).then(d(C),g(C))},b)}});a("rsvp/all",["./promise","exports"],function(a,b){var d=a["default"];b["default"]=function(a,b){return d.all(a,b)}});a("rsvp/asap",["exports"],function(a){function b(){for(var a=0;a<e.length;a++){var d=e[a];(0,d[0])(d[1])}e.length=0}a["default"]=function(a,b){1===e.push([a,b])&&d()};var d,a="undefined"!=typeof window?window:{},a=a.MutationObserver||a.WebKitMutationObserver,e=[];if("undefined"!=typeof process&&"[object process]"===
{}.toString.call(process))a=function(){process.nextTick(b)};else if(a)var f=0,a=new a(b),u=document.createTextNode(""),a=(a.observe(u,{characterData:!0}),function(){u.data=f=++f%2});else a=function(){setTimeout(b,1)};d=a});a("rsvp/config",["./events","exports"],function(a,b){var d={instrument:!1};a["default"].mixin(d);b.config=d;b.configure=function(a,b){return"onerror"===a?void d.on("error",b):2!==arguments.length?d[a]:void(d[a]=b)}});a("rsvp/defer",["./promise","exports"],function(a,b){var d=a["default"];
b["default"]=function(a){var b={};return b.promise=new d(function(a,d){b.resolve=a;b.reject=d},a),b}});a("rsvp/events",["exports"],function(a){function b(a,d){for(var e=0,f=a.length;f>e;e++)if(a[e]===d)return e;return-1}function d(a){var b=a._promiseCallbacks;return b||(b=a._promiseCallbacks={}),b}a["default"]={mixin:function(a){return a.on=this.on,a.off=this.off,a.trigger=this.trigger,a._promiseCallbacks=void 0,a},on:function(a,e){var f,g=d(this);(f=g[a])||(f=g[a]=[]);-1===b(f,e)&&f.push(e)},off:function(a,
e){var f,g,n=d(this);return e?(f=n[a],g=b(f,e),void(-1!==g&&f.splice(g,1))):void(n[a]=[])},trigger:function(a,b){var e;if(e=d(this)[a])for(var f=0;f<e.length;f++)(0,e[f])(b)}}});a("rsvp/filter",["./promise","./utils","exports"],function(a,b,d){var e=a["default"],f=b.isFunction;d["default"]=function(a,b,d){return e.all(a,d).then(function(a){if(!f(b))throw new TypeError("You must pass a function as filter's second argument.");for(var g=a.length,h=Array(g),k=0;g>k;k++)h[k]=b(a[k]);return e.all(h,d).then(function(b){for(var d=
Array(g),e=0,f=0;g>f;f++)!0===b[f]&&(d[e]=a[f],e++);return d.length=e,d})})}});a("rsvp/hash-settled",["./promise","./utils","exports"],function(a,b,d){var e=a["default"],f=b.isNonThenable,u=b.keysOf;d["default"]=function(a){return new e(function(b){function d(a){return function(b){h(a,{state:"fulfilled",value:b})}}function g(a){return function(b){h(a,{state:"rejected",reason:b})}}function h(a,d){A[a]=d;0===--C&&b(A)}var k,x,A={},D=u(a),C=D.length;if(0===C)return void b(A);for(var z=0;z<D.length;z++)x=
D[z],k=a[x],f(k)?h(x,{state:"fulfilled",value:k}):e.resolve(k).then(d(x),g(x))})}});a("rsvp/hash",["./promise","./utils","exports"],function(a,b,d){var e=a["default"],f=b.isNonThenable,u=b.keysOf;d["default"]=function(a){return new e(function(b,d){function g(a){return function(d){A[a]=d;0===--C&&b(A)}}function h(a){C=0;d(a)}var k,x,A={},D=u(a),C=D.length;if(0===C)return void b(A);for(var z=0;z<D.length;z++)x=D[z],k=a[x],f(k)?(A[x]=k,0===--C&&b(A)):e.resolve(k).then(g(x),h)})}});a("rsvp/instrument",
["./config","./utils","exports"],function(a,b,d){var e=a.config,f=b.now;d["default"]=function(a,b,d){try{e.trigger(a,{guid:b._guidKey+b._id,eventName:a,detail:b._detail,childGuid:d&&b._guidKey+d._id,label:b._label,timeStamp:f(),stack:Error(b._label).stack})}catch(g){setTimeout(function(){throw g;},0)}}});a("rsvp/map",["./promise","./utils","exports"],function(a,b,d){var e=a["default"],f=(b.isArray,b.isFunction);d["default"]=function(a,b,d){return e.all(a,d).then(function(a){if(!f(b))throw new TypeError("You must pass a function as map's second argument.");
for(var g=a.length,h=Array(g),k=0;g>k;k++)h[k]=b(a[k]);return e.all(h,d)})}});a("rsvp/node",["./promise","./utils","exports"],function(a,b,d){var e=a["default"],f=b.isArray;d["default"]=function(a,b){function d(){for(var f=arguments.length,k=Array(f),r=0;f>r;r++)k[r]=arguments[r];var n;return g||h||!b?n=this:(console.warn('Deprecation: RSVP.denodeify() doesn\'t allow setting the "this" binding anymore. Use yourFunction.bind(yourThis) instead.'),n=b),e.all(k).then(function(d){return new e(function(e,
f){d.push(function(){for(var a=arguments.length,d=Array(a),k=0;a>k;k++)d[k]=arguments[k];a=d[0];k=d[1];if(a)f(a);else if(g)e(d.slice(1));else if(h){for(var a={},m=d.slice(1),k=0;k<b.length;k++)d=b[k],a[d]=m[k];e(a)}else e(k)});a.apply(n,d)})})}var g=!0===b,h=f(b);return d.__proto__=a,d}});a("rsvp/promise","./config ./events ./instrument ./utils ./promise/cast ./promise/all ./promise/race ./promise/resolve ./promise/reject exports".split(" "),function(a,b,d,e,f,u,l,n,w,s){function B(){}function y(a,
b){if(!K(a))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof y))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._id=H++;this._label=b;this._subscribers=[];J.instrument&&M("created",this);if(B!==a){var d=this,e=function(a){C(d,a)},f=function(a){E(d,a)};try{a(e,f)}catch(g){f(g)}}}function x(a,b){var d,e,f=a._subscribers,g=a._detail;
J.instrument&&M(b===$?"fulfilled":"rejected",a);for(var h=0;h<f.length;h+=3)d=f[h],e=f[h+b],A(b,d,e,g);a._subscribers=null}function A(a,b,d,e){var f,g,h,k,l=K(d);if(l)try{f=d(e),h=!0}catch(m){k=!0,g=m}else f=e,h=!0;D(b,f)||(l&&h?C(b,f):k?E(b,g):a===$?C(b,f):a===I&&E(b,f))}function D(a,b){var d,e=null;try{if(a===b)throw new TypeError("A promises callback cannot return that same promise.");if(O(b)&&(e=b.then,K(e)))return e.call(b,function(e){return d?!0:(d=!0,void(b!==e?C(a,e):z(a,e)))},function(b){return d?
!0:(d=!0,void E(a,b))},"Settle: "+(a._label||" unknown promise")),!0}catch(f){return d?!0:(E(a,f),!0)}return!1}function C(a,b){a===b?z(a,b):D(a,b)||z(a,b)}function z(a,b){a._state===L&&(a._state=S,a._detail=b,J.async(F,a))}function E(a,b){a._state===L&&(a._state=S,a._detail=b,J.async(N,a))}function F(a){x(a,a._state=$)}function N(a){a._onerror&&a._onerror(a._detail);x(a,a._state=I)}var J=a.config,M=(b["default"],d["default"]),O=e.objectOrFunction,K=e.isFunction,a=e.now,f=f["default"],u=u["default"],
l=l["default"],n=n["default"],w=w["default"],a="rsvp_"+a()+"-",H=0;s["default"]=y;y.cast=f;y.all=u;y.race=l;y.resolve=n;y.reject=w;var L=void 0,S=0,$=1,I=2;y.prototype={constructor:y,_id:void 0,_guidKey:a,_label:void 0,_state:void 0,_detail:void 0,_subscribers:void 0,_onerror:function(a){J.trigger("error",a)},then:function(a,b,d){var e=this;this._onerror=null;var f=new this.constructor(B,d);if(this._state){var g=arguments;J.async(function(){A(e._state,f,g[e._state-1],e._detail)})}else{var h=this._subscribers,
k=h.length;h[k]=f;h[k+$]=a;h[k+I]=b}return J.instrument&&M("chained",e,f),f},"catch":function(a,b){return this.then(null,a,b)},"finally":function(a,b){var d=this.constructor;return this.then(function(b){return d.resolve(a()).then(function(){return b})},function(b){return d.resolve(a()).then(function(){throw b;})},b)}}});a("rsvp/promise/all",["../utils","exports"],function(a,b){var d=a.isArray,e=a.isNonThenable;b["default"]=function(a,b){var f=this;return new f(function(b,g){function h(a){return function(d){A[a]=
d;0===--x&&b(A)}}function u(a){x=0;g(a)}if(!d(a))throw new TypeError("You must pass an array to all.");var y,x=a.length,A=Array(x);if(0===x)return void b(A);for(var D=0;D<a.length;D++)y=a[D],e(y)?(A[D]=y,0===--x&&b(A)):f.resolve(y).then(h(D),u)},b)}});a("rsvp/promise/cast",["exports"],function(a){a["default"]=function(a,b){return a&&"object"==typeof a&&a.constructor===this?a:new this(function(b){b(a)},b)}});a("rsvp/promise/race",["../utils","exports"],function(a,b){var d=a.isArray,e=(a.isFunction,
a.isNonThenable);b["default"]=function(a,b){var f,g=this;return new g(function(b,h){function u(a){x&&(x=!1,b(a))}function y(a){x&&(x=!1,h(a))}if(!d(a))throw new TypeError("You must pass an array to race.");for(var x=!0,A=0;A<a.length;A++){if(f=a[A],e(f))return x=!1,void b(f);g.resolve(f).then(u,y)}},b)}});a("rsvp/promise/reject",["exports"],function(a){a["default"]=function(a,b){return new this(function(b,d){d(a)},b)}});a("rsvp/promise/resolve",["exports"],function(a){a["default"]=function(a,b){return a&&
"object"==typeof a&&a.constructor===this?a:new this(function(b){b(a)},b)}});a("rsvp/race",["./promise","exports"],function(a,b){var d=a["default"];b["default"]=function(a,b){return d.race(a,b)}});a("rsvp/reject",["./promise","exports"],function(a,b){var d=a["default"];b["default"]=function(a,b){return d.reject(a,b)}});a("rsvp/resolve",["./promise","exports"],function(a,b){var d=a["default"];b["default"]=function(a,b){return d.resolve(a,b)}});a("rsvp/rethrow",["exports"],function(a){a["default"]=function(a){throw setTimeout(function(){throw a;
}),a;}});a("rsvp/utils",["exports"],function(a){function b(a){return"function"==typeof a||"object"==typeof a&&null!==a}a.objectOrFunction=b;a.isFunction=function(a){return"function"==typeof a};a.isNonThenable=function(a){return!b(a)};a.isArray=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};a.now=Date.now||function(){return(new Date).getTime()};a.keysOf=Object.keys||function(a){var b=[],d;for(d in a)b.push(d);return b}});a("rsvp","./rsvp/promise ./rsvp/events ./rsvp/node ./rsvp/all ./rsvp/all-settled ./rsvp/race ./rsvp/hash ./rsvp/hash-settled ./rsvp/rethrow ./rsvp/defer ./rsvp/config ./rsvp/map ./rsvp/resolve ./rsvp/reject ./rsvp/filter ./rsvp/asap exports".split(" "),
function(a,b,d,e,f,u,l,n,w,s,B,y,x,A,D,C,z){function E(){F.on.apply(F,arguments)}var a=a["default"],b=b["default"],d=d["default"],e=e["default"],f=f["default"],u=u["default"],l=l["default"],n=n["default"],w=w["default"],s=s["default"],F=B.config,B=B.configure,y=y["default"],x=x["default"],A=A["default"],D=D["default"];if(F.async=C["default"],"undefined"!=typeof window&&"object"==typeof window.__PROMISE_INSTRUMENTATION__){C=window.__PROMISE_INSTRUMENTATION__;B("instrument",!0);for(var N in C)C.hasOwnProperty(N)&&
E(N,C[N])}z.Promise=a;z.EventTarget=b;z.all=e;z.allSettled=f;z.race=u;z.hash=l;z.hashSettled=n;z.rethrow=w;z.defer=s;z.denodeify=d;z.configure=B;z.on=E;z.off=function(){F.off.apply(F,arguments)};z.resolve=x;z.reject=A;z.async=function(a,b){F.async(a,b)};z.map=y;z.filter=D});f.RSVP=b("rsvp")}(window);pc.promise={Promise:window.RSVP.Promise,all:window.RSVP.all};pc.anim={Animation:pc.Animation,Key:pc.Key,Node:pc.Node,Skeleton:pc.Skeleton};pc.asset={ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap"};pc.audio={AudioManager:pc.SoundManager,Channel:pc.Channel,Channel3d:pc.Channel3d,Listener:pc.Listener,Sound:pc.Sound};
pc.fw={Application:pc.Application,Component:pc.Component,ComponentData:pc.ComponentData,ComponentSystem:pc.ComponentSystem,ContentFile:pc.ContentFile,Entity:pc.Entity,FillMode:{NONE:pc.FILLMODE_NONE,FILL_WINDOW:pc.FILLMODE_FILL_WINDOW,KEEP_ASPECT:pc.FILLMODE_KEEP_ASPECT},Pack:pc.Pack,ResolutionMode:{AUTO:pc.RESOLUTION_AUTO,FIXED:pc.RESOLUTION_FIXED}};
pc.extend(pc.gfx,{drawQuadWithShader:pc.drawQuadWithShader,precalculatedTangents:pc.precalculatedTangents,programlib:pc.programlib,shaderChunks:pc.shaderChunks,ContextCreationError:pc.ContextCreationError,Device:pc.GraphicsDevice,IndexBuffer:pc.IndexBuffer,ProgramLibrary:pc.ProgramLibrary,RenderTarget:pc.RenderTarget,ScopeId:pc.ScopeId,Shader:pc.Shader,ShaderInput:pc.ShaderInput,Texture:pc.Texture,UnsupportedBrowserError:pc.UnsupportedBrowserError,VertexBuffer:pc.VertexBuffer,VertexFormat:pc.VertexFormat,
VertexIterator:pc.VertexIterator});pc.extend(pc.input,{getTouchTargetCoords:pc.getTouchTargetCoords,Controller:pc.Controller,GamePads:pc.GamePads,Keyboard:pc.Keyboard,KeyboardEvent:pc.KeyboardEvent,Mouse:pc.Mouse,MouseEvent:pc.MouseEvent,Touch:pc.Touch,TouchDevice:pc.TouchDevice,TouchEvent:pc.TouchEvent});pc.posteffect={createFullscreenQuad:pc.createFullscreenQuad,drawFullscreenQuad:pc.drawFullscreenQuad,PostEffect:pc.PostEffect,PostEffectQueue:pc.PostEffectQueue};
pc.extend(pc.scene,{partitionSkin:pc.partitionSkin,procedural:{calculateTangents:pc.calculateTangents,createMesh:pc.createMesh,createTorus:pc.createTorus,createCylinder:pc.createCylinder,createCapsule:pc.createCapsule,createCone:pc.createCone,createSphere:pc.createSphere,createPlane:pc.createPlane,createBox:pc.createBox},BasicMaterial:pc.BasicMaterial,DepthMaterial:pc.DepthMaterial,ForwardRenderer:pc.ForwardRenderer,GraphNode:pc.GraphNode,Material:pc.Material,Command:pc.Command,Mesh:pc.Mesh,MeshInstance:pc.MeshInstance,
Model:pc.Model,ParticleEmitter:pc.ParticleEmitter,PhongMaterial:pc.StandardMaterial,Picker:pc.Picker,PickMaterial:pc.PickMaterial,Projection:{ORTHOGRAPHIC:pc.PROJECTION_ORTHOGRAPHIC,PERSPECTIVE:pc.PROJECTION_PERSPECTIVE},Scene:pc.Scene,Skin:pc.Skin,SkinInstance:pc.SkinInstance});pc.shape={Aabb:pc.BoundingBox,Sphere:pc.BoundingSphere,Plane:pc.Plane};pc.time={now:pc.now,Timer:pc.Timer};pc.PhongMaterial=pc.StandardMaterial;pc.extend(pc.Application.prototype,function(){var f=null,a=[],b=null,d=null,e=null,g=function(){this.numLinesAllocated=128;this.mesh=this.vbRam=this.vb=null;this.linesUsed=0;this.meshInstance=this.material=null};g.prototype={init:function(a,b){this.mesh||(this.mesh=new pc.Mesh,this.mesh.primitive[0].type=pc.PRIMITIVE_LINES,this.mesh.primitive[0].base=0,this.mesh.primitive[0].indexed=!1,this.material=new pc.BasicMaterial,this.material.vertexColors=!0,this.material.blend=!0,this.material.blendType=
pc.BLEND_NORMAL,this.material.update());for(;this.linesUsed+b>this.numLinesAllocated;)this.vb=null,this.numLinesAllocated*=2;this.vb||(this.vb=new pc.VertexBuffer(a,f,2*this.numLinesAllocated,pc.BUFFER_DYNAMIC),this.mesh.vertexBuffer=this.vb,this.vbRam=new DataView(this.vb.lock()),this.meshInstance||(this.meshInstance=new pc.MeshInstance({worldTransform:pc.Mat4.IDENTITY},this.mesh,this.material)))},addLines:function(a,b){for(var d=!!b.length,e=2*this.linesUsed*f.size,g,l=0;l<a.length;l++)this.vbRam.setFloat32(e,
a[l].x,!0),e+=4,this.vbRam.setFloat32(e,a[l].y,!0),e+=4,this.vbRam.setFloat32(e,a[l].z,!0),e+=4,g=d?b[l]:b,this.vbRam.setUint8(e,255*g.r),e+=1,this.vbRam.setUint8(e,255*g.g),e+=1,this.vbRam.setUint8(e,255*g.b),e+=1,this.vbRam.setUint8(e,255*g.a),e+=1;this.linesUsed+=a.length/2},finalize:function(a){0<this.linesUsed&&(this.vb.setData(this.vbRam.buffer),this.mesh.primitive[0].count=2*this.linesUsed,a.push(this.meshInstance),this.linesUsed=0)}};return{renderMeshInstance:function(a){this.scene.immediateDrawCalls.push(a)},
renderMesh:function(a,b,d){a=new pc.MeshInstance({worldTransform:d},a,b);this.scene.immediateDrawCalls.push(a)},renderLine:function(a,b,d,e,f){var g=d,n=pc.LINEBATCH_WORLD;e&&("number"===typeof e?n=e:(g=e,f&&(n=f)));this._addLines(n,[a,b],[d,g])},renderLines:function(a,b,d){void 0===d&&(d=pc.LINEBATCH_WORLD);b.length&&a.length!==b.length?pc.log.error("renderLines: position/color arrays have different lengths"):0!==a.length%2?pc.log.error("renderLines: array length is not divisible by 2"):this._addLines(d,
a,b)},renderQuad:function(a,d,e){if(!b){var f=new pc.VertexFormat(this.graphicsDevice,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]);quadVb=new pc.VertexBuffer(this.graphicsDevice,f,4);f=new pc.VertexIterator(quadVb);f.element[pc.SEMANTIC_POSITION].set(-0.5,-0.5,0);f.next();f.element[pc.SEMANTIC_POSITION].set(0.5,-0.5,0);f.next();f.element[pc.SEMANTIC_POSITION].set(-0.5,0.5,0);f.next();f.element[pc.SEMANTIC_POSITION].set(0.5,0.5,0);f.end();b=new pc.Mesh;b.vertexBuffer=
quadVb;b.primitive[0].type=pc.PRIMITIVE_TRISTRIP;b.primitive[0].base=0;b.primitive[0].count=4;b.primitive[0].indexed=!1}a=new pc.MeshInstance({worldTransform:a},b,d);e&&(a.layer=e);this.scene.immediateDrawCalls.push(a)},renderWireCube:function(a,b,f){void 0===f&&(f=pc.LINEBATCH_WORLD);var g;d||(d=[new pc.Vec3(-0.5,-0.5,-0.5),new pc.Vec3(-0.5,0.5,-0.5),new pc.Vec3(0.5,0.5,-0.5),new pc.Vec3(0.5,-0.5,-0.5),new pc.Vec3(-0.5,-0.5,0.5),new pc.Vec3(-0.5,0.5,0.5),new pc.Vec3(0.5,0.5,0.5),new pc.Vec3(0.5,
-0.5,0.5)],e=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3]);for(g=0;8>g;g++)a.transformPoint(d[g],e[g]);this.renderLines([e[0],e[1],e[1],e[2],e[2],e[3],e[3],e[0],e[4],e[5],e[5],e[6],e[6],e[7],e[7],e[4],e[0],e[4],e[1],e[5],e[2],e[6],e[3],e[7]],b,f)},_addLines:function(b,d,e){f||(f=new pc.VertexFormat(this.graphicsDevice,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_COLOR,components:4,type:pc.ELEMENTTYPE_UINT8,
normalize:!0}]),this.on("prerender",this._preRenderImmediate,this));a[b]?a[b].init(this.graphicsDevice,d.length/2):(a[b]=new g,a[b].init(this.graphicsDevice,d.length/2),b===pc.LINEBATCH_OVERLAY?(a[b].material.depthTest=!1,a[b].meshInstance.layer=pc.LAYER_GIZMO):b===pc.LINEBATCH_GIZMO&&(a[b].meshInstance.layer=pc.LAYER_GIZMO));a[b].addLines(d,e)},_preRenderImmediate:function(){for(var b=0;3>b;b++)a[b]&&a[b].finalize(this.scene.immediateDrawCalls)}}}());pc.extend(pc,function(){function f(a,b,d,e){if(a.enabled){var g;if(a.model&&(a.model.model&&a.model.enabled)&&(e&&e.push(a),a.model.data.lightmapped&&b)){var h=!0,k=a.model.model.meshInstances;for(g=0;g<k.length;g++)if(!k[g].mesh.vertexBuffer.format.hasUv1){h=!1;break}if(h){var m,r=[];for(g=0;g<k.length;g++){m=!1;for(h=0;h<k.length;h++)g!==h&&k[g].mesh===k[h].mesh&&(m=!0);m?(b.push(a),d.push([k[g]])):r.push(k[g])}0<r.length&&(b.push(a),d.push(r))}}a=a.getChildren();for(g=0;g<a.length;g++)f(a[g],b,
d,e)}}var a=[],b=[],d,e=new pc.Vec3,g=new pc.BoundingBox,h=new pc.BoundingBox,k={},m,r=function(a,b,d,e,f){this.device=a;this.root=b;this.scene=d;this.renderer=e;this.assets=f;this._stats={renderPasses:0,lightmapCount:0,lightmapMem:0,totalRenderTime:0,forwardTime:0,fboTime:0,shadowMapTime:0,compileTime:0,shadersLinked:0}};r.prototype={calculateLightmapSize:function(a){var b=this.scene.lightmapSizeMultiplier||16,d=1,f=1,g=1,h=1;if(a.model.asset){var k=this.assets.get(a.model.asset).data;k.area&&(d=
k.area.x,f=k.area.y,g=k.area.z,h=k.area.uv)}else a.model._area&&(k=a.model,k._area&&(d=k._area.x,f=k._area.y,g=k._area.z,h=k._area.uv));k=a.model.lightmapSizeMultiplier||1;d*=k;f*=k;g*=k;e.copy(a.getLocalScale());for(a=a.getParent();a;)e.mul(a.getLocalScale()),a=a.getParent();d=d*e.y*e.z+f*e.x*e.z+g*e.x*e.y;d=Math.sqrt(d/h);return Math.min(pc.math.nextPowerOfTwo(d*b),this.scene.lightmapMaxResolution||2048)},bake:function(r){var l=pc.now();this.device.fire("lightmapper:start",{timestamp:l,target:this});
var n,w,s,B=this.device,y=this.scene,x=this._stats;x.renderPasses=x.lightmapMem=x.shadowMapTime=x.forwardTime=0;var A=B._shaderStats.linked,D=B._renderTargetCreationTime,C=B._shaderStats.compileTime,z=[],E=[];if(r){for(n=0;n<a.length;n++)for(n=w;w<r.length;w++)b[n]===r[w]&&a[n].destroy();a=[];b=[];var F=[];for(n=0;n<r.length;n++)f(r[n],F,E);r=F;f(this.root,null,null,z)}else{for(n=0;n<a.length;n++)a[n].destroy();a=[];b=[];r=[];f(this.root,r,E,z)}x.lightmapCount=r.length;var N=[],F=[],J={},M,O;for(n=
0;n<r.length;n++)M=this.calculateLightmapSize(r[n],E[n]),N.push(M),O=new pc.Texture(B,{width:M,height:M,format:pc.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!1,rgbm:!0}),O.addressU=pc.ADDRESS_CLAMP_TO_EDGE,O.addressV=pc.ADDRESS_CLAMP_TO_EDGE,O._minFilter=pc.FILTER_LINEAR,O._magFilter=pc.FILTER_LINEAR,F.push(O),x.lightmapMem+=16*M*M,J[M]||(O=new pc.Texture(B,{width:M,height:M,format:pc.PIXELFORMAT_R8_G8_B8_A8,autoMipmap:!1,rgbm:!0}),O.addressU=pc.ADDRESS_CLAMP_TO_EDGE,O.addressV=pc.ADDRESS_CLAMP_TO_EDGE,O._minFilter=
pc.FILTER_LINEAR,O._magFilter=pc.FILTER_LINEAR,O=new pc.RenderTarget(B,O,{depth:!1}),J[M]=O);N=[];M=[];O=[];var K=[],H=y._lights,L;for(n=0;n<H.length;n++)H[n]._enabled&&(L=H[n].mask,0!==(L&4)&&(M.push(L),O.push(H[n].shadowUpdateMode),H[n].setMask(4294967295),H[n].shadowUpdateMode=H[n].getType()===pc.LIGHTTYPE_DIRECTIONAL?pc.SHADOWUPDATE_REALTIME:pc.SHADOWUPDATE_THISFRAME,N.push(H[n]))),K.push(H[n]._enabled),H[n].setEnabled(!1);n=pc.shaderChunks;var S=n.transformUv1VS,$=n.bakeLmEndPS;L=n.createShaderFromCode(B,
n.fullscreenQuadVS,n.dilatePS,"lmDilate");var I=B.scope.resolve("source"),Q=B.scope.resolve("pixelOffset"),Y,G=y.drawCalls;for(n=0;n<G.length;n++)G[n].node&&G[n].node.getWorldTransform();var G=y.fog,W=y.ambientLight.r,ga=y.ambientLight.g,ia=y.ambientLight.b,V=y.drawCalls;y.fog=pc.FOG_NONE;y.ambientLight.r=0;y.ambientLight.g=0;y.ambientLight.b=0;d||(d=new pc.Camera,d._node=new pc.GraphNode,d.setClearOptions({color:[0,0,0,0],depth:1,flags:pc.CLEARFLAG_COLOR}),d.frustumCulling=!1);var T,P;for(T=0;T<
z.length;T++){P=z[T].model.model.meshInstances;for(n=0;n<P.length;n++)P[n]._shaderDefs&=~pc.SHADERDEF_LM}var aa=[];for(T=0;T<z.length;T++)aa[T]=z[T].model.castShadows,z[T].model.castShadows=z[T].model.data.castShadowsLightmap;var ea=[],da=[],U=[];y.updateShadersFunc(B);for(T=0;T<r.length;T++){P=E[T];for(n=0;n<P.length;n++)Y=P[n].material,ea.push(Y)}m||(m=new pc.StandardMaterial,m.chunks.transformVS=S,m.chunks.endPS=$,m.ambient=new pc.Color(0,0,0),m.ambientTint=!0,m.chunks.outputAlphaPS="\n",m.chunks.outputAlphaOpaquePS=
"\n",m.chunks.outputAlphaPremulPS="\n",m.cull=pc.CULLFACE_NONE,m.forceUv1=!0,m.update(),m.updateShader(B,y));for(T=0;T<r.length;T++){P=E[T];S=F[T];if(0<P.length){g.copy(P[0].aabb);for(n=0;n<P.length;n++)P[n].node.getWorldTransform(),g.add(P[n].aabb)}n=new pc.BoundingBox;n.copy(g);da.push(n);for(n=0;n<P.length;n++)Y=P[n],Y._shaderDefs&=~pc.SHADERDEF_LM,Y.mask=4,Y.deleteParameter("texture_lightMap"),Y.material=m;$=new pc.RenderTarget(B,S,{depth:!1});U.push($)}for(w=0;w<N.length;w++)N[w].setEnabled(!1);
for(n=0;n<N.length;n++){N[n].setEnabled(!0);N[n]._cacheShadowMap=!0;N[n].getType()!==pc.LIGHTTYPE_DIRECTIONAL&&(N[n]._node.getWorldTransform(),N[n].getBoundingSphere(k),h.center=k.center,h.halfExtents.x=k.radius,h.halfExtents.y=k.radius,h.halfExtents.z=k.radius);N[n].getType()===pc.LIGHTTYPE_SPOT&&(T=N[n],s=this.renderer.getShadowCamera(B,T),s._node.setPosition(T._node.getPosition()),s._node.setRotation(T._node.getRotation()),s._node.rotateLocal(-90,0,0),s.setProjection(pc.PROJECTION_PERSPECTIVE),
s.setNearClip(T.getAttenuationEnd()/1E3),s.setFarClip(T.getAttenuationEnd()),s.setAspectRatio(1),s.setFov(2*T.getOuterConeAngle()),this.renderer.updateCameraFrustum(s));for(T=0;T<r.length;T++){P=E[T];S=F[T];g=da[T];$=U[T];Y=J[S.width];texTmp=Y.colorBuffer;y.drawCalls=[];for(w=0;w<P.length;w++)y.drawCalls.push(P[w]);y.updateShaders=!0;if(N[n].getType()===pc.LIGHTTYPE_DIRECTIONAL)e.copy(g.center),e.y+=g.halfExtents.y,d._node.setPosition(e),d._node.setEulerAngles(-90,0,0),w=Math.max(g.halfExtents.x,
g.halfExtents.z),d.setProjection(pc.PROJECTION_ORTHOGRAPHIC),d.setNearClip(0),d.setFarClip(2*g.halfExtents.y),d.setAspectRatio(1),d.setOrthoHeight(w);else if(!h.intersects(g))continue;if(N[n].getType()===pc.LIGHTTYPE_SPOT){var ba=!1;for(w=0;w<P.length;w++)if(this.renderer._isVisible(s,P[w])){ba=!0;break}if(!ba)continue}d.setRenderTarget(Y);this.renderer.render(y,d);x.shadowMapTime+=this.renderer._shadowMapTime;x.forwardTime+=this.renderer._forwardTime;x.renderPasses++;F[T]=texTmp;U[T]=Y;J[S.width]=
$;for(w=0;w<P.length;w++)Y=P[w],Y.setParameter("texture_lightMap",texTmp),Y._shaderDefs|=pc.SHADERDEF_LM}N[n].setEnabled(!1);N[n]._cacheShadowMap=!1}for(T=s=0;T<r.length;T++){P=E[T];S=F[T];$=U[T];Y=J[S.width];texTmp=Y.colorBuffer;n=new pc.Vec2(1/S.width,1/S.height);Q.setValue(n.data);for(n=0;4>n;n++)I.setValue(S),pc.drawQuadWithShader(B,Y,L),I.setValue(texTmp),pc.drawQuadWithShader(B,$,L);for(n=0;n<P.length;n++)Y=P[n],Y.mask=2,P[n].material=ea[s],P[n].setParameter("texture_lightMap",S),s++;a.push(S);
b.push(r[T]);$.destroy()}for(var X in J)J.hasOwnProperty(X)&&(J[X].colorBuffer.destroy(),J[X].destroy());for(T=0;T<z.length;T++)z[T].model.castShadows=aa[T];for(n=0;n<N.length;n++)N[n].setMask(M[n]),N[n].shadowUpdateMode=O[n];for(n=0;n<H.length;n++)H[n].setEnabled(K[n]);y.drawCalls=V;y.fog=G;y.ambientLight.r=W;y.ambientLight.g=ga;y.ambientLight.b=ia;y._updateLightStats();this.device.fire("lightmapper:end",{timestamp:pc.now(),target:this});x.totalRenderTime=pc.now()-l;x.shadersLinked=B._shaderStats.linked-
A;x.compileTime=B._shaderStats.compileTime-C;x.fboTime=B._renderTargetCreationTime-D}};return{Lightmapper:r,MASK_DYNAMIC:1,MASK_BAKED:2,MASK_LIGHTMAP:4}}());
